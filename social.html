<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kowbi | social</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Link Shared CSS -->
    <link rel="stylesheet" href="assets/styles.css">
    <!-- Page Specific Styles (if any) -->
    <style>
        /* Add page-specific styles here if needed */
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDY48xF1byvU05kS9qKvN8iyrIR3hheP8w",
            authDomain: "kowbi-fitness.firebaseapp.com",
            projectId: "kowbi-fitness",
            storageBucket: "kowbi-fitness.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123def456"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body class="antialiased">

    <!-- Theme script (should be early) -->
    <script>
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <div class="container mx-auto max-w-7xl px-4 py-6">
        <!-- Header Placeholder -->
        <div id="header-placeholder"></div>

        <!-- Main Content Area -->
        <main>
             <!-- Removed h1 -->

            <!-- Segmented Control Navigation -->
            <nav class="segmented-control mb-8">
                <button id="friends-tab" class="tab-btn active" data-tab="friends">Friends</button>
                <button id="community-tab" class="tab-btn" data-tab="community">Community</button>
                <button id="achievements-tab" class="tab-btn" data-tab="achievements">Gains</button>
            </nav>

            <!-- Tab Content Panels -->
            <div>
                <!-- Friends Panel -->
                <section id="friends-panel" class="tab-panel active">
                    <div class="space-y-6">
                        <!-- Recent Imports Section -->
                        <div class="content-card">
                            <h3 class="text-xl font-semibold mb-4">Recent Imports</h3>
                            <div id="recent-imports-list" class="space-y-3"></div>
                        </div>

                        <!-- Your Shares Section -->
                        <div class="content-card">
                            <h3 class="text-xl font-semibold mb-4">Your Shares</h3>
                            <div id="your-shares-list" class="space-y-3"></div>
                        </div>
                    </div>
                </section>

                <!-- Community Panel -->
                <section id="community-panel" class="tab-panel">
                    <div class="content-card mb-6">
                        <h2 class="text-2xl font-semibold mb-4">Community Feed</h2>
                        <!-- Filter Buttons -->
                        <nav class="segmented-control mb-6">
                            <button id="filter-all" class="tab-btn active" data-filter="all">All</button>
                            <button id="filter-workouts" class="tab-btn" data-filter="workout">Workouts</button>
                            <button id="filter-recipes" class="tab-btn" data-filter="recipe">Recipes</button>
                        </nav>
                        <!-- Feed Content -->
                        <div id="community-feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </section>

                <!-- Achievements Panel -->
                <section id="achievements-panel" class="tab-panel">
                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">Your Achievements</h2>
                        <div id="achievements-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Script to load Header/Footer and Page Logic -->
    <script>
        // --- Load Header and Footer ---
        async function loadComponent(url, placeholderId) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}: ${response.statusText}`);
                const text = await response.text();
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = text;
                }
            } catch (error) {
                console.error(`Error loading component from ${url}:`, error);
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = `<p class="text-red-500 text-center">Error loading component.</p>`;
                }
            }
        }

        async function initializeLayout() {
            await Promise.all([
                loadComponent('assets/header.html', 'header-placeholder'),
                loadComponent('assets/footer.html', 'footer-placeholder')
            ]);
            lucide.createIcons(); // Re-render icons after loading components

            // --- Set Active Footer Link ---
            const currentPage = 'social'; // Set this page as active
            const navLinks = document.querySelectorAll('#mobile-footer-nav .nav-link');
            navLinks.forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // --- Initialize Page Specific JS ---
            initializeSocialPage();
        }
        // --- End Load Header and Footer ---

        // --- Original script from social.html (wrapped, profile logic removed) ---
        function initializeSocialPage() {
             // --- UI ELEMENT DEFINITIONS ---
            const ui = {
                tabs: document.querySelectorAll('.tab-btn'),
                panels: document.querySelectorAll('.tab-panel'),
                filterBtns: document.querySelectorAll('[data-filter]')
            };

            let currentFilter = 'all';

            // --- FRIENDS TAB FUNCTIONS ---
            function loadFriendsTab() {
                loadRecentImports();
                loadYourShares();
            }

            function loadRecentImports() {
                const importHistory = JSON.parse(localStorage.getItem('fitTrackAI_importHistory') || '[]');
                const container = document.getElementById('recent-imports-list');

                if (importHistory.length === 0) {
                    container.innerHTML = '<p class="text-secondary-text text-center py-8">You haven\'t imported any shared content yet. Get a share code from a friend!</p>';
                    return;
                }

                container.innerHTML = importHistory.slice(0, 10).map(item => {
                    const timeAgo = getTimeAgo(item.importedAt);
                    const badgeColor = item.itemType === 'workout' ? 'bg-blue-500' : 'bg-green-500';
                    return `
                        <div class="p-4 bg-input-bg rounded-lg border border-border-color">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <p class="font-medium">@${item.username}</p>
                                        <span class="text-xs ${badgeColor} text-white rounded-full px-2 py-0.5">${item.itemType === 'workout' ? 'Workout' : 'Recipe'}</span>
                                    </div>
                                    <p class="text-sm text-secondary-text">${item.itemName}</p>
                                    <p class="text-xs text-secondary-text mt-1">${timeAgo}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async function loadYourShares() {
                const username = localStorage.getItem('fitTrackAI_userUsername');
                const container = document.getElementById('your-shares-list');

                if (!username) {
                    container.innerHTML = '<p class="text-secondary-text text-center py-8">Set your username in Settings to start sharing!</p>';
                    return;
                }

                try {
                    // Query workouts
                    const workoutsSnapshot = await db.collection('shared_workouts')
                        .where('sharedBy', '==', username)
                        .orderBy('sharedAt', 'desc')
                        .limit(10)
                        .get();

                    // Query recipes
                    const recipesSnapshot = await db.collection('shared_recipes')
                        .where('sharedBy', '==', username)
                        .orderBy('sharedAt', 'desc')
                        .limit(10)
                        .get();

                    const shares = [];
                    workoutsSnapshot.forEach(doc => shares.push({ ...doc.data(), type: 'workout' }));
                    recipesSnapshot.forEach(doc => shares.push({ ...doc.data(), type: 'recipe' }));

                    // Sort by date
                    shares.sort((a, b) => b.sharedAt.toMillis() - a.sharedAt.toMillis());

                    if (shares.length === 0) {
                        container.innerHTML = '<p class="text-secondary-text text-center py-8">You haven\'t shared anything yet</p>';
                        return;
                    }

                    container.innerHTML = shares.slice(0, 10).map(share => {
                        const name = share.type === 'workout' ? share.workoutPlan.name : share.recipe.name;
                        const timeAgo = getTimeAgo(share.sharedAt.toMillis());
                        const badgeColor = share.type === 'workout' ? 'bg-blue-500' : 'bg-green-500';
                        return `
                            <div class="p-4 bg-input-bg rounded-lg border border-border-color">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <p class="font-medium">${name}</p>
                                            <span class="text-xs ${badgeColor} text-white rounded-full px-2 py-0.5">${share.type === 'workout' ? 'Workout' : 'Recipe'}</span>
                                        </div>
                                        <p class="text-sm text-secondary-text">Code: <span class="font-mono font-bold">${share.code}</span></p>
                                        <p class="text-xs text-secondary-text mt-1">${timeAgo}</p>
                                    </div>
                                    <button class="btn btn-secondary !px-3 !py-1 text-sm copy-share-code" data-code="${share.code}">
                                        <i data-lucide="copy" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    lucide.createIcons();

                    // Add event listeners for copy buttons
                    document.querySelectorAll('.copy-share-code').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const code = btn.dataset.code;
                            navigator.clipboard.writeText(code).then(() => {
                                btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i>';
                                lucide.createIcons();
                                setTimeout(() => {
                                    btn.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i>';
                                    lucide.createIcons();
                                }, 2000);
                            });
                        });
                    });

                } catch (error) {
                    console.error('Error loading shares:', error);
                    container.innerHTML = '<p class="text-red-400 text-center py-8">Unable to load. Check your connection.</p>';
                }
            }

            // --- COMMUNITY TAB FUNCTIONS ---
            async function loadCommunityTab(filter = 'all') {
                const container = document.getElementById('community-feed');
                container.innerHTML = '<div class="col-span-full text-center py-8"><div class="loader mx-auto"></div></div>';

                try {
                    let allItems = [];

                    // Fetch workouts if needed
                    if (filter === 'all' || filter === 'workout') {
                        const workoutsSnapshot = await db.collection('shared_workouts')
                            .orderBy('sharedAt', 'desc')
                            .limit(20)
                            .get();
                        workoutsSnapshot.forEach(doc => allItems.push({ ...doc.data(), itemType: 'workout' }));
                    }

                    // Fetch recipes if needed
                    if (filter === 'all' || filter === 'recipe') {
                        const recipesSnapshot = await db.collection('shared_recipes')
                            .orderBy('sharedAt', 'desc')
                            .limit(20)
                            .get();
                        recipesSnapshot.forEach(doc => allItems.push({ ...doc.data(), itemType: 'recipe' }));
                    }

                    // Sort by date
                    allItems.sort((a, b) => b.sharedAt.toMillis() - a.sharedAt.toMillis());
                    allItems = allItems.slice(0, 20);

                    if (allItems.length === 0) {
                        container.innerHTML = '<p class="text-secondary-text col-span-full text-center py-8">No shared items yet. Be the first to share!</p>';
                        return;
                    }

                    container.innerHTML = allItems.map(item => {
                        const isWorkout = item.itemType === 'workout';
                        const name = isWorkout ? item.workoutPlan.name : item.recipe.name;
                        const timeAgo = getTimeAgo(item.sharedAt.toMillis());
                        const badgeColor = isWorkout ? 'bg-blue-500' : 'bg-green-500';

                        let preview = '';
                        if (isWorkout) {
                            const daysPerWeek = Object.values(item.workoutPlan.schedule || {}).filter(d => d !== 'Rest').length;
                            let totalExercises = 0;
                            if (item.workoutPlan.workouts) {
                                item.workoutPlan.workouts.forEach(w => {
                                    if (w.exercises) totalExercises += w.exercises.length;
                                });
                            }
                            preview = `${daysPerWeek} days/week â€¢ ${totalExercises} exercises`;
                        } else {
                            const calories = item.recipe.calories || 0;
                            const protein = item.recipe.protein || 0;
                            const numIngredients = item.recipe.ingredients ? item.recipe.ingredients.length : 0;
                            preview = `${calories.toFixed(0)}cal â€¢ ${protein.toFixed(0)}g protein â€¢ ${numIngredients} ingredients`;
                        }

                        return `
                            <div class="p-4 bg-input-bg rounded-lg border border-border-color">
                                <div class="mb-3">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="font-bold text-lg">${name}</h3>
                                        <span class="text-xs ${badgeColor} text-white rounded-full px-2 py-0.5">${isWorkout ? 'Workout' : 'Recipe'}</span>
                                    </div>
                                    <p class="text-sm text-secondary-text">by @${item.sharedBy}</p>
                                    <p class="text-sm text-secondary-text mt-1">${preview}</p>
                                    <p class="text-xs text-secondary-text mt-2">${timeAgo}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm font-mono font-bold flex-1">${item.code}</p>
                                    <button class="btn btn-primary !px-3 !py-2 text-sm quick-import-btn" data-code="${item.code}" data-type="${item.itemType}">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                        Import
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    lucide.createIcons();

                    // Add event listeners for quick import
                    document.querySelectorAll('.quick-import-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const code = btn.dataset.code;
                            const type = btn.dataset.type;
                            if (confirm(`Import this ${type}?`)) {
                                if (type === 'workout') {
                                    window.location.href = `workouts.html?importCode=${code}`;
                                } else {
                                    window.location.href = `nutrition.html?importCode=${code}`;
                                }
                            }
                        });
                    });

                } catch (error) {
                    console.error('Error loading community feed:', error);
                    container.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">Unable to load. Check your connection. <button class="btn btn-secondary ml-2" onclick="location.reload()">Retry</button></p>';
                }
            }

            // --- ACHIEVEMENTS TAB FUNCTIONS ---
            function loadAchievementsTab() {
                const achievements = calculateAchievements();
                const container = document.getElementById('achievements-list');

                if (!achievements || achievements.length === 0) {
                    container.innerHTML = '<p class="text-secondary-text col-span-full text-center py-8">Start logging workouts to earn achievements!</p>';
                    return;
                }

                container.innerHTML = achievements.map(achievement => {
                    const progress = Math.min(100, (achievement.current / achievement.nextMilestone) * 100);
                    return `
                        <div class="p-4 bg-input-bg rounded-lg border border-border-color">
                            <div class="flex items-start gap-4">
                                <div class="text-4xl">${achievement.icon}</div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg mb-1">${achievement.title}</h3>
                                    <p class="text-sm text-secondary-text mb-3">${achievement.description}</p>
                                    <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                                        <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                                    </div>
                                    <p class="text-xs text-secondary-text">Next: ${achievement.nextMilestone}</p>
                                    ${achievement.unlockedMilestones.length > 0 ? `
                                        <div class="flex gap-1 mt-2">
                                            ${achievement.unlockedMilestones.map(m => `<span class="text-xs bg-green-600 text-white rounded px-2 py-0.5">${m}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function calculateAchievements() {
                const workoutHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutHistory') || '[]');
                const allDailyLogs = JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs') || '{}');
                const goals = JSON.parse(localStorage.getItem('fitTrackAI_goals') || '{}');

                const achievements = [];

                // Workout Streak
                const streakData = calculateWorkoutStreak(workoutHistory);
                const streakMilestones = [3, 7, 14, 30, 60, 100];
                const nextStreakMilestone = streakMilestones.find(m => m > streakData.current) || streakMilestones[streakMilestones.length - 1];
                achievements.push({
                    icon: 'ðŸ”¥',
                    title: 'Workout Streak',
                    description: `Current: ${streakData.current} days â€¢ Best: ${streakData.best} days`,
                    current: streakData.current,
                    nextMilestone: nextStreakMilestone,
                    unlockedMilestones: streakMilestones.filter(m => m <= streakData.best)
                });

                // Total Workouts
                const totalWorkouts = workoutHistory.length;
                const workoutMilestones = [10, 25, 50, 100, 250, 500];
                const nextWorkoutMilestone = workoutMilestones.find(m => m > totalWorkouts) || workoutMilestones[workoutMilestones.length - 1];
                achievements.push({
                    icon: 'ðŸ’ª',
                    title: 'Total Workouts',
                    description: `Completed ${totalWorkouts} workouts`,
                    current: totalWorkouts,
                    nextMilestone: nextWorkoutMilestone,
                    unlockedMilestones: workoutMilestones.filter(m => m <= totalWorkouts)
                });

                // Nutrition Tracking
                const nutritionDays = Object.keys(allDailyLogs).length;
                const nutritionMilestones = [7, 14, 30, 60, 100];
                const nextNutritionMilestone = nutritionMilestones.find(m => m > nutritionDays) || nutritionMilestones[nutritionMilestones.length - 1];
                achievements.push({
                    icon: 'ðŸ¥—',
                    title: 'Nutrition Tracking',
                    description: `Logged nutrition for ${nutritionDays} days`,
                    current: nutritionDays,
                    nextMilestone: nextNutritionMilestone,
                    unlockedMilestones: nutritionMilestones.filter(m => m <= nutritionDays)
                });

                return achievements;
            }

            function calculateWorkoutStreak(history) {
                if (history.length === 0) return { current: 0, best: 0 };

                const dates = history.map(w => new Date(w.date).toDateString()).sort();
                let current = 0;
                let best = 0;
                let streak = 1;

                for (let i = 1; i < dates.length; i++) {
                    const prevDate = new Date(dates[i - 1]);
                    const currDate = new Date(dates[i]);
                    const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));

                    if (diffDays === 1) {
                        streak++;
                    } else if (diffDays > 1) {
                        best = Math.max(best, streak);
                        streak = 1;
                    }
                }
                best = Math.max(best, streak);

                // Calculate current streak
                if (dates.length > 0) {
                    const lastDate = new Date(dates[dates.length - 1]);
                    const today = new Date();
                    const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                    current = diffDays <= 1 ? streak : 0;
                }

                return { current, best };
            }

            // --- HELPER FUNCTIONS ---
            function getTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            }

            // --- TABBING LOGIC ---
            function showTab(tabName) {
                ui.panels.forEach(panel => { panel.classList.remove('active'); panel.style.display = 'none'; });
                ui.tabs.forEach(tab => { tab.classList.remove('active'); });
                const activePanel = document.getElementById(tabName + '-panel');
                const activeTab = document.getElementById(tabName + '-tab');
                if (activePanel) { activePanel.classList.add('active'); activePanel.style.display = 'block'; }
                if (activeTab) { activeTab.classList.add('active'); }

                // Load data when tab is shown
                if (tabName === 'friends') {
                    loadFriendsTab();
                } else if (tabName === 'community') {
                    loadCommunityTab(currentFilter);
                } else if (tabName === 'achievements') {
                    loadAchievementsTab();
                }
            }

            // --- EVENT LISTENERS ---
            ui.tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.tab;
                    showTab(tabName);
                });
            });

            // Community filter buttons
            ui.filterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentFilter = e.currentTarget.dataset.filter;
                    ui.filterBtns.forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    loadCommunityTab(currentFilter);
                });
            });

            // --- INITIALIZATION ---
            showTab('friends'); // Show friends tab by default and load data
            // Lucide icons are now rendered in initializeLayout
        }
        // --- End Original script ---

        // Initialize layout and page logic on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeLayout);
    </script>
</body>
</html>