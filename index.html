<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kowbi | Home</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Link Shared CSS -->
    <link rel="stylesheet" href="assets/styles.css">
    <!-- Page Specific Styles (if any) -->
    <style>
        /* ADDED: Prevent the whole page body from sliding */
        body {
            overflow-x: hidden;
        }
        /* Styles for the new carousel */
        .carousel-track {
            display: flex;
            /* MODIFIED: removed transition, will be handled by JS */
        }
        .carousel-slide {
            width: 100%;
            flex-shrink: 0;
            height: 100%;
        }
        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: background-color 0.3s ease;
        }
        .carousel-dot.active {
            background-color: var(--accent);
        }
        /* Ensure clickable card styles don't add unwanted transforms */
        .clickable-card-slide {
             transition: background-color 0.2s ease; /* Keep hover effect */
        }
        .clickable-card-slide:hover {
            background-color: var(--input-bg);
        }
        /* ADDED: Improve touch swipe behavior on the carousel */
        #summary-carousel-container {
            touch-action: pan-y;
            cursor: grab; /* Add grab cursor for desktop */
        }
        #summary-carousel-container:active {
            cursor: grabbing; /* Show grabbing cursor when dragging */
        }
    </style>
</head>
<body class="antialiased">

    <!-- Theme script (should be early) -->
    <script>
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <div class="container mx-auto max-w-7xl px-4 py-6">

        <!-- Header Placeholder -->
        <div id="header-placeholder"></div>

        <!-- Main content -->
        <main class="space-y-8">
            <div class="text-center">
                <h2 class="text-4xl font-bold">Welcome Back!</h2>
                <p class="text-lg text-secondary-text mt-2">Here's a quick summary of your progress.</p>
            </div>

            <!-- MODIFIED: Replaced the 3 summary cards with a carousel -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                
                <!-- START: New Carousel Container -->
                <!-- This single carousel item replaces the original three cards -->
                <!-- It spans 2 columns on medium screens and 3 on large screens to fill the row -->
                <div id="summary-carousel-container" class="md:col-span-2 lg:col-span-3 content-card relative overflow-hidden min-h-[210px] !p-0">
                    
                    <!-- Carousel Track -->
                    <div id="summary-carousel-track" class="flex h-full">
                        
                        <!-- Slide 1: Nutrition -->
                        <div class="carousel-slide">
                            <!-- Make the slide itself the link -->
                            <a href="nutrition.html" class="block h-full p-6 md:p-8 clickable-card-slide">
                                <h3 class="text-2xl font-bold mb-4">Nutrition at a Glance</h3>
                                <div class="flex items-center gap-6">
                                    <div class="w-24 h-24 flex-shrink-0">
                                        <!-- This canvas MUST be initialized after the page loads -->
                                        <canvas id="macro-chart-summary"></canvas>
                                    </div>
                                    <div class="w-full grid grid-cols-1 gap-y-2 text-sm">
                                        <div class="flex justify-between items-baseline"><span class="text-secondary-text">Calories:</span> <span class="font-semibold"><span id="summary-current-calories">0</span> / <span id="summary-goal-calories">2000</span></span></div>
                                        <div class="flex justify-between items-baseline"><span class="text-secondary-text">Protein:</span> <span class="font-semibold"><span id="summary-current-protein">0</span> / <span id="summary-goal-protein">150</span> g</span></div>
                                        <div class="flex justify-between items-baseline"><span class="text-secondary-text">Carbs:</span> <span class="font-semibold"><span id="summary-current-carbs">0</span> / <span id="summary-goal-carbs">225</span> g</span></div>
                                        <div class="flex justify-between items-baseline"><span class="text-secondary-text">Fat:</span> <span class="font-semibold"><span id="summary-current-fat">0</span> / <span id="summary-goal-fat">60</span> g</span></div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Slide 2: Workout -->
                        <div class="carousel-slide">
                            <a href="workouts.html" class="block h-full p-6 md:p-8 clickable-card-slide">
                                <h3 class="text-2xl font-bold mb-4">Today's Workout</h3>
                                <div id="workout-summary" class="text-center text-secondary-text pt-4">
                                    <p>No workout data available.</p>
                                    <span class="text-accent hover:text-accent-hover mt-4 inline-block">Log a workout</span>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Slide 3: Sleep -->
                        <div class="carousel-slide">
                            <a href="sleep.html" class="block h-full p-6 md:p-8 clickable-card-slide">
                                <h3 class="text-2xl font-bold mb-4">Last Night's Sleep</h3>
                                <div id="sleep-summary" class="text-center text-secondary-text pt-4">
                                    <p>No sleep data available.</p>
                                    <span class="text-accent hover:text-accent-hover mt-4 inline-block">Log your sleep</span>
                                </div>
                            </a>
                        </div>

                    </div>

                    <!-- Desktop Buttons (Hidden on mobile) - REMOVED -->
                    
                    <!-- Mobile Dots (NOW SHOWN ON ALL SIZES) -->
                    <div id="carousel-dots-container" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10">
                        <!-- Dots will be added by JS -->
                    </div>
                </div>
                <!-- END: New Carousel Container -->

            </div>

            <!-- NEW: Quick Actions Card -->
            <div id="quick-actions-card" class="content-card">
                <h3 class="text-2xl font-semibold mb-4">Quick Actions</h3>
                <div class="grid grid-cols-3 gap-4">
                    <button id="quick-log-water-btn" class="btn btn-secondary !p-3 sm:!p-4 flex flex-col items-center justify-center gap-2 h-24 sm:h-28 text-center">
                        <i data-lucide="glass-water" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                        <span class="text-xs sm:text-sm">Log Water</span>
                    </button>
                    <a href="assets/nutrition/scan-combined.html" class="btn btn-secondary !p-3 sm:!p-4 flex flex-col items-center justify-center gap-2 h-24 sm:h-28 text-center">
                        <i data-lucide="scan-line" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                        <span class="text-xs sm:text-sm">Scan Food</span>
                    </a>
                    <!-- **** MODIFIED THIS LINE **** -->
                    <a href="assets/nutrition/ai-macro-swap.html" id="quick-macro-swap-btn" class="btn btn-secondary !p-3 sm:!p-4 flex flex-col items-center justify-center gap-2 h-24 sm:h-28 text-center">
                        <i data-lucide="replace" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                        <span class="text-xs sm:text-sm">Macro Swap</span>
                    </a>
                </div>
                <p id="quick-action-feedback" class="text-sm h-5 text-center mt-4 text-green-400"></p>
            </div>

            <!-- Daily Check-in Card (MOVED HERE) -->
            <div id="daily-check-in-card" class="content-card">
                <h3 class="text-2xl font-semibold mb-4">Daily Check-in</h3>
                <p class="text-sm text-secondary-text mb-4">Log your weight for today.</p>
                <form id="check-in-form" class="flex flex-col gap-4"> <!-- Simplified layout -->
                    <input type="number" step="0.1" id="check-in-weight" placeholder="Current weight (kg)" class="form-input w-full" required>
                    <!-- SMM input removed -->
                    <button type="submit" id="check-in-btn" class="btn btn-primary w-full"> <!-- Full width button -->
                        <span class="btn-text">Check In</span>
                        <div class="loader hidden"></div>
                    </button>
                </form>
                <div id="check-in-feedback" class="mt-4 text-sm h-5 text-center"></div>
            </div>
            <!-- END Daily Check-in Card -->

             <div class="content-card">
                <h3 class="text-2xl font-bold mb-4">Weekly Progress (Weight & Calories)</h3>
                 <div class="h-64">
                    <canvas id="weekly-progress-chart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Script to load Header/Footer and Page Logic -->
    <script>
        // --- Load Header and Footer ---
        async function loadComponent(url, placeholderId) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}: ${response.statusText}`);
                const text = await response.text();
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = text;
                }
            } catch (error) {
                console.error(`Error loading component from ${url}:`, error);
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = `<p class="text-red-500 text-center">Error loading component.</p>`;
                }
            }
        }

        async function initializeLayout() {
            await Promise.all([
                loadComponent('assets/header.html', 'header-placeholder'),
                loadComponent('assets/footer.html', 'footer-placeholder')
            ]);
            lucide.createIcons(); // Re-render icons after loading components

            // --- Set Active Footer Link ---
            const currentPage = 'index'; // Change this for each page (e.g., 'nutrition', 'workouts')
            const navLinks = document.querySelectorAll('#mobile-footer-nav .nav-link');
            navLinks.forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // --- Initialize Page Specific JS ---
            initializeIndexPage();
        }
        // --- End Load Header and Footer ---

        // --- Original script from index.html (wrapped in a function) ---
        function initializeIndexPage() {
            // --- STATE MANAGEMENT ---
            let appData = {};
            let chartTextColor, chartGridColor;
            let carouselInterval = null; // For auto-cycling

            // --- CHART.JS SETUP ---
            function updateChartThemeColors() {
                chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-text').trim();
                chartGridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                Chart.defaults.color = chartTextColor;
            }
            updateChartThemeColors(); // Call it once to set initial colors


            const macroCtx = document.getElementById('macro-chart-summary').getContext('2d');
            const macroChart = new Chart(macroCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Protein', 'Carbs', 'Fat'],
                    datasets: [{
                        data: [1, 1, 1],
                        backgroundColor: ['#3b82f6', '#10b981', '#ef4444'],
                        borderColor: 'var(--card-bg)', // Use CSS var
                        borderWidth: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) label += context.parsed.toFixed(1) + 'g';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            const weeklyCtx = document.getElementById('weekly-progress-chart').getContext('2d');
            const weeklyProgressChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Calories', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', yAxisID: 'y', tension: 0.3, fill: true, },
                        { label: 'Weight (kg)', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)', yAxisID: 'y1', tension: 0.3, }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', ticks: { color: chartTextColor }, grid: { color: chartGridColor } },
                        y1: { type: 'linear', display: true, position: 'right', ticks: { color: chartTextColor }, grid: { drawOnChartArea: false }, },
                        x: { ticks: { color: chartTextColor }, grid: { color: chartGridColor } }
                    },
                    plugins: { legend: { labels: { color: chartTextColor } } }
                }
            });

            // --- START: RE-WRITTEN CAROUSEL LOGIC (NO CLONES) ---
            function setupSummaryCarousel() {
                const container = document.getElementById('summary-carousel-container');
                const track = document.getElementById('summary-carousel-track');
                const dotsContainer = document.getElementById('carousel-dots-container');

                if (!container || !track || !dotsContainer) {
                    console.error('Carousel elements not found!');
                    return;
                }

                // --- NO CLONING ---
                let slides = Array.from(track.children);
                let totalSlides = slides.length; // This is the original number (3)

                let currentIndex = 0; // Start at the *real* first slide (index 0)
                let isDragging = false;
                let dragStartX = 0;
                let dragDeltaX = 0;
                let wasDragging = false; 

                // Create dots for the original number of slides
                dotsContainer.innerHTML = '';
                for (let i = 0; i < totalSlides; i++) {
                    const dot = document.createElement('button');
                    dot.className = 'carousel-dot';
                    dot.dataset.index = i;
                    dotsContainer.appendChild(dot);
                }
                const dots = Array.from(dotsContainer.children);

                function updateDots(index) {
                    // index is already 0, 1, or 2
                    dots.forEach((dot, i) => {
                        dot.classList.toggle('active', i === index);
                    });
                }

                function goToSlide(index, isProgrammatic = false, isInitial = false) {
                    // Set transition style
                    track.style.transition = isInitial ? 'none' : 'transform 0.3s ease-in-out';
                    // Move the track
                    track.style.transform = `translateX(-${index * 100}%)`;
                    currentIndex = index;
                    updateDots(index);
                    
                    if (!isProgrammatic) {
                        startAutoCycle();
                    }
                }

                // --- REMOVED: Transition End Listener ---

                function nextSlide(isProgrammatic = false) {
                    let newIndex = currentIndex + 1;
                    if (newIndex >= totalSlides) {
                        newIndex = 0; // Loop back to start
                    }
                    goToSlide(newIndex, isProgrammatic);
                }

                function prevSlide() {
                    let newIndex = currentIndex - 1;
                    if (newIndex < 0) {
                        newIndex = totalSlides - 1; // Loop to end
                    }
                    goToSlide(newIndex);
                }

                function startAutoCycle() {
                    clearInterval(carouselInterval);
                    carouselInterval = setInterval(() => nextSlide(true), 3000);
                }

                // --- MODIFIED: Combined Drag/Swipe Handlers ---
                function dragStart(e) {
                    if (e.type === 'mousedown') {
                        e.preventDefault(); // Prevent browser image drag, etc.
                    }
                    isDragging = true;
                    dragStartX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    clearInterval(carouselInterval); // Pause on touch/click
                    track.style.transition = 'none'; // Disable transition for fluid drag
                    container.style.cursor = 'grabbing';
                    wasDragging = false; // <-- RESET FLAG ON NEW DRAG
                }

                function dragMove(e) {
                    if (!isDragging) return;
                    e.preventDefault(); // Prevent page scroll/text selection
                    const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    dragDeltaX = currentX - dragStartX;
                    
                    if (Math.abs(dragDeltaX) > 10) {
                        wasDragging = true;
                    }

                    // Move the track with the finger/mouse
                    track.style.transform = `translateX(calc(-${currentIndex * 100}% + ${dragDeltaX}px))`;
                }

                function dragEnd() {
                    if (!isDragging) return;
                    isDragging = false;
                    container.style.cursor = 'grab';
                    track.style.transition = 'transform 0.3s ease-in-out'; // Re-enable animation

                    // Check for swipe and loop
                    if (dragDeltaX < -50) { // Swipe left
                        let newIndex = currentIndex + 1;
                        if (newIndex >= totalSlides) newIndex = 0; // Loop to start
                        goToSlide(newIndex);
                    } else if (dragDeltaX > 50) { // Swipe right
                        let newIndex = currentIndex - 1;
                        if (newIndex < 0) newIndex = totalSlides - 1; // Loop to end
                        goToSlide(newIndex);
                    } else {
                        // No swipe, snap back to current slide
                        goToSlide(currentIndex);
                    }
                    
                    dragDeltaX = 0; // Reset delta
                    
                    // Reset wasDragging flag after a tiny delay
                    setTimeout(() => {
                        wasDragging = false;
                    }, 0);
                }
                
                // Event Listeners
                dotsContainer.addEventListener('click', (e) => {
                    const dot = e.target.closest('.carousel-dot');
                    if (dot) {
                        // Use index directly
                        goToSlide(parseInt(dot.dataset.index));
                    }
                });

                container.addEventListener('click', (e) => {
                    if (wasDragging) {
                        e.preventDefault(); // Stop the 'a' tag from navigating
                        e.stopPropagation(); // Stop event from bubbling further
                    }
                }, true); // Use capture phase

                // Touch Events
                container.addEventListener('touchstart', dragStart, { passive: true });
                container.addEventListener('touchmove', dragMove, { passive: false });
                container.addEventListener('touchend', dragEnd);

                // Mouse Events (for laptop swipe)
                container.addEventListener('mousedown', dragStart);
                container.addEventListener('mousemove', dragMove);
                container.addEventListener('mouseup', dragEnd);
                container.addEventListener('mouseleave', dragEnd); 


                // --- MODIFIED: Initial setup ---
                goToSlide(0, true, true); // Go to the first slide (index 0)
                startAutoCycle();
            }
            // --- END: RE-WRITTEN CAROUSEL LOGIC ---


            // --- HELPER FUNCTIONS ---
            function dateToKey(date) { return date.toISOString().split('T')[0]; }
            function getWorkoutDayType(date) {
                 const savedPlan = JSON.parse(localStorage.getItem('fitTrackAI_workoutPlan') || '{}');
                 const schedule = savedPlan.schedule || { "Monday": "Push", "Tuesday": "Pull", "Wednesday": "Legs", "Thursday": "Push", "Friday": "Pull", "Saturday": "Legs", "Sunday": "Rest" };
                 const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                 return { type: schedule[dayName] || 'Rest' };
            }
            function calculateDuration(startTime, endTime, dateStr) {
                const startDate = new Date(`${dateStr}T${startTime}`);
                const endDate = new Date(`${dateStr}T${endTime}`);
                if(endDate <= startDate) endDate.setDate(endDate.getDate() + 1);
                const durationMs = endDate - startDate;
                const durationHours = Math.floor(durationMs / (1000 * 60 * 60));
                const durationMinutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                if (durationMs < 0 || durationHours > 24) return { durationHours: 0, durationMinutes: 0 };
                return { durationHours, durationMinutes };
            }

            // --- DATA LOADING & SAVING ---
            
            // NEW: Added saveData function
            function saveData() {
                localStorage.setItem('fitTrackAI_userProfile', JSON.stringify(appData.userProfile));
                localStorage.setItem('fitTrackAI_goals', JSON.stringify(appData.goals));
                localStorage.setItem('fitTrackAI_allDailyLogs', JSON.stringify(appData.allDailyLogs));
                // We also save workout/status history, though this page doesn't modify them
                localStorage.setItem('fitTrackAI_workoutHistory', JSON.stringify(appData.workoutHistory));
                localStorage.setItem('fitTrackAI_workoutStatus', JSON.stringify(appData.workoutStatusHistory));
            }

            function loadData() {
                const todayKey = dateToKey(new Date());
                const defaultGoals = { calories: 2000, protein: 150, carbs: 225, fat: 60 };
                
                // Load all data into the appData object
                appData.allDailyLogs = JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs')) || {};
                appData.userProfile = JSON.parse(localStorage.getItem('fitTrackAI_userProfile')) || { sleepHistory: [], weightHistory: [] };
                appData.workoutHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutHistory')) || [];
                appData.workoutStatusHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutStatus')) || {};
                appData.goals = JSON.parse(localStorage.getItem('fitTrackAI_goals')) || defaultGoals;

                // Ensure arrays exist on userProfile
                if (!appData.userProfile.sleepHistory) appData.userProfile.sleepHistory = [];
                if (!appData.userProfile.weightHistory) appData.userProfile.weightHistory = [];

                const todayLogData = appData.allDailyLogs[todayKey] || { entries: [], water: 0 };
                appData.todayLog = todayLogData.entries || [];
                appData.goals = { ...defaultGoals, ...appData.goals };
            }

            // --- RENDERING FUNCTIONS ---
            function renderNutritionSummary() {
                const totals = appData.todayLog.reduce((acc, item) => ({ calories: acc.calories + (item.calories || 0), protein: acc.protein + (item.protein || 0), carbs: acc.carbs + (item.carbs || 0), fat: acc.fat + (item.fat || 0) }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
                document.getElementById('summary-current-calories').textContent = totals.calories.toFixed(0);
                document.getElementById('summary-goal-calories').textContent = appData.goals.calories.toFixed(0);
                document.getElementById('summary-current-protein').textContent = totals.protein.toFixed(1);
                document.getElementById('summary-goal-protein').textContent = appData.goals.protein.toFixed(0);
                document.getElementById('summary-current-carbs').textContent = totals.carbs.toFixed(1);
                document.getElementById('summary-goal-carbs').textContent = appData.goals.carbs.toFixed(0);
                document.getElementById('summary-current-fat').textContent = totals.fat.toFixed(1);
                document.getElementById('summary-goal-fat').textContent = appData.goals.fat.toFixed(0);
                const macroSum = totals.protein + totals.carbs + totals.fat;
                macroChart.data.datasets[0].data = macroSum > 0 ? [totals.protein, totals.carbs, totals.fat] : [1, 1, 1];
                macroChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();
                macroChart.update();
            }

            function renderWorkoutSummary() {
                const today = new Date(); today.setHours(0,0,0,0); const todayKey = dateToKey(today);
                const dayInfo = getWorkoutDayType(today);
                const loggedExercises = appData.workoutHistory.filter(log => dateToKey(new Date(log.date)) === todayKey);
                const status = appData.workoutStatusHistory[todayKey];
                let summaryHtml = '';
                if (dayInfo.type === 'Rest') {
                    summaryHtml = `<p class="text-3xl font-bold text-green-400 mb-2">Rest Day</p><p class="text-lg font-semibold text-primary-text">Recovery is key!</p><a href="workouts.html" class="text-accent hover:text-accent-hover mt-4 inline-block">View full plan</a>`;
                } else if (loggedExercises.length > 0) {
                     const firstExercise = loggedExercises[0].name;
                     const exerciseCount = new Set(loggedExercises.map(ex => ex.name)).size;
                     const statusText = status === 'full' ? 'Complete' : (status === 'started' ? 'In Progress' : 'Logged');
                     summaryHtml = `<p class="text-3xl font-bold text-blue-400 mb-2">${dayInfo.type} (${statusText})</p><p class="text-lg font-semibold text-primary-text">Logged ${exerciseCount} exercises. Started with ${firstExercise}.</p><a href="workouts.html" class="text-accent hover:text-accent-hover mt-4 inline-block">View full log</a>`;
                } else {
                    summaryHtml = `<p class="text-lg font-semibold text-primary-text">${dayInfo.type} Scheduled</p><p>Time to hit the gym!</p><a href="workouts.html" class="text-accent hover:text-accent-hover mt-4 inline-block">Start your workout</a>`;
                }
                document.getElementById('workout-summary').innerHTML = summaryHtml;
            }

            function renderSleepSummary() {
                const sleepHistory = (appData.userProfile.sleepHistory || []).sort((a,b) => new Date(b.date) - new Date(a.date));
                const lastLog = sleepHistory[0]; let summaryHtml = '';
                if (lastLog) {
                    const { durationHours, durationMinutes } = calculateDuration(lastLog.startTime, lastLog.endTime, lastLog.date);
                    const totalMinutes = durationHours * 60 + durationMinutes;
                    if (totalMinutes <= 0) {
                         summaryHtml = `<p>No recent valid sleep data.</p><a href="sleep.html" class="text-accent hover:text-accent-hover mt-4 inline-block">Log your sleep</a>`;
                    } else {
                        const qualityText = '★'.repeat(lastLog.quality) + '☆'.repeat(5 - lastLog.quality);
                        summaryHtml = `<p class="text-3xl font-bold text-primary-text">${durationHours}h ${durationMinutes}m</p><p class="text-lg text-yellow-400 font-semibold mb-2">${qualityText}</p><a href="sleep.html" class="text-accent hover:text-accent-hover mt-4 inline-block">View details</a>`;
                    }
                } else {
                    summaryHtml = `<p>No sleep data available.</p><a href="sleep.html" class="text-accent hover:text-accent-hover mt-4 inline-block">Log your sleep</a>`;
                }
                document.getElementById('sleep-summary').innerHTML = summaryHtml;
            }

            function renderWeeklyProgressChart() {
                const daysToDisplay = 7; const labels = []; const calorieData = []; const weightData = [];
                for (let i = daysToDisplay - 1; i >= 0; i--) {
                    const date = new Date(); date.setDate(date.getDate() - i); const dateKey = dateToKey(date);
                    labels.push(date.toLocaleDateString(undefined, { weekday: 'short' }));
                    const dailyLogData = appData.allDailyLogs[dateKey] || { entries: [], water: 0 };
                    const dailyLogEntries = dailyLogData.entries || [];
                    const totalCalories = dailyLogEntries.reduce((sum, item) => sum + (item.calories || 0), 0);
                    calorieData.push(totalCalories || null);
                    // MODIFIED: Use the correct path to weightHistory
                    const historicalWeight = (appData.userProfile.weightHistory || []).filter(entry => new Date(entry.date.replace(/-/g, '/')) <= date).sort((a, b) => new Date(b.date.replace(/-/g, '/')) - new Date(a.date.replace(/-/g, '/')))[0];
                    weightData.push(historicalWeight ? historicalWeight.weight : null);
                }
                weeklyProgressChart.data.labels = labels; weeklyProgressChart.data.datasets[0].data = calorieData; weeklyProgressChart.data.datasets[1].data = weightData;
                const validCalories = calorieData.filter(d => d !== null && d > 0); const validWeights = weightData.filter(d => d !== null);
                updateChartThemeColors();
                weeklyProgressChart.options.scales.y.ticks.color = chartTextColor; weeklyProgressChart.options.scales.y.grid.color = chartGridColor;
                weeklyProgressChart.options.scales.y1.ticks.color = chartTextColor; weeklyProgressChart.options.scales.x.ticks.color = chartTextColor; weeklyProgressChart.options.scales.x.grid.color = chartGridColor; weeklyProgressChart.options.plugins.legend.labels.color = chartTextColor;
                weeklyProgressChart.options.scales.y.min = validCalories.length > 0 ? Math.min(...validCalories) * 0.9 : 0;
                weeklyProgressChart.options.scales.y1.min = validWeights.length > 0 ? Math.min(...validWeights) * 0.95 : 60;
                weeklyProgressChart.update();
            }

            function fullRender() {
                loadData();
                renderNutritionSummary();
                renderWorkoutSummary();
                renderSleepSummary();
                renderWeeklyProgressChart();
                lucide.createIcons(); // Re-run lucide after rendering summaries
            }

            // --- INITIALIZATION ---
            
            // ************ FIX ************
            // Load data and render everything FIRST
            fullRender();

            // Call setup for the carousel AFTER content is populated
            setupSummaryCarousel();
            // ************ END FIX ************

            // --- NEW: Quick Log Water Function ---
            function logQuickWater() {
                // Load data fresh just in case
                loadData(); 
                const defaultSize = appData.userProfile.waterServingSize || 250;
                const dayLog = getDayLog(new Date());
                const originalWater = dayLog.water || 0;
                dayLog.water = originalWater + defaultSize;
                
                saveData(); // Save the updated log
                fullRender(); // Re-render all summaries

                // Show feedback
                const feedbackDiv = document.getElementById('quick-action-feedback');
                if(feedbackDiv) {
                    feedbackDiv.textContent = `Logged ${defaultSize}ml water. Total: ${dayLog.water}ml.`;
                    setTimeout(() => {
                        if(feedbackDiv) feedbackDiv.textContent = '';
                    }, 2500);
                }
            }

            // --- MODIFIED: Check-in Form Listener ---
            const checkInForm = document.getElementById('check-in-form');
            if (checkInForm) {
                checkInForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const btn = document.getElementById('check-in-btn');
                    const feedbackDiv = document.getElementById('check-in-feedback');
                    const weightInput = document.getElementById('check-in-weight');
                    
                    const newWeight = parseFloat(weightInput.value);

                    if (!newWeight || newWeight <= 0) {
                        if (feedbackDiv) {
                            feedbackDiv.textContent = "Please enter a valid weight.";
                            feedbackDiv.classList.add('text-red-400');
                            feedbackDiv.classList.remove('text-green-400');
                        }
                        return;
                    }

                    // Check if profile is set up (using 'age' as a proxy, which is set in progress.html)
                    // We need to load it first. loadData() does this.
                    /* MODIFICATION: Removed this check. Users should be able to log weight without a full profile.
                    if (!appData.userProfile || !appData.userProfile.age) {
                         if (feedbackDiv) {
                            feedbackDiv.textContent = "Please set up your profile in the Progress tab first.";
                            feedbackDiv.classList.add('text-red-400');
                            feedbackDiv.classList.remove('text-green-400');
                        }
                        return;
                    }
                    */

                    if (btn) {
                        btn.disabled = true;
                        btn.querySelector('.btn-text').style.display = 'none';
                        btn.querySelector('.loader').classList.remove('hidden');
                    }

                    const today = dateToKey(new Date());

                    if (!appData.userProfile.weightHistory) {
                        appData.userProfile.weightHistory = [];
                    }

                    const todayWeightIndex = appData.userProfile.weightHistory.findIndex(entry => entry.date === today);
                    
                    if (todayWeightIndex > -1) {
                        // Update today's entry
                        appData.userProfile.weightHistory[todayWeightIndex].weight = newWeight;
                    } else {
                        // Add new entry
                        appData.userProfile.weightHistory.push({ date: today, weight: newWeight });
                    }
                    
                    // Update current weight in profile
                    appData.userProfile.weight = newWeight;

                    // Save data to localStorage
                    saveData();

                    // Give feedback
                    if (feedbackDiv) {
                        feedbackDiv.textContent = `Weight logged as ${newWeight} kg.`;
                        feedbackDiv.classList.add('text-green-400');
                        feedbackDiv.classList.remove('text-red-400');
                    }
                    weightInput.value = '';

                    // Reset button
                    if (btn) {
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.querySelector('.btn-text').style.display = 'inline';
                            btn.querySelector('.loader').classList.add('hidden');
                            if (feedbackDiv) feedbackDiv.textContent = '';
                        }, 2000);
                    }
                    
                    // Re-render charts
                    fullRender();
                });
            }
            // --- END MODIFIED Check-in ---

            // --- NEW: Quick Action Listeners ---
            const quickLogWaterBtn = document.getElementById('quick-log-water-btn');
            if (quickLogWaterBtn) {
                quickLogWaterBtn.addEventListener('click', logQuickWater);
            }


            // Dynamic Update Listener
            window.addEventListener('storage', (event) => {
                if (event.key && (event.key.startsWith('fitTrackAI_') || event.key === null)) {
                    console.log('localStorage change detected. Re-rendering dashboard.');
                    fullRender();
                }
            });

            // Theme Change Listener
            window.addEventListener('storage', (event) => {
                if (event.key === 'fitTrackAI_theme') {
                    updateChartThemeColors();
                    renderWeeklyProgressChart();
                    renderNutritionSummary();
                }
            });

            // --- START: NEW Dynamic Width Logic ---
            function matchCarouselWidth() {
                const carouselContainer = document.getElementById('summary-carousel-container');
                const checkInCard = document.getElementById('daily-check-in-card');
                
                if (carouselContainer && checkInCard) {
                    // This JS is no longer needed as the layout is fixed with grid/HTML structure
                }
            }
            
            // Run on load, after setup
            // matchCarouselWidth(); // No longer needed
            // Run on resize
            // window.addEventListener('resize', matchCarouselWidth); // No longer needed
            // --- END: NEW Dynamic Width Logic ---

        }
        // --- End Original script ---

        // Initialize layout and page logic on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeLayout);
    </script>
</body>
</html>
