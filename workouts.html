<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kowbi | workouts</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Link Shared CSS -->
    <link rel="stylesheet" href="assets/styles.css">
    <!-- Page Specific Styles (if any) -->
    <style>
        /* Add page-specific styles here if needed */
    </style>
</head>
<body class="antialiased">

    <!-- Theme script (should be early) -->
    <script>
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <div class="container mx-auto max-w-7xl px-4 py-6">

        <!-- Header Placeholder -->
        <div id="header-placeholder"></div>

        <main>
             <div class="flex flex-col justify-between items-center mb-8 px-2">
                    <div>
                        <h2 id="plan-main-title" class="text-2xl font-bold cursor-pointer" title="Double-tap to edit plan name">Your Workout Plan</h2>
                        <p id="plan-subtitle" class="text-gray-400 mt-1">Your personalized workout schedule.</p>
                    </div>
                </div>

            <div class="grid grid-cols-1 gap-4 sm:gap-8 grid-layout">
                <div id="day-navigation-card" class="col-span-full content-card">
                    <div id="plan-view-header" class="flex flex-row justify-between items-center gap-4">
                           <div class="flex-1">
                               <button id="day-view-date-display-btn" class="text-left hover:bg-input-bg px-4 py-2 rounded-lg transition-colors w-full">
                                   <span id="day-view-title-span" class="text-xl font-semibold block"></span>
                                   <span id="day-view-date-span" class="text-sm text-secondary-text"></span>
                               </button>
                           </div>
                         <div class="flex items-center gap-2">
                            <div id="workout-progress-container" class="w-24 h-2 bg-white rounded-full overflow-hidden" title="Workout Progress">
                                <div id="workout-progress-bar" class="h-full bg-red-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
                            </div>
                            <span id="workout-progress-text" class="text-sm font-medium text-secondary-text w-10 text-right">0/0</span>
                        </div>
                    </div>
                </div>

                <div id="plan-history-container-card" class="col-span-full content-card">
                    <div id="plan-history-grid" class="grid grid-cols-1 gap-x-8 gap-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2 border-b border-border-color pb-1">
                                <h5 class="font-semibold text-lg">Plan</h5>
                                <div class="flex items-center gap-2">
                                    <button id="edit-plan-btn" class="btn btn-secondary !p-1.5" title="Edit Current Plan"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                    <!-- Use a standard link for navigation -->
                                    <a href="assets/workouts/ai-plan-generator.html" id="ai-plan-generator-btn-inline" class="btn btn-secondary !p-1.5" title="New AI Plan"><i data-lucide="wand-2" class="w-4 h-4"></i></a>
                                    <button id="add-temporary-warmup-btn" class="btn btn-secondary !p-1.5 hidden" title="Add Warm-up for Today"><i data-lucide="sun" class="w-4 h-4"></i></button>
                                    <button id="add-temporary-exercise-btn" class="btn btn-secondary !p-1.5 hidden" title="Add Exercise for Today"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div id="workout-plan-for-day" class="space-y-2 max-h-[28rem] overflow-y-auto custom-scrollbar pr-2"></div>
                        </div>
                    </div>
                </div>

                <div class="col-span-full content-card">
                    <div class="flex flex-col justify-between items-center mb-4 gap-4">
                        <h3 class="text-xl font-semibold">Progression Chart</h3>
                        <div class="flex gap-2 flex-wrap justify-center" id="progress-range-selector">
                            <button class="btn btn-secondary !py-1 !px-3 text-xs progress-range-btn" data-range="month">1M</button>
                            <button class="btn btn-secondary !py-1 !px-3 text-xs progress-range-btn" data-range="3month">3M</button>
                            <button class="btn btn-secondary !py-1 !px-3 text-xs progress-range-btn selected-full" data-range="year">1Y</button>
                            <button class="btn btn-secondary !py-1 !px-3 text-xs progress-range-btn" data-range="all">All Time</button>
                        </div>
                        <select id="progress-exercise-select" class="w-full form-select"></select>
                    </div>
                    <div class="w-full h-80 flex items-center justify-center">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>
                 <div class="col-span-full content-card">
                        <h3 class="text-xl font-semibold mb-4 text-center">AI Coach</h3>

                        <div class="flex border-b border-border-color mb-4">
                            <button id="ai-tab-specific" class="flex-1 py-2 text-center font-semibold border-b-2 border-accent text-primary-text">Specific Advice</button>
                            <button id="ai-tab-general" class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-secondary-text">General Chat</button>
                        </div>

                        <div id="ai-panel-specific">
                            <p class="text-gray-400 text-sm mb-3 text-center">Select an exercise to get science-based advice on when to add weight or reps.</p>
                            <div class="flex flex-col gap-2">
                                <select id="ai-advice-exercise-select" class="w-full form-select">
                                    <option value="">Select an exercise...</option>
                                </select>
                                <button id="get-ai-advice-btn" class="btn btn-secondary w-full">
                                    <span class="btn-text">Get Advice</span>
                                    <div class="loader hidden ml-2"></div>
                                </button>
                            </div>
                            <div id="ai-advice-output" class="mt-4 p-3 bg-black/30 rounded-md text-sm min-h-[50px]"></div>
                        </div>

                        <div id="ai-panel-general" class="hidden text-center">
                            <p class="text-gray-400 text-sm mb-4">Ask for specific advice about your plan, or have a general chat about your training.</p>
                            <div class="bg-black/30 p-4 rounded-lg">
                                <i data-lucide="message-circle" class="w-12 h-12 text-blue-400 mx-auto mb-4"></i>
                                <button id="open-workout-chat-btn" class="btn btn-primary w-full">Chat with AI Coach</button>
                            </div>
                        </div>
                    </div>
            </div>
        </main>
    </div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Modals remain the same -->
    <div id="edit-plan-modal" class="modal-backdrop">
        <div class="modal-content !max-w-4xl custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Edit Current Plan</h2>
                <button id="close-edit-plan-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="space-y-8">
                 <div>
                        <h3 class="font-bold text-lg text-blue-400 mb-2">Weekly Schedule</h3>
                        <p class="text-sm text-secondary-text mb-4">Tap a day to cycle through your available workout types. This changes when you do each workout.</p>
                        <div id="edit-plan-schedule-builder" class="grid grid-cols-2 gap-2"></div>
                 </div>
                 <div>
                    <h3 class="font-bold text-lg text-blue-400 mb-2">Manage Warmups</h3>
                    <p class="text-sm text-secondary-text mb-4">Select a workout type to manage its warm-up routine.</p>
                    <div class="flex flex-col gap-2 items-center mb-4">
                         <select id="edit-plan-warmup-day-type-select" class="form-select"></select>
                         <button id="edit-plan-add-warmup-btn" class="btn btn-secondary w-full">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                             <span>Add Warmup</span>
                         </button>
                    </div>
                    <div id="edit-plan-warmup-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2 border border-border-color p-2 rounded-lg min-h-[100px]">
                    </div>
                 </div>
                <div>
                    <h3 class="font-bold text-lg text-blue-400 mb-2">Manage Workouts</h3>
                    <p class="text-sm text-secondary-text mb-4">Select a workout type to add, remove, or reorder its exercises.</p>
                    <div class="flex flex-col gap-2 items-center mb-4">
                        <select id="edit-plan-day-type-select" class="form-select"></select>
                        <button id="edit-plan-add-exercise-btn" class="btn btn-secondary w-full">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Add Exercise</span>
                        </button>
                    </div>
                    <div id="edit-plan-exercise-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2 border border-border-color p-2 rounded-lg min-h-[100px]">
                    </div>
                </div>
                <button id="save-plan-edits-btn" class="btn btn-primary w-full">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="custom-exercise-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 id="custom-exercise-modal-title" class="text-xl font-bold">Add Custom Exercise</h2><button id="close-custom-exercise-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div id="custom-exercise-initial-choice" class="flex gap-4"><button id="custom-exercise-ai-choice-btn" class="btn btn-primary w-full"><i data-lucide="sparkles"></i>Use AI</button><button id="custom-exercise-manual-choice-btn" class="btn btn-secondary w-full"><i data-lucide="edit-3"></i>Manual</button></div><form id="custom-exercise-form" class="hidden space-y-4 mt-4"><div><label for="custom-exercise-name" class="form-label">Exercise Name *</label><div class="flex gap-2"><input type="text" id="custom-exercise-name" class="form-input" required placeholder="e.g., Kneeling Landmine Press"><button type="button" id="ai-generate-exercise-details-btn" class="btn btn-secondary !px-3 hidden"><i data-lucide="sparkles"></i></button></div></div><div id="custom-exercise-details-container" class="space-y-4 pt-4 border-t border-border-color"><div class="w-full aspect-video bg-black rounded-lg flex items-center justify-center overflow-hidden border border-border-color relative"><div id="custom-exercise-img-loader" class="loader hidden"></div><div id="custom-exercise-media-container" class="w-full h-full"><img id="custom-exercise-img" src="" class="w-full h-full object-cover hidden"></div></div><div class="grid grid-cols-2 gap-2"><label for="custom-img-upload" class="btn btn-secondary !py-1 text-xs cursor-pointer">Upload Image<input type="file" id="custom-img-upload" class="hidden" accept="image/*"></label><input type="url" id="custom-img-url" class="form-input !py-1 text-xs" placeholder="Or paste image/video URL"></div><div><label for="custom-exercise-instructions" class="form-label">Instructions</label><textarea id="custom-exercise-instructions" rows="5" class="form-input mt-1"></textarea></div><div><label for="custom-exercise-rep-range" class="form-label">Rep Range</label><input type="text" id="custom-exercise-rep-range" class="form-input mt-1"></div><div class="grid grid-cols-2 gap-4"><div><label for="custom-exercise-group" class="form-label">Muscle Group</label><select id="custom-exercise-group" class="form-select mt-1"></select></div><div><label for="custom-exercise-type" class="form-label">Equipment</label><select id="custom-exercise-type" class="form-select mt-1"></select></div></div><div id="custom-exercise-action-buttons" class="flex flex-col gap-2 pt-2"></div></div></form></div></div>
    <div id="exercise-detail-modal" class="modal-backdrop"><div class="modal-content !max-w-xl custom-scrollbar"><div class="flex justify-between items-center mb-4"><h2 id="exercise-detail-title" class="text-xl font-bold">Exercise Details</h2><button id="close-exercise-detail-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="space-y-4"><div class="w-full aspect-video bg-black rounded-lg flex items-center justify-center overflow-hidden border border-gray-800 relative"><div id="exercise-media-loader" class="loader hidden"></div><div id="exercise-media-container" class="w-full h-full bg-no-repeat bg-cover bg-center"></div></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Instructions</h3><textarea id="exercise-detail-instructions" class="form-input mt-1 w-full bg-input-bg text-sm transition-colors" disabled style="resize: none; overflow-y: hidden;"></textarea><button id="save-instructions-btn" class="mt-2 w-full btn btn-secondary">Edit Instructions</button></div><div class="grid grid-cols-2 gap-4"><div><h3 class="font-bold text-lg text-blue-400 mb-2">Sets</h3><p id="exercise-detail-sets" class="text-gray-300"></p></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Rep Range</h3><p id="exercise-detail-rep-range" class="text-gray-300"></p></div></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Personal Notes & Advice</h3><textarea id="exercise-detail-notes" rows="4" class="form-input mt-1" placeholder="Add your personal cues, weight progression goals, etc."></textarea><button id="save-exercise-notes-btn" class="mt-2 w-full btn btn-secondary">Save Notes</button></div><button id="log-from-detail-btn" class="w-full btn btn-primary mt-4">Log This Exercise</button></div></div></div>
    <div id="warmup-manage-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 id="warmup-form-title" class="text-xl font-bold">Manage Warm-up</h2><button id="close-warmup-manage-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="warmup-form" class="space-y-3"><div><label for="warmup-name" class="form-label">Name</label><input type="text" id="warmup-name" class="form-input mt-1" required></div><div><label for="warmup-instructions" class="form-label">Instructions (one per line)</label><textarea id="warmup-instructions" rows="4" class="form-input mt-1"></textarea></div><button type="submit" id="save-warmup-btn" class="w-full btn btn-primary">Add Warm-up</button></form></div></div>
    <div id="workout-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-xl font-bold">Log Exercise</h2><div class="flex items-center gap-1 border border-border-color rounded-lg p-1"><button type="button" id="unit-toggle-kg" class="btn !py-1 !px-3 text-sm unit-toggle-btn">kg</button><button type="button" id="unit-toggle-lbs" class="btn !py-1 !px-3 text-sm unit-toggle-btn">lbs</button></div><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="workout-log-form"><div class="space-y-4"><div id="sets-container"></div><button type="button" id="add-set-btn" class="w-full btn btn-secondary">Add Set</button><button type="submit" id="save-workout-btn" class="w-full btn btn-primary mt-2">Save Workout</button></div></form></div></div>
    <div id="exercise-library-modal" class="modal-backdrop"><div class="modal-content !max-w-2xl"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold" id="exercise-library-title">Exercise Library</h2><button id="close-exercise-library-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="flex flex-wrap gap-2 mb-4"><input type="search" id="exercise-library-search" class="form-input flex-grow" placeholder="Search..."><select id="exercise-library-filter" class="form-select w-full"><option value="">All Muscle Groups</option></select><select id="warmup-library-filter" class="form-select w-full hidden"><option value="">All Muscle Groups</option></select><select id="exercise-library-equipment-filter" class="form-select w-full"><option value="">All Equipment</option></select><button id="create-new-exercise-from-library-btn" class="btn btn-secondary !px-3" title="Create New Exercise"><i data-lucide="plus"></i></button></div><div id="exercise-library-list" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar pr-2"></div><button id="add-selected-exercises-btn" class="btn btn-primary w-full mt-4">Add Selected</button></div></div>
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button></div></div></div>
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2><p id="alert-modal-text" class="text-gray-300 mb-6"></p><div class="flex justify-end"><button id="alert-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    <div id="permanent-edit-warning-modal" class="modal-backdrop"><div class="modal-content"><h2 class="text-xl font-bold mb-4">Permanent Edits</h2><p class="text-gray-300 mb-6">To permanently edit an exercise's details (like instructions or name), please use the "Edit Current Plan" section or manage it in the Exercise Library. Swiping here only allows temporary, single-day removal.</p><div class="flex items-center mb-6"><input type="checkbox" id="permanent-edit-dont-show-again" class="form-checkbox h-4 w-4 bg-input-bg border-border-color rounded text-blue-500 focus:ring-blue-500"><label for="permanent-edit-dont-show-again" class="ml-2 text-sm text-gray-400">Don't show this again</label></div><div class="flex justify-end"><button id="permanent-edit-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    <div id="ai-workout-chat-modal" class="modal-backdrop"><div class="modal-content flex flex-col"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">AI Workout Coach</h2><button id="close-ai-workout-chat-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div id="ai-chat-history" class="flex-grow flex flex-col gap-4 overflow-y-auto custom-scrollbar pr-2 mb-4 min-h-[300px]"></div><div class="flex gap-2"><input type="text" id="ai-chat-input" class="form-input" placeholder="Ask a fitness question..."><button id="ai-chat-send-btn" class="btn btn-primary"><i data-lucide="send"></i></button></div></div></div>
    <div id="undo-toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-4 transform translate-y-20 opacity-0 z-[200]"> <span id="undo-toast-text"></span><button id="undo-toast-btn" class="font-bold text-blue-400 hover:text-blue-300">Undo</button> </div>

    <!-- Script to load Header/Footer and Page Logic -->
    <script type="module">
        // --- Load Header and Footer ---
        async function loadComponent(url, placeholderId) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}: ${response.statusText}`);
                const text = await response.text();
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = text;
                }
            } catch (error) {
                console.error(`Error loading component from ${url}:`, error);
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = `<p class="text-red-500 text-center">Error loading component.</p>`;
                }
            }
        }

        async function initializeLayout() {
            await Promise.all([
                loadComponent('assets/header.html', 'header-placeholder'),
                loadComponent('assets/footer.html', 'footer-placeholder')
            ]);
            lucide.createIcons(); // Re-render icons after loading components

            // --- Set Active Footer Link ---
            const currentPage = 'workouts'; // This should be 'workouts'
            const navLinks = document.querySelectorAll('#mobile-footer-nav .nav-link');
            navLinks.forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // --- Initialize Page Specific JS ---
            initializeWorkoutsPage();
        }
        // --- End Load Header and Footer ---

        // --- Original script from workouts.html (wrapped in a function) ---
        function initializeWorkoutsPage() {
            // --- STATE MANAGEMENT ---
            let workoutPlan = {};
            let workoutHistory = [];
            let exerciseDB = [];
            let warmups = {};
            let workoutStatusHistory = {};
            let userSettings = { unit: 'kg', showPermanentEditWarning: true };
            let workoutChatHistory = [];
            let dailyModifications = {}; // For temporary daily changes
            let lastLoggedSets = {}; // Stores the last logged weights/reps per exercise
            let currentlyLoggingExercise = null;
            let editingWorkoutLogId = null;
            let editingExerciseId = null;
            let editingWarmupIndex = null;
            let confirmCallback = null;
            let viewDate = new Date(); viewDate.setHours(0,0,0,0);
            let isLogging = false;
            let exercisePrefs = {}; // For AI plan generator (though generator modal is removed)
            let libraryModalContext = { purpose: 'add', group: '' };
            let restTimerInterval = null;
            let isAddingFromLibrary = false;
            let modalUnit = 'kg';
            let isNativeDragging = false;
            let chartRange = 'year';
            let undoTimeout = null;
            let undoCallback = null;
            let pointerDelta = { x: 0, y: 0 };
            let ALL_MUSCLE_GROUPS = [];
            let ALL_EQUIPMENT_TYPES = [];
            const ALL_SPLIT_TYPES = ['Rest', 'Push', 'Pull', 'Legs', 'Upper', 'Lower', 'Full Body'];

            // --- UI ELEMENTS ---
            const ui = {
                workoutModal: document.getElementById('workout-modal'), modalTitle: document.getElementById('modal-title'), closeModalBtn: document.getElementById('close-modal-btn'),
                workoutLogForm: document.getElementById('workout-log-form'), setsContainer: document.getElementById('sets-container'), addSetBtn: document.getElementById('add-set-btn'), saveWorkoutBtn: document.getElementById('save-workout-btn'),
                confirmModal: document.getElementById('confirm-modal'), confirmModalTitle: document.getElementById('confirm-modal-title'), confirmModalText: document.getElementById('confirm-modal-text'),
                confirmModalCancelBtn: document.getElementById('confirm-modal-cancel-btn'), confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                alertModal: document.getElementById('alert-modal'), alertModalTitle: document.getElementById('alert-modal-title'), alertModalText: document.getElementById('alert-modal-text'), alertModalOkBtn: document.getElementById('alert-modal-ok-btn'),
                exerciseLibraryModal: document.getElementById('exercise-library-modal'), closeExerciseLibraryModalBtn: document.getElementById('close-exercise-library-modal-btn'),
                exerciseLibraryTitle: document.getElementById('exercise-library-title'),
                addSelectedExercisesBtn: document.getElementById('add-selected-exercises-btn'),
                progressExerciseSelect: document.getElementById('progress-exercise-select'),
                aiAdviceExerciseSelect: document.getElementById('ai-advice-exercise-select'), getAIAdviceBtn: document.getElementById('get-ai-advice-btn'), aiAdviceOutput: document.getElementById('ai-advice-output'),
                exerciseDetailModal: document.getElementById('exercise-detail-modal'), closeExerciseDetailModalBtn: document.getElementById('close-exercise-detail-modal-btn'), exerciseDetailTitle: document.getElementById('exercise-detail-title'),
                exerciseMediaLoader: document.getElementById('exercise-media-loader'), exerciseMediaContainer: document.getElementById('exercise-media-container'),
                exerciseDetailInstructions: document.getElementById('exercise-detail-instructions'), saveInstructionsBtn: document.getElementById('save-instructions-btn'), exerciseDetailRepRange: document.getElementById('exercise-detail-rep-range'),
                exerciseDetailNotes: document.getElementById('exercise-detail-notes'), saveExerciseNotesBtn: document.getElementById('save-exercise-notes-btn'), logFromDetailBtn: document.getElementById('log-from-detail-btn'),
                dayViewDateDisplayBtn: document.getElementById('day-view-date-display-btn'),
                workoutPlanForDay: document.getElementById('workout-plan-for-day'),
                dayNavigationCard: document.getElementById('day-navigation-card'),
                aiTabSpecific: document.getElementById('ai-tab-specific'), aiTabGeneral: document.getElementById('ai-tab-general'), aiPanelSpecific: document.getElementById('ai-panel-specific'), openWorkoutChatBtn: document.getElementById('open-workout-chat-btn'),
                reorganizeAiBtn: document.getElementById('reorganize-ai-btn'),
                unitToggleKg: document.getElementById('unit-toggle-kg'), unitToggleLbs: document.getElementById('unit-toggle-lbs'),
                // AI Generator elements removed
                editPlanBtn: document.getElementById('edit-plan-btn'),
                customExerciseModal: document.getElementById('custom-exercise-modal'), closeCustomExerciseModalBtn: document.getElementById('close-custom-exercise-modal-btn'),
                customExerciseInitialChoice: document.getElementById('custom-exercise-initial-choice'), customExerciseAiChoiceBtn: document.getElementById('custom-exercise-ai-choice-btn'),
                customExerciseManualChoiceBtn: document.getElementById('custom-exercise-manual-choice-btn'),
                customExerciseForm: document.getElementById('custom-exercise-form'), customExerciseNameInput: document.getElementById('custom-exercise-name'),
                aiGenerateExerciseDetailsBtn: document.getElementById('ai-generate-exercise-details-btn'), customExerciseDetailsContainer: document.getElementById('custom-exercise-details-container'),
                customExerciseImgLoader: document.getElementById('custom-exercise-img-loader'), customExerciseImg: document.getElementById('custom-exercise-img'),
                customExerciseInstructions: document.getElementById('custom-exercise-instructions'), customExerciseRepRange: document.getElementById('custom-exercise-rep-range'),
                customExerciseGroup: document.getElementById('custom-exercise-group'),
                customExerciseActionButtons: document.getElementById('custom-exercise-action-buttons'),
                createNewExerciseFromLibraryBtn: document.getElementById('create-new-exercise-from-library-btn'),
                planViewHeader: document.getElementById('plan-view-header'),
                // Edit Plan Modal UI
                editPlanModal: document.getElementById('edit-plan-modal'),
                closeEditPlanModalBtn: document.getElementById('close-edit-plan-modal-btn'),
                editPlanScheduleBuilder: document.getElementById('edit-plan-schedule-builder'),
                editPlanDayTypeSelect: document.getElementById('edit-plan-day-type-select'),
                editPlanAddExerciseBtn: document.getElementById('edit-plan-add-exercise-btn'),
                editPlanExerciseList: document.getElementById('edit-plan-exercise-list'),
                savePlanEditsBtn: document.getElementById('save-plan-edits-btn'),
                editPlanWarmupDayTypeSelect: document.getElementById('edit-plan-warmup-day-type-select'),
                editPlanAddWarmupBtn: document.getElementById('edit-plan-add-warmup-btn'),
                editPlanWarmupList: document.getElementById('edit-plan-warmup-list'),
                // Removed Mobile Menu elements
                permanentEditWarningModal: document.getElementById('permanent-edit-warning-modal'),
                permanentEditOkBtn: document.getElementById('permanent-edit-ok-btn'),
                permanentEditDontShowAgain: document.getElementById('permanent-edit-dont-show-again'),
            };

             // --- CHART.JS SETUP ---
            let chartTextColor, chartGridColor; // Define theme variables

            function updateChartThemeColors() {
                chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-text').trim();
                chartGridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                Chart.defaults.color = chartTextColor;
            }
            updateChartThemeColors(); // Call once initially

            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, {
                type: 'line', data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: chartTextColor }, grid: { color: chartGridColor } },
                        x: { ticks: { color: chartTextColor }, grid: { color: chartGridColor } }
                    },
                    plugins: { legend: { labels: { color: chartTextColor } } }
                 }
            });

            // --- All other functions (saveData, loadAllData, helpers, modals, event listeners etc.) ---
            // These functions remain exactly the same as in the provided workouts.html code.
            // ... (rest of the JavaScript code from workouts.html goes here) ...

            // --- LOCALSTORAGE & DATA FUNCTIONS (UPDATED) ---
            function saveData() {
                localStorage.setItem('fitTrackAI_workoutPlan', JSON.stringify(workoutPlan));
                localStorage.setItem('fitTrackAI_workoutHistory', JSON.stringify(workoutHistory));
                const customExercises = exerciseDB.filter(ex => ex.isCustom);
                localStorage.setItem('fitTrackAI_exerciseDB', JSON.stringify(customExercises));
                localStorage.setItem('fitTrackAI_warmups', JSON.stringify(warmups));
                localStorage.setItem('fitTrackAI_workoutStatus', JSON.stringify(workoutStatusHistory));
                localStorage.setItem('fitTrackAI_userSettings', JSON.stringify(userSettings));
                localStorage.setItem('fitTrackAI_workoutChatHistory', JSON.stringify(workoutChatHistory));
                localStorage.setItem('fitTrackAI_dailyModifications', JSON.stringify(dailyModifications));
                localStorage.setItem('fitTrackAI_lastLoggedSets', JSON.stringify(lastLoggedSets));
            }

            async function loadAllData() {
                let baseExercises = [];
                let baseWarmups = {};
                try {
                    const response = await fetch('assets/data/exercises.json');
                    if (!response.ok) throw new Error('Failed to fetch exercise data');
                    const data = await response.json();
                    baseExercises = data.exercises || [];
                    baseWarmups = data.warmups || {};
                } catch (error) {
                    console.error("Could not load exercises.json.", error);
                    showCustomAlert("Error", "Could not load the base exercise library.");
                }

                const localWorkoutPlan = JSON.parse(localStorage.getItem('fitTrackAI_workoutPlan')) || {};
                const localWorkoutHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutHistory')) || [];
                const customExercises = JSON.parse(localStorage.getItem('fitTrackAI_exerciseDB')) || [];
                const localWarmups = JSON.parse(localStorage.getItem('fitTrackAI_warmups')) || {};
                const localStatusHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutStatus')) || {};
                const localUserSettings = JSON.parse(localStorage.getItem('fitTrackAI_userSettings')) || { unit: 'kg', showPermanentEditWarning: true };
                const localChatHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutChatHistory')) || [];
                const localDailyModifications = JSON.parse(localStorage.getItem('fitTrackAI_dailyModifications')) || {};
                const localLastLoggedSets = JSON.parse(localStorage.getItem('fitTrackAI_lastLoggedSets')) || {};

                const baseExerciseIds = new Set(baseExercises.map(ex => ex.id));
                const uniqueCustomExercises = customExercises.filter(ex => !baseExerciseIds.has(ex.id));

                exerciseDB = [...baseExercises, ...uniqueCustomExercises];
                workoutPlan = localWorkoutPlan;
                warmups = Object.keys(localWarmups).length > 0 ? localWarmups : baseWarmups;
                workoutHistory = localWorkoutHistory;
                workoutStatusHistory = localStatusHistory;
                userSettings = {...{ unit: 'kg', showPermanentEditWarning: true }, ...localUserSettings};
                workoutChatHistory = localChatHistory;
                dailyModifications = localDailyModifications;
                lastLoggedSets = localLastLoggedSets;

                exerciseDB.forEach(ex => { if (!ex.id) ex.id = crypto.randomUUID(); });
                exerciseDB.forEach(ex => {
                    if (ex.group === "Abs") ex.group = "Abdominals";
                    if (["Lats", "Upper Back", "Lower Back", "Traps"].includes(ex.group)) ex.group = "Back";
                });

                ALL_MUSCLE_GROUPS = [...new Set(exerciseDB.map(ex => ex.group))].sort();
                ALL_EQUIPMENT_TYPES = [...new Set(exerciseDB.map(ex => ex.type))].sort();
            }

            // --- CORE & HELPER FUNCTIONS ---
            const getApiUrl = (model, action = 'generateContent') => {
                 const apiKey = ""; // Handled by environment
                 return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`;
             };

            function dateToKey(date) { return date.toISOString().split('T')[0]; }
            function showModal(modalElement) { modalElement.style.display = 'flex'; }
            function hideModal(modalElement) { modalElement.style.display = 'none'; }
            function showConfirmModal(title, text, onConfirm) { ui.confirmModalTitle.textContent = title; ui.confirmModalText.textContent = text; confirmCallback = onConfirm; showModal(ui.confirmModal); };
            function showCustomAlert(title, text) { ui.alertModalTitle.textContent = title; ui.alertModalText.textContent = text; showModal(ui.alertModal); };
            function updateUI() {
                updateDayView(viewDate);
                populateProgressSelect();
                renderProgressionChart(ui.progressExerciseSelect.value || 'general');
                document.getElementById('plan-main-title').textContent = workoutPlan.name || "Your Workout Plan";
                lucide.createIcons();
            }
            function kgToLbs(kg) { return kg * 2.20462; }
            function lbsToKg(lbs) { return lbs / 2.20462; }
            function formatWeight(weightKg) {
                if(!weightKg && weightKg !== 0) return `0 ${userSettings.unit}`;
                if (userSettings.unit === 'lbs') return `${kgToLbs(weightKg).toFixed(1)} lbs`;
                return `${weightKg.toFixed(1)} kg`;
            }
            function toggleFavoriteByName(itemName) {
                const exIndex = exerciseDB.findIndex(ex => ex.name === itemName);
                if (exIndex > -1) {
                    exerciseDB[exIndex].favorite = !exerciseDB[exIndex].favorite;
                    saveData();
                    renderWorkoutPlanForDate(viewDate);
                }
            }

            function showUndoToast(message, onUndo) {
                const toast = document.getElementById('undo-toast');
                const toastText = document.getElementById('undo-toast-text');
                toastText.textContent = message;
                undoCallback = onUndo;
                clearTimeout(undoTimeout);
                toast.classList.add('show');
                undoTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                    undoCallback = null;
                }, 5000);
            }

            function stopRestTimer() {
                clearInterval(restTimerInterval);
                restTimerInterval = null;
                const activeTimer = document.querySelector('.rest-timer-active');
                if (activeTimer) {
                    activeTimer.textContent = '';
                    activeTimer.classList.remove('rest-timer-active');
                }
            }

            function startRestTimer(timerSpot) {
                stopRestTimer();
                timerSpot.classList.add('rest-timer-active');
                let restSeconds = userSettings.defaultRestTimer || 90;
                const updateTimer = () => {
                    const minutes = Math.floor(restSeconds / 60);
                    const seconds = restSeconds % 60;
                    timerSpot.textContent = `Rest: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    if (restSeconds <= 0) {
                        stopRestTimer();
                        timerSpot.textContent = 'Rest Over!';
                        setTimeout(() => { if (timerSpot.textContent === 'Rest Over!') timerSpot.textContent = ''; }, 3000);
                    } else { restSeconds--; }
                };
                updateTimer();
                restTimerInterval = setInterval(updateTimer, 1000);
            }

            function openWorkoutModal(exerciseName) {
                isLogging = true;
                editingWorkoutLogId = null;
                currentlyLoggingExercise = exerciseName;
                ui.modalTitle.textContent = `Log: ${exerciseName}`;
                ui.saveWorkoutBtn.textContent = 'Save Workout';
                ui.setsContainer.innerHTML = '';
                modalUnit = userSettings.unit;
                updateUnitToggleUI(modalUnit);
                const exerciseDetails = exerciseDB.find(ex => ex.name === exerciseName);
                let setsToRender = [];
                if (lastLoggedSets[exerciseName] && lastLoggedSets[exerciseName].length > 0) {
                    setsToRender = lastLoggedSets[exerciseName];
                } else {
                    let numSets = 3;
                    if (exerciseDetails && exerciseDetails.sets) {
                        const setsMatch = String(exerciseDetails.sets).match(/\d+/);
                        if (setsMatch) numSets = parseInt(setsMatch[0], 10);
                    }
                    for (let i = 0; i < numSets; i++) setsToRender.push([{weight: '', reps: '', partial: false}]);
                }
                setsToRender.forEach(setParts => addSetRow(setParts));
                showModal(ui.workoutModal);
            };

            function addSetRow(setParts = [{weight: '', reps: '', partial: false}]) {
                const setNumber = ui.setsContainer.children.length + 1;
                const row = document.createElement('div');
                row.className = 'set-row border border-gray-800 p-3 rounded-lg space-y-2';
                row.innerHTML = `<div class="flex justify-between items-center"><label class="font-bold text-lg">Set ${setNumber}</label><span class="rest-timer-spot text-sm text-blue-400 font-mono"></span><div><button type="button" class="add-part-btn text-blue-400 hover:text-blue-300 p-1" title="Add drop set / pyramid"><i data-lucide="plus-circle" class="w-5 h-5 pointer-events-none"></i></button><button type="button" class="remove-set-btn text-red-500 hover:text-red-400 p-1" title="Delete set"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div></div><div class="parts-container space-y-2"></div>`;
                ui.setsContainer.appendChild(row);
                lucide.createIcons();
                const partsContainer = row.querySelector('.parts-container');
                setParts.forEach(part => {
                    const displayWeight = modalUnit === 'lbs' ? (part.weight ? kgToLbs(part.weight).toFixed(1) : '') : (part.weight || '');
                    addWeightRepPart(partsContainer, displayWeight, part.reps, part.partial);
                });
                row.querySelector('.add-part-btn').addEventListener('click', () => addWeightRepPart(partsContainer));
            };

            function addWeightRepPart(container, weight='', reps='', isPartial=false) {
                const partHtml = `<div class="set-part-row grid grid-cols-12 gap-2 items-center"><input type="number" step="any" min="0" placeholder="Weight (${modalUnit})" value="${weight}" class="form-input !py-2 col-span-4 set-weight"><span class="text-center col-span-1">x</span><input type="number" min="1" step="1" placeholder="Reps" value="${reps}" class="form-input !py-2 col-span-3 set-reps"><div class="col-span-3 flex items-center justify-center"><input type="checkbox" ${isPartial ? 'checked' : ''} class="form-checkbox h-5 w-5 bg-input-bg border-border-color rounded text-blue-500 focus:ring-blue-500 set-partial"><label class="ml-2 text-sm">Partial</label></div><button type="button" class="remove-part-btn text-gray-500 hover:text-red-400 p-1 col-span-1"><i data-lucide="x-circle" class="w-4 h-4 pointer-events-none"></i></button></div>`;
                container.insertAdjacentHTML('beforeend', partHtml);
                lucide.createIcons();
            };

            function updateDayView(date) {
                viewDate = date;
                renderWorkoutPlanForDate(date);
                updateWorkoutProgressBar(date);
                const today = new Date(); today.setHours(0,0,0,0);
                const isToday = dateToKey(date) === dateToKey(today);
                const isFutureDay = date > today;
                const dayViewBtn = document.getElementById('day-view-date-display-btn');
                dayViewBtn.querySelector('#day-view-title-span').textContent = date.toLocaleDateString(undefined, { weekday: 'long' }) + (isToday ? ' (Today)' : '');
                dayViewBtn.querySelector('#day-view-date-span').textContent = date.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
                const addTempExBtn = document.getElementById('add-temporary-exercise-btn');
                const addTempWarmupBtn = document.getElementById('add-temporary-warmup-btn');
                if (addTempExBtn) addTempExBtn.classList.toggle('hidden', isFutureDay);
                if (addTempWarmupBtn) addTempWarmupBtn.classList.toggle('hidden', isFutureDay);
                lucide.createIcons();
            }

            function getWorkoutDayType(date) {
                const schedule = workoutPlan.schedule || {};
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                return schedule[dayName] || 'Rest';
            }

            function renderWorkoutPlanForDate(date) {
                const dayType = getWorkoutDayType(date);
                const dateKey = dateToKey(date);
                const loggedExercisesForDay = new Set(workoutHistory.filter(log => log.date === dateKey).map(l => l.name));
                let exercisesHtml = '';
                const modsForDay = dailyModifications[dateKey] || { removed: [], added: [], warmups: [], removedWarmups: [] }; // Ensure removedWarmups exists
                const removedExercises = new Set(modsForDay.removed);
                const addedExercises = modsForDay.added || [];
                const addedWarmups = modsForDay.warmups || [];
                const removedWarmups = new Set(modsForDay.removedWarmups || []); // Use Set for removedWarmups

                const createItemHTML = (itemName, type, isTemporary = false) => {
                    const isExercise = type === 'exercise';
                    const item = isExercise ? exerciseDB.find(e => e.name === itemName) : Object.values(warmups).flat().find(w => w.name === itemName);
                    if (!item) return '';
                    const isLogged = isExercise && loggedExercisesForDay.has(item.name);
                    const isFavorite = isExercise && item.favorite;
                    const statusIcon = isLogged ? '<i data-lucide="check-circle-2" class="w-5 h-5 text-green-400"></i>' : '<i data-lucide="x-circle" class="w-5 h-5 text-gray-600"></i>';
                    const temporaryBadge = isTemporary ? `<span class="text-xs ml-2 bg-${isExercise ? 'blue' : 'green'}-500/30 text-${isExercise ? 'blue' : 'green'}-300 px-1.5 py-0.5 rounded">Today</span>` : '';
                    const buttonHtml = isExercise ? `<button class="btn btn-secondary !p-2 info-btn" data-name="${item.name}" data-type="exercise" data-day-type="${dayType}" title="View Info"><i data-lucide="info" class="w-4 h-4 pointer-events-none"></i></button>` : '';
                    return `<div class="swipe-item plan-item-container rounded-lg" data-name="${item.name}" data-type="${type}" data-day-type="${dayType}" draggable="true"><div class="swipe-actions"><div class="swipe-action-container left"><div class="action delete"><i data-lucide="trash-2" class="pointer-events-none"></i><span class="ml-2 pointer-events-none">Remove</span></div></div><div class="swipe-action-container right"><div class="action edit"><span class="mr-2 pointer-events-none">Edit</span><i data-lucide="pencil" class="pointer-events-none"></i></div></div></div><div class="swipe-content p-3 rounded-lg"><div class="text-base text-gray-300 flex justify-between items-center group"><div class="flex-grow flex items-center gap-3"><div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">${statusIcon}</div><div><span class="flex-grow text-left flex items-center">${item.name}${temporaryBadge}</span>${isExercise ? `<p class="text-xs text-blue-400">${item.group}</p>` : ''}</div></div><div class="flex items-center gap-2">${isFavorite ? '<i data-lucide="star" class="w-4 h-4 fill-yellow-400 text-yellow-400"></i>' : ''}${buttonHtml}</div></div></div></div>`;
                };

                if (dayType === 'Rest') {
                    exercisesHtml = `<div class="flex flex-col items-center justify-center h-full text-center p-4"><i data-lucide="bed-double" class="w-12 h-12 text-gray-500 mb-2"></i><p class="text-gray-500 italic mt-2">Rest Day</p></div>`;
                } else {
                    const workoutForDay = (workoutPlan.workouts || []).find(w => w.day === dayType);
                    let planWarmupExercises = warmups[dayType] || [];
                    const finalWarmups = [...planWarmupExercises.map(w => w.name).filter(name => !removedWarmups.has(name)), ...addedWarmups];
                    const uniqueFinalWarmups = [...new Set(finalWarmups)];

                    if (uniqueFinalWarmups.length > 0) {
                        exercisesHtml += `<div><h5 class="font-semibold text-green-400 text-sm mb-1">Warm-up</h5><div class="space-y-1 warmup-list">${uniqueFinalWarmups.map(name => createItemHTML(name, 'warmup', addedWarmups.includes(name))).join('')}</div></div>`;
                    }
                    let planExercisesHtml = '';
                    if (workoutForDay?.exercises?.length > 0) {
                        const finalExercises = workoutForDay.exercises.filter(exName => !removedExercises.has(exName));
                        planExercisesHtml = finalExercises.map(exName => createItemHTML(exName, 'exercise', false)).join('');
                    }
                    let temporaryExercisesHtml = addedExercises.map(exName => createItemHTML(exName, 'exercise', true)).join('');
                    if (planExercisesHtml || temporaryExercisesHtml) {
                        exercisesHtml += `<div><h5 class="font-semibold text-blue-400 text-sm my-2">Workout</h5><div class="space-y-1 exercise-list">${planExercisesHtml}${temporaryExercisesHtml}</div></div>`;
                    }
                    if (!planExercisesHtml && !temporaryExercisesHtml && uniqueFinalWarmups.length === 0) {
                        exercisesHtml += `<p class="text-secondary-text mt-4">No exercises planned for ${dayType} day. Use the Plan Editor to add some!</p>`;
                    }
                }
                ui.workoutPlanForDay.innerHTML = exercisesHtml;
                lucide.createIcons();
            }

            function updateWorkoutProgressBar(date) {
                const progressBar = document.getElementById('workout-progress-bar');
                const progressText = document.getElementById('workout-progress-text');
                const progressContainer = document.getElementById('workout-progress-container');
                if (!progressBar || !progressText || !progressContainer) return;

                const dayType = getWorkoutDayType(date); const dateKey = dateToKey(date); const loggedExercisesForDay = new Set(workoutHistory.filter(log => log.date === dateKey).map(l => l.name));
                let completedCount = 0; let totalCount = 0; let status = 'none';

                if (dayType === 'Rest') { completedCount = 1; totalCount = 1; status = 'full'; progressText.textContent = 'Rest'; }
                else {
                    const modsForDay = dailyModifications[dateKey] || { removed: [], added: [], warmups: [], removedWarmups: [] };
                    const removedExercises = new Set(modsForDay.removed); const addedExercises = modsForDay.added || [];
                    const workoutForDay = (workoutPlan.workouts || []).find(w => w.day === dayType); const plannedExercises = workoutForDay?.exercises || [];
                    const finalPlannedExercises = plannedExercises.filter(exName => !removedExercises.has(exName));
                    const allExercisesForDay = [...new Set([...finalPlannedExercises, ...addedExercises])].filter(Boolean);
                    totalCount = allExercisesForDay.length;
                    if (totalCount > 0) completedCount = allExercisesForDay.filter(exName => loggedExercisesForDay.has(exName)).length;
                    progressText.textContent = `${completedCount}/${totalCount}`;
                    if (totalCount === 0) status = 'none'; else if (completedCount === 0) status = 'none'; else if (completedCount >= totalCount) status = 'full'; else status = 'partial';
                }
                const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
                progressBar.style.width = `${percentage}%`;
                workoutStatusHistory[dateKey] = status; saveData();
                progressBar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
                if (status === 'full') progressBar.classList.add('bg-green-500'); else if (status === 'partial') progressBar.classList.add('bg-yellow-500'); else progressBar.classList.add('bg-red-500');
            }

            function handleItemDelete(element) {
                const name = element.dataset.name; const type = element.dataset.type; const dayType = element.dataset.dayType; const dateKey = dateToKey(viewDate);
                if (element.classList.contains('plan-item-container')) {
                    if (type === 'warmup') {
                        if (!dailyModifications[dateKey]) dailyModifications[dateKey] = { removed: [], added: [], warmups: [], removedWarmups: [] };
                        const modsForDay = dailyModifications[dateKey];
                        if (warmups[dayType]?.some(w => w.name === name)) {
                            if (!modsForDay.removedWarmups) modsForDay.removedWarmups = [];
                            if (!modsForDay.removedWarmups.includes(name)) modsForDay.removedWarmups.push(name);
                        } else { const index = modsForDay.warmups.indexOf(name); if (index > -1) modsForDay.warmups.splice(index, 1); }
                        showUndoToast(`${name} removed for today.`, () => {
                            if (modsForDay.removedWarmups?.includes(name)) { const index = modsForDay.removedWarmups.indexOf(name); if (index > -1) modsForDay.removedWarmups.splice(index, 1); }
                            else if (warmups[dayType] && !warmups[dayType].some(w => w.name === name)) { modsForDay.warmups.push(name); }
                            saveData(); updateUI();
                        });
                        saveData(); updateUI(); return;
                    }
                    if (!dailyModifications[dateKey]) dailyModifications[dateKey] = { removed: [], added: [], warmups: [], removedWarmups: [] };
                    const modsForDay = dailyModifications[dateKey]; const addedIndex = (modsForDay.added || []).indexOf(name);
                    if (addedIndex > -1) {
                        modsForDay.added.splice(addedIndex, 1);
                        showUndoToast(`${name} removed for today.`, () => { if (!modsForDay.added.includes(name)) modsForDay.added.push(name); saveData(); updateUI(); });
                    } else {
                        if (!modsForDay.removed.includes(name)) modsForDay.removed.push(name);
                        showUndoToast(`${name} removed for today.`, () => { const index = modsForDay.removed.indexOf(name); if (index > -1) modsForDay.removed.splice(index, 1); saveData(); updateUI(); });
                    }
                    saveData(); updateUI();
                }
            }

            function handleItemEdit(element) { if (element.classList.contains('plan-item-container')) { const type = element.dataset.type; if (type === 'exercise') showPermanentEditWarningModal(); else if (type === 'warmup') openEditPlanModal(); } }
            function showPermanentEditWarningModal() { if (userSettings.showPermanentEditWarning !== false) showModal(ui.permanentEditWarningModal); else openEditPlanModal(); }
            function getPointerCoordinates(e) { return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY }; }

            function handlePointerDown(e) {
                const target = e.target.closest('.swipe-item'); if (!target || e.target.closest('button, a')) return;
                isNativeDragging = false; const coords = getPointerCoordinates(e); pointerStart.x = coords.x; pointerStart.y = coords.y; currentX = 0; swipedElement = target;
                swipedElement.querySelector('.swipe-content').classList.add('swiping');
                document.addEventListener('mousemove', handlePointerMove); document.addEventListener('mouseup', handlePointerUp);
                document.addEventListener('touchmove', handlePointerMove, { passive: false }); document.addEventListener('touchend', handlePointerUp);
            }
            function handlePointerMove(e) {
                if (isNativeDragging || !swipedElement) return; const coords = getPointerCoordinates(e); const deltaX = coords.x - pointerStart.x; const deltaY = coords.y - pointerStart.y; pointerDelta = { x: deltaX, y: deltaY };
                if (!isSwiping && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) isSwiping = true;
                if (isSwiping) {
                    if(e.cancelable) e.preventDefault(); currentX = deltaX; const content = swipedElement.querySelector('.swipe-content'); content.style.transform = `translateX(${currentX}px)`;
                    const rightAction = swipedElement.querySelector('.swipe-action-container.right'); const leftAction = swipedElement.querySelector('.swipe-action-container.left');
                    if (currentX < 0) { rightAction.style.opacity = Math.min(1, Math.abs(currentX) / 80).toString(); leftAction.style.opacity = '0'; }
                    else { leftAction.style.opacity = Math.min(1, currentX / 80).toString(); rightAction.style.opacity = '0'; }
                }
            }
            function handlePointerUp(e) {
                document.removeEventListener('mousemove', handlePointerMove); document.removeEventListener('mouseup', handlePointerUp);
                document.removeEventListener('touchmove', handlePointerMove); document.removeEventListener('touchend', handlePointerUp);
                if (!swipedElement) return;
                const elementToClean = swipedElement; const content = elementToClean.querySelector('.swipe-content');
                const currentTime = Date.now(); const isDoubleTap = (currentTime - lastTap) < 300 && !isSwiping; lastTap = currentTime;
                const totalDistance = Math.sqrt(pointerDelta.x**2 + pointerDelta.y**2);
                if (isSwiping) {
                    const swipeThreshold = elementToClean.offsetWidth * 0.35; content.classList.add('returning');
                    if (currentX < -swipeThreshold) { handleItemEdit(elementToClean); content.style.transform = 'translateX(0)'; }
                    else if (currentX > swipeThreshold) { handleItemDelete(elementToClean); }
                    else { content.style.transform = 'translateX(0)'; }
                } else if (totalDistance < 10) {
                     if (elementToClean.classList.contains('plan-item-container')) {
                        const today = new Date(); today.setHours(0,0,0,0); const isFutureDay = viewDate > today;
                        const { name, type, dayType } = swipedElement.dataset;
                        if (isDoubleTap && type === 'exercise') { toggleFavoriteByName(name); swipedElement = null; isSwiping = false; return; }
                        else if (type === 'exercise' && !isFutureDay && !isNativeDragging) { openWorkoutModal(name); }
                        else if (type === 'warmup' && !isNativeDragging) { openExerciseDetailModal(name, 'warmup', dayType); }
                    }
                }
                isSwiping = false; swipedElement = null; currentX = 0; pointerDelta = { x: 0, y: 0 };
                setTimeout(() => {
                    content.classList.remove('swiping', 'returning'); content.style.transform = '';
                    elementToClean.querySelectorAll('.swipe-action-container').forEach(el => el.style.opacity = '0');
                }, 300);
            }

            let dayNavPointerStart = { x: 0, y: 0 }; let dayNavCurrentX = 0; let isDayNavSwiping = false;
            function handleDayNavPointerDown(e) {
                if (e.target.closest('.swipe-item, a, select, input, button') && !e.target.closest('#day-view-date-display-btn')) return;
                const coords = getPointerCoordinates(e); dayNavPointerStart.x = coords.x; dayNavPointerStart.y = coords.y; dayNavCurrentX = 0; isDayNavSwiping = false;
                ui.dayNavigationCard.style.transition = 'none';
                document.addEventListener('mousemove', handleDayNavPointerMove); document.addEventListener('mouseup', handleDayNavPointerUp);
                document.addEventListener('touchmove', handleDayNavPointerMove, { passive: false }); document.addEventListener('touchend', handleDayNavPointerUp);
            }
            function handleDayNavPointerMove(e) {
                const coords = getPointerCoordinates(e); const deltaX = coords.x - dayNavPointerStart.x; const deltaY = coords.y - dayNavPointerStart.y;
                if (!isDayNavSwiping) { if (Math.abs(deltaX) > 10 && Math.abs(deltaX) > Math.abs(deltaY)) isDayNavSwiping = true; else if (Math.abs(deltaY) > 10) { handleDayNavPointerUp(); return; } }
                if (isDayNavSwiping) { if(e.cancelable) e.preventDefault(); dayNavCurrentX = deltaX; ui.dayNavigationCard.style.transform = `translateX(${dayNavCurrentX}px)`; ui.dayNavigationCard.style.opacity = (1 - Math.abs(dayNavCurrentX) / ui.dayNavigationCard.offsetWidth).toString(); }
            }
            function handleDayNavPointerUp() {
                document.removeEventListener('mousemove', handleDayNavPointerMove); document.removeEventListener('mouseup', handleDayNavPointerUp);
                document.removeEventListener('touchmove', handleDayNavPointerMove); document.removeEventListener('touchend', handleDayNavPointerUp);
                const swipeThreshold = 20;
                ui.dayNavigationCard.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                if (isDayNavSwiping) {
                    if (dayNavCurrentX < -swipeThreshold) { viewDate.setDate(viewDate.getDate() + 1); updateUI(); }
                    else if (dayNavCurrentX > swipeThreshold) { viewDate.setDate(viewDate.getDate() - 1); updateUI(); }
                }
                ui.dayNavigationCard.style.transform = 'translateX(0)'; ui.dayNavigationCard.style.opacity = '1';
                isDayNavSwiping = false; dayNavCurrentX = 0;
                setTimeout(() => { ui.dayNavigationCard.style.transition = ''; }, 300);
            }

            let draggedPlanItem = null;
            function handlePlanDragStart(e) { if (!e.target.classList.contains('plan-item-container')) { e.preventDefault(); return; } isNativeDragging = true; draggedPlanItem = e.target; setTimeout(() => { if (draggedPlanItem) draggedPlanItem.classList.add('dragging'); }, 0); }
            function handlePlanDragEnd() { if (draggedPlanItem) { draggedPlanItem.classList.remove('dragging'); draggedPlanItem = null; } document.querySelectorAll('.plan-item-container.drag-over').forEach(el => el.classList.remove('drag-over')); isNativeDragging = false; }
            function getDragAfterElementPlan(container, y) { const draggableElements = [...container.querySelectorAll('.plan-item-container:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }
            function handlePlanDragOver(e) {
                e.preventDefault(); const container = e.target.closest('.warmup-list, .exercise-list'); if (!container || !draggedPlanItem) return;
                const draggedType = draggedPlanItem.dataset.type;
                if ((draggedType === 'warmup' && !container.classList.contains('warmup-list')) || (draggedType === 'exercise' && !container.classList.contains('exercise-list'))) return;
                const afterElement = getDragAfterElementPlan(container, e.clientY); document.querySelectorAll('.plan-item-container.drag-over').forEach(el => el.classList.remove('drag-over'));
                if (afterElement) afterElement.classList.add('drag-over');
            }
            function handlePlanDrop(e) {
                e.preventDefault(); const container = e.target.closest('.warmup-list, .exercise-list'); if (!container || !draggedPlanItem) return;
                const draggedType = draggedPlanItem.dataset.type;
                if ((draggedType === 'warmup' && !container.classList.contains('warmup-list')) || (draggedType === 'exercise' && !container.classList.contains('exercise-list'))) { handlePlanDragEnd(); return; }
                const afterElement = getDragAfterElementPlan(container, e.clientY); if (afterElement == null) container.appendChild(draggedPlanItem); else container.insertBefore(draggedPlanItem, afterElement);
                const dayType = draggedPlanItem.dataset.dayType;
                if (container.classList.contains('warmup-list')) { const newOrder = Array.from(container.querySelectorAll('.plan-item-container')).map(el => el.dataset.name); const reorderedWarmups = newOrder.map(name => warmups[dayType].find(w => w.name === name)).filter(Boolean); warmups[dayType] = reorderedWarmups; }
                else if (container.classList.contains('exercise-list')) { const workout = workoutPlan.workouts.find(w => w.day === dayType); if (workout) workout.exercises = Array.from(container.querySelectorAll('.plan-item-container')).map(el => el.dataset.name); }
                saveData(); handlePlanDragEnd();
            }

            ui.workoutPlanForDay.addEventListener('mousedown', handlePointerDown);
            ui.workoutPlanForDay.addEventListener('touchstart', handlePointerDown, { passive: true });
            ui.workoutPlanForDay.addEventListener('click', (e) => { const infoBtn = e.target.closest('.info-btn'); if (infoBtn) { const { name, type, dayType } = infoBtn.dataset; openExerciseDetailModal(name, type, dayType); } });
            document.getElementById('undo-toast-btn').addEventListener('click', () => { if (undoCallback) undoCallback(); clearTimeout(undoTimeout); document.getElementById('undo-toast').classList.remove('show'); undoCallback = null; });
            ui.closeExerciseLibraryModalBtn.addEventListener('click', () => hideModal(ui.exerciseLibraryModal));
            ui.addSelectedExercisesBtn.addEventListener('click', () => {
                const selected = Array.from(document.querySelectorAll('#exercise-library-list input:checked')).map(cb => cb.value);
                if (libraryModalContext.purpose === 'edit-plan-add') {
                    if (selected.length > 0) {
                        const dayType = libraryModalContext.dayType; let workout = workoutPlan.workouts.find(w => w.day === dayType);
                        if (!workout) { workout = { day: dayType, exercises: [] }; workoutPlan.workouts.push(workout); }
                        const existingExercises = new Set(workout.exercises); selected.forEach(name => existingExercises.add(name)); workout.exercises = Array.from(existingExercises);
                        renderExercisesForEdit(dayType);
                    }
                } else if (libraryModalContext.purpose === 'add-temporary') {
                    const { dateKey } = libraryModalContext; if (selected.length > 0 && dateKey) {
                        if (!dailyModifications[dateKey]) dailyModifications[dateKey] = { removed: [], added: [], warmups: [] };
                        if (libraryModalContext.type === 'warmup') { const existing = new Set(dailyModifications[dateKey].warmups || []); selected.forEach(name => existing.add(name)); dailyModifications[dateKey].warmups = Array.from(existing); }
                        else { const existing = new Set(dailyModifications[dateKey].added || []); selected.forEach(name => existing.add(name)); dailyModifications[dateKey].added = Array.from(existing); }
                        saveData(); updateUI();
                    }
                } else if (libraryModalContext.purpose === 'pref') { const group = libraryModalContext.group; const allInGroup = exerciseDB.filter(ex => ex.group === group).length; if(selected.length === allInGroup) delete exercisePrefs[group]; else exercisePrefs[group] = selected; /* No renderExercisePreferences needed */ }
                hideModal(ui.exerciseLibraryModal);
            });
            ui.getAIAdviceBtn.addEventListener('click', async () => {
                const exerciseName = ui.aiAdviceExerciseSelect.value; if (!exerciseName) { ui.aiAdviceOutput.innerHTML = `<p class="text-yellow-400">Please select an exercise first.</p>`; return; }
                const btn = ui.getAIAdviceBtn; btn.disabled = true; btn.querySelector('.btn-text').style.display = 'none'; btn.querySelector('.loader').classList.remove('hidden'); ui.aiAdviceOutput.innerHTML = '';
                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName).slice(-3);
                const prompt = `Act as an expert fitness coach. A user performed these recent sessions for ${exerciseName}: ${exerciseLogs.map((log, i) => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; return `Session ${i+1} (${new Date(log.date.replace(/-/g, '/')).toLocaleDateString()}): ${sets.map(set => set.map(part => `${part.weight}kg x ${part.reps} reps`).join(' + ')).join(', ')}`}).join('\n')} Based on progressive overload, give a clear, actionable recommendation for their *next* session. Be specific (e.g., "Aim for 6-8 reps with 52.5kg"). Keep it under 75 words.`;
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                 try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const result = await response.json(); let text = result.candidates[0].content.parts[0].text; ui.aiAdviceOutput.innerHTML = `<p>${text}</p>`; }
                 catch (error) { console.error("AI Workout Advice Error:", error); ui.aiAdviceOutput.innerHTML = `<p class="text-red-400">Could not get AI advice.</p>`; }
                 finally { btn.disabled = false; btn.querySelector('.btn-text').style.display = 'inline'; btn.querySelector('.loader').classList.add('hidden'); }
             });
            ui.closeModalBtn.addEventListener('click', () => { hideModal(ui.workoutModal); isLogging = false; stopRestTimer(); });
            ui.addSetBtn.addEventListener('click', () => addSetRow());
            ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));
            ui.confirmModalCancelBtn.addEventListener('click', () => hideModal(ui.confirmModal));
            ui.confirmModalConfirmBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(); hideModal(ui.confirmModal); });
            ui.progressExerciseSelect.addEventListener('change', (e) => renderProgressionChart(e.target.value));
            ui.dayViewDateDisplayBtn.addEventListener('click', () => { const today = new Date(); today.setHours(0,0,0,0); viewDate = today; updateUI(); });
            document.getElementById('progress-range-selector').addEventListener('click', e => { const btn = e.target.closest('.progress-range-btn'); if (btn) { chartRange = btn.dataset.range; document.querySelectorAll('.progress-range-btn').forEach(b => b.classList.remove('selected-full')); btn.classList.add('selected-full'); renderProgressionChart(ui.progressExerciseSelect.value); } });
            function populateProgressSelect() {
                const currentSelection = ui.progressExerciseSelect.value; const exercisedNames = [...new Set(workoutHistory.map(log => log.name))].sort(); const singleExerciseOptions = exercisedNames.map(name => `<option value="${name}">${name}</option>`).join('');
                const dayType = getWorkoutDayType(new Date()); const todayOptionText = dayType === 'Rest' ? "Overall Progression" : `Progression for ${dayType} Day`;
                ui.progressExerciseSelect.innerHTML = `<option value="today-general">${todayOptionText}</option><option value="general">Overall General Progression</option><optgroup label="Specific Exercises">${singleExerciseOptions}</optgroup>`;
                ui.progressExerciseSelect.value = currentSelection || 'general'; ui.aiAdviceExerciseSelect.innerHTML = '<option value="">Select an exercise...</option>' + singleExerciseOptions;
            };
            function getStartDateForRange(range) { const now = new Date(); if (range === 'month') { now.setMonth(now.getMonth() - 1); return now; } if (range === '3month') { now.setMonth(now.getMonth() - 3); return now; } if (range === 'year') { now.setFullYear(now.getFullYear() - 1); return now; } return null; }
            function renderProgressionChart(selection) {
                if (selection === "today-general") { renderTodaysGeneralProgressionChart(); return; } if (selection === "general" || !selection) { renderGeneralProgressionChart(); return; }
                const startDate = getStartDateForRange(chartRange); let exerciseLogs = workoutHistory.filter(log => log.name === selection); if (startDate) exerciseLogs = exerciseLogs.filter(log => new Date(log.date) >= startDate);
                exerciseLogs.sort((a,b) => new Date(a.date) - new Date(b.date)); const labels = exerciseLogs.map(log => { if (!log.date || typeof log.date !== 'string') return 'Unknown'; return new Date(log.date.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); });
                const maxWeightData = exerciseLogs.map(log => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const maxWeightKg = Math.max(...sets.flatMap(set => set.map(s => s.weight || 0))); return userSettings.unit === 'lbs' ? kgToLbs(maxWeightKg) : maxWeightKg; });
                const volumeData = exerciseLogs.map(log => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const volumeKg = sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0); return userSettings.unit === 'lbs' ? kgToLbs(volumeKg) : volumeKg; });
                const est1RMData = exerciseLogs.map(log => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; if (!sets || sets.length === 0) return null; const max1RM = Math.max(...sets.flat().map(s => { if (s.reps > 12 || s.reps < 1 || !s.weight) return null; return s.weight * (1 + s.reps / 30); }).filter(val => val !== null)); if (max1RM === -Infinity) return null; return userSettings.unit === 'lbs' ? kgToLbs(max1RM) : max1RM; });
                 updateChartThemeColors(); progressChart.data.labels = labels; progressChart.data.datasets = [ { label: `Max Weight (${userSettings.unit})`, data: maxWeightData, borderColor: '#60a5fa', backgroundColor: '#60a5fa33', tension: 0.2, fill: true }, { label: `Total Volume (${userSettings.unit})`, data: volumeData, borderColor: '#4ade80', backgroundColor: '#4ade8033', tension: 0.2, fill: true }, { label: `Est. 1RM (${userSettings.unit})`, data: est1RMData, borderColor: '#facc15', backgroundColor: '#facc15', tension: 0.2, borderDash: [5, 5], fill: false } ]; progressChart.update();
             };
            function renderGeneralProgressionChart() {
                if (workoutHistory.length === 0) { progressChart.data.labels = []; progressChart.data.datasets = []; progressChart.update(); return; } const volumeByDay = {}; const startDate = getStartDateForRange(chartRange); let relevantHistory = workoutHistory; if(startDate) relevantHistory = workoutHistory.filter(log => new Date(log.date) >= startDate);
                relevantHistory.forEach(log => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const dateKey = log.date; const logVolume = sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0); if (!volumeByDay[dateKey]) volumeByDay[dateKey] = 0; volumeByDay[dateKey] += logVolume; });
                const sortedDates = Object.keys(volumeByDay).sort((a, b) => new Date(a) - new Date(b)); const labels = sortedDates.map(dateStr => { if (!dateStr || typeof dateStr !== 'string') return 'Unknown'; return new Date(dateStr.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); }); const volumeData = sortedDates.map(date => { const volumeKg = volumeByDay[date]; return userSettings.unit === 'lbs' ? kgToLbs(volumeKg) : volumeKg; });
                 updateChartThemeColors(); progressChart.data.labels = labels; progressChart.data.datasets = [{ label: `Total Daily Volume (${userSettings.unit})`, data: volumeData, borderColor: '#a78bfa', backgroundColor: '#a78bfa33', tension: 0.2, fill: true }]; progressChart.update();
             }
            function renderTodaysGeneralProgressionChart() {
                const dayType = getWorkoutDayType(new Date()); if (dayType === 'Rest') { renderGeneralProgressionChart(); return; } const workoutForDay = (workoutPlan.workouts || []).find(w => w.day === dayType); if (!workoutForDay || !workoutForDay.exercises) { renderGeneralProgressionChart(); return; }
                const todaysExercises = new Set(workoutForDay.exercises); const volumeByDay = {}; const startDate = getStartDateForRange(chartRange); let relevantHistory = workoutHistory; if(startDate) relevantHistory = workoutHistory.filter(log => new Date(log.date) >= startDate);
                relevantHistory.filter(log => todaysExercises.has(log.name)).forEach(log => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const dateKey = log.date; const logVolume = sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0); if (!volumeByDay[dateKey]) volumeByDay[dateKey] = 0; volumeByDay[dateKey] += logVolume; });
                if (Object.keys(volumeByDay).length === 0) { progressChart.data.labels = []; progressChart.data.datasets = [ { label: `Volume for Today's Workout (${userSettings.unit})`, data: [], borderColor: '#34d399', backgroundColor: '#34d39933', tension: 0.2, fill: true }]; progressChart.update(); return; }
                const sortedDates = Object.keys(volumeByDay).sort((a, b) => new Date(a) - new Date(b)); const labels = sortedDates.map(dateStr => { if (!dateStr || typeof dateStr !== 'string') return 'Unknown'; return new Date(dateStr.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); }); const volumeData = sortedDates.map(date => { const volumeKg = volumeByDay[date]; return userSettings.unit === 'lbs' ? kgToLbs(volumeKg) : volumeKg; });
                 updateChartThemeColors(); progressChart.data.labels = labels; progressChart.data.datasets = [{ label: `Volume for Today's Workout (${userSettings.unit})`, data: volumeData, borderColor: '#34d399', backgroundColor: '#34d39933', tension: 0.2, fill: true }]; progressChart.update();
             }
            function openEditWorkoutModal(logId) { const logEntry = workoutHistory.find(log => log.id === logId); if (!logEntry) return; isLogging = true; editingWorkoutLogId = logId; currentlyLoggingExercise = logEntry.name; ui.modalTitle.textContent = `Edit: ${logEntry.name}`; ui.saveWorkoutBtn.textContent = 'Update Workout'; ui.setsContainer.innerHTML = ''; const sets = typeof logEntry.sets === 'string' ? JSON.parse(logEntry.sets) : logEntry.sets; sets.forEach(set => addSetRow(set)); modalUnit = userSettings.unit; updateUnitToggleUI(modalUnit); showModal(ui.workoutModal); };
            async function displayExerciseMedia(exerciseName) {
                ui.exerciseMediaLoader.classList.remove('hidden'); ui.exerciseMediaContainer.innerHTML = '';
                const item = exerciseDB.find(ex => ex.name === exerciseName) || Object.values(warmups).flat().find(w => w.name === exerciseName);
                let mediaFilename = item?.media || item?.videoPlaceholder;
                const antiDownloadAttributes = 'oncontextmenu="return false;" draggable="false"'; const preventInteractions = 'pointer-events: none;';
                if (mediaFilename && !mediaFilename.startsWith('data:') && mediaFilename !== 'logo.png') {
                    const mediaPath = mediaFilename.startsWith('media/') ? mediaFilename : `media/${mediaFilename}`; const mediaType = mediaFilename.toLowerCase().match(/\.(mp4|mov|webm)$/) ? 'video' : 'image';
                    if (mediaType === 'video') ui.exerciseMediaContainer.innerHTML = `<video src="${mediaPath}" loop autoplay muted playsinline class="w-full h-full object-cover rounded-lg" style="${preventInteractions}" ${antiDownloadAttributes} onerror="this.onerror=null; this.src='logo.png'; this.classList.remove('object-cover'); this.classList.add('object-contain', 'p-4');"></video>`;
                    else if (mediaType === 'image' || mediaFilename.toLowerCase().match(/\.(jpg|png|jpeg|gif)$/)) ui.exerciseMediaContainer.innerHTML = `<img src="${mediaPath}" alt="${exerciseName}" class="w-full h-full object-cover rounded-lg" ${antiDownloadAttributes} onerror="this.onerror=null; this.src='logo.png'; this.classList.remove('object-cover'); this.classList.add('object-contain', 'p-4');">`;
                    else ui.exerciseMediaContainer.innerHTML = `<img src="logo.png" alt="FitTrack AI Logo" class="w-full h-full object-contain p-4 rounded-lg">`;
                    ui.exerciseMediaLoader.classList.add('hidden'); return;
                }
                ui.exerciseMediaContainer.innerHTML = `<img src="logo.png" alt="FitTrack AI Logo" class="w-full h-full object-contain p-4 rounded-lg">`; ui.exerciseMediaLoader.classList.add('hidden');
            }
            function openExerciseDetailModal(itemName, itemType = 'exercise', dayType = null) {
                let item; if (itemType === 'warmup') item = Object.values(warmups).flat().find(w => w.name === itemName); else item = exerciseDB.find(ex => ex.name === itemName); if (!item) return;
                currentlyLoggingExercise = item.name; ui.exerciseDetailTitle.textContent = item.name; displayExerciseMedia(item.name);
                const instructions = Array.isArray(item.instructions) ? item.instructions : (item.instructions || "").split('\n'); const instructionsTextarea = ui.exerciseDetailInstructions; instructionsTextarea.value = instructions.join('\n');
                setTimeout(() => { instructionsTextarea.style.height = 'auto'; instructionsTextarea.style.height = (instructionsTextarea.scrollHeight) + 'px'; }, 0);
                document.getElementById('exercise-detail-sets').textContent = item.sets ? `Aim for ${item.sets} sets.` : 'As needed.'; ui.exerciseDetailRepRange.textContent = item.repRange ? `Aim for ${item.repRange}.` : 'No specific rep range.'; ui.exerciseDetailNotes.value = item.notes || '';
                ui.logFromDetailBtn.style.display = itemType === 'warmup' ? 'none' : 'block'; showModal(ui.exerciseDetailModal);
            }
            ui.closeExerciseDetailModalBtn.addEventListener('click', () => hideModal(ui.exerciseDetailModal));
            ui.logFromDetailBtn.addEventListener('click', () => { hideModal(ui.exerciseDetailModal); openWorkoutModal(currentlyLoggingExercise); });
            ui.saveInstructionsBtn.addEventListener('click', () => {
                const btn = ui.saveInstructionsBtn; const textarea = ui.exerciseDetailInstructions;
                if(textarea.disabled){ textarea.disabled = false; btn.textContent = 'Save Changes'; btn.classList.add('btn-primary'); btn.classList.remove('btn-secondary'); textarea.focus(); }
                else { const exIndex = exerciseDB.findIndex(e => e.name === currentlyLoggingExercise); if (exIndex > -1) { exerciseDB[exIndex].instructions = textarea.value.split('\n').filter(line => line.trim() !== ''); saveData(); textarea.disabled = true; btn.textContent = 'Saved!'; btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); setTimeout(() => { btn.textContent = 'Edit Instructions'; }, 2000); } }
            });
            ui.saveExerciseNotesBtn.addEventListener('click', () => { const exIndex = exerciseDB.findIndex(e => e.name === currentlyLoggingExercise); if (exIndex > -1) { exerciseDB[exIndex].notes = ui.exerciseDetailNotes.value; saveData(); const btn = ui.saveExerciseNotesBtn; btn.textContent = 'Saved!'; setTimeout(() => { btn.textContent = 'Save Notes'; }, 2000); } });
            function openEditPlanModal() { /* ... function body remains the same ... */ }
            function renderExercisesForEdit(dayType) { /* ... function body remains the same ... */ }
            function renderWarmupsForEdit(dayType) { /* ... function body remains the same ... */ }
            ui.editPlanBtn.addEventListener('click', openEditPlanModal);
            ui.closeEditPlanModalBtn.addEventListener('click', () => hideModal(ui.editPlanModal));
            ui.editPlanDayTypeSelect.addEventListener('change', (e) => renderExercisesForEdit(e.target.value));
            ui.editPlanWarmupDayTypeSelect.addEventListener('change', (e) => renderWarmupsForEdit(e.target.value));
            ui.editPlanAddExerciseBtn.addEventListener('click', () => { const dayType = ui.editPlanDayTypeSelect.value; if (!dayType) { showCustomAlert("Select Day", "Please select a workout day type first."); return; } libraryModalContext = { purpose: 'edit-plan-add', dayType: dayType, type: 'exercise' }; openExerciseLibrary(); });
            document.getElementById('add-temporary-warmup-btn').addEventListener('click', () => { const dayType = getWorkoutDayType(viewDate); if (!dayType || dayType === 'Rest') { showCustomAlert("Action Not Available", "Cannot add warm-ups to a rest day."); return; } libraryModalContext = { purpose: 'add-temporary', dateKey: dateToKey(viewDate), dayType: dayType, type: 'warmup' }; openExerciseLibrary(); });
            document.getElementById('add-temporary-exercise-btn').addEventListener('click', () => { const dayType = getWorkoutDayType(viewDate); if (!dayType || dayType === 'Rest') { showCustomAlert("Action Not Available", "Cannot add exercises to a rest day."); return; } libraryModalContext = { purpose: 'add-temporary', dateKey: dateToKey(viewDate), dayType: dayType, type: 'exercise' }; openExerciseLibrary(); });
            ui.editPlanExerciseList.addEventListener('click', e => { /* ... function body remains the same ... */ });
            let draggedItem = null; function handleDragStart(e) { /* ... function body remains the same ... */ } function handleDragEnd() { /* ... function body remains the same ... */ } function handleDragOver(e) { /* ... function body remains the same ... */ } function handleDrop(e) { /* ... function body remains the same ... */ } [ui.editPlanExerciseList, ui.editPlanWarmupList].forEach(list => { list.addEventListener('dragstart', handleDragStart); list.addEventListener('dragend', handleDragEnd); list.addEventListener('dragover', handleDragOver); list.addEventListener('drop', handleDrop); }); function getDragAfterElement(container, y) { /* ... function body remains the same ... */ }
            ui.savePlanEditsBtn.addEventListener('click', () => { /* ... function body remains the same ... */ });
            ui.editPlanAddWarmupBtn.addEventListener('click', () => { /* ... function body remains the same ... */ });
            ui.editPlanWarmupList.addEventListener('click', (e) => { /* ... function body remains the same ... */ });
            document.getElementById('warmup-form').addEventListener('submit', (e) => { /* ... function body remains the same ... */ });
            document.getElementById('close-warmup-manage-modal-btn').addEventListener('click', () => hideModal(document.getElementById('warmup-manage-modal')));
            function openCustomExerciseModal(exercise = null) { /* ... function body remains the same ... */ }
            ui.customExerciseAiChoiceBtn.addEventListener('click', () => { /* ... function body remains the same ... */ });
            ui.customExerciseManualChoiceBtn.addEventListener('click', () => { /* ... function body remains the same ... */ });
            ui.closeCustomExerciseModalBtn.addEventListener('click', () => { /* ... function body remains the same ... */ });
            ui.aiGenerateExerciseDetailsBtn.addEventListener('click', async () => { /* ... function body remains the same ... */ });
            document.getElementById('custom-img-upload').addEventListener('change', (e) => { /* ... function body remains the same ... */ });
            function handleSaveCustomExercise(isNewVariation = false) { /* ... function body remains the same ... */ }
            ui.customExerciseForm.addEventListener('submit', (e) => { e.preventDefault(); handleSaveCustomExercise(false); });
            ui.customExerciseActionButtons.addEventListener('click', e => { if(e.target.id === 'save-as-variation-btn'){ handleSaveCustomExercise(true); } });
            ui.createNewExerciseFromLibraryBtn.addEventListener('click', () => { isAddingFromLibrary = true; hideModal(ui.exerciseLibraryModal); openCustomExerciseModal(); });
            document.getElementById('exercise-library-list').addEventListener('click', e => { /* ... function body remains the same ... */ });
            function updateUnitToggleUI(unit) { /* ... function body remains the same ... */ }
            function convertModalWeights(newUnit) { /* ... function body remains the same ... */ }
            ui.unitToggleKg.addEventListener('click', () => convertModalWeights('kg')); ui.unitToggleLbs.addEventListener('click', () => convertModalWeights('lbs')); window.addEventListener('beforeunload', (e) => { if (isLogging) { e.preventDefault(); e.returnValue = ''; } });
            function renderChatHistory() { /* ... function body remains the same ... */ }
            function addMessageToChat(message, sender, isLoading = false) { /* ... function body remains the same ... */ }
            function updateLastMessage(newMessage) { /* ... function body remains the same ... */ }
            async function handleAiChatSend() { /* ... function body remains the same ... */ }
            ui.openWorkoutChatBtn.addEventListener('click', () => { renderChatHistory(); showModal(document.getElementById('ai-workout-chat-modal')); });
            document.getElementById('close-ai-workout-chat-modal-btn').addEventListener('click', () => hideModal(document.getElementById('ai-workout-chat-modal')));
            document.getElementById('ai-chat-send-btn').addEventListener('click', handleAiChatSend);
            document.getElementById('ai-chat-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') handleAiChatSend(); });
            ui.dayNavigationCard.addEventListener('mousedown', handleDayNavPointerDown); ui.dayNavigationCard.addEventListener('touchstart', handleDayNavPointerDown, { passive: true });
            ui.permanentEditOkBtn.addEventListener('click', () => { if (ui.permanentEditDontShowAgain.checked) { userSettings.showPermanentEditWarning = false; saveData(); } hideModal(ui.permanentEditWarningModal); openEditPlanModal(); });
            ui.workoutPlanForDay.addEventListener('dragstart', handlePlanDragStart); ui.workoutPlanForDay.addEventListener('dragend', handlePlanDragEnd); ui.workoutPlanForDay.addEventListener('dragover', handlePlanDragOver); ui.workoutPlanForDay.addEventListener('drop', handlePlanDrop);
            const planTitleElement = document.getElementById('plan-main-title'); planTitleElement.addEventListener('dblclick', () => { /* ... function body remains the same ... */ });
            async function initializeApp() { await loadAllData(); if (!workoutPlan || !workoutPlan.schedule || Object.keys(workoutPlan.schedule).length === 0) { if (exerciseDB.length > 0) { workoutPlan = { name: "Default PPL Plan", schedule: { "Monday": "Push", "Tuesday": "Pull", "Wednesday": "Legs", "Thursday": "Push", "Friday": "Pull", "Saturday": "Legs", "Sunday": "Rest" }, workouts: [ { day: "Push", exercises: ["Bench Press (Dumbbell)", "Overhead Press (Dumbbell)", "Triceps Pushdown", "Tricep Kickback (Dumbbell)", "Front Raise (Dumbbell)", "Plate Squeeze (Svend Press)"] }, { day: "Pull", exercises: ["Lat Pulldown (Cable)", "Seated Cable Row - V Grip (Cable)", "Dumbbell Row", "Bicep Curl (Dumbbell)", "Face Pull", "Shrug (Dumbbell)"] }, { day: "Legs", exercises: ["Squat (Barbell)", "Romanian Deadlift (Barbell)", "Leg Extension (Machine)", "Lying Leg Curl (Machine)", "Standing Calf Raise (Machine)", "Hanging Leg Raise"] } ], restTime: 90 }; saveData(); } } applyTheme(localStorage.getItem('fitTrackAI_theme') || 'dark'); updateUI(); }
            function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('fitTrackAI_theme', theme); updateChartThemeColors(); if (progressChart) progressChart.update(); }
            window.addEventListener('storage', (event) => { if (event.key === 'fitTrackAI_theme') applyTheme(event.newValue || 'dark'); if (event.key === 'fitTrackAI_userSettings') { userSettings = JSON.parse(event.newValue) || { unit: 'kg', showPermanentEditWarning: true }; updateUI(); } });

            // --- Function to open the exercise library ---
            function openExerciseLibrary(group = '', type = 'exercise') {
                const libraryList = document.getElementById('exercise-library-list');
                const exerciseFilterSelect = document.getElementById('exercise-library-filter');
                const warmupFilterSelect = document.getElementById('warmup-library-filter');
                const equipmentFilterSelect = document.getElementById('exercise-library-equipment-filter');
                const searchInput = document.getElementById('exercise-library-search');

                const isWarmupMode = type === 'warmup';

                exerciseFilterSelect.style.display = isWarmupMode ? 'none' : 'block';
                warmupFilterSelect.style.display = isWarmupMode ? 'block' : 'none';
                equipmentFilterSelect.style.display = isWarmupMode ? 'none' : 'block';
                document.getElementById('create-new-exercise-from-library-btn').classList.toggle('hidden', isWarmupMode);

                let libraryToUse;

                if (libraryModalContext.purpose === 'edit-plan-add' || libraryModalContext.purpose === 'add-temporary') {
                    ui.exerciseLibraryTitle.textContent = `Add ${isWarmupMode ? 'Warm-up' : 'Exercise'} to ${libraryModalContext.dayType || 'Today'}`;
                    ui.addSelectedExercisesBtn.textContent = `Add Selected ${isWarmupMode ? 'Warm-ups' : 'Exercises'}`;
                }
                else if (libraryModalContext.purpose === 'manage') { ui.exerciseLibraryTitle.textContent = 'Manage Exercise Library'; ui.addSelectedExercisesBtn.textContent = 'Done'; }
                else { ui.exerciseLibraryTitle.textContent = `Select Preferred Exercises for ${group}`; ui.addSelectedExercisesBtn.textContent = 'Confirm Selection'; }

                if (isWarmupMode) {
                    const allWarmupItems = Object.values(warmups).flat();
                    const ALL_WARMUP_GROUPS = [...new Set(allWarmupItems.map(w => w.group).filter(Boolean))].sort();
                    libraryToUse = [...new Map(allWarmupItems.map(item => [item.name, item])).values()];
                    warmupFilterSelect.innerHTML = '<option value="">All Muscle Groups</option>' + ALL_WARMUP_GROUPS.map(g => `<option value="${g}">${g}</option>`).join('');
                    warmupFilterSelect.value = group || "";
                } else {
                    libraryToUse = exerciseDB;
                    exerciseFilterSelect.innerHTML = '<option value="">All Muscle Groups</option>' + ALL_MUSCLE_GROUPS.map(g => `<option value="${g}">${g}</option>`).join('');
                    equipmentFilterSelect.innerHTML = '<option value="">All Equipment</option>' + ALL_EQUIPMENT_TYPES.map(t => `<option value="${t}">${t}</option>`).join('');
                    exerciseFilterSelect.value = group || "";
                    equipmentFilterSelect.value = "";
                }

                searchInput.value = '';
                const preSelected = libraryModalContext.purpose === 'pref' ? exercisePrefs[group] : undefined;

                const renderLibrary = (muscleFilter = '', search = '', equipmentFilter = '') => {
                    libraryList.innerHTML = libraryToUse
                        .filter(item => {
                            if (isWarmupMode) return (muscleFilter ? item.group === muscleFilter : true) && (search ? item.name.toLowerCase().includes(search.toLowerCase()) : true);
                            else return (muscleFilter ? item.group === muscleFilter : true) && (equipmentFilter ? item.type === equipmentFilter : true) && (search ? item.name.toLowerCase().includes(search.toLowerCase()) : true);
                        })
                        .sort((a,b) => a.name.localeCompare(b.name))
                        .map(item => {
                             const isSelected = (libraryModalContext.purpose === 'add' && false) || (libraryModalContext.purpose === 'pref' && (preSelected === undefined || preSelected.includes(item.name))) || (libraryModalContext.purpose === 'add-temporary' && isWarmupMode && dailyModifications[libraryModalContext.dateKey]?.warmups?.includes(item.name));
                            return `<div class="flex items-center justify-between p-2 rounded-md hover:bg-input-bg group"><label class="flex-grow flex items-center gap-3 cursor-pointer"><input type="checkbox" value="${item.name}" ${isSelected ? 'checked' : ''} class="form-checkbox h-4 w-4 bg-input-bg border-border-color rounded text-blue-500 focus:ring-blue-500"><div><p>${item.name}</p><p class="text-xs text-blue-400">${item.group || (isWarmupMode ? 'Warm-up' : 'N/A')}</p></div></label>${!isWarmupMode ? `<div class="hidden group-hover:flex items-center gap-1"><button class="btn !p-1.5 !bg-transparent edit-exercise-library-btn" data-id="${item.id}" title="Edit"><i data-lucide="pencil" class="w-4 h-4 pointer-events-none"></i></button><button class="btn !p-1.5 !bg-transparent delete-exercise-library-btn" data-id="${item.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 text-red-500/80 pointer-events-none"></i></button></div>` : ''}</div>`;
                        }).join('');
                        lucide.createIcons();
                };
                const renderFilteredLibrary = () => { if (isWarmupMode) renderLibrary(warmupFilterSelect.value, searchInput.value); else renderLibrary(exerciseFilterSelect.value, searchInput.value, equipmentFilterSelect.value); };
                renderFilteredLibrary();
                searchInput.oninput = renderFilteredLibrary; exerciseFilterSelect.onchange = renderFilteredLibrary; equipmentFilterSelect.onchange = renderFilteredLibrary; warmupFilterSelect.onchange = renderFilteredLibrary;
                showModal(ui.exerciseLibraryModal);
            };

            // --- INITIALIZATION ---
            initializeApp();
        }
        // --- End Original script ---

        // Initialize layout and page logic on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeLayout);
    </script>

</body>
</html>