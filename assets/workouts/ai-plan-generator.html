<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kowbi | AI Plan Generator</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide icons via CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Font: Manrope -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Shared dark theme variables from other app files */
        :root {
            --background: #000000;
            --primary-text: #eaeaea;
            --secondary-text: #888888;
            --card-bg: #111111;
            --input-bg: #191919;
            --border-color: #222222;
            --accent: #FFFFFF;
            --accent-hover: #DDDDDD; /* Added hover for consistency */
            --danger: #E53E3E; /* Added danger color */
            --nav-footer-height: 64px; /* Footer nav height */
            --validation-error: #F87171; /* red-400 */
        }

        html, body {
            overscroll-behavior-y: contain;
            /* Ensure content has room above the fixed footer */
            padding-bottom: var(--nav-footer-height);
        }

        body {
            background-color: var(--background);
            color: var(--primary-text);
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        /* Footer Nav Styles (copied from index.html) */
        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            height: 100%;
            transition: color 0.3s ease;
            color: var(--primary-text); /* UPDATED: Changed from secondary-text to primary-text */
            font-size: 0.75rem;
            text-decoration: none;
            padding-top: 4px;
        }
        .nav-link:hover { color: var(--accent); } /* Hover uses accent */
        .nav-link.active { color: #60a5fa; } /* UPDATED: Changed to blue for active link */
        .nav-link.active .nav-icon { color: #60a5fa; } /* UPDATED: Changed to blue for active icon */
        .nav-icon { color: var(--primary-text); margin-bottom: 2px; width: 24px; height: 24px; } /* UPDATED: Changed from accent to primary-text */
        #mobile-footer-nav { background-color: var(--background); } /* Match page background */
        /* End Footer Nav Styles */


        /* Content Card Style */
        .content-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem; /* Consistent padding */
            overflow: hidden; /* Added for wizard */
        }

        /* Form Element Styles */
        .form-input, .form-select, .form-textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--primary-text);
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent); /* Consistent focus ring */
        }
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .form-label {
            color: var(--secondary-text);
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            width: 100%;
        }
        /* Required field indicator */
        .form-label.required::after {
            content: '*';
            color: var(--validation-error);
            margin-left: 0.25rem;
            font-weight: bold;
        }
        /* Help Icon */
        .help-icon { color: var(--secondary-text); cursor: help; }

        /* Button Styles (consistent with app) */
        .btn { border-radius: 0.5rem; font-weight: 600; padding: 0.75rem 1.5rem; transition: all 0.2s ease-in-out; text-align: center; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transform: translateY(0); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: translateY(0); }
        .btn-primary { background-color: var(--accent); color: var(--background); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); }
        .btn-secondary { background-color: transparent; border: 1px solid var(--border-color); color: var(--primary-text); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--border-color); border-color: var(--accent); /* Added accent border on hover */ }
        .btn-icon-sm { padding: 0.25rem; border-radius: 0.375rem; background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--secondary-text); }
        .btn-icon-sm:hover { background-color: #2a2a2a; color: var(--primary-text); }

        /* Checkbox & Radio Styles */
        .form-checkbox, .form-radio { height: 1rem; width: 1rem; background-color: var(--input-bg); border: 1px solid var(--border-color); color: #3B82F6; flex-shrink: 0; }
        .form-checkbox:checked, .form-radio:checked { background-color: #3B82F6; border-color: #3B82F6; }
        .form-checkbox { border-radius: 0.25rem; }
        .form-radio { border-radius: 9999px; }

        /* Image-based radio buttons */
        .img-radio-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.75rem; }
        .img-radio-label { display: block; cursor: pointer; border-radius: 0.5rem; transition: all 0.2s; background-color: var(--input-bg); }
        .img-radio-label > div { border: 2px solid var(--border-color); border-radius: 0.375rem; transition: all 0.2s; overflow: hidden; padding: 0.5rem; } /* Added padding inside */
        .img-radio-label img { width: 100%; height: 60px; /* Reduced height slightly */ object-fit: cover; background-color: #333; border-radius: 0.25rem; /* Inner radius */ }
        .img-radio-label span { display: block; text-align: center; font-size: 0.75rem; margin-top: 0.5rem; color: var(--secondary-text); padding: 0 0.25rem 0.25rem; }
        .img-radio-label input { display: none; }
        .img-radio-label input:checked + div { border-color: var(--accent); background-color: #222; }
        .img-radio-label input:checked + div span { color: var(--primary-text); font-weight: 600; }

        /* Modal styles (consistent with app) */
        .modal-backdrop { display: none; position: fixed; z-index: 100; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; padding: 1rem; animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--card-bg); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 0.75rem; width: 95%; max-width: 550px; max-height: 90vh; display: flex; flex-direction: column; animation: slideIn 0.3s ease; }
        .modal-body { overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 0.5rem; margin-right: -0.5rem; }
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: var(--input-bg); border-radius: 3px; }
        .modal-body::-webkit-scrollbar-thumb { background-color: #444; border-radius: 3px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background-color: #666; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Loader */
        .loader { border: 2px solid #333; border-top: 2px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Split List Item */
        .split-list-item { display: flex; align-items: center; justify-content: space-between; background-color: var(--input-bg); padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color); }

        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--input-bg); border: 1px solid var(--border-color); transition: .4s; border-radius: 20px; }
        .toggle-slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: var(--secondary-text); transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #3B82F6; border-color: #3B82F6; }
        input:checked + .toggle-slider:before { background-color: white; transform: translateX(14px); }

        /* Validation Error Styles */
        .error-message { color: var(--validation-error); font-size: 0.75rem; margin-top: 0.25rem; display: none; /* Hidden by default */ }
        .input-error { border-color: var(--validation-error) !important; } /* Use !important to override focus */
        .input-error:focus { box-shadow: 0 0 0 2px color-mix(in srgb, var(--validation-error) 30%, transparent) !important; }
        .checkbox-group-error > label, .radio-group-error > label { border: 1px dashed var(--validation-error) !important; }
        .img-radio-group.input-error { border: 2px dashed var(--validation-error) !important; padding: 0.5rem; border-radius: 0.5rem; }

        /* --- NEW WIZARD STYLES --- */
        /* Page container */
        .wizard-page {
            display: none; /* Pages are hidden by default */
        }
        .wizard-page.active {
            display: block; /* Active page is shown */
        }

        /* Wizard navigation bar */
        .wizard-nav {
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: var(--input-bg);
            border-radius: 99px;
            height: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--accent);
            border-radius: 99px;
            width: 0%; /* Controlled by JS */
            transition: width 0.3s ease-in-out;
        }
        .progress-text {
            color: var(--secondary-text);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Review Page Styles */
        #review-summary-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #review-summary-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        #review-summary-list li:last-child {
            border-bottom: none;
        }
        #review-summary-list .review-label {
            color: var(--secondary-text);
            font-size: 0.875rem;
            font-weight: 500;
        }
        #review-summary-list .review-value {
            color: var(--primary-text);
            font-size: 0.875rem;
            font-weight: 600;
            text-align: right;
            max-width: 60%;
        }

    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-7xl px-4 py-6">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8 pb-4 border-b border-border-color">
             <a href="index.html" class="flex items-center gap-3">
                <svg width="100" height="24" viewBox="0 0 100 24" fill="#FFFFFF" xmlns="http://www.w3.org/2000/svg" style="height: 24px; width: auto;">
                    <style>
                        .logo-text { font-family: 'Manrope', sans-serif; font-size: 20px; font-weight: 700; letter-spacing: 0.05em; fill: var(--primary-text); } /* Dynamic fill */
                        .logo-fill { fill: var(--primary-text); } /* Dynamic fill */
                        .logo-stroke { stroke: var(--primary-text); } /* Dynamic stroke */
                        .logo-bg { fill: var(--background); } /* Dynamic background for smiley */
                        .halo-text { font-family: 'Manrope', sans-serif; font-size: 4px; font-weight: 500; fill: var(--primary-text); } /* Dynamic fill */
                    </style>
                    <text x="6" y="19" class="logo-text">K</text>
                    <circle cx="28" cy="12" r="7" class="logo-fill"/>
                    <circle cx="25" cy="10" r="1.5" class="logo-bg"/>
                    <circle cx="31" cy="10" r="1.5" class="logo-bg"/>
                    <ellipse cx="28" cy="2" rx="6" ry="1" class="logo-stroke" stroke-width="0.8" fill="none"/>
                    <text x="25.5" y="8" class="halo-text"></text>
                    <text x="37" y="19" class="logo-text">WBI</text>
                </svg>
            </a>
        </header>

        <!-- Main Content -->
        <main class="max-w-3xl mx-auto"> <!-- Centered content area -->
            <div class="content-card">

                <!-- Main Form Panel -->
                <div id="ai-plan-panel">
                    <!-- Form wraps everything to capture all inputs for localStorage saving -->
                    <form id="ai-plan-generator-form" class="space-y-4">

                        <!-- ====== START: WIZARD HEADER (PROGRESS) ====== -->
                        <div id="wizard-header" class="mb-6 space-y-2">
                             <div class="flex justify-between items-center">
                                <h2 id="wizard-title" class="text-2xl font-bold">AI Workout Plan Generator</h2>
                                <span id="wizard-progress-text" class="progress-text">Step 1 of 6</span>
                             </div>
                             <div class="progress-bar-container">
                                <div id="wizard-progress-fill" class="progress-bar-fill"></div>
                             </div>
                        </div>
                        <!-- ====== END: WIZARD HEADER ====== -->


                        <!-- ====== START: PAGE 1 (Core Stats) ====== -->
                        <div id="page-1" class="wizard-page active">
                            <div class="text-center mb-6">
                                <h3 class="text-xl font-semibold">Welcome! Let's get your details.</h3>
                                <p class="text-sm text-secondary-text mt-1">Fill in your core stats to get started.</p>
                            </div>

                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="ai-plan-current-weight" class="form-label required">Current Weight</label>
                                        <input type="number" id="ai-plan-current-weight" min="1" step="any" class="form-input" placeholder="e.g., 80" required>
                                        <p class="error-message" id="error-current-weight">Please enter your current weight.</p>
                                    </div>
                                    <div>
                                        <label for="ai-plan-ideal-weight" class="form-label required">Ideal Weight</label>
                                        <input type="number" id="ai-plan-ideal-weight" min="1" step="any" class="form-input" placeholder="e.g., 75" required>
                                         <p class="error-message" id="error-ideal-weight">Please enter your ideal weight.</p>
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label required">What best matches your current body type?</label>
                                    <div class="img-radio-group radio-group-error mt-2" id="body-type-group">
                                        <!-- Image radio buttons -->
                                        <label class="img-radio-label"><input type="radio" name="body-type" value="Slender"><div><img src="https://placehold.co/100x60/333/555?text=Slender" alt="Slender body type" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>Slender</span></div></label>
                                        <label class="img-radio-label"><input type="radio" name="body-type" value="Slender and soft"><div><img src="https://placehold.co/100x60/333/555?text=Slender+Soft" alt="Slender and soft body type" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>Slender & Soft</span></div></label>
                                        <label class="img-radio-label"><input type="radio" name="body-type" value="Defined"><div><img src="https://placehold.co/100x60/333/555?text=Defined" alt="Defined body type" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>Defined</span></div></label>
                                        <label class="img-radio-label"><input type="radio" name="body-type" value="Athletic"><div><img src="https://placehold.co/100x60/333/555?text=Athletic" alt="Athletic body type" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>Athletic</span></div></label>
                                        <label class="img-radio-label"><input type="radio" name="body-type" value="Bulky"><div><img src="https://placehold.co/100x60/333/555?text=Bulky" alt="Bulky body type" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>Bulky</span></div></label>
                                        <label class="img-radio-label"><input type="radio" name="body-type" value="Soft and heavy"><div><img src="https://placehold.co/100x60/333/555?text=Soft+Heavy" alt="Soft and heavy body type" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>Soft & Heavy</span></div></label>
                                    </div>
                                    <p class="error-message" id="error-body-type">Please select your body type.</p>
                                </div>

                                <div>
                                    <label class="form-label required">
                                        <span>Which image best reflects your current body fat level?</span>
                                        <span title="These are visual estimates. Choose the image that most closely resembles your current physique." class="help-icon"><i data-lucide="help-circle" class="w-3.5 h-3.5"></i></span>
                                    </label>
                                    <div class="grid grid-cols-2 gap-4 mt-2">
                                        <p class="text-sm text-secondary-text col-span-2 md:col-span-1">Appearance examples (Male):</p>
                                        <p class="text-sm text-secondary-text col-span-2 md:col-span-1">Appearance examples (Female):</p>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="body-fat-container">
                                        <div id="body-fat-group-1" class="img-radio-group radio-group-error mt-1">
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="10-12%"><div><img src="https://placehold.co/100x60/333/555?text=~10-12%25" alt="10-12% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>10-12%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="15%"><div><img src="https://placehold.co/100x60/333/555?text=~15%25" alt="15% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>15%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="20%"><div><img src="https://placehold.co/100x60/333/555?text=~20%25" alt="20% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>20%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="25%"><div><img src="https://placehold.co/100x60/333/555?text=~25%25" alt="25% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>25%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="30%"><div><img src="https://placehold.co/100x60/333/555?text=~30%25" alt="30% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>30%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="35-40%"><div><img src="https://placehold.co/100x60/333/555?text=~35-40%25" alt="35-40% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>35-40%</span></div></label>
                                        </div>
                                        <div id="body-fat-group-2" class="img-radio-group radio-group-error mt-1">
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="15-17%"><div><img src="https://placehold.co/100x60/333/555?text=~15-17%25" alt="15-17% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>15-17%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="20-22%"><div><img src="https://placehold.co/100x60/333/555?text=~20-22%25" alt="20-22% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>20-22%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="25%"><div><img src="https://placehold.co/100x60/333/555?text=~25%25" alt="25% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>25%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="30%"><div><img src="https://placehold.co/100x60/333/555?text=~30%25" alt="30% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>30%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="35%"><div><img src="https://placehold.co/100x60/333/555?text=~35%25" alt="35% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>35%</span></div></label>
                                            <label class="img-radio-label"><input type="radio" name="body-fat" value="40-45%"><div><img src="https://placehold.co/100x60/333/555?text=~40-45%25" alt="40-45% body fat example" onerror="this.onerror=null; this.src='https://placehold.co/100x60/333/555?text=Img';"><span>40-45%</span></div></label>
                                        </div>
                                    </div>
                                    <p class="error-message" id="error-body-fat">Please select your estimated body fat level.</p>
                                </div>

                                <!-- MOVED ITEM HERE -->
                                <div class="pt-4 border-t border-border-color">
                                    <label for="ai-plan-trouble-spots" class="form-label">What area(s) are the most difficult to lose fat from? (Optional)</label>
                                    <input type="text" id="ai-plan-trouble-spots" class="form-input" placeholder="e.g., Lower belly, thighs">
                                </div>
                            </div>
                        </div>
                        <!-- ====== END: PAGE 1 ====== -->


                        <!-- ====== START: PAGE 2 (Goals & Experience) ====== -->
                        <div id="page-2" class="wizard-page">
                            <div class="text-center mb-6">
                                <h3 class="text-xl font-semibold">Your Goals & Experience</h3>
                                <p class="text-sm text-secondary-text mt-1">What do you want to achieve?</p>
                            </div>

                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="ai-plan-goal" class="form-label required">Primary Goal</label>
                                        <select id="ai-plan-goal" class="form-select" required>
                                            <option value="">-- Select Goal --</option>
                                            <option value="muscle hypertrophy">Muscle Hypertrophy</option>
                                            <option value="fat loss">Fat Loss</option>
                                            <option value="body recomposition">Body Recomposition</option>
                                            <option value="general fitness">General Fitness</option>
                                            <option value="strength gain">Strength Gain</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                        <p class="error-message" id="error-goal">Please select your primary goal.</p>
                                    </div>
                                    <div id="ai-plan-goal-text-container" class="hidden">
                                        <label for="ai-plan-goal-text" class="form-label required">Describe Your Custom Goal</label>
                                        <textarea id="ai-plan-goal-text" rows="2" class="form-textarea" placeholder="e.g., 'I want to build bigger arms and get a six-pack.'"></textarea>
                                        <p class="error-message" id="error-goal-text">Please describe your custom goal.</p>
                                    </div>
                                    <div>
                                        <label for="ai-plan-training-history" class="form-label required">Training History</label>
                                        <select id="ai-plan-training-history" class="form-select" required>
                                            <option value="">-- Select Experience --</option>
                                            <option value="Just starting">Just starting (new to fitness)</option>
                                            <option value="< 6 months">&lt; 6 months</option>
                                            <option value="6-12 months">6-12 months</option>
                                            <option value="1+ years">1+ years</option>
                                            <option value="3+ years">3+ years (Advanced)</option>
                                        </select>
                                        <p class="error-message" id="error-training-history">Please select your training experience.</p>
                                    </div>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                    <label class="form-label">
                                        <span>Goal Timeline</span>
                                        <span title="Check this if you have a specific deadline (e.g., an event in 8 weeks). The AI will adjust intensity. Leave unchecked for a more general, sustainable plan." class="help-icon"><i data-lucide="help-circle" class="w-3.5 h-3.5"></i></span>
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-secondary-text">Optimize for a specific timeline?</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="ai-plan-optimize-timeline-toggle">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div id="ai-plan-optimize-timeline-input" class="hidden mt-2">
                                        <label for="ai-plan-timeline-weeks" class="form-label required">Desired Timeline (in weeks)</label>
                                        <input type="number" id="ai-plan-timeline-weeks" min="4" step="1" class="form-input" placeholder="e.g., 8">
                                        <p class="error-message" id="error-timeline-weeks">Timeline must be at least 4 weeks.</p>
                                    </div>
                                </div>

                                <div>
                                    <label for="ai-plan-knowledge-level" class="form-label required">How familiar are you with fitness/nutrition science?</label>
                                    <select id="ai-plan-knowledge-level" class="form-select" required>
                                        <option value="">-- Select Level --</option>
                                        <option value="Beginner">Beginner (Explain it simply)</option>
                                        <option value="Intermediate">Intermediate (I know the basics)</option>
                                        <option value="Advanced">Advanced (Use technical terms)</option>
                                    </select>
                                    <p class="error-message" id="error-knowledge-level">Please select your knowledge level.</p>
                                </div>

                                <div>
                                    <label class="form-label">Have you attempted any of the following in the past? (Optional)</label>
                                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-2">
                                        <label class="flex items-center gap-2"><input type="checkbox" name="past-attempts" value="Weight loss" class="form-checkbox"><span class="text-sm">Weight loss</span></label>
                                        <label class="flex items-center gap-2"><input type="checkbox" name="past-attempts" value="Muscle gain" class="form-checkbox"><span class="text-sm">Muscle gain</span></label>
                                        <label class="flex items-center gap-2"><input type="checkbox" name="past-attempts" value="Personal trainer" class="form-checkbox"><span class="text-sm">Personal trainer</span></label>
                                        <label class="flex items-center gap-2"><input type="checkbox" name="past-attempts" value="Specific diet (keto, etc)" class="form-checkbox"><span class="text-sm">Specific diet (keto, etc)</span></label>
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label">Do you currently use a workout tracking app? (Optional)</label>
                                    <div class="flex gap-4 mt-2">
                                        <label class="flex items-center gap-2"><input type="radio" name="tracking-app" value="yes" class="form-radio"><span class="text-sm">Yes</span></label>
                                        <label class="flex items-center gap-2"><input type="radio" name="tracking-app" value="no" class="form-radio" checked><span class="text-sm">No</span></label>
                                    </div>
                                    <div id="ai-plan-tracking-app-details" class="hidden space-y-3 mt-3">
                                        <label for="ai-plan-tracking-app-name" class="form-label required">Which app?</label>
                                        <input type="text" id="ai-plan-tracking-app-name" class="form-input" placeholder="e.g., FitNotes">
                                        <p class="error-message" id="error-tracking-app-name">Please enter the app name.</p>
                                        <label for="ai-plan-tracking-follow-up" class="form-label">Would you like to continue with a similar program or try this new personalized one?</label>
                                        <select id="ai-plan-tracking-follow-up" class="form-select">
                                            <option value="Try new">Try this new personalized one</option>
                                            <option value="Similar">Continue with a similar program</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ====== END: PAGE 2 ====== -->


                        <!-- ====== START: PAGE 3 (Schedule & Split) ====== -->
                        <div id="page-3" class="wizard-page">
                            <div class="text-center mb-6">
                                <h3 class="text-xl font-semibold">Your Schedule & Split</h3>
                                <p class="text-sm text-secondary-text mt-1">When can you work out?</p>
                            </div>

                            <div class="space-y-4">
                                <!-- MOVED SPLIT TEMPLATE HERE -->
                                <div class="pt-4 border-t border-border-color">
                                    <label for="ai-plan-split-select" class="form-label required">Split Template</label>
                                    <select id="ai-plan-split-select" class="form-select" required>
                                        <option value="">-- Select Split --</option>
                                        <option value="Push, Pull, Legs">Push, Pull, Legs</option>
                                        <option value="Upper, Lower">Upper, Lower</option>
                                        <option value="Full Body">Full Body</option>
                                        <option value="Custom">Custom...</option>
                                    </select>
                                    <p class="error-message" id="error-split-select">Please select a split template.</p>
                                </div>
                                <div id="ai-plan-custom-split-container" class="hidden space-y-3 p-4 border border-dashed border-gray-700 rounded-lg">
                                    <label class="form-label required">Custom Split Days</label>
                                    <div id="custom-split-list" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-1"></div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="new-custom-split-name" class="form-input" placeholder="e.g., Chest & Back">
                                        <button type="button" id="add-custom-split-btn" class="btn-icon-sm flex-shrink-0"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                    </div>
                                    <p class="error-message" id="error-custom-split">Please add at least one custom split day.</p>
                                </div>
                                <div>
                                    <label class="flex items-center gap-2 mt-2">
                                        <input type="checkbox" id="ai-plan-ab-toggle" class="form-checkbox">
                                        <span class="text-sm">Create A/B day variations?</span>
                                        <span title="Creates two different workouts for each split type (e.g., Push A, Push B) to add variety if you train a muscle group multiple times per week." class="help-icon"><i data-lucide="help-circle" class="w-3.5 h-3.5"></i></span>
                                    </label>
                                </div>
                                <!-- END MOVED SPLIT TEMPLATE -->

                                <!-- MOVED SCHEDULE TYPE TO TOP AND REMOVED CHECKBOXES -->
                                <div class="pt-4 border-t border-border-color">
                                    <label for="ai-plan-schedule-type" class="form-label required">
                                        <span>Define Your Weekly Schedule</span>
                                        <span title="Weekly: Assigns specific workout types (e.g., Push A) to fixed days (e.g., Monday). Cyclic: Assigns workout types to weekdays, and the sequence rotates each week (e.g., Mon=Push, Tue=Pull, Wed=Legs, Thu=Rest, Fri=Push... next Mon=Pull)." class="help-icon"><i data-lucide="help-circle" class="w-3.5 h-3.5"></i></span>
                                    </label>
                                    <select id="ai-plan-schedule-type" class="form-select">
                                        <option value="weekly">Weekly (Fixed Days)</option>
                                        <option value="cyclic">Cyclic (Rolling Split)</option>
                                    </select>
                                </div>
                                <div id="ai-plan-weekly-schedule-container">
                                    <p class="text-xs text-secondary-text">Click each day below to assign a workout type (or Rest/Cardio). This defines your weekly availability.</p>
                                    <div id="ai-plan-schedule-builder" class="grid grid-cols-4 sm:grid-cols-7 gap-2 mt-2 checkbox-group-error"></div> <!-- Added error class target -->
                                </div>
                                <div id="ai-plan-cyclic-schedule-container" class="hidden space-y-3">
                                    <p class="text-xs text-secondary-text">Click weekdays below to assign workout types. The split sequence will automatically cycle week to week based on these assignments.</p>
                                    <div id="ai-plan-cycle-builder" class="grid grid-cols-4 sm:grid-cols-7 gap-2 mt-2 checkbox-group-error"></div> <!-- Added error class target -->
                                </div>
                                <p class="error-message" id="error-schedule">Please assign at least one workout day in the schedule.</p>

                                <!-- REMOVED AVAILABILITY CHECKBOXES -->

                                <div class="pt-4 border-t border-border-color">
                                    <label for="ai-plan-schedule-constraints" class="form-label required">How busy are you typically?</label>
                                    <select id="ai-plan-schedule-constraints" class="form-select" required>
                                        <option value="">-- Select --</option>
                                        <option value="Very busy">Very busy (need short, efficient workouts)</option>
                                        <option value="Balanced">Balanced (can make time)</option>
                                        <option value="Lots of free time">Lots of free time (open to longer workouts)</option>
                                    </select>
                                    <p class="error-message" id="error-schedule-constraints">Please select how busy you are.</p>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                    <label for="ai-plan-activity-level" class="form-label required">Daily Activity Level (non-exercise)</label>
                                    <select id="ai-plan-activity-level" class="form-select" required>
                                        <option value="">-- Select --</option>
                                        <option value="Sedentary">Sedentary (desk job)</option>
                                        <option value="Lightly Active">Lightly Active (some walking)</option>
                                        <option value="Active">Active (on your feet most of the day)</option>
                                        <option value="Very Active">Very Active (physical labor, etc.)</option>
                                    </select>
                                    <p class="error-message" id="error-activity-level">Please select your activity level.</p>
                                </div>
                            </div>
                        </div>
                        <!-- ====== END: PAGE 3 ====== -->


                        <!-- ====== START: PAGE 4 (Equipment & Preferences) ====== -->
                        <div id="page-4" class="wizard-page">
                            <div class="text-center mb-6">
                                <h3 class="text-xl font-semibold">Your Equipment & Preferences</h3>
                                <p class="text-sm text-secondary-text mt-1">What do you have available, and what do you prefer?</p>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="form-label required">Equipment Available</label>
                                        <div class="flex gap-2">
                                            <button type="button" class="text-xs text-blue-400 hover:underline select-all-btn" data-target="ai-plan-equipment-container">All</button>
                                            <button type="button" class="text-xs text-blue-400 hover:underline deselect-all-btn" data-target="ai-plan-equipment-container">None</button>
                                        </div>
                                    </div>
                                    <div id="ai-plan-equipment-container" class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2 mt-2 max-h-40 overflow-y-auto border border-border-color p-2 rounded-md checkbox-group-error"></div>
                                    <p class="error-message" id="error-equipment">Please select at least one piece of equipment.</p>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="form-label">Focus Muscle Groups (Optional)</label>
                                        <div class="flex gap-2">
                                            <button type="button" class="text-xs text-blue-400 hover:underline select-all-btn" data-target="ai-plan-focus-muscle-container">All</button>
                                            <button type="button" class="text-xs text-blue-400 hover:underline deselect-all-btn" data-target="ai-plan-focus-muscle-container">Clear</button>
                                        </div>
                                    </div>
                                    <div id="ai-plan-focus-muscle-container" class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2 mt-2 max-h-40 overflow-y-auto border border-border-color p-2 rounded-md"></div>
                                    <p class="text-xs text-secondary-text mt-1">Select groups you want to emphasize. Leave all checked for a balanced plan.</p>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                    <label class="form-label">
                                        <span>Main Compound Lift Comfort</span>
                                        <span title="Select your comfort level with standard barbell Squats, Bench Press, and Deadlifts. Choose 'Avoid' for injuries, or 'Prefer...' if you'd rather use alternatives." class="help-icon"><i data-lucide="help-circle" class="w-3.5 h-3.5"></i></span>
                                    </label>
                                    <p class="text-xs text-secondary-text mb-2">How comfortable are you with the "big 3"?</p>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label for="ai-plan-comfort-squat" class="form-label text-sm">Squat (Barbell)</label>
                                            <select id="ai-plan-comfort-squat" class="form-select">
                                                <option value="comfortable">Comfortable</option>
                                                <option value="needs work">Needs form work</option>
                                                <option value="avoid">Avoid (e.g., injury)</option>
                                                <option value="prefer dumbbell">Prefer Dumbbell/Machine</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="ai-plan-comfort-bench" class="form-label text-sm">Bench Press (Barbell)</label>
                                            <select id="ai-plan-comfort-bench" class="form-select">
                                                <option value="comfortable">Comfortable</option>
                                                <option value="needs work">Needs form work</option>
                                                <option value="avoid">Avoid (e.g., injury)</option>
                                                <option value="prefer dumbbell">Prefer Dumbbell/Machine</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="ai-plan-comfort-deadlift" class="form-label text-sm">Deadlift (Barbell)</label>
                                            <select id="ai-plan-comfort-deadlift" class="form-select">
                                                <option value="comfortable">Comfortable</option>
                                                <option value="needs work">Needs form work</option>
                                                <option value="avoid">Avoid (e.g., injury)</option>
                                                <option value="prefer dumbbell">Prefer Dumbbell/Trap Bar</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                    <label class="form-label">Disliked Exercises (Optional)</label>
                                    <button type="button" id="manage-disliked-exercises-btn" class="btn btn-secondary w-full">
                                        <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                                        Select Disliked Exercises
                                    </button>
                                    <p id="disliked-exercises-display" class="text-xs text-secondary-text mt-2">No exercises disliked yet.</p>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                    <label for="ai-plan-avoidances" class="form-label">Injuries / Movements to Avoid (Optional)</label>
                                    <input type="text" id="ai-plan-avoidances" class="form-input" placeholder="e.g., bad knees, avoid jumping, lower back pain">
                                </div>
                                <div class="pt-4 border-t border-border-color">
                                    <label class="flex items-center gap-2 mt-2">
                                        <input type="checkbox" id="ai-plan-joint-friendly" class="form-checkbox">
                                        <span class="text-sm">Prioritize Joint-Friendly Exercises (e.g., machines over free weights)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- ====== END: PAGE 4 ====== -->


                        <!-- ====== START: PAGE 5 (Fine-Tuning) ====== -->
                        <div id="page-5" class="wizard-page">
                            <div class="text-center mb-6">
                                <h3 class="text-xl font-semibold">Fine-Tuning</h3>
                                <p class="text-sm text-secondary-text mt-1">Adjust the details of your plan.</p>
                            </div>

                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="ai-plan-duration" class="form-label required">Default Duration (minutes)</label>
                                        <input type="number" id="ai-plan-duration" value="60" min="10" step="5" class="form-input" required>
                                        <p class="error-message" id="error-duration">Duration must be at least 10 minutes.</p>
                                        <button type="button" id="customize-duration-btn" class="text-sm text-blue-400 hover:underline mt-2">Customize per day/type (Optional)</button>
                                        <div id="ai-plan-durations-container" class="space-y-2 mt-2 hidden"></div>
                                    </div>
                                    <div>
                                        <!-- MODIFIED: Label, input, and validation -->
                                        <label for="ai-plan-rest" class="form-label required">Default Rest Between Sets (seconds)</label>
                                        <input type="number" id="ai-plan-rest" value="90" step="15" min="30" class="form-input" required>
                                        <p class="error-message" id="error-rest">Rest must be at least 30 seconds.</p>
                                        <p class="text-xs text-secondary-text mt-1">e.g., 90 = 1.5 minutes. AI may adjust based on exercise.</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-border-color">
                                    <div>
                                        <label class="form-label required">Warmup / Cooldown Duration</label>
                                        <div class="space-y-2 mt-1">
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="ai-plan-warmup-duration" min="0" step="1" value="5" class="form-input !w-20 !py-1 text-center" required>
                                                <label for="ai-plan-warmup-duration" class="text-sm">minutes Warmup</label>
                                            </div>
                                            <p class="error-message !mt-0" id="error-warmup-duration">Warmup cannot be negative.</p>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="ai-plan-cooldown-duration" min="0" step="1" value="5" class="form-input !w-20 !py-1 text-center" required>
                                                <label for="ai-plan-cooldown-duration" class="text-sm">minutes Cooldown</label>
                                            </div>
                                            <p class="error-message !mt-0" id="error-cooldown-duration">Cooldown cannot be negative.</p>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="ai-plan-cardio" class="form-label">Cardio Integration (Optional)</label>
                                        <select id="ai-plan-cardio" class="form-select">
                                            <option value="None">None (Cardio handled by schedule)</option>
                                            <option value="pre-workout">Add specific cardio before workouts</option>
                                            <option value="post-workout">Add specific cardio after workouts</option>
                                            <option value="mid-workout">Suggest cardio during workout (AI choice)</option>
                                        </select>
                                        <p class="text-xs text-secondary-text mt-1">Select 'None' if you prefer dedicated Cardio days set in the schedule.</p>
                                    </div>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                    <label class="form-label">Exercise Preferences (Optional)</label>
                                    <p class="text-xs text-secondary-text">Specify exercises you prefer for specific muscle groups. If none selected for a group, AI will choose based on equipment/goals.</p>
                                    <div id="ai-plan-exercise-prefs-container" class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2"></div>
                                </div>
                                <div class="pt-4 border-t border-border-color">
                                    <label class="form-label">Custom Exercises / Variations (Optional)</label>
                                    <button type="button" id="manage-custom-exercises-btn" class="btn btn-secondary w-full mt-1">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                        Manage Custom Exercises & Variations
                                    </button>
                                    <div id="custom-exercise-display" class="text-xs text-secondary-text mt-2">No custom exercises added.</div>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                     <label class="form-label">Advanced: Target Sets (Optional)</label>
                                    <p class="text-xs text-secondary-text mb-2">Override AI's set volume recommendations. Leave blank to let AI decide based on goal and experience.</p>
                                    <div class="mb-4">
                                        <label for="ai-plan-default-sets" class="form-label">Default Sets Per Muscle Group Per Week</label>
                                        <input type="number" id="ai-plan-default-sets" min="0" step="1" class="form-input" placeholder="Auto (Recommended)">
                                        <p class="error-message !mt-0" id="error-default-sets">Default sets cannot be negative.</p>
                                        <button type="button" id="customize-sets-btn" class="text-sm text-blue-400 hover:underline mt-2">Customize per muscle group</button>
                                    </div>
                                    <div id="ai-plan-sets-container" class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 hidden"></div>
                                </div>
                            </div>
                        </div>
                        <!-- ====== END: PAGE 5 ====== -->


                        <!-- ====== START: PAGE 6 (Review & Generate) ====== -->
                        <div id="page-6" class="wizard-page">
                            <div class="text-center mb-6">
                                <h3 class="text-xl font-semibold">Ready to Go!</h3>
                                <p class="text-sm text-secondary-text mt-1">Review your details below and click Generate.</p>
                            </div>

                            <div class="space-y-4">
                                <div class="p-4 border border-border-color rounded-lg bg-input-bg/50">
                                    <h4 class="font-semibold text-lg mb-2">Your Summary</h4>
                                    <ul id="review-summary-list">
                                        <!-- Summary items will be populated by JS -->
                                    </ul>
                                </div>

                                <div class="pt-4 border-t border-border-color">
                                    <label for="ai-plan-nutrition-consistency" class="form-label">Any final notes for the AI? (Optional)</label>
                                    <textarea id="ai-plan-nutrition-consistency" rows="2" class="form-textarea" placeholder="e.g., 'I'm great with workouts but struggle with late-night snacking.' or 'I really want to focus on my arms.'"></textarea>
                                    <!-- MOVED TROUBLE SPOTS TO PAGE 1 -->
                                </div>
                            </div>
                        </div>
                        <!-- ====== END: PAGE 6 ====== -->


                        <!-- ====== START: WIZARD NAVIGATION ====== -->
                        <div class="wizard-nav">
                            <button type="button" id="wizard-prev-btn" class="btn btn-secondary">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                Previous
                            </button>

                            <!-- This button type changes to "submit" on the last page -->
                            <button type="button" id="wizard-next-btn" class="btn btn-primary">
                                <span>Next</span>
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>

                            <!-- The real submit button, hidden until the last page -->
                            <button type="submit" id="wizard-submit-btn" class="btn btn-primary hidden w-full">
                                <span class="btn-text">Generate My Plan</span>
                                <div class="loader hidden"></div>
                            </button>
                        </div>
                        <!-- ====== END: WIZARD NAVIGATION ====== -->

                    </form>

                    <!-- ====== START: OUTPUT PANEL (PAGE 7) ====== -->
                    <div id="page-7" class="wizard-page mt-6">
                        <div class="text-center mb-6">
                            <h3 class="text-xl font-semibold">Your New Workout Plan!</h3>
                        </div>
                        <div id="ai-plan-timeline-output" class="text-sm p-3 bg-blue-900/30 border border-blue-500 text-blue-200 rounded-lg mb-4 hidden"></div>
                        <div id="ai-plan-explanation" class="text-sm p-3 bg-black/30 rounded-lg mb-4"></div>
                        <pre id="ai-plan-json-output" class="hidden"></pre>

                        <div class="wizard-nav">
                             <button type="button" id="start-over-btn" class="btn btn-secondary">
                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                Start Over
                            </button>
                            <button type="button" id="save-new-plan-btn" class="btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                Save & Apply Plan
                            </button>
                        </div>
                    </div>
                    <!-- ====== END: OUTPUT PANEL ====== -->
                </div>
            </div>
        </main>
    </div>

    <!-- ====== START: MODALS (Unchanged) ====== -->
    <div id="alert-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2>
            <p id="alert-modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end">
                <button id="alert-modal-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>
    <div id="exercise-prefs-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="prefs-modal-title" class="text-xl font-bold mb-4 flex-shrink-0">Exercise Preferences</h2>
            <div class="flex justify-between items-center mb-3 flex-shrink-0">
                <label id="prefs-modal-label" class="form-label">Select preferred exercises:</label>
                <div class="flex gap-2">
                    <button type="button" class="text-xs text-blue-400 hover:underline" id="prefs-select-all-btn">All</button>
                    <button type="button" class="text-xs text-blue-400 hover:underline" id="prefs-deselect-all-btn">None</button>
                </div>
            </div>
            <div id="prefs-modal-list" class="modal-body space-y-2 mb-6"></div>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3 flex-shrink-0 mb-4 border-t border-border-color pt-4">
                 <button id="prefs-ai-suggest-btn" type="button" class="btn btn-secondary w-full">
                     <i data-lucide="sparkles" class="w-4 h-4"></i> AI Suggest Alternatives
                 </button>
                 <button id="prefs-add-variation-btn" type="button" class="btn btn-secondary w-full">
                     <i data-lucide="copy-plus" class="w-4 h-4"></i> Add Variation
                 </button>
            </div>
             <p id="prefs-selection-info" class="text-xs text-secondary-text mb-4 text-center hidden">Select exactly one exercise above to get suggestions or add a variation.</p>
            <div class="flex justify-end gap-3 flex-shrink-0">
                <button id="prefs-modal-cancel-btn" type="button" class="btn btn-secondary">Cancel</button>
                <button id="prefs-modal-save-btn" type="button" class="btn btn-primary">Save Preferences</button>
            </div>
        </div>
    </div>
    <div id="custom-exercise-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="custom-ex-modal-title" class="text-xl font-bold mb-4 flex-shrink-0">Manage Custom Exercises</h2>
            <div class="modal-body mb-6 space-y-4">
                <div class="space-y-3 p-4 border border-dashed border-gray-700 rounded-lg">
                    <h3 class="font-semibold">AI Assist Creation</h3>
                     <div>
                        <label for="ai-assist-prompt" class="form-label">Describe the exercise you want:</label>
                        <textarea id="ai-assist-prompt" rows="2" class="form-textarea mt-1" placeholder="e.g., 'bodyweight abs easier than V-ups' or 'dumbbell bench press alternative'"></textarea>
                    </div>
                     <button type="button" id="ai-assist-btn" class="btn btn-secondary w-full">
                        <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i> Get AI Suggestion
                         <div class="loader hidden ml-2"></div>
                     </button>
                </div>
                <form id="custom-exercise-form" class="space-y-3 p-4 border border-gray-700 rounded-lg">
                    <h3 id="custom-ex-form-title" class="font-semibold">Add New Exercise Manually</h3>
                    <input type="hidden" id="custom-ex-id">
                    <div>
                        <label for="custom-ex-name" class="form-label required">Exercise Name</label>
                        <input type="text" id="custom-ex-name" class="form-input" required>
                        <p class="error-message" id="error-custom-ex-name">Name is required.</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="custom-ex-group" class="form-label required">Muscle Group</label>
                            <select id="custom-ex-group" class="form-select" required></select>
                        </div>
                        <div>
                            <label for="custom-ex-type" class="form-label required">Equipment Type</label>
                            <select id="custom-ex-type" class="form-select" required></select>
                        </div>
                    </div>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="custom-ex-compound" class="form-checkbox">
                        <span class="text-sm">This is a compound exercise</span>
                    </label>
                    <button type="submit" id="custom-ex-save-btn" class="btn btn-primary w-full">Add Exercise</button>
                </form>
                <div>
                    <h3 class="font-semibold mb-2">Your Custom Exercises / Variations</h3>
                    <div id="custom-exercise-list" class="space-y-2 max-h-48 overflow-y-auto p-2 bg-black/30 rounded-md custom-scrollbar pr-1"></div>
                </div>
            </div>
            <div class="flex justify-end flex-shrink-0">
                <button id="custom-exercise-close-btn" type="button" class="btn btn-primary">Close</button>
            </div>
        </div>
    </div>
    <!-- ====== END: MODALS ====== -->

    <!-- FIXED MOBILE FOOTER NAV BAR (FROM index.html) -->
    <nav id="mobile-footer-nav" class="fixed bottom-0 left-0 right-0 h-16 z-50">
        <!-- Inner container to match header/main width, now with top border -->
        <div class="container mx-auto max-w-7xl px-4 h-full flex justify-around items-center border-t border-border-color">
            <a href="index.html" class="nav-link active"> <!-- Active -->
                <i data-lucide="home" class="nav-icon"></i>
                <span>Home</span>
            </a>
            <a href="nutrition.html" class="nav-link">
                <i data-lucide="utensils" class="nav-icon"></i>
                <span>Nutrition</span>
            </a>
            <a href="workouts.html" class="nav-link">
                <i data-lucide="dumbbell" class="nav-icon"></i>
                <span>Workouts</span>
            </a>
            <a href="sleep.html" class="nav-link">
                <i data-lucide="moon" class="nav-icon"></i>
                <span>Sleep</span>
            </a>
            <a href="progress.html" class="nav-link">
                <i data-lucide="trending-up" class="nav-icon"></i>
                <span>Progress</span>
            </a>
            <a href="social.html" class="nav-link">
                <i data-lucide="users" class="nav-icon"></i>
                <span>Social</span>
            </a>
        </div>
    </nav>

    <!-- Undo Toast Notification -->
    <div id="undo-toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg flex items-center gap-4 transform translate-y-24 opacity-0 transition-all duration-300 z-[100]">
        <span id="undo-toast-text"></span>
        <button id="undo-toast-btn" class="font-bold text-blue-400 hover:text-blue-300">Undo</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- API KEY (Rely on runtime injection) ---
            const API_KEY = ""; // Leave blank - will be provided by environment

            // --- STATE ---
            let exerciseDB = [];
            let warmupDB = {};
            let customExerciseDB = [];
            let ALL_MUSCLE_GROUPS = [];
            let ALL_EQUIPMENT_TYPES = [];
            let currentCustomSplits = [];
            let dislikedExercises = [];
            let workoutPlan = {}; // Stores the generated plan *before* saving
            let exercisePrefs = {}; // User preferences for exercises per muscle group
            let libraryModalContext = { purpose: 'prefs' }; // 'prefs', 'dislike', 'suggest', 'variation'
            let editExerciseId = null; // ID of custom exercise being edited
            let lastAction = null; // For undo functionality
            let undoTimeout = null;
            let currentPlanData = {}; // Stores the *applied* plan after saving

            // --- NEW WIZARD STATE ---
            let currentPage = 1;
            const TOTAL_PAGES = 6; // Total number of form pages (before results)

            // --- CONSTANTS ---
             const WEEK_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
             window.CURRENT_SPLIT_TYPES = []; // Global to hold available types for schedule builder

            // --- UI ELEMENTS ---
            const ui = {
                // Main Form & Panels
                aiPlanGeneratorForm: document.getElementById('ai-plan-generator-form'),
                aiPlanPanel: document.getElementById('ai-plan-panel'),
                // Note: aiPlanOutput is now page-7
                aiPlanTimelineOutput: document.getElementById('ai-plan-timeline-output'),
                aiPlanExplanation: document.getElementById('ai-plan-explanation'),
                aiPlanJsonOutput: document.getElementById('ai-plan-json-output'),
                saveNewPlanBtn: document.getElementById('save-new-plan-btn'),
                startOverBtn: document.getElementById('start-over-btn'),

                // Wizard UI
                wizardHeader: document.getElementById('wizard-header'),
                wizardTitle: document.getElementById('wizard-title'),
                wizardProgressText: document.getElementById('wizard-progress-text'),
                wizardProgressFill: document.getElementById('wizard-progress-fill'),
                wizardPages: document.querySelectorAll('.wizard-page'),
                wizardPrevBtn: document.getElementById('wizard-prev-btn'),
                wizardNextBtn: document.getElementById('wizard-next-btn'),
                wizardSubmitBtn: document.getElementById('wizard-submit-btn'),

                // Page 1
                aiPlanCurrentWeight: document.getElementById('ai-plan-current-weight'),
                aiPlanIdealWeight: document.getElementById('ai-plan-ideal-weight'),
                bodyTypeGroup: document.getElementById('body-type-group'),
                bodyFatContainer: document.getElementById('body-fat-container'),
                aiPlanTroubleSpots: document.getElementById('ai-plan-trouble-spots'), // Added moved item

                // Page 2
                aiPlanGoalSelect: document.getElementById('ai-plan-goal'),
                aiPlanGoalTextContainer: document.getElementById('ai-plan-goal-text-container'),
                aiPlanGoalText: document.getElementById('ai-plan-goal-text'),
                aiPlanTrainingHistory: document.getElementById('ai-plan-training-history'),
                aiPlanOptimizeTimelineToggle: document.getElementById('ai-plan-optimize-timeline-toggle'),
                aiPlanOptimizeTimelineInput: document.getElementById('ai-plan-optimize-timeline-input'),
                aiPlanTimelineWeeksInput: document.getElementById('ai-plan-timeline-weeks'),
                aiPlanTrackingAppRadios: document.querySelectorAll('input[name="tracking-app"]'),
                aiPlanTrackingAppDetails: document.getElementById('ai-plan-tracking-app-details'),
                aiPlanTrackingAppName: document.getElementById('ai-plan-tracking-app-name'),
                aiPlanKnowledgeLevel: document.getElementById('ai-plan-knowledge-level'),

                // Page 3
                aiPlanActivityLevel: document.getElementById('ai-plan-activity-level'),
                aiPlanScheduleConstraints: document.getElementById('ai-plan-schedule-constraints'),
                aiPlanSplitSelect: document.getElementById('ai-plan-split-select'),
                aiPlanCustomSplitContainer: document.getElementById('ai-plan-custom-split-container'),
                customSplitList: document.getElementById('custom-split-list'),
                newCustomSplitNameInput: document.getElementById('new-custom-split-name'),
                addCustomSplitBtn: document.getElementById('add-custom-split-btn'),
                aiPlanAbToggle: document.getElementById('ai-plan-ab-toggle'),
                aiPlanScheduleTypeSelect: document.getElementById('ai-plan-schedule-type'),
                aiPlanWeeklyScheduleContainer: document.getElementById('ai-plan-weekly-schedule-container'),
                aiPlanScheduleBuilder: document.getElementById('ai-plan-schedule-builder'),
                aiPlanCyclicScheduleContainer: document.getElementById('ai-plan-cyclic-schedule-container'),
                aiPlanCycleBuilder: document.getElementById('ai-plan-cycle-builder'),

                // Page 4
                aiPlanEquipmentContainer: document.getElementById('ai-plan-equipment-container'),
                aiPlanFocusMuscleContainer: document.getElementById('ai-plan-focus-muscle-container'),
                manageDislikedExercisesBtn: document.getElementById('manage-disliked-exercises-btn'),
                dislikedExercisesDisplay: document.getElementById('disliked-exercises-display'),
                aiPlanComfortSquat: document.getElementById('ai-plan-comfort-squat'),
                aiPlanComfortBench: document.getElementById('ai-plan-comfort-bench'),
                aiPlanComfortDeadlift: document.getElementById('ai-plan-comfort-deadlift'),
                aiPlanAvoidancesInput: document.getElementById('ai-plan-avoidances'),
                aiPlanJointFriendlyCheckbox: document.getElementById('ai-plan-joint-friendly'),

                // Page 5
                aiPlanDurationInput: document.getElementById('ai-plan-duration'),
                customizeDurationBtn: document.getElementById('customize-duration-btn'),
                aiPlanDurationsContainer: document.getElementById('ai-plan-durations-container'),
                aiPlanRestInput: document.getElementById('ai-plan-rest'), // MODIFIED: Target this for update
                aiPlanWarmupDurationInput: document.getElementById('ai-plan-warmup-duration'),
                aiPlanCooldownDurationInput: document.getElementById('ai-plan-cooldown-duration'),
                aiPlanCardioSelect: document.getElementById('ai-plan-cardio'),
                aiPlanExercisePrefsContainer: document.getElementById('ai-plan-exercise-prefs-container'),
                manageCustomExercisesBtn: document.getElementById('manage-custom-exercises-btn'),
                customExerciseDisplay: document.getElementById('custom-exercise-display'),
                aiPlanDefaultSetsInput: document.getElementById('ai-plan-default-sets'),
                customizeSetsBtn: document.getElementById('customize-sets-btn'),
                aiPlanSetsContainer: document.getElementById('ai-plan-sets-container'),

                // Page 6
                reviewSummaryList: document.getElementById('review-summary-list'),
                aiPlanNutritionConsistency: document.getElementById('ai-plan-nutrition-consistency'),

                // Modals
                alertModal: document.getElementById('alert-modal'),
                alertModalTitle: document.getElementById('alert-modal-title'),
                alertModalText: document.getElementById('alert-modal-text'),
                alertModalOkBtn: document.getElementById('alert-modal-ok-btn'),
                exercisePrefsModal: document.getElementById('exercise-prefs-modal'),
                prefsModalTitle: document.getElementById('prefs-modal-title'),
                prefsModalLabel: document.getElementById('prefs-modal-label'),
                prefsModalList: document.getElementById('prefs-modal-list'),
                prefsSelectAllBtn: document.getElementById('prefs-select-all-btn'),
                prefsDeselectAllBtn: document.getElementById('prefs-deselect-all-btn'),
                prefsModalCancelBtn: document.getElementById('prefs-modal-cancel-btn'),
                prefsModalSaveBtn: document.getElementById('prefs-modal-save-btn'),
                prefsAiSuggestBtn: document.getElementById('prefs-ai-suggest-btn'),
                prefsAddVariationBtn: document.getElementById('prefs-add-variation-btn'),
                prefsSelectionInfo: document.getElementById('prefs-selection-info'),
                customExerciseModal: document.getElementById('custom-exercise-modal'),
                customExModalTitle: document.getElementById('custom-ex-modal-title'),
                customExerciseForm: document.getElementById('custom-exercise-form'),
                customExFormTitle: document.getElementById('custom-ex-form-title'),
                customExIdInput: document.getElementById('custom-ex-id'),
                customExNameInput: document.getElementById('custom-ex-name'),
                customExGroupSelect: document.getElementById('custom-ex-group'),
                customExTypeSelect: document.getElementById('custom-ex-type'),
                customExCompoundCheckbox: document.getElementById('custom-ex-compound'),
                customExSaveBtn: document.getElementById('custom-ex-save-btn'),
                customExerciseList: document.getElementById('custom-exercise-list'),
                customExerciseCloseBtn: document.getElementById('custom-exercise-close-btn'),
                aiAssistPrompt: document.getElementById('ai-assist-prompt'),
                aiAssistBtn: document.getElementById('ai-assist-btn'),

                // Undo Toast
                undoToast: document.getElementById('undo-toast'),
                undoToastText: document.getElementById('undo-toast-text'),
                undoToastBtn: document.getElementById('undo-toast-btn'),
            };

            // --- HELPER FUNCTIONS (Unchanged) ---
            const getApiUrl = (model, action = 'generateContent') => {
                 if (API_KEY === "YOUR_API_KEY_HERE" || !API_KEY) {
                     // API Key is expected to be injected by the environment.
                     // We proceed assuming it will be available.
                 }
                // Rely on the runtime environment to provide the key.
                return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${API_KEY}`;
            };

            async function makeApiCall(apiUrl, payload, button = null, responseMimeType = "text/plain") {
                 // Check if API_KEY is effectively available (useful if runtime fails)
                 if (API_KEY === "" && !apiUrl.includes("key=")) {
                      console.error("API Key Missing");
                      showCustomAlert("API Key Missing", "API Key is not configured. AI features are disabled.");
                      return null;
                 }
                 let loader;
                 if (button) {
                     button.disabled = true;
                     loader = button.querySelector('.loader');
                     const btnText = button.querySelector('.btn-text'); // Find btn-text if exists
                     if (loader) loader.classList.remove('hidden');
                     if (btnText) btnText.style.display = 'none'; // Hide text during load
                 }
                 try {
                     let retries = 0; const maxRetries = 5; let delay = 1000;
                     while (retries < maxRetries) {
                         const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                         if (response.ok) {
                             const result = await response.json();
                             const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                             if (!text && responseMimeType === "text/plain") { // Adjust check for text only responses
                                 console.warn("API response structure unexpected, but status OK:", result);
                                 if (retries >= maxRetries - 1) throw new Error("Invalid response structure from API after retries.");
                             } else if (responseMimeType === "application/json") {
                                 try {
                                     // Check if text is actually present before parsing
                                     if (!text) throw new Error("API did not return text for JSON parsing.");
                                     return JSON.parse(text);
                                 } catch (e) {
                                     console.error("Failed to parse JSON response:", text, e);
                                     throw new Error("API did not return valid JSON.");
                                 }
                             }
                             // For text/plain or if JSON parsing isn't required but text exists
                             return text;
                         } else if (response.status === 429 || response.status >= 500) {
                             retries++;
                             if (retries >= maxRetries) throw new Error(`API Error after ${maxRetries} retries: ${response.status} - ${await response.text()}`);
                             await new Promise(resolve => setTimeout(resolve, delay));
                             delay *= 2;
                         } else {
                             // Handle specific errors like API key issues
                             if (response.status === 400 || response.status === 403) {
                                 console.error("API Error (400/403):", await response.text());
                                 throw new Error(`API Configuration Error (${response.status}). Check API Key or permissions.`);
                             }
                             throw new Error(`API Error: ${response.status} - ${await response.text()}`);
                         }
                     }
                 } catch (error) {
                     console.error("API Call Error:", error);
                     showCustomAlert("AI Error", `Could not get response from AI. ${error.message}`);
                     return null;
                 } finally {
                     if (button) {
                         button.disabled = false;
                         const btnText = button.querySelector('.btn-text'); // Find btn-text again
                         if (loader) loader.classList.add('hidden');
                         if (btnText) btnText.style.display = 'inline'; // Show text again
                     }
                 }
                 return null;
            }

            function showModal(modalElement) { modalElement.style.display = 'flex'; }
            function hideModal(modalElement) { modalElement.style.display = 'none'; }
            function showCustomAlert(title, text) {
                ui.alertModalTitle.textContent = title;
                ui.alertModalText.textContent = text;
                showModal(ui.alertModal);
            }

            function showUndo(message, onUndo) {
                clearTimeout(undoTimeout);
                ui.undoToastText.textContent = message;
                lastAction = { onUndo: onUndo }; // Store only the callback
                ui.undoToast.classList.remove('translate-y-24', 'opacity-0');
                undoTimeout = setTimeout(() => { hideUndo(); }, 5000); // 5 seconds
            }

            function hideUndo() {
                lastAction = null;
                ui.undoToast.classList.add('translate-y-24', 'opacity-0');
            }

            // Function to save form state to localStorage
            function saveFormState() {
                const formData = {};
                ui.aiPlanGeneratorForm.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        if (el.name) {
                            if (!formData[el.name]) formData[el.name] = [];
                            if (el.checked) {
                                if (el.type === 'radio') formData[el.name] = el.value; // Store single value for radio
                                else formData[el.name].push(el.value); // Store array for checkboxes
                            }
                        }
                    } else if (el.id) {
                        formData[el.id] = el.value;
                    }
                });

                // Also save wizard state
                formData['wizardCurrentPage'] = currentPage;

                localStorage.setItem('demo_aiPlanFormState', JSON.stringify(formData));
            }

            // Function to load form state from localStorage
            function loadFormState() {
                const savedState = JSON.parse(localStorage.getItem('demo_aiPlanFormState') || '{}');
                ui.aiPlanGeneratorForm.querySelectorAll('input, select, textarea').forEach(el => {
                     const value = savedState[el.id] ?? savedState[el.name];
                     if (value !== undefined) {
                        if (el.type === 'checkbox') {
                            el.checked = Array.isArray(value) ? value.includes(el.value) : false;
                        } else if (el.type === 'radio') {
                            el.checked = (value === el.value);
                        } else {
                            el.value = value;
                        }
                        // Trigger change events for elements that depend on others
                        if (['ai-plan-goal', 'ai-plan-optimize-timeline-toggle', 'tracking-app', 'ai-plan-split-select', 'ai-plan-ab-toggle', 'ai-plan-schedule-type'].includes(el.id) || el.name === 'tracking-app') {
                            el.dispatchEvent(new Event('change'));
                        }
                        if (el.id === 'ai-plan-default-sets') {
                            el.dispatchEvent(new Event('input'));
                        }
                    }
                });
                 // Restore Custom Split state
                currentCustomSplits = JSON.parse(localStorage.getItem('demo_customSplits') || '[]');
                if (savedState['ai-plan-split-select'] === 'Custom') {
                    renderCustomSplitList();
                }
                 // Restore Exercise Prefs
                exercisePrefs = JSON.parse(localStorage.getItem('demo_exercisePrefs') || '{}');
                // Restore Disliked Exercises
                dislikedExercises = JSON.parse(localStorage.getItem('demo_dislikedExercises') || '[]');
                renderDislikedExercisesDisplay();
                // Restore Custom Exercises
                customExerciseDB = JSON.parse(localStorage.getItem('demo_customExerciseDB') || '[]')
                renderCustomExerciseDisplay();

                // Restore wizard page
                currentPage = parseInt(savedState['wizardCurrentPage'] || '1');
                if (currentPage > TOTAL_PAGES) { // Don't resume on results page
                    currentPage = TOTAL_PAGES;
                }
                showPage(currentPage, true); // Show the restored page without scrolling
            }

            // Save form state whenever an input changes
            ui.aiPlanGeneratorForm.addEventListener('change', saveFormState);
            ui.aiPlanGeneratorForm.addEventListener('input', saveFormState); // Catch textarea/text input changes too

            // Function to load data needed for the generator
            function loadGeneratorData() {
                currentCustomSplits = JSON.parse(localStorage.getItem('demo_customSplits') || '[]');
                exercisePrefs = JSON.parse(localStorage.getItem('demo_exercisePrefs') || '{}');
                dislikedExercises = JSON.parse(localStorage.getItem('demo_dislikedExercises') || '[]');
                customExerciseDB = JSON.parse(localStorage.getItem('demo_customExerciseDB') || '[]')
                // Load applied plan to show user what's currently active (optional, could display plan name)
                currentPlanData = JSON.parse(localStorage.getItem('fitTrackAI_workoutPlan') || '{}');
            }

             // --- Validation Helper (Unchanged) ---
             function clearError(elementId) {
                const element = document.getElementById(elementId);
                const errorMsg = document.getElementById(`error-${elementId.split('-').slice(2).join('-')}`); // Derive error msg ID

                if (element) {
                    element.classList.remove('input-error');
                    // Handle group containers differently
                    if(element.classList.contains('checkbox-group-error') || element.classList.contains('radio-group-error') || element.classList.contains('img-radio-group')){
                         element.classList.remove('input-error'); // Remove border from container
                    }
                }
                if (errorMsg) errorMsg.style.display = 'none';
            }

             function showError(elementId, message) {
                const element = document.getElementById(elementId);
                const errorMsg = document.getElementById(`error-${elementId.split('-').slice(2).join('-')}`);

                if (element) {
                    element.classList.add('input-error');
                     // Handle group containers differently
                    if(element.classList.contains('checkbox-group-error') || element.classList.contains('radio-group-error') || element.classList.contains('img-radio-group')){
                         element.classList.add('input-error'); // Add border to container
                    }
                }
                if (errorMsg) {
                    errorMsg.textContent = message;
                    errorMsg.style.display = 'block';
                }
             }

             // Scroll to first error on page
             function scrollToFirstError() {
                const firstError = document.querySelector(`#page-${currentPage} .input-error, #page-${currentPage} .checkbox-group-error.input-error, #page-${currentPage} .radio-group-error.input-error`);
                 if (firstError) {
                     firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
             }

             // Add event listeners to clear errors on input/change
            ui.aiPlanGeneratorForm.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('input', () => { if(el.id) clearError(el.id) });
                el.addEventListener('change', () => { if(el.id) clearError(el.id) });
            });
            // Specific listeners for radio/checkbox groups
            ['body-type-group', 'body-fat-container', 'ai-plan-equipment-container'].forEach(id => {
                 const container = document.getElementById(id);
                 if (container) {
                     container.addEventListener('change', () => {
                         let errorIdSuffix;
                         if (id === 'body-type-group') errorIdSuffix = 'body-type';
                         else if (id === 'body-fat-container') errorIdSuffix = 'body-fat';
                         else if (id === 'ai-plan-equipment-container') errorIdSuffix = 'equipment';

                         if (errorIdSuffix) {
                             const errorMsg = document.getElementById(`error-${errorIdSuffix}`);
                             if(errorMsg) errorMsg.style.display = 'none';
                             // Find the error target (might be the container itself or a child group)
                             const errorTarget = container.querySelector('.input-error') || container;
                             errorTarget.classList.remove('input-error');
                         }
                     });
                 }
            });
             // Schedule builder error clearing
             [ui.aiPlanScheduleBuilder, ui.aiPlanCycleBuilder].forEach(builder => {
                 builder.addEventListener('click', (e) => {
                     if (e.target.classList.contains('day-schedule-btn')) {
                         document.getElementById('error-schedule').style.display = 'none';
                         ui.aiPlanScheduleBuilder.classList.remove('input-error');
                         ui.aiPlanCycleBuilder.classList.remove('input-error');
                     }
                 });
             });

            async function loadExerciseData() {
                try {
                    const response = await fetch('exercises.json'); // Assumes exercises.json is in the same directory
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    exerciseDB = data.exercises || [];
                    warmupDB = data.warmups || {};
                    if (exerciseDB.length === 0) throw new Error("No exercises found in JSON.");

                    // Clean and standardize groups
                    exerciseDB.forEach(ex => {
                        if (ex.group === "Abs") ex.group = "Abdominals";
                        if (["Lats", "Upper Back", "Lower Back", "Traps"].includes(ex.group)) ex.group = "Back";
                    });

                    ALL_MUSCLE_GROUPS = [...new Set(exerciseDB.map(ex => ex.group).filter(Boolean))].sort();
                    if (!ALL_MUSCLE_GROUPS.includes("Cardio")) ALL_MUSCLE_GROUPS.push("Cardio");
                    ALL_MUSCLE_GROUPS.sort();

                    ALL_EQUIPMENT_TYPES = [...new Set(exerciseDB.map(ex => ex.type).filter(Boolean))].sort();

                    populateGeneratorFields();
                    renderCustomExerciseDisplay(); // Uses customExerciseDB
                    renderDislikedExercisesDisplay(); // Uses dislikedExercises
                    loadFormState(); // Load form state *after* dropdowns are populated

                } catch (error) {
                    console.error("Failed to load exercises:", error);
                    showCustomAlert("Data Missing", "Exercise database (exercises.json) could not be loaded. Generator is unavailable.");
                    // Disable submit button if data fails to load
                    if (ui.wizardSubmitBtn) ui.wizardSubmitBtn.disabled = true;
                }
            }

            // --- ALL MODAL, DATA, and HELPER LOGIC (Unchanged) ---
            // (All functions like populateGeneratorFields, renderCustomSplitList, updateSplit,
            // renderScheduleBuilders, openExerciseLibrary, renderExercisePreferences,
            // renderCustomExerciseDisplay, etc., are preserved here exactly as they were
            // in the original file. They are simply called by the new wizard flow.)
            // ... (Omitting 1000+ lines of identical helper logic for brevity) ...

            // --- [Start of identical logic from original file] ---
            // This section includes:
            // - populateGeneratorFields()
            // - renderCustomSplitList() and its listeners
            // - updateSplit()
            // - renderScheduleBuilders(), renderWeeklyScheduleBuilder(), renderCyclicScheduleBuilder(), onDayScheduleBtnClick()
            // - renderDurations() and its listener
            // - updateAdvancedSetPlaceholders() and its listeners
            // - openExerciseLibrary()
            // - renderExercisePreferences()
            // - renderDislikedExercisesDisplay()
            // - all modal listeners (prefs, custom exercise)
            // - handlePrefsAction()
            // - renderCustomExerciseDisplay() and its listeners
            // - AI Assist listener
            // - Select All/Deselect All listeners
            // - Alert Modal listener
            // - Undo Toast listener
            // - All other specific input event listeners (timeline, tracking app, etc.)

            // --- (Original helper functions) ---

            function populateGeneratorFields() {
                if (exerciseDB.length === 0) return;
                ui.aiPlanEquipmentContainer.innerHTML = ALL_EQUIPMENT_TYPES.map(e => `<div><label class="flex items-center gap-2"><input type="checkbox" name="equipment" value="${e}" checked class="form-checkbox"><span class="text-sm">${e}</span></label></div>`).join('');
                ui.aiPlanFocusMuscleContainer.innerHTML = ALL_MUSCLE_GROUPS.map(g => `<div><label class="flex items-center gap-2"><input type="checkbox" name="focusMuscle" value="${g}" checked class="form-checkbox"><span class="text-sm">${g}</span></label></div>`).join('');
                 ui.aiPlanSetsContainer.innerHTML = ALL_MUSCLE_GROUPS.map(group =>
                    `<div class="flex items-center gap-2">
                         <label for="sets-${group}" class="form-label text-sm flex-1">${group}</label>
                         <input type="number" id="sets-${group}" data-group="${group}" min="0" step="1" class="form-input !w-20 !py-1 text-center advanced-set-input" placeholder="Auto">
                         <p class="error-message !mt-0" id="error-sets-${group}">Sets cannot be negative.</p>
                     </div>`
                 ).join('');
                 ui.aiPlanSetsContainer.querySelectorAll('.advanced-set-input').forEach(input => {
                     input.addEventListener('input', () => clearError(input.id));
                 });
                updateAdvancedSetPlaceholders();
                ui.customExGroupSelect.innerHTML = ALL_MUSCLE_GROUPS.map(g => `<option value="${g}">${g}</option>`).join('');
                ui.customExTypeSelect.innerHTML = ALL_EQUIPMENT_TYPES.map(e => `<option value="${e}">${e}</option>`).join('');
                updateSplit();
                renderExercisePreferences();
            }

             function renderCustomSplitList() {
                 ui.customSplitList.innerHTML = currentCustomSplits.map((splitName, index) => `
                     <div class="split-list-item">
                         <span>${splitName}</span>
                         <button type="button" class="btn-icon-sm remove-split-btn" data-index="${index}">
                             <i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i>
                         </button>
                     </div>
                 `).join('');
                 lucide.createIcons({ nodes: ui.customSplitList.querySelectorAll('button')});

                 ui.customSplitList.querySelectorAll('.remove-split-btn').forEach(btn => {
                     btn.addEventListener('click', () => {
                         currentCustomSplits.splice(parseInt(btn.dataset.index), 1);
                         localStorage.setItem('demo_customSplits', JSON.stringify(currentCustomSplits));
                         saveFormState();
                         updateSplit();
                     });
                 });
             }
             ui.addCustomSplitBtn.addEventListener('click', () => {
                 const newName = ui.newCustomSplitNameInput.value.trim();
                 if (newName && !currentCustomSplits.includes(newName)) {
                     currentCustomSplits.push(newName);
                     localStorage.setItem('demo_customSplits', JSON.stringify(currentCustomSplits));
                     saveFormState();
                     ui.newCustomSplitNameInput.value = '';
                     updateSplit();
                 } else if (currentCustomSplits.includes(newName)) {
                     showCustomAlert("Duplicate Name", "This split name already exists.");
                 } else {
                     showCustomAlert("Invalid Name", "Please enter a name for the custom split.");
                 }
             });
             ui.newCustomSplitNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); ui.addCustomSplitBtn.click(); } });

            function updateSplit() {
                const splitSelectVal = ui.aiPlanSplitSelect.value;
                const isCustom = splitSelectVal === 'Custom';
                const isAB = ui.aiPlanAbToggle.checked;
                ui.aiPlanCustomSplitContainer.classList.toggle('hidden', !isCustom);
                let baseSplitNames = [];
                if (isCustom) {
                    baseSplitNames = [...currentCustomSplits];
                    // Validate custom split if it's selected
                    if (baseSplitNames.length === 0) {
                        showError('error-custom-split', 'Please add at least one custom split day.');
                    } else {
                        clearError('error-custom-split');
                    }
                } else {
                    baseSplitNames = splitSelectVal.split(',').map(s => s.trim()).filter(Boolean);
                    clearError('error-custom-split'); // Clear error if not custom
                }

                // Update available types for schedule builder
                window.CURRENT_SPLIT_TYPES = ['Rest'];
                baseSplitNames.forEach(name => {
                    if (isAB) { window.CURRENT_SPLIT_TYPES.push(`${name} A`); window.CURRENT_SPLIT_TYPES.push(`${name} B`); }
                    else { window.CURRENT_SPLIT_TYPES.push(name); }
                });
                window.CURRENT_SPLIT_TYPES.push('Cardio');
                if (isCustom) renderCustomSplitList();
                renderScheduleBuilders();
                renderDurations();
            }

             function renderScheduleBuilders() {
                 renderWeeklyScheduleBuilder();
                 renderCyclicScheduleBuilder();
                 validateSchedule(true); // Validate silently
             }

             const onDayScheduleBtnClick = (btn) => {
                 let currentIndex = parseInt(btn.dataset.currentIndex) + 1;
                 if (currentIndex >= window.CURRENT_SPLIT_TYPES.length) currentIndex = 0;
                 btn.dataset.currentIndex = currentIndex;
                 btn.querySelector('.text-xs').textContent = window.CURRENT_SPLIT_TYPES[currentIndex];
                 renderDurations();
                 validateSchedule(true); // Validate silently
                 saveFormState();
             };

             const renderWeeklyScheduleBuilder = () => {
                 const dayGrid = ui.aiPlanScheduleBuilder;
                 let currentAssignments = {};
                 if (dayGrid.children.length > 0) {
                      dayGrid.querySelectorAll('.day-schedule-btn').forEach(btn => {
                          currentAssignments[btn.dataset.day] = btn.querySelector('.text-xs').textContent;
                      });
                 }
                 const firstWorkoutType = window.CURRENT_SPLIT_TYPES.length > 1 ? window.CURRENT_SPLIT_TYPES[1] : 'Rest';
                 let defaultSchedule = {};
                 if (firstWorkoutType.startsWith('Push')) defaultSchedule = { Monday: window.CURRENT_SPLIT_TYPES.includes("Push A") ? "Push A" : "Push", Tuesday: window.CURRENT_SPLIT_TYPES.includes("Pull A") ? "Pull A" : "Pull", Wednesday: window.CURRENT_SPLIT_TYPES.includes("Legs A") ? "Legs A" : "Legs", Thursday: "Rest", Friday: window.CURRENT_SPLIT_TYPES.includes("Push B") ? "Push B" : (window.CURRENT_SPLIT_TYPES.includes("Push") ? "Push" : "Rest"), Saturday: window.CURRENT_SPLIT_TYPES.includes("Pull B") ? "Pull B" : (window.CURRENT_SPLIT_TYPES.includes("Pull") ? "Pull" : "Rest"), Sunday: window.CURRENT_SPLIT_TYPES.includes("Legs B") ? "Legs B" : (window.CURRENT_SPLIT_TYPES.includes("Legs") ? "Legs" : "Rest") };
                 else if (firstWorkoutType.startsWith('Upper')) defaultSchedule = { Monday: window.CURRENT_SPLIT_TYPES.includes("Upper A") ? "Upper A" : "Upper", Tuesday: window.CURRENT_SPLIT_TYPES.includes("Lower A") ? "Lower A" : "Lower", Wednesday: "Rest", Thursday: window.CURRENT_SPLIT_TYPES.includes("Upper B") ? "Upper B" : (window.CURRENT_SPLIT_TYPES.includes("Upper") ? "Upper" : "Rest"), Friday: window.CURRENT_SPLIT_TYPES.includes("Lower B") ? "Lower B" : (window.CURRENT_SPLIT_TYPES.includes("Lower") ? "Lower" : "Rest"), Saturday: "Rest", Sunday: "Rest"};
                 else defaultSchedule = { Monday: firstWorkoutType, Tuesday: "Rest", Wednesday: firstWorkoutType, Thursday: "Rest", Friday: firstWorkoutType, Saturday: "Rest", Sunday: "Rest"};

                 dayGrid.innerHTML = WEEK_DAYS.map(day => {
                     let currentType = currentAssignments[day] || defaultSchedule[day] || 'Rest';
                     let currentIndex = window.CURRENT_SPLIT_TYPES.indexOf(currentType);
                     if (currentIndex === -1) {
                         if (currentType.endsWith(' A') || currentType.endsWith(' B')) {
                             const baseName = currentType.replace(/ A$| B$/, '');
                             currentIndex = window.CURRENT_SPLIT_TYPES.indexOf(baseName);
                         }
                         if (currentIndex === -1) currentIndex = 0;
                     }
                     currentType = window.CURRENT_SPLIT_TYPES[currentIndex];
                    return ` <button type="button" class="day-schedule-btn text-center p-2 rounded-lg bg-input-bg" data-day="${day}" data-current-index="${currentIndex}"> <p class="font-semibold text-sm">${day.substring(0, 3)}</p> <p class="text-xs text-blue-400">${currentType}</p> </button> `;
                 }).join('');
                 dayGrid.querySelectorAll('.day-schedule-btn').forEach(btn => { btn.addEventListener('click', () => onDayScheduleBtnClick(btn)); });
                 lucide.createIcons({ nodes: dayGrid.querySelectorAll('button') });
             };

             const renderCyclicScheduleBuilder = () => {
                 const cycleGrid = ui.aiPlanCycleBuilder;
                 let currentAssignments = {};
                  if (cycleGrid.children.length > 0) {
                      cycleGrid.querySelectorAll('.day-schedule-btn').forEach(btn => {
                          currentAssignments[btn.dataset.day] = btn.querySelector('.text-xs').textContent;
                      });
                 }
                 let defaultCycleAssign = {};
                 let typeIndex = 1;
                 const workoutTypesOnly = window.CURRENT_SPLIT_TYPES.filter(t => t !== 'Rest' && t !== 'Cardio');
                 WEEK_DAYS.forEach((day) => {
                      if (workoutTypesOnly.length > 0) {
                           defaultCycleAssign[day] = workoutTypesOnly[(typeIndex - 1) % workoutTypesOnly.length];
                           typeIndex++;
                      } else {
                           defaultCycleAssign[day] = 'Rest';
                      }
                 });
                 cycleGrid.innerHTML = WEEK_DAYS.map(day => {
                      let currentType = currentAssignments[day] || defaultCycleAssign[day] || 'Rest';
                      let currentIndex = window.CURRENT_SPLIT_TYPES.indexOf(currentType);
                       if (currentIndex === -1) {
                         if (currentType.endsWith(' A') || currentType.endsWith(' B')) {
                             const baseName = currentType.replace(/ A$| B$/, '');
                             currentIndex = window.CURRENT_SPLIT_TYPES.indexOf(baseName);
                         }
                         if (currentIndex === -1) currentIndex = 0;
                     }
                     currentType = window.CURRENT_SPLIT_TYPES[currentIndex];
                     return ` <button type="button" class="day-schedule-btn text-center p-2 rounded-lg bg-input-bg" data-day="${day}" data-current-index="${currentIndex}"> <p class="font-semibold text-sm">${day.substring(0, 3)}</p> <p class="text-xs text-blue-400">${currentType}</p> </button> `;
                 }).join('');
                 cycleGrid.querySelectorAll('.day-schedule-btn').forEach(btn => { btn.addEventListener('click', () => onDayScheduleBtnClick(btn)); });
                 lucide.createIcons({ nodes: cycleGrid.querySelectorAll('button') });
             };

            ui.aiPlanSplitSelect.addEventListener('change', updateSplit);
            ui.aiPlanAbToggle.addEventListener('change', updateSplit);
            ui.aiPlanScheduleTypeSelect.addEventListener('change', (e) => {
                const isWeekly = e.target.value === 'weekly';
                ui.aiPlanWeeklyScheduleContainer.classList.toggle('hidden', !isWeekly);
                ui.aiPlanCyclicScheduleContainer.classList.toggle('hidden', isWeekly);
                renderDurations();
                validateSchedule(true); // Validate silently
            });

             function renderDurations() {
                const container = ui.aiPlanDurationsContainer;
                const scheduleType = ui.aiPlanScheduleTypeSelect.value;
                const defaultDuration = ui.aiPlanDurationInput.value || 60;
                let itemsToRender = [];
                let currentDurations = {};
                 container.querySelectorAll('.day-duration-input').forEach(input => {
                     if (input.value) currentDurations[input.dataset.key] = input.value;
                 });
                if (scheduleType === 'weekly') {
                     itemsToRender = [...ui.aiPlanScheduleBuilder.querySelectorAll('.day-schedule-btn')].map(btn => ({ key: btn.dataset.day, type: btn.querySelector('.text-xs').textContent }));
                } else {
                     const uniqueTypes = [...new Set([...ui.aiPlanCycleBuilder.querySelectorAll('.day-schedule-btn')].map(btn => btn.querySelector('.text-xs').textContent))];
                     itemsToRender = uniqueTypes.map(type => ({ key: type, type: type }));
                }
                let hasWorkoutDay = false; let durationHTML = '';
                itemsToRender.forEach(item => {
                    if(item.type !== 'Rest') {
                        hasWorkoutDay = true;
                        const currentValue = currentDurations[item.key] || '';
                        durationHTML += `<div class="flex items-center justify-between gap-2"><label class="text-sm">${item.key}</label><input type="number" data-key="${item.key}" value="${currentValue}" min="10" step="5" class="form-input !w-24 !py-1 day-duration-input" placeholder="${defaultDuration}"></div>`;
                    }
                });
                if(hasWorkoutDay) { container.innerHTML = durationHTML; }
                else { container.innerHTML = '<p class="text-xs text-secondary-text">Assign workout days in the schedule first.</p>'; }
                 ui.customizeDurationBtn.textContent = container.classList.contains('hidden') ? 'Customize per day/type (Optional)' : 'Use default duration';
            };
            ui.customizeDurationBtn.addEventListener('click', (e) => { ui.aiPlanDurationsContainer.classList.toggle('hidden'); renderDurations(); });

            function updateAdvancedSetPlaceholders() {
                 const defaultSetsValue = ui.aiPlanDefaultSetsInput.value || '';
                 ui.aiPlanSetsContainer.querySelectorAll('input[type="number"]').forEach(input => { input.placeholder = defaultSetsValue || 'Auto'; });
             }
             ui.aiPlanDefaultSetsInput.addEventListener('input', updateAdvancedSetPlaceholders);
            ui.customizeSetsBtn.addEventListener('click', (e) => {
                const container = ui.aiPlanSetsContainer; container.classList.toggle('hidden');
                e.target.textContent = container.classList.contains('hidden') ? 'Customize per muscle group' : 'Use default sets';
                if (!container.classList.contains('hidden')) { updateAdvancedSetPlaceholders(); }
            });

             function openExerciseLibrary(group) {
                const combinedDB = [...exerciseDB, ...customExerciseDB];
                let currentSelection = [];
                let isChecked;
                if (libraryModalContext.purpose === 'dislike') {
                    ui.prefsModalTitle.textContent = `Select Disliked Exercises`;
                    ui.prefsModalLabel.textContent = `Select exercises to avoid:`;
                    ui.prefsModalSaveBtn.textContent = 'Save Dislikes';
                    currentSelection = dislikedExercises;
                     ui.prefsModalList.innerHTML = combinedDB.sort((a,b) => a.name.localeCompare(b.name)).map(ex => {
                        isChecked = currentSelection.includes(ex.name);
                        return `<label class="flex items-center gap-2 p-2 rounded-md hover:bg-input-bg cursor-pointer ${group && ex.group !== group ? 'opacity-50' : ''}">
                            <input type="checkbox" name="exercise-pref" value="${ex.name}" ${isChecked ? 'checked' : ''} class="form-checkbox">
                            <span class="text-sm">${ex.name} <span class="text-xs text-secondary-text">(${ex.group})</span></span>
                        </label>`;
                    }).join('');
                } else {
                    libraryModalContext.group = group;
                    const exercisesInGroup = combinedDB.filter(ex => ex.group === group);
                    ui.prefsModalTitle.textContent = `Exercise Preferences for ${group}`;
                    ui.prefsModalLabel.textContent = `Select preferred exercises:`;
                    ui.prefsModalSaveBtn.textContent = 'Save Preferences';
                    currentSelection = exercisePrefs[group] || [];
                    const defaultSelectAll = currentSelection.length === 0;
                    ui.prefsModalList.innerHTML = exercisesInGroup.sort((a,b) => a.name.localeCompare(b.name)).map(ex => {
                        isChecked = defaultSelectAll || currentSelection.includes(ex.name);
                        return `<label class="flex items-center gap-2 p-2 rounded-md hover:bg-input-bg cursor-pointer">
                            <input type="checkbox" name="exercise-pref" value="${ex.name}" ${isChecked ? 'checked' : ''} class="form-checkbox">
                            <span class="text-sm">${ex.name}</span>
                        </label>`;
                    }).join('');
                }
                ui.prefsSelectionInfo.classList.add('hidden');
                showModal(ui.exercisePrefsModal);
                lucide.createIcons({ nodes: ui.exercisePrefsModal.querySelectorAll('label') });
            }

            function renderExercisePreferences() {
                const container = ui.aiPlanExercisePrefsContainer;
                const checkedMuscles = Array.from(ui.aiPlanFocusMuscleContainer.querySelectorAll('input[name="focusMuscle"]:checked')).map(cb => cb.value);
                if (checkedMuscles.length === 0) {
                    container.innerHTML = '<p class="text-secondary-text text-sm col-span-2 md:col-span-3">Select focus muscle groups to set preferences.</p>';
                    return;
                }
                container.innerHTML = checkedMuscles.sort().map(muscle => {
                     const combinedDB = [...exerciseDB, ...customExerciseDB];
                     const allInGroupCount = combinedDB.filter(ex => ex.group === muscle).length;
                     const prefCount = (exercisePrefs[muscle] || []).length;
                     const countText = (prefCount === 0 || prefCount === allInGroupCount) ? `All (${allInGroupCount})` : `${prefCount} selected`;
                     return ` <button type="button" class="btn btn-secondary w-full justify-between" data-group="${muscle}"> <span>${muscle}</span> <span class="text-xs px-2 py-0.5 bg-blue-500/20 text-blue-300 rounded-full" id="pref-count-${muscle}">${countText}</span> </button> `;
                 }).join('');
                container.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        libraryModalContext.purpose = 'prefs';
                        openExerciseLibrary(btn.dataset.group);
                    });
                });
                lucide.createIcons({ nodes: container.querySelectorAll('button') });
            }

            function renderDislikedExercisesDisplay() {
                if (dislikedExercises.length === 0) {
                    ui.dislikedExercisesDisplay.textContent = "No exercises disliked yet.";
                } else {
                    const displayCount = 3;
                    ui.dislikedExercisesDisplay.textContent = `${dislikedExercises.length} disliked: ${dislikedExercises.slice(0, displayCount).join(', ')}${dislikedExercises.length > displayCount ? '...' : ''}`;
                }
            }

            ui.aiPlanFocusMuscleContainer.addEventListener('change', renderExercisePreferences);
            ui.aiPlanGoalSelect.addEventListener('change', (e) => {
                const isCustom = e.target.value === 'custom';
                ui.aiPlanGoalTextContainer.classList.toggle('hidden', !isCustom);
                ui.aiPlanGoalText.required = isCustom;
                if (!isCustom) clearError('ai-plan-goal-text');
            });

            ui.prefsModalCancelBtn.addEventListener('click', () => hideModal(ui.exercisePrefsModal));
            ui.prefsModalSaveBtn.addEventListener('click', () => {
                const selectedExercises = Array.from(ui.prefsModalList.querySelectorAll('input[name="exercise-pref"]:checked')).map(cb => cb.value);
                if (libraryModalContext.purpose === 'dislike') {
                    dislikedExercises = selectedExercises;
                    localStorage.setItem('demo_dislikedExercises', JSON.stringify(dislikedExercises));
                    renderDislikedExercisesDisplay();
                } else {
                    const group = libraryModalContext.group;
                    if (!group) return;
                    const combinedDB = [...exerciseDB, ...customExerciseDB];
                    const allExercisesInGroupCount = combinedDB.filter(ex => ex.group === group).length;
                    if (selectedExercises.length > 0 && selectedExercises.length < allExercisesInGroupCount) {
                         exercisePrefs[group] = selectedExercises;
                    } else {
                         delete exercisePrefs[group];
                    }
                    localStorage.setItem('demo_exercisePrefs', JSON.stringify(exercisePrefs));
                    renderExercisePreferences();
                }
                saveFormState();
                hideModal(ui.exercisePrefsModal);
            });
            ui.manageDislikedExercisesBtn.addEventListener('click', () => {
                libraryModalContext.purpose = 'dislike';
                openExerciseLibrary(null);
            });
            const setPrefsCheckboxes = (checked) => ui.prefsModalList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = checked);
            ui.prefsSelectAllBtn.addEventListener('click', () => setPrefsCheckboxes(true));
            ui.prefsDeselectAllBtn.addEventListener('click', () => setPrefsCheckboxes(false));

             ui.prefsAiSuggestBtn.addEventListener('click', async () => handlePrefsAction('suggest'));
             ui.prefsAddVariationBtn.addEventListener('click', () => handlePrefsAction('variation'));
             ui.prefsModalList.addEventListener('change', () => {
                 const selectedCount = ui.prefsModalList.querySelectorAll('input[name="exercise-pref"]:checked').length;
                 ui.prefsSelectionInfo.classList.toggle('hidden', selectedCount !== 1);
             });

             async function handlePrefsAction(action) {
                 const selectedCheckboxes = ui.prefsModalList.querySelectorAll('input[name="exercise-pref"]:checked');
                 if (selectedCheckboxes.length !== 1) {
                     ui.prefsSelectionInfo.classList.remove('hidden');
                     return;
                 }
                 ui.prefsSelectionInfo.classList.add('hidden');
                 const exerciseName = selectedCheckboxes[0].value;
                 const combinedDB = [...exerciseDB, ...customExerciseDB];
                 const exerciseDetails = combinedDB.find(ex => ex.name === exerciseName);
                 if (!exerciseDetails) return;
                 if (action === 'suggest') {
                     const group = exerciseDetails.group;
                     const equipment = Array.from(ui.aiPlanEquipmentContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                     const isJointFriendly = ui.aiPlanJointFriendlyCheckbox.checked;
                     const currentPrefsOrDislikes = (libraryModalContext.purpose === 'prefs' ? (exercisePrefs[group] || []) : dislikedExercises);
                     const prompt = `Suggest exactly 3 alternative exercises for "${exerciseName}" which targets the ${group}.
Consider: Available Equipment: ${equipment.join(', ') || 'Standard gym equipment'}. Prioritize Joint-Friendly: ${isJointFriendly}.
Avoid suggesting these if possible: ${[exerciseName, ...currentPrefsOrDislikes].join(', ')}.
Choose ONLY from this list of available exercises: ${combinedDB.map(ex => ex.name).join(', ')}.
Respond ONLY with a comma-separated list of the 3 suggested exercise names.`;
                     const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                     const suggestionsText = await makeApiCall(apiUrl, { contents: [{ parts: [{ text: prompt }] }] }, ui.prefsAiSuggestBtn);
                     if (suggestionsText) {
                         showCustomAlert(`AI Suggestions for ${exerciseName}`, `Alternatives: ${suggestionsText.split(',').map(s=>s.trim()).join(', ')}`);
                     }
                 } else if (action === 'variation') {
                     editExerciseId = null;
                     ui.customExModalTitle.textContent = "Add Variation";
                     ui.customExFormTitle.textContent = `Add Variation based on: ${exerciseName}`;
                     ui.customExIdInput.value = '';
                     ui.customExerciseForm.reset();
                     ui.customExNameInput.value = `${exerciseName} - Variation`;
                     ui.customExGroupSelect.value = exerciseDetails.group;
                     ui.customExTypeSelect.value = exerciseDetails.type;
                     ui.customExCompoundCheckbox.checked = !!exerciseDetails.isCompound;
                     ui.customExSaveBtn.textContent = 'Add Variation';
                     hideModal(ui.exercisePrefsModal);
                     showModal(ui.customExerciseModal);
                 }
             }

            ui.manageCustomExercisesBtn.addEventListener('click', () => {
                 editExerciseId = null;
                 ui.customExModalTitle.textContent = "Manage Custom Exercises";
                 ui.customExFormTitle.textContent = "Add New Exercise Manually";
                 ui.customExIdInput.value = '';
                 ui.customExerciseForm.reset();
                 ui.customExSaveBtn.textContent = 'Add Exercise';
                 showModal(ui.customExerciseModal);
            });
            ui.customExerciseCloseBtn.addEventListener('click', () => hideModal(ui.customExerciseModal));

            ui.customExerciseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = ui.customExNameInput.value.trim();
                const group = ui.customExGroupSelect.value;
                const type = ui.customExTypeSelect.value;
                 clearError('custom-ex-name');
                if (!name) {
                    showError('custom-ex-name', 'Exercise name cannot be empty.');
                    return;
                }
                 const isNameDuplicate = [...exerciseDB, ...customExerciseDB].some(ex =>
                     ex.name.toLowerCase() === name.toLowerCase() && ex.id !== editExerciseId
                 );
                 if (isNameDuplicate) {
                     showError('custom-ex-name', `An exercise named "${name}" already exists.`);
                     return;
                 }
                const exerciseData = {
                    id: editExerciseId || `custom-${crypto.randomUUID()}`,
                    name: name,
                    group: group,
                    type: type,
                    isCompound: ui.customExCompoundCheckbox.checked,
                    isCustom: true,
                    instructions: [], repRange: '', media: ''
                };
                if (editExerciseId) {
                    const index = customExerciseDB.findIndex(ex => ex.id === editExerciseId);
                    if (index > -1) customExerciseDB[index] = exerciseData;
                } else {
                    customExerciseDB.push(exerciseData);
                }
                localStorage.setItem('demo_customExerciseDB', JSON.stringify(customExerciseDB));
                saveFormState();
                renderCustomExerciseDisplay();
                 ui.customExerciseForm.reset();
                 editExerciseId = null;
                 ui.customExFormTitle.textContent = "Add New Exercise Manually";
                 ui.customExSaveBtn.textContent = 'Add Exercise';
                 renderExercisePreferences();
            });

             function renderCustomExerciseDisplay() {
                 const listContainer = ui.customExerciseList;
                 if (customExerciseDB.length === 0) {
                     ui.customExerciseDisplay.textContent = "No custom exercises/variations added.";
                     listContainer.innerHTML = `<p class="text-sm text-secondary-text p-2">None yet.</p>`;
                 } else {
                     ui.customExerciseDisplay.textContent = `${customExerciseDB.length} custom exercise(s) / variation(s) added.`;
                     listContainer.innerHTML = customExerciseDB.map(ex =>
                         `<div class="text-sm p-2 bg-input-bg rounded-md flex justify-between items-center gap-2">
                             <div>
                                 <span class="font-medium">${ex.name}</span>
                                 <span class="text-xs text-secondary-text block">(${ex.group} / ${ex.type} / ${ex.isCompound ? 'Compound' : 'Isolation'})</span>
                             </div>
                             <div class="flex gap-1 flex-shrink-0">
                                <button type="button" class="btn-icon-sm edit-custom-ex-btn" data-id="${ex.id}" title="Edit"><i data-lucide="pencil" class="w-3 h-3 pointer-events-none"></i></button>
                                <button type="button" class="btn-icon-sm remove-custom-ex-btn !text-red-400 !border-red-400/50 hover:!bg-red-500/10" data-id="${ex.id}" title="Delete"><i data-lucide="trash-2" class="w-3 h-3 pointer-events-none"></i></button>
                             </div>
                          </div>`
                     ).join('');
                     listContainer.querySelectorAll('.remove-custom-ex-btn').forEach(btn => {
                         btn.addEventListener('click', () => {
                             const idToRemove = btn.dataset.id;
                             const exerciseName = customExerciseDB.find(ex => ex.id === idToRemove)?.name || 'this exercise';
                             if (confirm(`Are you sure you want to delete "${exerciseName}"? This cannot be undone.`)) {
                                customExerciseDB = customExerciseDB.filter(ex => ex.id !== idToRemove);
                                localStorage.setItem('demo_customExerciseDB', JSON.stringify(customExerciseDB));
                                saveFormState();
                                renderCustomExerciseDisplay();
                                renderExercisePreferences();
                             }
                         });
                     });
                     listContainer.querySelectorAll('.edit-custom-ex-btn').forEach(btn => {
                          btn.addEventListener('click', () => {
                             const idToEdit = btn.dataset.id;
                             const exerciseToEdit = customExerciseDB.find(ex => ex.id === idToEdit);
                             if (exerciseToEdit) {
                                 editExerciseId = idToEdit;
                                 ui.customExModalTitle.textContent = "Edit Custom Exercise";
                                 ui.customExFormTitle.textContent = `Editing: ${exerciseToEdit.name}`;
                                 ui.customExIdInput.value = exerciseToEdit.id;
                                 ui.customExNameInput.value = exerciseToEdit.name;
                                 ui.customExGroupSelect.value = exerciseToEdit.group;
                                 ui.customExTypeSelect.value = exerciseToEdit.type;
                                 ui.customExCompoundCheckbox.checked = exerciseToEdit.isCompound;
                                 ui.customExSaveBtn.textContent = 'Save Changes';
                                 clearError('custom-ex-name');
                                 ui.customExNameInput.focus();
                             }
                         });
                     });
                 }
                 lucide.createIcons({ nodes: listContainer.querySelectorAll('button') });
             }

            ui.aiAssistBtn.addEventListener('click', async () => {
                const description = ui.aiAssistPrompt.value.trim();
                if (!description) { showCustomAlert("Missing Description", "Please describe the exercise."); return; }
                const prompt = `Suggest parameters for an exercise based on: "${description}".
Available Muscle Groups: ${ALL_MUSCLE_GROUPS.join(', ')}
Available Equipment Types: ${ALL_EQUIPMENT_TYPES.join(', ')}
Respond ONLY with valid JSON: {"name": string, "group": string (must be from list), "type": string (must be from list), "isCompound": boolean}. Ensure group and type are exactly from the provided lists.`;
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                 const suggestedParams = await makeApiCall(apiUrl, { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }, ui.aiAssistBtn, "application/json");

                if (suggestedParams && suggestedParams.name && suggestedParams.group && suggestedParams.type && ALL_MUSCLE_GROUPS.includes(suggestedParams.group) && ALL_EQUIPMENT_TYPES.includes(suggestedParams.type) ) {
                     editExerciseId = null;
                     ui.customExFormTitle.textContent = "Add New Exercise Manually (AI Pre-filled)";
                     ui.customExIdInput.value = '';
                     ui.customExerciseForm.reset();
                     ui.customExNameInput.value = suggestedParams.name;
                     ui.customExGroupSelect.value = suggestedParams.group;
                     ui.customExTypeSelect.value = suggestedParams.type;
                     ui.customExCompoundCheckbox.checked = !!suggestedParams.isCompound;
                     ui.customExSaveBtn.textContent = 'Add Exercise';
                      clearError('custom-ex-name');
                     showCustomAlert("AI Suggestion", "Suggestion pre-filled below. Please review and click 'Add Exercise'.");
                } else { showCustomAlert("AI Suggestion Failed", "Could not get valid parameters from AI, or the suggested group/type was invalid. Please try describing differently or fill manually."); }
            });

            document.querySelectorAll('.select-all-btn, .deselect-all-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.target.dataset.target;
                    const container = document.getElementById(targetId);
                    if (container) {
                        const shouldCheck = e.target.classList.contains('select-all-btn');
                        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            cb.checked = shouldCheck;
                        });
                         container.dispatchEvent(new Event('change'));
                        if (targetId === 'ai-plan-focus-muscle-container') {
                            renderExercisePreferences();
                        }
                    }
                });
            });

            ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));
            ui.undoToastBtn.addEventListener('click', () => {
                if (lastAction && typeof lastAction.onUndo === 'function') {
                    lastAction.onUndo();
                }
                hideUndo();
            });

            ui.aiPlanOptimizeTimelineToggle.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                ui.aiPlanOptimizeTimelineInput.classList.toggle('hidden', !isChecked);
                ui.aiPlanTimelineWeeksInput.required = isChecked;
                 if (!isChecked) clearError('ai-plan-timeline-weeks');
            });
            ui.aiPlanTrackingAppRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                     const isYes = e.target.value === 'yes';
                     ui.aiPlanTrackingAppDetails.classList.toggle('hidden', !isYes);
                     ui.aiPlanTrackingAppName.required = isYes;
                     if (!isYes) clearError('ai-plan-tracking-app-name');
                });
            });

            // --- [End of identical logic] ---


            // --- NEW: WIZARD NAVIGATION LOGIC ---

            // Page Titles
            const PAGE_TITLES = [
                "AI Workout Plan Generator", // Page 1
                "Your Goals & Experience",   // Page 2
                "Your Schedule & Split",     // Page 3
                "Equipment & Preferences",   // Page 4
                "Fine-Tuning",               // Page 5
                "Review & Generate",         // Page 6
                "Your New Workout Plan"      // Page 7 (Results)
            ];

            function showPage(pageNumber, isResuming = false) {
                // Hide all pages
                ui.wizardPages.forEach(page => page.classList.remove('active'));

                // Show the active page
                const newPage = document.getElementById(`page-${pageNumber}`);
                if (newPage) {
                    newPage.classList.add('active');
                }

                // Update progress bar
                const progressPercent = (pageNumber > TOTAL_PAGES) ? 100 : ((pageNumber - 1) / TOTAL_PAGES) * 100;
                ui.wizardProgressFill.style.width = `${progressPercent}%`;

                // Update title and step text
                ui.wizardTitle.textContent = PAGE_TITLES[pageNumber - 1] || "AI Workout Plan Generator";
                if (pageNumber <= TOTAL_PAGES) {
                    ui.wizardProgressText.textContent = `Step ${pageNumber} of ${TOTAL_PAGES}`;
                    ui.wizardHeader.classList.remove('hidden');
                } else {
                    // On results page (Page 7), hide the main progress header
                    ui.wizardHeader.classList.add('hidden');
                }

                // Update navigation buttons
                ui.wizardPrevBtn.classList.toggle('hidden', pageNumber === 1 || pageNumber > TOTAL_PAGES);
                ui.wizardNextBtn.classList.toggle('hidden', pageNumber >= TOTAL_PAGES);
                ui.wizardSubmitBtn.classList.toggle('hidden', pageNumber !== TOTAL_PAGES);

                // Update "Next" button text for Page 5 (Fine-Tuning)
                if (pageNumber === TOTAL_PAGES - 1) { // Page 5
                    ui.wizardNextBtn.querySelector('span').textContent = 'Review';
                } else {
                    ui.wizardNextBtn.querySelector('span').textContent = 'Next';
                }

                // If we're on the review page, populate the summary
                if (pageNumber === TOTAL_PAGES) {
                    populateReviewSummary();
                }

                // Scroll to top of card on page change, unless just resuming session
                if (!isResuming) {
                    ui.aiPlanPanel.parentElement.scrollIntoView({ behavior: 'smooth' });
                }
            }

            ui.wizardNextBtn.addEventListener('click', () => {
                if (validateCurrentPage()) {
                    currentPage++;
                    showPage(currentPage);
                    saveFormState(); // Save the new page number
                } else {
                    scrollToFirstError(); // Scroll to first error on the current page
                }
            });

            ui.wizardPrevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    showPage(currentPage);
                    saveFormState(); // Save the new page number
                }
            });

            ui.startOverBtn.addEventListener('click', () => {
                if (confirm("Are you sure you want to start over? All your inputs will be cleared.")) {
                    localStorage.removeItem('demo_aiPlanFormState');
                    localStorage.removeItem('demo_customSplits');
                    localStorage.removeItem('demo_exercisePrefs');
                    localStorage.removeItem('demo_dislikedExercises');
                    localStorage.removeItem('demo_customExerciseDB');

                    // Reset all state variables
                    currentPage = 1;
                    currentCustomSplits = [];
                    dislikedExercises = [];
                    workoutPlan = {};
                    exercisePrefs = {};
                    customExerciseDB = [];

                    // Reset form and reload
                    ui.aiPlanGeneratorForm.reset();
                    loadGeneratorData(); // Reload necessary state
                    loadExerciseData(); // Reload DB, repopulate fields, and load (now empty) state
                    showPage(1); // Go back to page 1
                }
            });


            // --- NEW: PAGE-SPECIFIC VALIDATION ---

            // Helper for required fields
            const checkRequired = (id, errorMsg) => {
                const el = document.getElementById(id);
                if (!el || !el.value) {
                    if(el) showError(id, errorMsg);
                    return false;
                }
                clearError(id);
                return true;
            };

            const checkRequiredNumber = (id, errorMsg, minVal = -Infinity, maxVal = Infinity) => {
                 const el = document.getElementById(id);
                 if (!el) return false;
                 const val = parseFloat(el.value);
                 if (!el.value || isNaN(val) || val < minVal || val > maxVal) {
                     showError(id, errorMsg);
                     return false;
                 }
                 clearError(id);
                 return true;
             };

            function validatePage1() {
                let isValid = true;
                if (!checkRequiredNumber('ai-plan-current-weight', 'Current weight is required and must be a positive number.', 1)) isValid = false;
                if (!checkRequiredNumber('ai-plan-ideal-weight', 'Ideal weight is required and must be a positive number.', 1)) isValid = false;
                if (!document.querySelector('input[name="body-type"]:checked')) { showError('body-type-group', 'Please select your body type.'); isValid = false; } else { clearError('body-type-group'); }
                if (!document.querySelector('input[name="body-fat"]:checked')) { showError('body-fat-container', 'Please select your body fat level.'); isValid = false; } else { clearError('body-fat-container'); }
                // No validation needed for optional trouble-spots
                return isValid;
            }

            function validatePage2() {
                let isValid = true;
                if (!checkRequired('ai-plan-goal', 'Please select your primary goal.')) isValid = false;
                if (ui.aiPlanGoalSelect.value === 'custom' && !checkRequired('ai-plan-goal-text', 'Please describe your custom goal.')) isValid = false;
                if (!checkRequired('ai-plan-training-history', 'Please select your training experience.')) isValid = false;
                if (ui.aiPlanOptimizeTimelineToggle.checked && !checkRequiredNumber('ai-plan-timeline-weeks', 'Timeline must be at least 4 weeks.', 4)) isValid = false;
                if (document.querySelector('input[name="tracking-app"]:checked')?.value === 'yes' && !checkRequired('ai-plan-tracking-app-name', 'Please enter the tracking app name.')) isValid = false;
                if (!checkRequired('ai-plan-knowledge-level', 'Please select your knowledge level.')) isValid = false;
                return isValid;
            }

            function validatePage3() {
                let isValid = true;
                 if (!checkRequired('ai-plan-split-select', 'Please select a split template.')) isValid = false;
                 if (ui.aiPlanSplitSelect.value === 'Custom' && currentCustomSplits.length === 0) {
                     showError('error-custom-split', 'Please add at least one custom split day.');
                     isValid = false;
                 } else {
                     clearError('error-custom-split');
                 }
                if (!checkRequired('ai-plan-schedule-constraints', 'Please select how busy you are.')) isValid = false;
                if (!checkRequired('ai-plan-activity-level', 'Please select your activity level.')) isValid = false;
                if (!validateSchedule()) isValid = false; // validateSchedule shows its own error
                return isValid;
            }

            function validatePage4() {
                 let isValid = true;
                 if (ui.aiPlanEquipmentContainer.querySelectorAll('input:checked').length === 0) { showError('ai-plan-equipment-container', 'Select at least one piece of equipment.'); isValid = false; } else { clearError('ai-plan-equipment-container'); }
                 return isValid; // The rest of this page is optional
            }

            function validatePage5() {
                let isValid = true;
                if (!checkRequiredNumber('ai-plan-duration', 'Duration must be at least 10 minutes.', 10)) isValid = false;
                // MODIFIED: Rest time validation (seconds)
                if (!checkRequiredNumber('ai-plan-rest', 'Rest must be at least 30 seconds.', 30)) isValid = false;
                if (!checkRequiredNumber('ai-plan-warmup-duration', 'Warmup duration cannot be negative.', 0)) isValid = false;
                if (!checkRequiredNumber('ai-plan-cooldown-duration', 'Cooldown duration cannot be negative.', 0)) isValid = false;

                // Validate Advanced Sets (if customized)
                 if(!ui.aiPlanSetsContainer.classList.contains('hidden')) {
                     ui.aiPlanSetsContainer.querySelectorAll('.advanced-set-input').forEach(input => {
                         if (input.value && (isNaN(parseFloat(input.value)) || parseFloat(input.value) < 0)) {
                             showError(input.id, 'Sets must be a non-negative number.'); isValid = false;
                         } else { clearError(input.id); }
                     });
                 }
                 const defaultSetsInput = ui.aiPlanDefaultSetsInput;
                 if (defaultSetsInput.value && (isNaN(parseFloat(defaultSetsInput.value)) || parseFloat(defaultSetsInput.value) < 0)) {
                      showError('ai-plan-default-sets', 'Default sets must be a non-negative number.'); isValid = false;
                 } else { clearError('ai-plan-default-sets'); }

                 return isValid;
            }

            function validatePage6() {
                // This page is just a review, no new inputs to validate
                return true;
            }

            // Function to run validation for the current page
            function validateCurrentPage() {
                switch(currentPage) {
                    case 1: return validatePage1();
                    case 2: return validatePage2();
                    case 3: return validatePage3();
                    case 4: return validatePage4();
                    case 5: return validatePage5();
                    case 6: return validatePage6();
                    default: return true;
                }
            }

            // Function to run all validations
            function validateAllPages() {
                // We run all validations so errors appear on all invalid fields
                const p1 = validatePage1();
                const p2 = validatePage2();
                const p3 = validatePage3();
                const p4 = validatePage4();
                const p5 = validatePage5();
                const p6 = validatePage6(); // (currently always true)
                return p1 && p2 && p3 && p4 && p5 && p6;
            }

             // Schedule Validation (used by Page 3)
             function validateSchedule(silent = false) {
                 const scheduleType = ui.aiPlanScheduleTypeSelect.value;
                 let hasWorkoutDay = false;
                 const scheduleBuilder = scheduleType === 'weekly' ? ui.aiPlanScheduleBuilder : ui.aiPlanCycleBuilder;

                 scheduleBuilder.querySelectorAll('.day-schedule-btn').forEach(btn => {
                     const type = btn.querySelector('.text-xs').textContent;
                     if (type !== 'Rest') {
                         hasWorkoutDay = true;
                     }
                 });

                 if (!hasWorkoutDay && !silent) {
                     showError(scheduleBuilder.id, "Assign at least one workout day (not 'Rest').");
                     // Also apply error style to the builder container
                     scheduleBuilder.classList.add('input-error');
                 } else {
                     clearError(scheduleBuilder.id);
                     scheduleBuilder.classList.remove('input-error');
                 }
                 return hasWorkoutDay;
             }

             // --- NEW: REVIEW PAGE POPULATION ---
             function populateReviewSummary() {
                const summaryContainer = ui.reviewSummaryList;
                const getChecked = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || 'N/A';
                const getSelectedText = (id) => document.getElementById(id).options[document.getElementById(id).selectedIndex]?.text || 'N/A';
                const getEquipment = () => Array.from(ui.aiPlanEquipmentContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                const getSchedule = () => {
                    const scheduleType = ui.aiPlanScheduleTypeSelect.value;
                    if (scheduleType === 'weekly') {
                        return Object.fromEntries(
                            [...ui.aiPlanScheduleBuilder.querySelectorAll('.day-schedule-btn')]
                            .map(btn => [btn.dataset.day.substring(0,3), btn.querySelector('.text-xs').textContent])
                            .filter(entry => entry[1] !== 'Rest')
                        );
                    } else {
                        return "Cyclic Schedule";
                    }
                }
                const getScheduleDays = () => {
                    const scheduleType = ui.aiPlanScheduleTypeSelect.value;
                    let count = 0;
                     if (scheduleType === 'weekly') {
                        count = [...ui.aiPlanScheduleBuilder.querySelectorAll('.day-schedule-btn')]
                            .filter(btn => btn.querySelector('.text-xs').textContent !== 'Rest').length;
                    } else {
                         count = [...ui.aiPlanCycleBuilder.querySelectorAll('.day-schedule-btn')]
                            .filter(btn => btn.querySelector('.text-xs').textContent !== 'Rest').length;
                    }
                    return `${count} days/week`;
                }

                const summaryData = [
                    { label: 'Primary Goal', value: getSelectedText('ai-plan-goal') },
                    { label: 'Experience', value: getSelectedText('ai-plan-training-history') },
                    { label: 'Body Type', value: getChecked('body-type') },
                    { label: 'Weights', value: `Current: ${ui.aiPlanCurrentWeight.value || 'N/A'}, Ideal: ${ui.aiPlanIdealWeight.value || 'N/A'}` },
                    { label: 'Workout Days', value: getScheduleDays() },
                    { label: 'Split', value: getSelectedText('ai-plan-split-select') + (ui.aiPlanAbToggle.checked ? ' (A/B)' : '') },
                    { label: 'Schedule', value: JSON.stringify(getSchedule()) },
                    { label: 'Duration', value: `${ui.aiPlanDurationInput.value} mins` },
                    { label: 'Rest', value: `${ui.aiPlanRestInput.value} secs` }, // MODIFIED: Show rest in seconds
                    { label: 'Equipment', value: getEquipment().join(', ') },
                ];

                summaryContainer.innerHTML = summaryData.map(item => `
                    <li>
                        <span class="review-label">${item.label}</span>
                        <span class="review-value">${item.value}</span>
                    </li>
                `).join('');
             }


            // --- UPDATED: FORM SUBMIT ---
            ui.aiPlanGeneratorForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Run validation for all pages
                if (!validateAllPages()) {
                    showCustomAlert("Validation Errors", "Please go back and fix the errors on previous pages.");
                    // Find first page with an error and go to it
                    for (let i = 1; i <= TOTAL_PAGES; i++) {
                        const pageHasError = document.querySelector(`#page-${i} .input-error, #page-${i} .checkbox-group-error.input-error, #page-${i} .radio-group-error.input-error`);
                        if (pageHasError) {
                            currentPage = i;
                            showPage(i);
                            scrollToFirstError();
                            break;
                        }
                    }
                    return; // Stop if validation fails
                }

                // Proceed with API call if valid
                const mainApiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                if (!mainApiUrl) return;

                const btn = ui.wizardSubmitBtn;
                // Button state managed within makeApiCall now

                // Show the results page (Page 7) with a loading state
                currentPage = TOTAL_PAGES + 1;
                showPage(currentPage);
                ui.aiPlanTimelineOutput.classList.add('hidden');
                ui.aiPlanExplanation.innerHTML = '<div class="flex justify-center items-center gap-2 p-4"><div class="loader"></div><span>Generating your plan...</span></div>';
                ui.saveNewPlanBtn.classList.add('hidden'); // Hide save button while loading

                try {
                    // Gather all form data (identical logic to original, except rest time)
                    const goal = ui.aiPlanGoalSelect.value;
                    const goalText = goal === 'custom' ? ui.aiPlanGoalText.value.trim() : goal;
                    const currentWeight = ui.aiPlanCurrentWeight.value;
                    const idealWeight = ui.aiPlanIdealWeight.value;
                    const bodyType = document.querySelector('input[name="body-type"]:checked')?.value;
                    const bodyFat = document.querySelector('input[name="body-fat"]:checked')?.value;
                    const activityLevel = ui.aiPlanActivityLevel.value;
                    const scheduleConstraints = ui.aiPlanScheduleConstraints.value;
                    const trainingHistory = ui.aiPlanTrainingHistory.value;
                    const pastAttempts = Array.from(document.querySelectorAll('input[name="past-attempts"]:checked')).map(cb => cb.value);
                    const isTracking = document.querySelector('input[name="tracking-app"]:checked')?.value;
                    const trackingAppName = isTracking === 'yes' ? ui.aiPlanTrackingAppName.value : 'N/A';
                    const trackingFollowUp = isTracking === 'yes' ? document.getElementById('ai-plan-tracking-follow-up').value : 'N/A';
                    const knowledgeLevel = ui.aiPlanKnowledgeLevel.value;
                    const nutritionConsistency = ui.aiPlanNutritionConsistency.value.trim();
                    const troubleSpots = ui.aiPlanTroubleSpots.value.trim();
                    const comfortSquat = ui.aiPlanComfortSquat.value;
                    const comfortBench = ui.aiPlanComfortBench.value;
                    const comfortDeadlift = ui.aiPlanComfortDeadlift.value;
                    const optimizeTimeline = ui.aiPlanOptimizeTimelineToggle.checked;
                    const timelineWeeks = optimizeTimeline ? ui.aiPlanTimelineWeeksInput.value : null;
                    const avoidances = ui.aiPlanAvoidancesInput.value.trim();
                    const isJointFriendly = ui.aiPlanJointFriendlyCheckbox.checked;
                    const warmupDuration = parseInt(ui.aiPlanWarmupDurationInput.value) || 0;
                    const cooldownDuration = parseInt(ui.aiPlanCooldownDurationInput.value) || 0;
                    const cardioPref = ui.aiPlanCardioSelect.value;
                    const dislikeList = dislikedExercises.join(', ');
                    const scheduleType = ui.aiPlanScheduleTypeSelect.value;

                    let schedule = {}; let schedulePromptText = '';
                    if (scheduleType === 'weekly') {
                        ui.aiPlanScheduleBuilder.querySelectorAll('.day-schedule-btn').forEach(btn => { schedule[btn.dataset.day] = btn.querySelector('.text-xs').textContent; });
                        schedulePromptText = `- Weekly Schedule: ${JSON.stringify(schedule)}`;
                    } else {
                        const cycleAssignments = {};
                         ui.aiPlanCycleBuilder.querySelectorAll('.day-schedule-btn').forEach(btn => { cycleAssignments[btn.dataset.day] = btn.querySelector('.text-xs').textContent; });
                        schedule = { type: 'cyclic', assignments: cycleAssignments };
                        schedulePromptText = `- Cyclic Schedule Assignments for Weekdays: ${JSON.stringify(cycleAssignments)} (Use these as the repeating pattern)`;
                    }

                    // Calculate daysPerWeek from the built schedule
                    let daysPerWeek = 0;
                    if (scheduleType === 'weekly') {
                        daysPerWeek = Object.values(schedule).filter(type => type !== 'Rest').length;
                    } else {
                        daysPerWeek = Object.values(schedule.assignments).filter(type => type !== 'Rest').length;
                    }

                    const equipment = Array.from(ui.aiPlanEquipmentContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                    const focusMuscles = Array.from(ui.aiPlanFocusMuscleContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                    const defaultSets = ui.aiPlanDefaultSetsInput.value;
                    const targetSets = {};
                    ui.aiPlanSetsContainer.querySelectorAll('input[type="number"]').forEach(input => { const muscle = input.dataset.group; if (input.value) targetSets[muscle] = input.value; });
                    const defaultDuration = ui.aiPlanDurationInput.value;
                    const durations = {};
                    ui.aiPlanDurationsContainer.querySelectorAll('.day-duration-input').forEach(input => { if (input.value) durations[input.dataset.key] = input.value; });
                    const restTimeSeconds = ui.aiPlanRestInput.value; // MODIFIED: Get seconds
                    let activeSplitTypes = [];
                    if (scheduleType === 'weekly') { activeSplitTypes = [...new Set(Object.values(schedule))]; }
                    else { activeSplitTypes = [...new Set(Object.values(schedule.assignments))]; }
                    activeSplitTypes = activeSplitTypes.filter(type => type !== 'Rest' && type !== 'Cardio');
                    const combinedExerciseDB = [...exerciseDB, ...customExerciseDB];
                    let allWarmupsList = [];
                    if (warmupDB.General) allWarmupsList.push(...warmupDB.General);
                    const uniqueWorkoutTypesInSchedule = new Set(activeSplitTypes.map(s => s.replace(/ A$| B$/, '')));
                    uniqueWorkoutTypesInSchedule.forEach(split => { if (warmupDB[split]) allWarmupsList.push(...warmupDB[split]); });
                    const allWarmupNames = [...new Set(allWarmupsList.map(w => w.name))].join(', ');


                    // Construct the prompt (UPDATED rest time)
                    let prompt = `Create a detailed weekly workout plan based on the following user profile and constraints.

User Profile:
- Primary Goal: ${goalText}
- Core Data: Current Weight: ${currentWeight}, Ideal Weight: ${idealWeight}, Body Type: ${bodyType}, Body Fat Estimate: ${bodyFat}, Daily Activity (Non-Exercise): ${activityLevel}
- Availability: ${daysPerWeek} days/week (derived from schedule). Typical Schedule: ${scheduleConstraints}.
- Experience: Training History: ${trainingHistory}, Past Attempts: ${pastAttempts.length > 0 ? pastAttempts.join(', ') : 'None specified'}, Tracking App Use: ${isTracking === 'yes' ? `Yes (${trackingAppName}, Follow-up: ${trackingFollowUp})` : 'No'}, Fitness Knowledge: ${knowledgeLevel}
- Preferences: Consistency Note: ${nutritionConsistency || 'None'}, Trouble Spots: ${troubleSpots || 'None'}, Compound Lift Comfort: (Squat: ${comfortSquat}, Bench: ${comfortBench}, Deadlift: ${comfortDeadlift})
- Injuries/Avoidances: ${avoidances || 'None'}
- Prioritize Joint-Friendly Exercises: ${isJointFriendly}
- Disliked Exercises: ${dislikeList || 'None'}
- Goal Timeline: ${optimizeTimeline ? `Specific target of ${timelineWeeks} weeks (adjust intensity accordingly)` : 'No specific timeline (generate a realistic estimate)'}

Plan Constraints:
- Warmup Duration: ${warmupDuration} minutes per workout.
- Cooldown Duration: ${cooldownDuration} minutes per workout.
- Cardio Integration: ${cardioPref}.
- Schedule Type: ${scheduleType}.
${schedulePromptText}
- Active Workout Types to Define: ${activeSplitTypes.join(', ')} (Create exercise lists ONLY for these types).
- Default Workout Duration: ${defaultDuration} minutes.
- Specific Durations (Overrides): ${JSON.stringify(durations)} (Use these if provided; key is Day for Weekly, Type for Cyclic).
- Default Rest Between Sets: ${restTimeSeconds} seconds (AI can adjust slightly based on exercise type).
- Available Equipment: ${equipment.join(', ') || 'Assume standard gym equipment'}
- Focus Muscle Groups (Emphasis): ${focusMuscles.join(', ') || 'Balanced development'}
- Preferred Exercises (Prioritize if suitable): ${JSON.stringify(exercisePrefs)}
- Available Exercises List (Use ONLY these): ${combinedExerciseDB.map(ex => `"${ex.name}" (${ex.group}, Compound: ${!!ex.isCompound})`).join(', ')}
- Available Warmup/Cooldown Exercises (Choose from these): ${allWarmupNames || 'General dynamic stretches, light cardio'}
- Volume Guidelines: Default Sets Per Muscle Group Per Week: ${defaultSets || 'Auto (AI decides based on goal/experience)'}. Specific Target Sets (Overrides): ${JSON.stringify(targetSets)}. Use these targets to guide exercise selection and set counts per workout. Estimate sets per exercise to fit workout duration (approx. 1.75 mins per set including rest).

Output Requirements:
Respond ONLY with a valid JSON object matching this structure:
{
  "name": "string (Creative and relevant plan name)",
  "schedule": ${JSON.stringify(schedule)}, // MUST match the provided schedule exactly
  "workouts": [ // Array containing ONE object for EACH unique Active Workout Type defined above
    {
      "day": "string (Workout Type Name, e.g., 'Push A', 'Legs', 'Upper B')",
      "warmup": ["string (List of 2-4 warmup exercise names from available list)"],
      "exercises": [ // List exercises for this specific workout type
        {
          "name": "string (Exercise name from available list)",
          "sets": "string (e.g., '3-4', '3')", // Recommended sets for this exercise
          "reps": "string (e.g., '8-12', '15-20')" // Recommended rep range
        }
      ],
      "cooldown": ["string (List of 1-2 cooldown exercise names)"]
    }
  ],
  "restTime": number (The default rest time in SECONDS provided),
  "estimatedTimeline": "string (e.g., '16-20 weeks' or 'Optimized for 8 weeks')",
  "reasoning": "string (Brief explanation <100 words, tailored to user's knowledge level: ${knowledgeLevel})"
}

Ensure the JSON is valid and complete according to the structure. Select appropriate exercises based on goals, equipment, preferences, and volume guidelines. Distribute target sets across the week's workouts. Add warmups and cooldowns. Generate a realistic timeline estimate if none was provided.`;

                    // Make the API Call
                    const parsedPlan = await makeApiCall(mainApiUrl, { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }, btn, "application/json");

                    if (parsedPlan && parsedPlan.workouts && parsedPlan.schedule) {
                        workoutPlan = parsedPlan; // Store generated plan
                        let reasoningHtml = `<strong>${parsedPlan.name || 'Your New Plan'}</strong><br>${parsedPlan.reasoning || "Here is your AI-generated plan."}`;
                        ui.aiPlanExplanation.innerHTML = reasoningHtml.replace(/\n/g, '<br>');
                        if (parsedPlan.estimatedTimeline) {
                            ui.aiPlanTimelineOutput.textContent = `Estimated time to reach your goal: ${parsedPlan.estimatedTimeline}`;
                            ui.aiPlanTimelineOutput.classList.remove('hidden');
                        }
                        ui.aiPlanJsonOutput.textContent = JSON.stringify(parsedPlan, null, 2);
                        ui.saveNewPlanBtn.classList.remove('hidden'); // Show save button
                    } else {
                         throw new Error("AI returned invalid or incomplete plan data.");
                    }
                } catch (error) {
                    console.error("Plan Generation Error:", error);
                    ui.aiPlanExplanation.innerHTML = `<span class="text-red-400"><strong>Plan Generation Failed:</strong> ${error.message}. Please check your inputs or try again later.</span>`;
                    ui.aiPlanTimelineOutput.classList.add('hidden');
                     ui.aiPlanJsonOutput.textContent = '';
                     ui.saveNewPlanBtn.classList.add('hidden'); // Hide save button on error
                }
            });

            // Save button on results page (unchanged logic)
            ui.saveNewPlanBtn.addEventListener('click', applyNewPlan);
             function applyNewPlan() {
               try {
                    if (!workoutPlan || !workoutPlan.schedule || !workoutPlan.workouts) { throw new Error("Generated plan data is missing required fields."); }
                    console.log("Applying new plan:", workoutPlan);
                    currentPlanData = workoutPlan;
                    localStorage.setItem('fitTrackAI_workoutPlan', JSON.stringify(currentPlanData));

                    // Clear form state after successful application
                    localStorage.removeItem('demo_aiPlanFormState');
                    // We don't reset the form here, we just show the alert
                    // and the user can click "Start Over"

                    showCustomAlert("Success", "Your new workout plan has been generated and saved!");
                    // Hide the save button to prevent double-saving
                    ui.saveNewPlanBtn.classList.add('hidden');

               } catch (error) {
                   console.error("Error applying plan:", error);
                   showCustomAlert("Error Saving Plan", `Could not save the new plan. The generated data might be invalid. ${error.message}`);
               }
            }


            // --- INITIALIZATION ---
            lucide.createIcons(); // Initial icon render
            loadGeneratorData(); // Load custom splits, prefs, dislikes
            loadExerciseData(); // Load exercise DB and populate form fields, then calls loadFormState
            // showPage(currentPage) is called inside loadFormState
        });
    </script>
</body>
</html>
