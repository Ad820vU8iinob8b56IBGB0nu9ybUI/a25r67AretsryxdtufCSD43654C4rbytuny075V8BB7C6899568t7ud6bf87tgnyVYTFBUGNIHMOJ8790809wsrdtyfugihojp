<!DOCTYPE html>
<html lang="en" class="h-full"> <!-- MODIFIED: h-full -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Food Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Added for barcode scanning --><script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <link rel="stylesheet" href="../styles.css">

    <style>
        html, body {
            overscroll-behavior-y: contain;
        }

        /* Styles for video overlay buttons */
        .btn-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--primary-text); /* Force light text */
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .btn-overlay:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.85); 
            transform: translateY(0);
        }

        .btn-overlay.btn-overlay-danger {
            background-color: rgba(229, 62, 62, 0.7); /* Red base color */
        }
        
        .btn-overlay.btn-overlay-danger:hover:not(:disabled) {
            background-color: rgba(229, 62, 62, 0.9); /* Darker red hover */
        }

        .btn-overlay {
            z-index: 20;
        }
        
        /* Item overlay for filmstrip */
        .item-overlay-content {
            position: absolute; 
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 100%);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            border-bottom-left-radius: 0.5rem; /* Match parent */
            border-bottom-right-radius: 0.5rem; /* Match parent */
            padding: 1.5rem 0.5rem 0.25rem 0.5rem; 
            color: var(--primary-text);
            text-align: left;
            opacity: 1;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            pointer-events: auto;
            z-index: 10;
        }

        .item-overlay-content p {
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem;
            color: var(--primary-text);
        }

        .item-overlay-content .item-title {
            font-weight: 600; /* font-semibold */
            font-size: 0.75rem; /* text-xs */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-overlay-content .item-nutrients {
            display: none; /* Hide nutrients on small filmstrip */
        }
        
        /* Carousel Wrapper is now the filmstrip container */
        .carousel-wrapper {
            position: relative;
            width: 100%;
            z-index: 15; /* Above camera, below buttons */
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
            flex-shrink: 0; 
        }

        /* Horizontal scroll container for filmstrip */
        .horizontal-scroll-container {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            overflow-x: auto;
            scroll-behavior: smooth;
            scroll-snap-type: x mandatory; 
            gap: 0.75rem; /* 12px */
            padding-bottom: 1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
            cursor: grab;
        }
        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .horizontal-scroll-container:active {
            cursor: grabbing;
        }
        
        /* Scroll item for filmstrip */
        .scroll-item {
            flex: 0 0 7rem; /* w-28 */
            width: 7rem; /* w-28 */
            height: 7rem; /* h-28 */
            scroll-snap-align: start; /* Snap to start */
            white-space: normal;
        }
        
        /* Custom scrollbar for the scanned items list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-text);
        }
        .custom-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: thin;  /* Firefox */
            scrollbar-color: var(--border-color) transparent;
        }

        /* Photo Popup Styles */
        #photo-popup {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: scale(0.9);
            display: none; /* Hidden by default */
            position: absolute;
            top: 1rem; /* 4 */
            left: 1rem; /* 4 */
            z-index: 30; /* Above video, below buttons */
            width: 6rem; /* w-24 */
            height: 6rem; /* h-24 */
            border-radius: 0.5rem; /* rounded-lg */
            border-width: 2px;
            border-color: #FFFFFF; /* border-white */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            overflow: hidden;
            opacity: 0;
        }
        #photo-popup.show {
            display: block;
            opacity: 1;
            transform: scale(1);
        }
        #photo-popup.hide {
            opacity: 0;
            transform: scale(0.9);
        }
        
        /* --- NEW: Tab/Swipe Styles --- */
        #swipe-track {
            transition: transform 0.3s ease-in-out;
        }
        
        .tab-dot { 
            transition: background-color 0.3s ease; 
            width: 0.5rem; /* w-2 */
            height: 0.5rem; /* h-2 */
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
        }
        .tab-dot.active { 
            background-color: var(--accent); 
        }
        .tab-dot:not(.active) { 
            background-color: var(--border-color); 
        }

    </style>
</head>
<!-- MODIFIED: Added h-full, flex, flex-col, overflow-hidden -->
<body class="antialiased h-full flex flex-col overflow-hidden">

    <script>
        // Apply theme immediately
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    
    <div id="header-placeholder"></div>

    <!-- Main content area -->
    <!-- MODIFIED: Replaced main content with swipe container structure -->
    <div class="content-card flex-grow overflow-hidden flex flex-col !p-0">
        
        <div id="swipe-container" class="flex-grow overflow-hidden relative flex flex-col">
            <!-- Swipe Track -->
            <div id="swipe-track" class="flex h-full flex-grow">
                
                <!-- Panel 1: Log -->
                <div id="log-panel" class="w-full h-full flex-shrink-0 flex flex-col p-4 overflow-y-auto custom-scrollbar">
                    <h2 class="text-2xl font-bold mb-4 flex-shrink-0">Today's Logged Items</h2>
                    <div id="scanned-log-display" class="space-y-2 flex-grow">
                        <!-- Logged items will be rendered here -->
                        <p class="text-secondary-text">No items logged yet.</p>
                    </div>
                </div>

                <!-- Panel 2: Camera (Original Content) -->
                <div id="camera-panel" class="w-full h-full flex-shrink-0 flex flex-col p-4 overflow-hidden">
                    <!-- This div holds the original layout -->
                    <div class="space-y-4 flex-grow flex flex-col">
                        <div id="ai-live-camera-container" class="!flex-shrink-0 bg-input-bg rounded-lg relative overflow-hidden flex-grow">
                            
                            <div id="photo-popup">
                                <img id="photo-popup-img" src="" alt="Scanned item" class="w-full h-full object-cover">
                            </div>

                            <div id="camera-overlay" class="absolute inset-0 z-20 rounded-lg overflow-hidden transition-opacity duration-300 opacity-0 pointer-events-none">
                                <!-- MODIFIED: Changed to object-cover -->
                                <canvas id="camera-overlay-canvas" class="absolute top-0 left-0 w-full h-full object-cover"></canvas>
                                <div class="absolute top-0 left-0 w-full h-full bg-black/70 backdrop-blur-sm"></div>
                                <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center z-10">
                                    <button id="start-camera-overlay-btn" class="btn bg-white text-black hover:bg-gray-200"><i data-lucide="camera"></i>Start Camera</button>
                                </div>
                            </div>

                            <h2 class="absolute top-4 left-1/2 -translate-x-1/2 z-30 text-lg font-bold text-white bg-black/30 px-4 py-1 rounded-full pointer-events-none">
                                AI Scanner
                            </h2>
                            
                            <!-- MODIFIED: Changed to object-cover -->
                            <video id="ai-camera-video" class="w-full h-full object-cover" autoplay playsinline muted></video>
                            <canvas id="ai-camera-canvas" class="hidden"></canvas> 
                            
                            <a href="javascript:history.back()" id="scanner-close-btn" class="btn-overlay !p-2 !rounded-full absolute top-4 right-4 z-30" title="Close Scanner">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </a>
                            
                            <!-- REMOVED: scanned-log-popup-btn -->

                            <button id="flip-camera-btn" class="btn btn-overlay !p-2 !rounded-full absolute bottom-3 left-3" title="Flip Camera">
                                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                            </button>

                            <div class="absolute bottom-3 left-1/2 -translate-x-1/2 z-20 flex items-center gap-2">
                                <button id="capture-ai-photo-btn" class="btn btn-overlay !p-2 !rounded-full" title="Capture Photo">
                                    <i data-lucide="camera" class="w-5 h-5"></i>
                                </button>
                                <button id="stop-ai-camera-btn" class="btn btn-overlay btn-overlay-danger !p-2 !rounded-full" title="Close Camera">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            
                            <!-- REMOVED: Upload label and input from here -->

                            <!-- NEW: Tab Indicators MOVED here -->
                            <div id="tab-indicators" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-30">
                                <button class="tab-dot" data-index="0"></button>
                                <button class="tab-dot active" data-index="1"></button>
                                <button class="tab-dot" data-index="2"></button>
                            </div>
                        </div>
                        
                        <div id="ai-scanner-carousel-wrapper" class="carousel-wrapper">
                            <div id="ai-scanner-results-container" class="horizontal-scroll-container scanner-carousel !flex !flex-row !flex-nowrap">
                                <!-- Scanned items will be prepended here by JS -->
                            </div>
                        </div>
                        
                        <p id="ai-scanner-status" class="text-center text-secondary-text text-sm min-h-[1.25rem] mt-4 flex-shrink-0"></p>
                    </div>
                </div>

                <!-- Panel 3: Upload -->
                <div id="upload-panel" class="w-full h-full flex-shrink-0 flex flex-col p-4 items-center justify-center overflow-y-auto custom-scrollbar">
                    <h2 class="text-2xl font-bold mb-4 text-center">Upload Photo</h2>
                    <label for="ai-upload-photo-input" class="flex flex-col items-center justify-center w-full max-w-sm h-64 bg-input-bg border-2 border-border-color border-dashed rounded-lg cursor-pointer hover:bg-card-bg transition-colors">
                        <i data-lucide="upload-cloud" class="w-16 h-16 text-secondary-text mb-4"></i>
                        <p class="text-lg font-semibold">Click to upload</p>
                        <p class="text-sm text-secondary-text">or drag and drop</p>
                    </label>
                    <input type="file" id="ai-upload-photo-input" class="hidden" accept="image/*" multiple>
                    <p class="text-xs text-secondary-text mt-4 text-center">Upload a photo of food or a barcode.</p>
                </div>

            </div>

            <!-- Tab Indicators -->
            <!-- MOVED: This div is no longer here -->
        </div>

    </div>
    <!-- END: New swipe container structure -->


    <!-- Hidden helper for html5-qrcode library -->
    <div id="barcode-reader-hidden-helper" class="hidden"></div>
    
    <!-- REMOVED: Undo Toast (simplifying) -->

    <!-- REMOVED: Scanned Log Modal -->

    <div id="footer-placeholder"></div>

    <script>
        // --- Load Header and Footer ---
        async function loadComponent(url, placeholderId) {
            // ... (existing loadComponent function) ...
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}: ${response.statusText}`);
                let text = await response.text();
                
                text = text.replace(/href="index\.html"/g, 'href="../../index.html"');
                text = text.replace(/href="settings\.html"/g, 'href="../../settings.html"');
                text = text.replace(/href="nutrition\.html"/g, 'href="../../nutrition.html"');
                text = text.replace(/href="workouts\.html"/g, 'href="../../workouts.html"');
                text = text.replace(/href="sleep\.html"/g, 'href="../../sleep.html"');
                text = text.replace(/href="progress\.html"/g, 'href="../../progress.html"');
                text = text.replace(/href="social\.html"/g, 'href="../../social.html"');

                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = text;
                }
            } catch (error) {
                console.error(`Error loading component from ${url}:`, error);
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = `<p class="text-red-500 text-center">Error loading component.</p>`;
                }
            }
        }

        async function initializeLayout() {
            // ... (existing initializeLayout function) ...
            await Promise.all([
                loadComponent('../header.html', 'header-placeholder'),
                loadComponent('../footer.html', 'footer-placeholder')
            ]);
            lucide.createIcons(); 

            const currentPage = 'nutrition';
            const navLinks = document.querySelectorAll('#mobile-footer-nav .nav-link');
            navLinks.forEach(link => {
                const linkPage = link.getAttribute('data-page');
                if (linkPage === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            initializeAppPage();
        }
        // --- End Load Header and Footer ---

        // --- MODIFIED page script ---
        function initializeAppPage() {
            let foodCameraStream = null;
            let html5QrCode = null;
            let currentFacingMode = 'environment';

            let scannerLogs = {}; // This now stores *scanned* items for the filmstrip
            let viewDate = new Date();
            viewDate.setHours(0, 0, 0, 0);

            let isDragging = false;
            let dragStartX = 0;
            let scrollLeftStart = 0;
            let dragDeltaX = 0;
            
            // --- NEW: Swipe Panel State ---
            let currentPanelIndex = 1; // Start on Camera
            let isSwiping = false;
            let swipeStartX = 0;
            let swipeDeltaX = 0;
            // --- END: Swipe Panel State ---

            // --- REMOVED: Undo Toast State ---

            const ui = {
                uploadPhotoInput: document.getElementById('ai-upload-photo-input'),
                scannerResultsContainer: document.getElementById('ai-scanner-results-container'),
                foodScannerStatus: document.getElementById('ai-scanner-status'),
                liveCameraContainer: document.getElementById('ai-live-camera-container'),
                cameraOverlay: document.getElementById('camera-overlay'),
                startCameraOverlayBtn: document.getElementById('start-camera-overlay-btn'),
                stopFoodCameraBtn: document.getElementById('stop-ai-camera-btn'),
                captureFoodPhotoBtn: document.getElementById('capture-ai-photo-btn'),
                foodCameraVideo: document.getElementById('ai-camera-video'),
                foodCameraCanvas: document.getElementById('ai-camera-canvas'),
                foodScannerCarouselWrapper: document.getElementById('ai-scanner-carousel-wrapper'),
                scannedLogDisplay: document.getElementById('scanned-log-display'), // Moved from modal
                flipCameraBtn: document.getElementById('flip-camera-btn'),
                photoPopup: document.getElementById('photo-popup'),
                photoPopupImg: document.getElementById('photo-popup-img'),
                
                // --- NEW: Swipe Panel UI ---
                swipeContainer: document.getElementById('swipe-container'),
                swipeTrack: document.getElementById('swipe-track'),
                tabIndicators: document.getElementById('tab-indicators'),
                
                // --- REMOVED: Modal UI ---
            };

            const getApiUrl = (model, action = 'generateContent') => {
                const apiKey = "AIzaSyA8-WLMo2U2Km-FN2r_fYk8OUfxyZ7dJoM"; // Leave empty for Canvas environment
                return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`;
            };

            async function fetchWithBackoff(apiUrl, payload, maxRetries = 3) {
                // ... (existing fetchWithBackoff function) ...
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const hasText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            const hasImageData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                            const hasStructuredResponse = payload.generationConfig?.responseMimeType === "application/json";

                           if (hasText || hasImageData || hasStructuredResponse) {
                                return result;
                            } else {
                                console.warn("API response structure unexpected, but status OK:", result);
                                if (i === maxRetries - 1) throw new Error("Invalid API response format after retries.");
                            }
                        } else if (response.status === 429 || response.status >= 500) {
                            if (i === maxRetries - 1) throw new Error(`API Error: ${response.status} after ${maxRetries} attempts.`);
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw new Error(`API Error: ${response.status} - ${await response.text()}`);
                        }
                    } catch (error) {
                        console.error(`Fetch attempt ${i + 1} failed:`, error);
                        if (i === maxRetries - 1) throw error;
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                throw new Error("API call failed after all retries.");
            }

            function capitalizeWords(str) { if (!str) return ''; return str.replace(/\b\w/g, char => char.toUpperCase()); }

            // --- REMOVED: Modal Show/Hide ---
            
            function fileToGenerativePart(file) { 
                // ... (existing fileToGenerativePart function) ...
                return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => { const base64Data = reader.result.split(',')[1]; resolve({ inlineData: { mimeType: file.type, data: base64Data } }); }; reader.onerror = (err) => reject(err); reader.readAsDataURL(file); }); 
            }

            function dateToKey(date) { 
                // ... (existing dateToKey function) ...
                return date.toISOString().split('T')[0]; 
            }

            // --- MODIFIED: Scanner Log (Filmstrip) functions ---
            function getTodaysLog() {
                // This gets the log for the *filmstrip*
                const key = dateToKey(viewDate);
                if (!scannerLogs[key]) {
                    scannerLogs[key] = { entries: [] };
                }
                return scannerLogs[key];
            }

            function saveScannerLog() {
                // This saves the log for the *filmstrip*
                localStorage.setItem('scannerAI_logs_v2', JSON.stringify(scannerLogs));
            }

            function loadScannerLog() {
                // This loads the log for the *filmstrip*
                scannerLogs = JSON.parse(localStorage.getItem('scannerAI_logs_v2')) || {};
                
                // NEW: Re-render carousel on load
                ui.scannerResultsContainer.innerHTML = '';
                const dayLog = getTodaysLog();
                dayLog.entries.forEach(item => {
                    renderScannedItemToCarousel(item);
                });
                renderScannerLog(); // This renders the "Log" panel list
            }
            // --- END: Scanner Log (Filmstrip) functions ---


            // --- REMOVED: Undo Toast Functions ---
            
            // --- NEW: Helper to set log button state ---
            function logButtonSetState(button, isLogged, logId) {
                if (isLogged) {
                    button.innerHTML = '<i data-lucide="check-check" class="w-4 h-4 pointer-events-none"></i>';
                    button.title = 'Logged! (Tap to un-log)'; // MODIFIED
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                    button.isLogged = true;
                    button.logId = logId; // This is the scannerLogId
                    button.dataset.logId = logId;
                } else {
                    button.innerHTML = '<i data-lucide="check" class="w-4 h-4 pointer-events-none"></i>';
                    button.title = 'Log this';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-primary');
                    button.isLogged = false;
                    button.logId = null;
                    button.dataset.logId = "null";
                }
                lucide.createIcons({ root: button });
            }

            // --- NEW: Function to log item to main nutrition log ---
            function logScannedItemToMain(item, button) {
                let mainNutritionLogs = JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs') || '{}');
                const todayKey = dateToKey(viewDate);
                if (!mainNutritionLogs[todayKey]) {
                    mainNutritionLogs[todayKey] = { entries: [], water: 0 };
                }
                
                // Add to main log
                const mainLogItem = {
                    ...item,
                    logId: Date.now(), // New unique ID for the *main* log
                    scannerLogId: item.logId // Reference to the scanner item
                };
                mainNutritionLogs[todayKey].entries.unshift(mainLogItem);
                localStorage.setItem('fitTrackAI_allDailyLogs', JSON.stringify(mainNutritionLogs));
                
                // Update button state
                logButtonSetState(button, true, item.logId);
                
                // Re-render the "Log" panel list
                renderScannerLog();
            }

            // --- MODIFIED: Delete Function ---
            function deleteLogItem(logId, source = 'list') {
                // This function now *only* removes from the main nutrition log
                let mainNutritionLogs = JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs') || '{}');
                const todayKey = dateToKey(viewDate);
                if (!mainNutritionLogs[todayKey]) return;

                // Find by scannerLogId
                const logIndex = mainNutritionLogs[todayKey].entries.findIndex(entry => entry.scannerLogId === logId);
                if (logIndex === -1) {
                    // If not found by scannerLogId (e.g., from log panel), try by logId
                    const logIndexById = mainNutritionLogs[todayKey].entries.findIndex(entry => entry.logId === logId);
                    if (logIndexById === -1) return; // Not found
                    
                    const itemToDelete = mainNutritionLogs[todayKey].entries.splice(logIndexById, 1)[0];
                    if (!itemToDelete) return;
                    
                    localStorage.setItem('fitTrackAI_allDailyLogs', JSON.stringify(mainNutritionLogs));
                    renderScannerLog(); // Re-render the "Log" panel list

                    // Update carousel button if it exists
                    if (itemToDelete.scannerLogId) {
                        const carouselLogButton = ui.scannerResultsContainer.querySelector(`.ai-log-button[data-log-id="${itemToDelete.scannerLogId}"]`);
                        if (carouselLogButton) {
                            logButtonSetState(carouselLogButton, false, null);
                        }
                    }
                    return;
                };

                const itemToDelete = mainNutritionLogs[todayKey].entries.splice(logIndex, 1)[0];
                if (!itemToDelete) return;

                localStorage.setItem('fitTrackAI_allDailyLogs', JSON.stringify(mainNutritionLogs));
                
                // Re-render the "Log" panel list
                renderScannerLog();

                // Find the carousel card button
                const carouselLogButton = ui.scannerResultsContainer.querySelector(`.ai-log-button[data-log-id="${logId}"]`);
                if (carouselLogButton) {
                    logButtonSetState(carouselLogButton, false, null);
                }
                
                // Special case: Double-click on carousel item
                if (source === 'carouselDblClick') {
                    // This item should be removed from the scanner log and UI
                    const dayLog = getTodaysLog();
                    const scannerIndex = dayLog.entries.findIndex(entry => entry.logId === logId);
                    if (scannerIndex > -1) {
                        dayLog.entries.splice(scannerIndex, 1);
                        saveScannerLog(); // Save removal from scanner log
                        
                        // Remove from UI
                        const itemToRemove = ui.scannerResultsContainer.querySelector(`.ai-log-button[data-log-id="${logId}"]`).closest('.scroll-item');
                        if (itemToRemove) {
                            itemToRemove.remove();
                        }
                    }
                }
            }


            // --- MODIFIED: renderScannerLog (for Log Panel) ---
            function renderScannerLog() {
                const mainNutritionLogs = JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs') || '{}');
                const todayMainLog = mainNutritionLogs[dateToKey(viewDate)];
                
                if (!todayMainLog || todayMainLog.entries.length === 0) {
                    ui.scannedLogDisplay.innerHTML = '<p class="text-secondary-text">No items logged yet.</p>';
                    return;
                }
                
                // Filter for items that *came from the scanner*
                const scannerEntries = todayMainLog.entries.filter(e => e.scannerLogId);
                
                if (scannerEntries.length === 0) {
                    ui.scannedLogDisplay.innerHTML = '<p class="text-secondary-text">No scanned items logged yet. (Manual entries will not appear here).</p>';
                    return;
                }

                ui.scannedLogDisplay.innerHTML = scannerEntries.map((item, index) => `
                    <div class="bg-card-bg border border-border-color p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-medium">${item.servings}x ${item.name} ${item.grams > 0 ? `(${item.grams.toFixed(0)}g)` : ''}</p>
                            <p class="text-sm text-secondary-text">${item.calories?.toFixed(0) || 0}kcal | ${item.protein?.toFixed(1) || 0}p | ${item.carbs?.toFixed(1) || 0}c | ${item.fat?.toFixed(1) || 0}f</p>
                        </div>
                        <button class="btn btn-danger !p-2 remove-log-btn" data-log-id="${item.logId}" title="Remove"> <!-- Use main logId -->
                            <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                    </div>
                `).join('');
                lucide.createIcons();
            } 

            // --- NEW: Render item to filmstrip carousel ---
            function renderScannedItemToCarousel(item) {
                const resultElement = document.createElement('div');
                resultElement.className = 'scroll-item bg-input-bg rounded-lg text-center !flex-shrink-0 h-28 w-28 overflow-hidden relative';
                resultElement.innerHTML = `
                    <img class="w-full h-full object-cover" src="${item.base64Image || 'https://placehold.co/112x112/191919/FFFFFF?text=Item'}" alt="Scanned item">
                    <div class="item-overlay-content">
                        <div>
                            <div class="flex justify-between items-start gap-2">
                                <div><p class="item-title">${item.name || 'Processing...'}</p></div>
                                <button class="btn btn-primary ai-log-button !p-2 !rounded-full !flex-shrink-0" data-log-id="${item.logId}" title="Log this">
                                    <i data-lucide="check" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add double-tap listener
                let lastTap = 0;
                resultElement.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    const currentTime = new Date().getTime();
                    if ((currentTime - lastTap) < 300) {
                        deleteLogItem(item.logId, 'carouselDblClick');
                        lastTap = 0;
                    } else {
                        lastTap = currentTime;
                    }
                });

                ui.scannerResultsContainer.prepend(resultElement);
                lucide.createIcons({ root: resultElement });

                const logButton = resultElement.querySelector('.ai-log-button');
                
                // Check if this item is *already* in the main nutrition log
                const mainNutritionLogs = JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs') || '{}');
                const todayMainLog = mainNutritionLogs[dateToKey(viewDate)];
                const isAlreadyLogged = todayMainLog && todayMainLog.entries.some(entry => entry.scannerLogId === item.logId);
                
                logButtonSetState(logButton, isAlreadyLogged, isAlreadyLogged ? item.logId : null);
                
                // Add log button click handler
                logButton.onclick = () => {
                    if (logButton.isLogged) {
                        deleteLogItem(item.logId, 'logButton'); // This will un-log it
                    } else {
                        logScannedItemToMain(item, logButton);
                    }
                };
            }
            
            // --- NEW: Update carousel UI after AI processing ---
            function updateCarouselItemUI(resultElement, item, isSuccess) {
                const overlayContent = resultElement.querySelector('.item-overlay-content');
                if (!overlayContent) return;

                if (isSuccess) {
                    overlayContent.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start gap-2">
                                <div><p class="item-title">${item.name}</p></div>
                                <button class="btn btn-primary ai-log-button !p-2 !rounded-full !flex-shrink-0" data-log-id="${item.logId}" title="Log this">
                                    <i data-lucide="check" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    // Add log button click handler
                    const logButton = overlayContent.querySelector('.ai-log-button');
                    logButtonSetState(logButton, false, null); // It's a new item, so it's not logged
                    logButton.onclick = () => {
                        if (logButton.isLogged) {
                            deleteLogItem(item.logId, 'logButton');
                        } else {
                            logScannedItemToMain(item, logButton);
                        }
                    };
                    // Update double-tap listener with correct logId
                    let lastTap = 0;
                    resultElement.addEventListener('click', (e) => {
                        if (e.target.closest('button')) return;
                        const currentTime = new Date().getTime();
                        if ((currentTime - lastTap) < 300) {
                            deleteLogItem(item.logId, 'carouselDblClick');
                            lastTap = 0;
                        } else {
                            lastTap = currentTime;
                        }
                    });

                } else {
                     overlayContent.innerHTML = `<p class="text-red-400 text-xs">${item.name || 'Error'}</p>`; // item.name will contain error msg
                }
                lucide.createIcons({ root: overlayContent });
            }

            // --- NEW: Show photo popup ---
            function showPhotoPopup(imageUrl) {
                if (ui.photoPopup && ui.photoPopupImg) {
                    ui.photoPopupImg.src = imageUrl;
                    ui.photoPopup.style.display = 'block';
                    setTimeout(() => {
                        ui.photoPopup.classList.add('show');
                        ui.photoPopup.classList.remove('hide');
                    }, 10);
                    setTimeout(() => {
                        ui.photoPopup.classList.add('hide');
                        ui.photoPopup.classList.remove('show');
                        setTimeout(() => {
                            if (!ui.photoPopup.classList.contains('show')) {
                                ui.photoPopup.style.display = 'none';
                            }
                        }, 300);
                    }, 2000);
                }
            }

            async function getAiImageClassification(imagePart) {
                // ... (existing getAiImageClassification function) ...
                const prompt = "Is this image primarily a barcode or a picture of food? Respond with ONLY 'barcode' or 'food'.";
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                const payload = { contents: [{ parts: [{ text: prompt }, imagePart] }] };
                try {
                    const result = await fetchWithBackoff(apiUrl, payload);
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid classification response.");
                    return result.candidates[0].content.parts[0].text.trim().toLowerCase();
                } catch (error) {
                    console.error("AI Classification Error:", error);
                    return 'error';
                }
            }

            // --- MODIFIED: processBarcodeScan ---
            async function processBarcodeScan(decodedText, file, resultElement, imageUrl) {
                const overlayContent = resultElement.querySelector('.item-overlay-content');
                if (!overlayContent) return;
                // overlayContent.innerHTML = '<div class="loader mx-auto"></div>'; // Already set

                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${decodedText}?fields=product_name,brands,nutriments,serving_size,quantity`);
                    if(!response.ok) throw new Error('Product not found.');
                    const data = await response.json();
                    if(data.status === 0 || !data.product) throw new Error(data.status_verbose || 'Product not found.');

                    const product = data.product, nutriments = product.nutriments;
                    const per100g = {
                        calories: nutriments['energy-kcal_100g'] || 0, protein: nutriments.proteins_100g || 0, carbs: nutriments.carbohydrates_100g || 0, fat: nutriments.fat_100g || 0, sugar: nutriments.sugars_100g || 0, sodium: (nutriments.sodium_100g || 0) * 1000, potassium: (nutriments.potassium_100g || 0) * 1000,
                    };

                    let defaultGrams = 100;
                    if (product.serving_size) {
                        const servingMatch = String(product.serving_size).match(/(\d+(\.\d+)?)/);
                        if (servingMatch) { defaultGrams = parseFloat(servingMatch[0]); }
                    } else if (product.quantity) {
                          const quantityMatch = String(product.quantity).match(/(\d+(\.\d+)?)/);
                          if (quantityMatch) { defaultGrams = parseFloat(quantityMatch[0]); }
                    }

                    const productName = capitalizeWords(product.product_name) || 'Scanned Item';
                    
                    if ((productName === 'Scanned Item' && per100g.calories === 0) || !product.product_name) {
                        updateCarouselItemUI(resultElement, { name: 'Barcode not found' }, false);
                        return;
                    }
                    
                    const logId = Date.now();
                    const servings = 1;
                    const grams = defaultGrams;
                    const foodItem = {
                        logId: logId, name: productName, brand: product.brands || '',
                        servings: servings, grams: grams,
                        calories: (per100g.calories / 100 * grams) || 0, 
                        protein: (per100g.protein / 100 * grams) || 0, 
                        carbs: (per100g.carbs / 100 * grams) || 0,
                        fat: (per100g.fat / 100 * grams) || 0,
                        sugar: (per100g.sugar / 100 * grams) || 0, 
                        sodium: (per100g.sodium / 100 * grams) || 0, 
                        potassium: (per100g.potassium / 100 * grams) || 0,
                        base64Image: imageUrl // <-- SAVE IMAGE
                    };
                    const dayLog = getTodaysLog();
                    dayLog.entries.unshift(foodItem);
                    saveScannerLog();
                    
                    updateCarouselItemUI(resultElement, foodItem, true);

                } catch (error) {
                    const errorMsg = `Barcode error: ${error.message}`;
                    updateCarouselItemUI(resultElement, { name: errorMsg }, false);
                }
            }

            function autoStopAiCamera() {
                // ... (existing autoStopAiCamera function) ...
                if (foodCameraStream) {
                    foodCameraStream.getTracks().forEach(track => track.stop());
                    foodCameraStream = null;
                    ui.foodScannerStatus.textContent = 'Camera paused.';
                }
            }

            // --- MODIFIED: manualStopAiCamera ---
            function manualStopAiCamera() {
                const video = ui.foodCameraVideo;
                const overlayCanvas = document.getElementById('camera-overlay-canvas');
                if (overlayCanvas && video.videoWidth > 0 && video.videoHeight > 0) {
                    try {
                        const overlayCtx = overlayCanvas.getContext('2d');
                        overlayCanvas.width = video.videoWidth;
                        overlayCanvas.height = video.videoHeight;
                        overlayCtx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                    } catch (e) {
                        console.error("Error drawing last frame to canvas:", e);
                    }
                }

                if (foodCameraStream) {
                    foodCameraStream.getTracks().forEach(track => track.stop());
                    foodCameraStream = null;
                }
                
                ui.cameraOverlay.classList.remove('opacity-0', 'pointer-events-none');
                
                ui.foodScannerStatus.textContent = 'Camera off. Tap to start.';
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Error stopping barcode scanner:", err));
                }
            }

            async function startAiCamera() {
                // --- MODIFIED: startAiCamera ---
                if (foodCameraStream) return; // Don't restart if already running
                
                ui.cameraOverlay.classList.add('opacity-0', 'pointer-events-none');
                ui.liveCameraContainer.classList.remove('hidden');

                ui.foodScannerStatus.textContent = 'Starting camera...';
                try {
                    foodCameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
                    ui.foodCameraVideo.srcObject = foodCameraStream;
                    ui.foodScannerStatus.textContent = 'Camera active. Point and capture.';
                } catch (err) {
                    console.error("Camera access error:", err);
                    ui.foodScannerStatus.textContent = `Could not access ${currentFacingMode} camera.`;
                    manualStopAiCamera(); // Show overlay on failure
                }
            }

            function flipCamera() {
                currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                startAiCamera(); // Restart camera with new mode
            }

            function captureAiPhoto() {
                // ... (existing captureAiPhoto function) ...
                const video = ui.foodCameraVideo;
                const canvas = ui.foodCameraCanvas;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(blob => {
                    if (blob) {
                        const file = new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' });
                        handleAiScanFiles([file]);
                    }
                }, 'image/jpeg', 0.9);
            }

            // --- MODIFIED: processFoodImageAI ---
            async function processFoodImageAI(imagePart, resultElement, imageUrl) {
                const overlayContent = resultElement.querySelector('.item-overlay-content');
                if (!overlayContent) return;
                // overlayContent.innerHTML = '<div class="loader mx-auto"></div>'; // Already set

                try {
                    let prompt = `Identify the food in this image. Respond ONLY with a valid JSON object with these fields: "name", "brand", "servings" (estimated number of standard servings shown), "totalGrams" (estimated total grams for all servings shown), "calories", "protein", "carbs", "fat", "sugar", "sodium", "potassium". The nutritional values (calories, protein, etc.) should be for the TOTAL amount of food pictured.`;

                    const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                    const payload = { contents: [{ parts: [{ text: prompt }, imagePart] }], generationConfig: { responseMimeType: "application/json" } };

                    const result = await fetchWithBackoff(apiUrl, payload);
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid API response format.");

                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    const foodName = capitalizeWords(data.name) || 'Unknown Food';

                    if (foodName.toLowerCase().includes('unknown') || foodName.toLowerCase().includes('no food') || foodName.toLowerCase().includes('not food')) {
                        updateCarouselItemUI(resultElement, { name: 'No food detected' }, false);
                        return;
                    }
                    
                    const logId = Date.now();
                    const servings = data.servings || 1;
                    const grams = data.totalGrams || 0;
                    const foodItem = {
                        logId: logId, name: foodName, brand: data.brand || '',
                        servings: servings, grams: grams,
                        calories: data.calories || 0, protein: data.protein || 0, carbs: data.carbs || 0, fat: data.fat || 0,
                        sugar: data.sugar || 0, sodium: data.sodium || 0, potassium: data.potassium || 0,
                        base64Image: imageUrl // <-- SAVE IMAGE
                    };
                    const dayLog = getTodaysLog();
                    dayLog.entries.unshift(foodItem);
                    saveScannerLog();
                    
                    updateCarouselItemUI(resultElement, foodItem, true);

                } catch (error) {
                    console.error("AI Image Scan Error:", error);
                    const errorMsg = `Scan failed: ${error.message}`;
                    updateCarouselItemUI(resultElement, { name: errorMsg }, false);
                }
            }

            // --- MODIFIED: classifyAndProcessImage ---
            async function classifyAndProcessImage(file, resultElement, imageUrl) {
                const overlayContent = resultElement.querySelector('.item-overlay-content');
                // if (overlayContent) { ... } // Loader is already there

                try {
                    const imagePart = await fileToGenerativePart(file);
                    const classification = await getAiImageClassification(imagePart);

                    if (classification.includes('barcode')) {
                        ui.foodScannerStatus.textContent = 'Barcode detected, scanning...';
                        try {
                            if (!html5QrCode) {
                                html5QrCode = new Html5Qrcode("barcode-reader-hidden-helper");
                            }
                            const decodedText = await html5QrCode.scanFile(file, false);
                            await processBarcodeScan(decodedText, file, resultElement, imageUrl);
                        } catch (err) {
                             console.warn("Local barcode scan failed, falling back to food AI:", err);
                            ui.foodScannerStatus.textContent = 'Barcode scan failed, trying food analysis...';
                            await processFoodImageAI(imagePart, resultElement, imageUrl);
                        }
                    } else if (classification.includes('food')) {
                        ui.foodScannerStatus.textContent = 'Food detected, analyzing...';
                        await processFoodImageAI(imagePart, resultElement, imageUrl);
                    } else {
                        throw new Error("Could not classify image.");
                    }
                } catch (error) {
                     console.error("Image Processing Error:", error);
                     const errorMsg = `Scan failed: ${error.message}`;
                     if (overlayContent) {
                         updateCarouselItemUI(resultElement, { name: errorMsg }, false);
                     }
                }
            }

            // --- MODIFIED: handleAiScanFiles ---
            function handleAiScanFiles(files) {
                if (!files || files.length === 0) return;
                const filesArray = Array.from(files);
                
                // Go to camera panel to show filmstrip
                goToPanel(1);

                for(const file of filesArray) {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'scroll-item bg-input-bg rounded-lg text-center !flex-shrink-0 h-28 w-28 overflow-hidden relative';
                    resultElement.innerHTML = `
                        <img class="w-full h-full object-cover" src="https://placehold.co/112x112/191919/191919?text=." alt="Scanned item placeholder">
                        <div class="item-overlay-content"><div class="loader mx-auto"></div></div>
                    `;
                    resultElement.dataset.logId = `temp-${Date.now()}`;
                    ui.scannerResultsContainer.prepend(resultElement);

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        const img = resultElement.querySelector('img');
                        img.src = imageUrl;

                        showPhotoPopup(imageUrl);
                        
                        classifyAndProcessImage(file, resultElement, imageUrl);
                    };
                     reader.onerror = () => {
                         const overlayContent = resultElement.querySelector('.item-overlay-content');
                         if (overlayContent) {
                            updateCarouselItemUI(resultElement, { name: 'Error reading file' }, false);
                         }
                     };
                     reader.readAsDataURL(file);

                    setTimeout(() => {
                        resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }, 100); 
                }
            }
            
            // --- NEW: Swipe Panel Functions ---
            function goToPanel(index) {
                if (index < 0 || index > 2) return;
                currentPanelIndex = index;
                ui.swipeTrack.style.transform = `translateX(-${currentPanelIndex * 100}%)`;
                
                // Update tab dots
                ui.tabIndicators.querySelectorAll('.tab-dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === currentPanelIndex);
                });

                // Manage camera state
                if (currentPanelIndex === 1) { // Camera panel
                    startAiCamera();
                } else {
                    manualStopAiCamera();
                }

                // If switching to log panel, re-render the log
                if (currentPanelIndex === 0) {
                    renderScannerLog();
                }
            }
            
            // --- MODIFIED: Listeners ---
            ui.scannerResultsContainer.addEventListener('mousedown', (e) => {
                ui.scannerResultsContainer.style.cursor = 'grabbing';
            });
            ui.scannerResultsContainer.addEventListener('mouseup', () => {
                ui.scannerResultsContainer.style.cursor = 'grab';
            });
            ui.scannerResultsContainer.addEventListener('mouseleave', () => {
                ui.scannerResultsContainer.style.cursor = 'grab';
            });

            ui.startCameraOverlayBtn.addEventListener('click', startAiCamera);
            ui.stopFoodCameraBtn.addEventListener('click', manualStopAiCamera);
            ui.captureFoodPhotoBtn.addEventListener('click', captureAiPhoto);
            ui.uploadPhotoInput.addEventListener('change', (e) => handleAiScanFiles(e.target.files)); // Listener for new upload panel

            ui.scannedLogDisplay.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-log-btn');
                if (removeBtn) {
                    const logId = parseInt(removeBtn.dataset.logId); // This is the *main* logId
                    if (isNaN(logId)) return;
                    deleteLogItem(logId, 'list');
                }
            });

            ui.flipCameraBtn.addEventListener('click', flipCamera); 

            // --- REMOVED: Undo Button Listener ---
            
            // --- REMOVED: Scanned Log Modal Listeners ---

            // --- NEW: Swipe Panel Listeners ---
            ui.swipeContainer.addEventListener('touchstart', (e) => {
                // Don't swipe if on filmstrip or log list
                if (e.target.closest('.horizontal-scroll-container, .custom-scrollbar')) return;
                isSwiping = true;
                swipeStartX = e.touches[0].clientX;
                swipeDeltaX = 0;
                ui.swipeTrack.style.transition = 'none';
            }, { passive: true });

            ui.swipeContainer.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                if (e.target.closest('.horizontal-scroll-container, .custom-scrollbar')) {
                    isSwiping = false; // Cancel swipe
                    return;
                }
                
                swipeDeltaX = e.touches[0].clientX - swipeStartX;
                // Only prevent default if we are actually swiping horizontally
                if (Math.abs(swipeDeltaX) > 10) { 
                    e.preventDefault();
                }
                ui.swipeTrack.style.transform = `translateX(calc(-${currentPanelIndex * 100}% + ${swipeDeltaX}px))`;
            }, { passive: false });

            ui.swipeContainer.addEventListener('touchend', () => {
                if (!isSwiping) return;
                isSwiping = false;
                ui.swipeTrack.style.transition = 'transform 0.3s ease-in-out';
                const swipeThreshold = 50; // 50px swipe threshold

                // --- MODIFIED SWIPE LOGIC ---
                if (currentPanelIndex === 1) { // On Camera (Center)
                    if (swipeDeltaX < -swipeThreshold) {
                        goToPanel(2); // Swipe Left (R->L) -> Go to Upload (2)
                    } else if (swipeDeltaX > swipeThreshold) {
                        goToPanel(0); // Swipe Right (L->R) -> Go to Log (0)
                    } else {
                        goToPanel(1); // Snap back
                    }
                } else if (currentPanelIndex === 0) { // On Log (Left)
                    if (swipeDeltaX > swipeThreshold) { // User swiped Right (L->R)
                        goToPanel(1); // Go to Camera (1)
                    } else {
                        goToPanel(0); // Snap back
                    }
                } else if (currentPanelIndex === 2) { // On Upload (Right)
                    if (swipeDeltaX < -swipeThreshold) { // User swiped Left (R->L)
                        goToPanel(1); // Go to Camera (1)
                    } else {
                        goToPanel(2); // Snap back
                    }
                }
                // --- END MODIFIED SWIPE LOGIC ---
            });
            
            // --- NEW: Tab Dot Listeners ---
            ui.tabIndicators.addEventListener('click', (e) => {
                const dot = e.target.closest('.tab-dot');
                if (dot) {
                    goToPanel(parseInt(dot.dataset.index));
                }
            });
            
            // --- INITIALIZATION ---
            loadScannerLog(); // This now also renders the filmstrip
            goToPanel(1); // Start on camera panel (this also calls startAiCamera)
        }

        // Initialize layout and page logic on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeLayout);
    </script>
</body>
</html>
