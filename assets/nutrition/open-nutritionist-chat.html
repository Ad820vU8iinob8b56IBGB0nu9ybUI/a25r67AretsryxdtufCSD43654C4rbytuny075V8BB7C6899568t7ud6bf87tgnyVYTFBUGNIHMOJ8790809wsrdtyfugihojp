<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-AR">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kowbi | AI Nutritionist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* Standalone page styles */
        body {
            /* Make the modal backdrop visible by default */
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
        }
    </style>
</head>
<body class="antialiased">

    <script>
        // Apply theme immediately
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <!-- AI Nutritionist Chat Modal -->
    <div id="ai-nutritionist-modal" class="modal-backdrop" style="display: flex; position: relative; height: auto;">
        <div class="modal-content !h-[90vh] !max-h-[800px] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-border-color">
                <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="bot" class="w-6 h-6 text-blue-400"></i>AI Nutritionist</h2>
                <!-- Changed to an <a> tag to go back -->
                <a href="../../nutrition.html" id="close-ai-nutritionist-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</a>
            </div>
            <div id="ai-chat-history" class="flex-grow overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                <!-- Chat history will be rendered here -->
            </div>
            <div class="mt-4 pt-4 border-t border-border-color flex gap-2">
                <input type="text" id="ai-chat-input" class="form-input flex-grow" placeholder="Ask about your diet...">
                <button id="ai-chat-send-btn" class="btn btn-primary !p-3"><i data-lucide="send" class="w-5 h-5"></i></button>
            </div>
        </div>
    </div>

    <!-- Generic Alert Modal -->
    <div id="alert-modal" class="modal-backdrop" style="z-index: 80;">
        <div class="modal-content">
            <h2 id="alert-modal-title" class="text-2xl font-bold mb-4">Alert</h2>
            <p id="alert-modal-text" class="text-gray-300 mb-6"></p>
            <button id="alert-modal-ok-btn" class="btn btn-primary w-full">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // --- UI ELEMENTS ---
            const ui = {
                aiChatHistory: document.getElementById('ai-chat-history'),
                aiChatInput: document.getElementById('ai-chat-input'),
                aiChatSendBtn: document.getElementById('ai-chat-send-btn'),
                alertModal: document.getElementById('alert-modal'),
                alertModalTitle: document.getElementById('alert-modal-title'),
                alertModalText: document.getElementById('alert-modal-text'),
                alertModalOkBtn: document.getElementById('alert-modal-ok-btn')
            };

            // --- STATE ---
            let chatHistory = [];
            let userProfile = {};
            let goals = {};
            let allDailyLogs = {};

            // --- MODAL FUNCTIONS ---
            function showModal(modalElement) {
                modalElement.style.display = 'flex';
            }
            function hideModal(modalElement) {
                modalElement.style.display = 'none';
            }
            function showCustomAlert(title, text) {
                if (ui.alertModal.style.display === 'flex') return;
                ui.alertModalTitle.textContent = title;
                ui.alertModalText.textContent = text;
                showModal(ui.alertModal);
            }
            ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));

            // --- GEMINI API ---
            const getApiUrl = (model, action = 'generateContent') => {
                 const apiKey = ""; // Leave empty for Canvas environment
                 return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`;
            };

            async function fetchWithBackoff(apiUrl, payload, maxRetries = 3) {
                // (Copied from ai-macro-swap.html)
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const hasText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                           if (hasText) {
                                return result; // Successful response
                            } else {
                                if (i === maxRetries - 1) throw new Error("Invalid API response format after retries.");
                            }
                        } else if (response.status === 429 || response.status >= 500) {
                            if (i === maxRetries - 1) throw new Error(`API Error: ${response.status} after ${maxRetries} attempts.`);
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw new Error(`API Error: ${response.status} - ${await response.text()}`);
                        }
                    } catch (error) {
                        console.error(`Fetch attempt ${i + 1} failed:`, error);
                        if (i === maxRetries - 1) throw error;
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                throw new Error("API call failed after all retries.");
            }

            // --- DATA LOAD/SAVE (for chat history) ---
            function saveData() {
                localStorage.setItem('fitTrackAI_chatHistory', JSON.stringify(chatHistory));
            }

            function loadData() {
                chatHistory = JSON.parse(localStorage.getItem('fitTrackAI_chatHistory')) || [];
                userProfile = JSON.parse(localStorage.getItem('fitTrackAI_userProfile')) || { goal: 'maintain weight' };
                goals = JSON.parse(localStorage.getItem('fitTrackAI_goals')) || { calories: 2000 };
                allDailyLogs = JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs')) || {};
            }

            // --- CHAT FUNCTIONS ---
            async function handleAiChatSend() {
                const userInput = ui.aiChatInput.value.trim();
                if(!userInput) return;

                chatHistory.push({ role: "user", parts: [{ text: userInput }] });
                addMessageToChat(userInput, 'user');
                ui.aiChatInput.value = '';
                ui.aiChatSendBtn.disabled = true;
                addMessageToChat('<div class="loader"></div>', 'model', true);

                try {
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const recentLogs = Object.entries(allDailyLogs).filter(([date]) => new Date(date) >= sevenDaysAgo);
                    
                    const context = `
                        User Profile: ${JSON.stringify(userProfile)}
                        Nutrition Goals: ${JSON.stringify(goals)}
                        Last 7 Days Food Log: ${JSON.stringify(recentLogs)}
                    `;
                    const systemPrompt = `You are FitTrack AI, a helpful and knowledgeable nutritionist. Analyze the user's provided data to give specific, actionable advice based on their question. Be encouraging and provide clear, concise answers. Here is the user's data context: ${context}`;

                    const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                    const payload = {
                        contents: chatHistory,
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };

                    const result = await fetchWithBackoff(apiUrl, payload);
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid API response format.");
                    const aiResponse = result.candidates[0].content.parts[0].text;

                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    updateLastMessage(aiResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'));

                } catch(error) {
                    console.error("AI Chat Error:", error);
                    updateLastMessage(`<p class="text-red-400">Sorry, I am having trouble connecting right now. ${error.message}</p>`);
                    // Don't pop history, let user retry
                } finally {
                    ui.aiChatSendBtn.disabled = false;
                    saveData(); // Save history after each exchange
                }
            }

            function renderChatHistory() {
                if(chatHistory.length === 0) {
                     ui.aiChatHistory.innerHTML = `<div class="text-center text-secondary-text p-4"><i data-lucide="bot" class="w-10 h-10 mx-auto mb-2"></i><p>Hello! I'm your AI Nutritionist. Ask me anything about your diet, food logs, or general nutrition.</p></div>`;
                     lucide.createIcons();
                } else {
                    ui.aiChatHistory.innerHTML = '';
                    chatHistory.forEach(msg => {
                        addMessageToChat(msg.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'), msg.role);
                    });
                }
            }

            function addMessageToChat(message, sender, isLoading = false) {
                 if (ui.aiChatHistory.innerHTML.includes('Hello! I\'m your AI Nutritionist.')) { 
                    ui.aiChatHistory.innerHTML = ''; 
                 }
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-3 rounded-lg max-w-[85%] ${sender === 'user' ? 'bg-blue-600 self-end' : 'bg-input-bg self-start'}`;
                if(isLoading) messageDiv.id = 'ai-loading-message';
                messageDiv.innerHTML = message;
                ui.aiChatHistory.appendChild(messageDiv);
                ui.aiChatHistory.scrollTop = ui.aiChatHistory.scrollHeight;
            }

             function updateLastMessage(newMessage) {
                const loadingMessage = document.getElementById('ai-loading-message');
                if (loadingMessage) {
                    loadingMessage.innerHTML = newMessage;
                    loadingMessage.removeAttribute('id');
                }
            }

            // --- PAGE LOGIC ---
            loadData();
            renderChatHistory();

            ui.aiChatSendBtn.addEventListener('click', handleAiChatSend);
            ui.aiChatInput.addEventListener('keydown', (e) => { 
                if(e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    handleAiChatSend(); 
                } 
            });
        });
    </script>
</body>
</html>