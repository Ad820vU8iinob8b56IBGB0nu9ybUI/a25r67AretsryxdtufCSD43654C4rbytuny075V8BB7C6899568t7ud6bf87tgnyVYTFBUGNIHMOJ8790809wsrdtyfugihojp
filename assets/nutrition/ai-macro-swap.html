<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-AR">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kowbi | AI Macro Swap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Added for barcode scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* Standalone page styles */
        html, body {
            overscroll-behavior-y: contain;
        }

        /* Styles for video overlay buttons */
        .btn-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--primary-text); /* Force light text */
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .btn-overlay:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.85); 
            transform: translateY(0);
        }

        .btn-overlay.btn-overlay-danger {
            background-color: rgba(229, 62, 62, 0.7); /* Red base color */
        }
        
        .btn-overlay.btn-overlay-danger:hover:not(:disabled) {
            background-color: rgba(229, 62, 62, 0.9); /* Darker red hover */
        }

        .btn-overlay {
            z-index: 20;
        }
        
        /* Item overlay for filmstrip */
        .item-overlay-content {
            position: absolute; 
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 100%);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            padding: 1.5rem 0.5rem 0.25rem 0.5rem; 
            color: var(--primary-text);
            text-align: left;
            opacity: 1;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            pointer-events: auto;
            z-index: 10;
        }

        .item-overlay-content p {
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem;
            color: var(--primary-text);
        }

        .item-overlay-content .item-title {
            font-weight: 600; /* font-semibold */
            font-size: 0.75rem; /* text-xs */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-overlay-content .item-nutrients {
            display: none; /* Hide nutrients on small filmstrip */
        }
        
        /* Carousel Wrapper is now the filmstrip container */
        .carousel-wrapper {
            position: relative;
            width: 100%;
            z-index: 15; /* Above camera, below buttons */
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
            flex-shrink: 0; 
        }

        /* Horizontal scroll container for filmstrip */
        .horizontal-scroll-container {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            overflow-x: auto;
            scroll-behavior: smooth;
            scroll-snap-type: x mandatory; 
            gap: 0.75rem; /* 12px */
            padding-bottom: 1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
            cursor: grab;
        }
        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .horizontal-scroll-container:active {
            cursor: grabbing;
        }
        
        /* Scroll item for filmstrip */
        .scroll-item {
            flex: 0 0 7rem; /* w-28 */
            width: 7rem; /* w-28 */
            height: 7rem; /* h-28 */
            scroll-snap-align: start; /* Snap to start */
            white-space: normal;
        }
        
        /* Custom scrollbar for the scanned items list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-text);
        }
        .custom-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: thin;  /* Firefox */
            scrollbar-color: var(--border-color) transparent;
        }

        /* Photo Popup Styles */
        #photo-popup {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: scale(0.9);
            display: none; /* Hidden by default */
            position: absolute;
            top: 1rem; /* 4 */
            left: 1rem; /* 4 */
            z-index: 30; /* Above video, below buttons */
            width: 6rem; /* w-24 */
            height: 6rem; /* h-24 */
            border-radius: 0.5rem; /* rounded-lg */
            border-width: 2px;
            border-color: #FFFFFF; /* border-white */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            overflow: hidden;
            opacity: 0;
        }
        #photo-popup.show {
            display: block;
            opacity: 1;
            transform: scale(1);
        }
        #photo-popup.hide {
            opacity: 0;
            transform: scale(0.9);
        }
    </style>
</head>
<!-- MODIFIED: Added h-full, flex, flex-col, overflow-hidden -->
<body class="antialiased h-full flex flex-col overflow-hidden">

    <script>
        // Apply theme immediately
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    
    <div id="header-placeholder"></div>

    <!-- Main Content Area -->
    <!-- MODIFIED: Removed container, max-w, etc. Added flex-grow, overflow-hidden, flex, flex-col -->
    <div class="flex-grow overflow-hidden flex flex-col">

        <!-- NEW: Manual Input Card -->
        <div class="content-card m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="replace" class="w-5 h-5 text-blue-400"></i>AI Macro Swap</h2>
                <!-- Changed to an <a> tag to go back to the root nutrition.html -->
                <a href="../../nutrition.html" id="close-ai-macro-swap-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</a>
            </div>
             <div class="flex gap-2">
                <input type="text" id="food-name-input" class="form-input" placeholder="Enter food name to swap...">
                <button id="get-swaps-btn" class="btn btn-primary !p-3" title="Get Swaps">
                    <i data-lucide="replace" class="w-5 h-5 btn-text"></i>
                    <div class="loader hidden"></div>
                </button>
             </div>
        </div>

        <!-- NEW: Camera UI Card (copied from scan-combined.html) -->
        <div class="content-card m-4 flex-grow overflow-hidden flex flex-col">
            <div class="space-y-4 flex-grow flex flex-col p-4">
                
                <div id="ai-live-camera-container" class="!flex-shrink-0 bg-input-bg rounded-lg relative overflow-hidden flex-grow">
                    
                    <div id="photo-popup">
                        <img id="photo-popup-img" src="" alt="Scanned item" class="w-full h-full object-cover">
                    </div>

                    <div id="camera-overlay" class="absolute inset-0 z-20 rounded-lg overflow-hidden transition-opacity duration-300 opacity-0 pointer-events-none">
                        <canvas id="camera-overlay-canvas" class="absolute top-0 left-0 w-full h-full object-cover"></canvas>
                        <div class="absolute top-0 left-0 w-full h-full bg-black/70 backdrop-blur-sm"></div>
                        <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center z-10">
                            <button id="start-camera-overlay-btn" class="btn bg-white text-black hover:bg-gray-200"><i data-lucide="camera"></i>Start Camera</button>
                        </div>
                    </div>

                    <h2 class="absolute top-4 left-1/2 -translate-x-1/2 z-30 text-lg font-bold text-white bg-black/30 px-4 py-1 rounded-full pointer-events-none">
                        Scan to Swap
                    </h2>
                    
                    <video id="ai-camera-video" class="w-full h-full object-cover" autoplay playsinline muted></video>
                    <canvas id="ai-camera-canvas" class="hidden"></canvas> 
                    
                    <!-- Close button removed, top-right close button serves this purpose -->
                    
                    <button id="scanned-log-popup-btn" class="btn-overlay !p-2 !rounded-full absolute top-4 left-4 z-30" title="Scanned Items">
                        <i data-lucide="list" class="w-5 h-5"></i>
                    </button>

                    <button id="flip-camera-btn" class="btn btn-overlay !p-2 !rounded-full absolute bottom-3 left-3" title="Flip Camera">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>

                    <div class="absolute bottom-3 left-1/2 -translate-x-1/2 z-20 flex items-center gap-2">
                        <button id="capture-ai-photo-btn" class="btn btn-overlay !p-2 !rounded-full" title="Capture Photo">
                            <i data-lucide="camera" class="w-5 h-5"></i>
                        </button>
                        <button id="stop-ai-camera-btn" class="btn btn-overlay btn-overlay-danger !p-2 !rounded-full" title="Close Camera">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <label for="ai-upload-photo-input" class="btn btn-overlay !p-2 !rounded-full absolute bottom-3 right-3 cursor-pointer" title="Upload Photo">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                    </label>
                    <input type="file" id="ai-upload-photo-input" class="hidden" accept="image/*" multiple>
                </div>
                
                <div id="ai-scanner-carousel-wrapper" class="carousel-wrapper">
                    <div id="ai-scanner-results-container" class="horizontal-scroll-container scanner-carousel !flex !flex-row !flex-nowrap">
                        <!-- Scanned items will be prepended here by JS -->
                    </div>
                </div>
                
                <p id="ai-scanner-status" class="text-center text-secondary-text text-sm min-h-[1.25rem] mt-4 flex-shrink-0"></p>
            </div>
        </div>

        <!-- REMOVED: Swap Results Card -->
    </div>

    <!-- Generic Alert Modal (still used by the script) -->
    <div id="alert-modal" class="modal-backdrop" style="z-index: 1002;">
        <div class="modal-content">
            <h2 id="alert-modal-title" class="text-2xl font-bold mb-4">Alert</h2>
            <p id="alert-modal-text" class="text-gray-300 mb-6"></p>
            <button id="alert-modal-ok-btn" class="btn btn-primary w-full">OK</button>
        </div>
    </div>
    
    <!-- Scanned Log Modal -->
    <div id="scanned-log-modal" class="modal-backdrop" style="z-index: 1001;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Scanned Items</h2>
                <button id="close-scanned-log-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="scanned-log-display" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-1">
                <p class="text-secondary-text">No items scanned yet.</p>
            </div>
            <button id="scanned-log-modal-ok-btn" class="btn btn-primary w-full mt-6">Close</button>
        </div>
    </div>

    <!-- NEW: Swap Results Modal -->
    <div id="swap-results-modal" class="modal-backdrop" style="z-index: 1001; display: none;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold">Swap Suggestions for <span id="swap-food-name" class="text-blue-400">...</span></h3>
                 <button id="close-swap-results-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="ai-macro-swap-output" class="space-y-3 min-h-[150px] max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                <!-- Suggestions will be injected here -->
            </div>
        </div>
    </div>

    <!-- Hidden helper for html5-qrcode library -->
    <div id="barcode-reader-hidden-helper" class="hidden"></div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <script>
        // --- Load Header and Footer ---
        async function loadComponent(url, placeholderId) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}: ${response.statusText}`);
                let text = await response.text();
                
                text = text.replace(/href="index\.html"/g, 'href="../../index.html"');
                text = text.replace(/href="settings\.html"/g, 'href="../../settings.html"');
                text = text.replace(/href="nutrition\.html"/g, 'href="../../nutrition.html"');
                text = text.replace(/href="workouts\.html"/g, 'href="../../workouts.html"');
                text = text.replace(/href="sleep\.html"/g, 'href="../../sleep.html"');
                text = text.replace(/href="progress\.html"/g, 'href="../../progress.html"');
                text = text.replace(/href="social\.html"/g, 'href="../../social.html"');

                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = text;
                }
            } catch (error) {
                console.error(`Error loading component from ${url}:`, error);
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = `<p class="text-red-500 text-center">Error loading component.</p>`;
                }
            }
        }

        async function initializeLayout() {
            await Promise.all([
                loadComponent('../header.html', 'header-placeholder'), // Path is ../ from assets/nutrition/
                loadComponent('../footer.html', 'footer-placeholder') // Path is ../ from assets/nutrition/
            ]);
            lucide.createIcons(); // Re-render icons after loading components

            const currentPage = 'nutrition'; 
            const navLinks = document.querySelectorAll('#mobile-footer-nav .nav-link');
            navLinks.forEach(link => {
                const linkPage = link.getAttribute('data-page');
                if (linkPage === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            initializeAppPage();
        }
        // --- End Load Header and Footer ---


        // --- Combined Page Script ---
        function initializeAppPage() {
            
            // --- STATE (Combined) ---
            let userProfile = {};
            let foodCameraStream = null;
            let html5QrCode = null;
            let currentFacingMode = 'environment';
            let scannerLogs = {}; // Stores *scanned* items, not *logged* items
            let viewDate = new Date();
            viewDate.setHours(0, 0, 0, 0);

            // --- UI ELEMENTS (Combined) ---
            const ui = {
                // Macro Swap UI
                aiMacroSwapOutput: document.getElementById('ai-macro-swap-output'),
                aiSwapFoodName: document.getElementById('swap-food-name'), // Renamed ID
                swapResultsModal: document.getElementById('swap-results-modal'), // NEW
                closeSwapResultsModalBtn: document.getElementById('close-swap-results-modal-btn'), // NEW
                foodNameInput: document.getElementById('food-name-input'),
                getSwapsBtn: document.getElementById('get-swaps-btn'),

                // Camera UI (from scan-combined.html)
                uploadPhotoInput: document.getElementById('ai-upload-photo-input'),
                scannerResultsContainer: document.getElementById('ai-scanner-results-container'),
                foodScannerStatus: document.getElementById('ai-scanner-status'),
                liveCameraContainer: document.getElementById('ai-live-camera-container'),
                cameraOverlay: document.getElementById('camera-overlay'),
                startCameraOverlayBtn: document.getElementById('start-camera-overlay-btn'),
                stopFoodCameraBtn: document.getElementById('stop-ai-camera-btn'),
                captureFoodPhotoBtn: document.getElementById('capture-ai-photo-btn'),
                foodCameraVideo: document.getElementById('ai-camera-video'),
                foodCameraCanvas: document.getElementById('ai-camera-canvas'),
                foodScannerCarouselWrapper: document.getElementById('ai-scanner-carousel-wrapper'),
                flipCameraBtn: document.getElementById('flip-camera-btn'),
                photoPopup: document.getElementById('photo-popup'),
                photoPopupImg: document.getElementById('photo-popup-img'),
                scannedLogPopupBtn: document.getElementById('scanned-log-popup-btn'),
                scannedLogModal: document.getElementById('scanned-log-modal'),
                closeScannedLogModalBtn: document.getElementById('close-scanned-log-modal-btn'),
                scannedLogModalOkBtn: document.getElementById('scanned-log-modal-ok-btn'),
                scannedLogDisplay: document.getElementById('scanned-log-display'),

                // Shared Modal UI
                alertModal: document.getElementById('alert-modal'),
                alertModalTitle: document.getElementById('alert-modal-title'),
                alertModalText: document.getElementById('alert-modal-text'),
                alertModalOkBtn: document.getElementById('alert-modal-ok-btn')
            };

            // --- MODAL FUNCTIONS (Shared) ---
            let openModalCount = 0;
            function showModal(modalElement) {
                if (!modalElement) return;
                modalElement.style.display = 'flex';
                if (openModalCount === 0) {
                    // document.body.style.overflow = 'hidden';
                }
                openModalCount++;
            }
            function hideModal(modalElement) {
                if (!modalElement) return;
                modalElement.style.display = 'none';
                openModalCount--;
                if (openModalCount <= 0) {
                    // document.body.style.overflow = '';
                    openModalCount = 0;
                }
            }
            function showCustomAlert(title, text) {
                if (ui.alertModal.style.display === 'flex') return;
                ui.alertModalTitle.textContent = title;
                ui.alertModalText.textContent = text;
                showModal(ui.alertModal);
            }
            ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));

            // --- GEMINI API (Shared) ---
            const getApiUrl = (model, action = 'generateContent') => {
                 const apiKey = "AIzaSyA8-WLMo2U2Km-FN2r_fYk8OUfxyZ7dJoM"; // Leave empty for Canvas environment
                 return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`;
            };

            async function fetchWithBackoff(apiUrl, payload, maxRetries = 3) {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const hasText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            const hasImageData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                            const hasStructuredResponse = payload.generationConfig?.responseMimeType === "application/json";

                           if (hasText || hasImageData || hasStructuredResponse) {
                                return result; // Successful response
                            } else {
                                if (i === maxRetries - 1) throw new Error("Invalid API response format after retries.");
                            }
                        } else if (response.status === 429 || response.status >= 500) {
                            if (i === maxRetries - 1) throw new Error(`API Error: ${response.status} after ${maxRetries} attempts.`);
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            const errorText = await response.text();
                            console.error("API Error Response:", errorText);
                            throw new Error(`API Error: ${response.status} - ${errorText}`);
                        }
                    } catch (error) {
                        console.error(`Fetch attempt ${i + 1} failed:`, error);
                        if (i === maxRetries - 1) throw error;
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                throw new Error("API call failed after all retries.");
            }

            // --- MACRO SWAP JS (Original) ---
            async function getAiMacroSwaps(foodName) {
                userProfile = JSON.parse(localStorage.getItem('fitTrackAI_userProfile')) || { goal: 'maintain weight' };
                const systemPrompt = `User is considering eating '${foodName}'. Their goal is ${userProfile.goal}. Suggest 3-5 healthier alternatives that fit a similar craving (e.g., salty, sweet, crunchy). For each, provide 'name' and 'reason' (why it's better, e.g., "Lower in fat", "Higher in protein"). Respond ONLY with a valid JSON array of objects: [{name: "Food 1", reason: "Lower in fat"}, {name: "Food 2", reason: "Higher in protein"}]`;
                const userQuery = `Suggest swaps for ${foodName}`;
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                const payload = {
                     contents: [{ parts: [{ text: userQuery }] }],
                     systemInstruction: { parts: [{ text: systemPrompt }] },
                     generationConfig: { responseMimeType: "application/json" }
                };
                try {
                    const result = await fetchWithBackoff(apiUrl, payload);
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid API response format.");
                    return JSON.parse(result.candidates[0].content.parts[0].text);
                } catch (error) {
                    console.error("getAiMacroSwaps Error:", error);
                    throw error;
                }
            }

            // --- NEW: Wrapper function to run the swap logic ---
            async function runGetAiMacroSwaps(foodName) {
                if (!foodName) {
                    showCustomAlert("No Food", "Please enter or scan a food name first.");
                    return;
                }
                
                // Show the modal and set loading state
                showModal(ui.swapResultsModal); // MODIFIED
                ui.aiSwapFoodName.textContent = foodName;
                ui.aiMacroSwapOutput.innerHTML = '<div class="loader mx-auto"></div>';
                // REMOVED: scrollIntoView

                // Also update the text input
                ui.foodNameInput.value = foodName;

                // Disable button
                ui.getSwapsBtn.disabled = true;
                const loader = ui.getSwapsBtn.querySelector('.loader');
                const btnText = ui.getSwapsBtn.querySelector('.btn-text');
                if (loader) loader.classList.remove('hidden');
                if (btnText) btnText.style.display = 'none';

                try {
                    const swaps = await getAiMacroSwaps(foodName);

                    if (swaps && swaps.length > 0) {
                        ui.aiMacroSwapOutput.innerHTML = swaps.map(swap => `
                            <button type="button" class="btn btn-secondary w-full !justify-between !text-left swap-suggestion-btn" data-food-name="${swap.name}">
                                <div class="flex flex-col">
                                    <span class="font-semibold text-white">${swap.name}</span>
                                    <span class="text-xs text-gray-400 font-normal">${swap.reason}</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                            </button>
                        `).join('');
                        lucide.createIcons();
                    } else {
                        ui.aiMacroSwapOutput.innerHTML = `<p class="text-gray-400 text-center">No swap suggestions found for "${foodName}".</p>`;
                    }
                } catch (error) {
                    console.error("AI Macro Swap Error:", error);
                    ui.aiMacroSwapOutput.innerHTML = `<p class="text-red-400 text-center">Error: ${error.message}</p>`;
                } finally {
                    // Re-enable button
                    ui.getSwapsBtn.disabled = false;
                    if (loader) loader.classList.add('hidden');
                    if (btnText) btnText.style.display = 'inline-block'; // or 'block' depending on original
                }
            }

            // --- CAMERA/SCANNER JS (Copied from scan-combined.html) ---

            function capitalizeWords(str) { if (!str) return ''; return str.replace(/\b\w/g, char => char.toUpperCase()); }
            
            function fileToGenerativePart(file) { 
                return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => { const base64Data = reader.result.split(',')[1]; resolve({ inlineData: { mimeType: file.type, data: base64Data } }); }; reader.onerror = (err) => reject(err); reader.readAsDataURL(file); }); 
            }
            function dateToKey(date) { return date.toISOString().split('T')[0]; }
            function getTodaysLog() {
                const key = dateToKey(viewDate);
                if (!scannerLogs[key]) {
                    scannerLogs[key] = { entries: [] };
                }
                return scannerLogs[key];
            }
            function saveScannerLog() {
                // This page won't save to the *main* log, just its internal list
                localStorage.setItem('swapScanner_tempLogs', JSON.stringify(scannerLogs));
            }
            function loadScannerLog() {
                // Load its own internal list
                scannerLogs = JSON.parse(localStorage.getItem('swapScanner_tempLogs')) || {};
            }

            function renderScannerLog() {
                const dayLog = getTodaysLog();
                if (dayLog.entries.length === 0) {
                    ui.scannedLogDisplay.innerHTML = '<p class="text-secondary-text">No items scanned yet.</p>';
                    return;
                }
                ui.scannedLogDisplay.innerHTML = dayLog.entries.map((item, index) => `
                    <div class="bg-card-bg border border-border-color p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-medium">${item.servings}x ${item.name} ${item.grams > 0 ? `(${item.grams.toFixed(0)}g)` : ''}</p>
                            <p class="text-sm text-secondary-text">${item.calories?.toFixed(0) || 0}kcal</p>
                        </div>
                        <button class="btn btn-danger !p-2 remove-log-btn" data-log-id="${item.logId}" title="Remove">
                            <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                    </div>
                `).join('');
                lucide.createIcons();
            } 

            async function getAiImageClassification(imagePart) {
                const prompt = "Is this image primarily a barcode or a picture of food? Respond with ONLY 'barcode' or 'food'.";
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                const payload = { contents: [{ parts: [{ text: prompt }, imagePart] }] };
                try {
                    const result = await fetchWithBackoff(apiUrl, payload);
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid classification response.");
                    return result.candidates[0].content.parts[0].text.trim().toLowerCase();
                } catch (error) {
                    console.error("AI Classification Error:", error);
                    return 'error';
                }
            }

           async function processBarcodeScan(decodedText, file, resultElement) {
                const overlayContent = resultElement.querySelector('.item-overlay-content');
                if (!overlayContent) return;
                overlayContent.innerHTML = '<div class="loader mx-auto"></div>';

                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${decodedText}?fields=product_name,brands`);
                    if(!response.ok) throw new Error('Product not found in Open Food Facts database.');
                    const data = await response.json();
                    if(data.status === 0 || !data.product) throw new Error(data.status_verbose || 'Product not found.');

                    const product = data.product;
                    const productName = capitalizeWords(product.product_name) || 'Scanned Item';
                    
                    if ((productName === 'Scanned Item') || !product.product_name) {
                        overlayContent.innerHTML = `<p class="text-yellow-400 text-xs">Could not identify this barcode. Please try a food photo instead.</p>`;
                        return;
                    }
                    
                    overlayContent.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start gap-2">
                                <div>
                                    <p class="item-title">${productName}</p>
                                </div>
                                <button class="btn btn-primary get-swap-btn !p-2 !rounded-full !flex-shrink-0" data-food-name="${productName}" title="Get Swaps">
                                    <i data-lucide="replace" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    lucide.createIcons({ root: overlayContent });
                    
                    const swapButton = overlayContent.querySelector('.get-swap-btn');
                    swapButton.onclick = () => {
                        runGetAiMacroSwaps(swapButton.dataset.foodName);
                    };

                } catch (error) {
                    const errorMsg = `<p class="text-red-400 text-xs">Error finding barcode data. ${error.message}</p>`;
                    overlayContent.innerHTML = errorMsg;
                }
            }

            function manualStopAiCamera() {
                const video = ui.foodCameraVideo;
                const overlayCanvas = document.getElementById('camera-overlay-canvas');
                if (overlayCanvas && video.videoWidth > 0 && video.videoHeight > 0) {
                    try {
                        const overlayCtx = overlayCanvas.getContext('2d');
                        overlayCanvas.width = video.videoWidth;
                        overlayCanvas.height = video.videoHeight;
                        overlayCtx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                    } catch (e) {
                        console.error("Error drawing last frame to canvas:", e);
                    }
                }

                if (foodCameraStream) {
                    foodCameraStream.getTracks().forEach(track => track.stop());
                    foodCameraStream = null;
                }
                
                ui.cameraOverlay.classList.remove('opacity-0', 'pointer-events-none');
                ui.foodScannerStatus.textContent = 'Camera off. Tap to start.';
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Error stopping barcode scanner:", err));
                }
            }

            async function startAiCamera() {
                ui.cameraOverlay.classList.add('opacity-0', 'pointer-events-none');
                ui.liveCameraContainer.classList.remove('hidden');

                if (foodCameraStream) {
                    foodCameraStream.getTracks().forEach(track => track.stop());
                    foodCameraStream = null;
                }

                ui.foodScannerStatus.textContent = 'Starting camera...';
                try {
                    foodCameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
                    ui.foodCameraVideo.srcObject = foodCameraStream;
                    ui.foodScannerStatus.textContent = 'Camera active. Point and capture.';
                } catch (err) {
                    console.error("Camera access error:", err);
                    ui.foodScannerStatus.textContent = `Could not access ${currentFacingMode} camera.`;
                    manualStopAiCamera();
                }
            }

            function flipCamera() {
                currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                startAiCamera(); // Restart camera with new mode
            }

            function captureAiPhoto() {
                const video = ui.foodCameraVideo;
                const canvas = ui.foodCameraCanvas;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(blob => {
                    if (blob) {
                        const file = new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' });
                        handleAiScanFiles([file]);
                    }
                }, 'image/jpeg', 0.9);
            }

            async function processFoodImageAI(imagePart, resultElement) {
                const overlayContent = resultElement.querySelector('.item-overlay-content');
                if (!overlayContent) return;
                overlayContent.innerHTML = '<div class="loader mx-auto"></div>';

                try {
                    // This prompt is simpler: just get the name.
                    let prompt = `Identify the single main food item in this image. Respond ONLY with the name of the food (e.g., "Apple", "Chicken Breast and Rice"). If multiple items, list the most prominent one.`;

                    const apiUrl = getApiUrl('gemini-2.5-flash-preview-09-2025');
                    const payload = { contents: [{ parts: [{ text: prompt }, imagePart] }] };

                    const result = await fetchWithBackoff(apiUrl, payload);
                    if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid API response format.");

                    const foodName = capitalizeWords(result.candidates[0].content.parts[0].text.trim());

                    if (foodName.toLowerCase().includes('unknown') || foodName.toLowerCase().includes('no food') || foodName.toLowerCase().includes('not food')) {
                        overlayContent.innerHTML = `
                            <div>
                                <p class="item-title text-yellow-400">No food detected</p>
                            </div>
                        `;
                        return;
                    }
                    
                    overlayContent.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start gap-2">
                                <div>
                                    <p class="item-title">${foodName}</p>
                                </div>
                                <button class="btn btn-primary get-swap-btn !p-2 !rounded-full !flex-shrink-0" data-food-name="${foodName}" title="Get Swaps">
                                    <i data-lucide="replace" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    lucide.createIcons({ root: overlayContent });

                    const swapButton = overlayContent.querySelector('.get-swap-btn');
                    swapButton.onclick = () => {
                        runGetAiMacroSwaps(swapButton.dataset.foodName);
                    };

                } catch (error) {
                    console.error("AI Image Scan Error:", error);
                    const errorMsg = `<p class="text-red-400 text-xs">Scan failed. ${error.message}</p>`;
                    overlayContent.innerHTML = errorMsg;
                }
            }

            async function classifyAndProcessImage(file, resultElement) {
                const overlayContent = resultElement.querySelector('.item-overlay-content');
                if (overlayContent) {
                    overlayContent.innerHTML = '<div class="loader mx-auto"></div>';
                }

                try {
                    const imagePart = await fileToGenerativePart(file);
                    const classification = await getAiImageClassification(imagePart);

                    if (classification.includes('barcode')) {
                        ui.foodScannerStatus.textContent = 'Barcode detected, scanning...';
                        try {
                            if (!html5QrCode) {
                                html5QrCode = new Html5Qrcode("barcode-reader-hidden-helper");
                            }
                            const decodedText = await html5QrCode.scanFile(file, false);
                            await processBarcodeScan(decodedText, file, resultElement);
                        } catch (err) {
                             console.warn("Local barcode scan failed, falling back to food AI:", err);
                            ui.foodScannerStatus.textContent = 'Barcode scan failed, trying food analysis...';
                            await processFoodImageAI(imagePart, resultElement);
                        }
                    } else if (classification.includes('food')) {
                        ui.foodScannerStatus.textContent = 'Food detected, analyzing...';
                        await processFoodImageAI(imagePart, resultElement);
                    } else {
                        throw new Error("Could not classify image.");
                    }
                } catch (error) {
                     console.error("Image Processing Error:", error);
                     const errorMsg = `<p class="text-red-400 text-xs">Scan failed. ${error.message}</p>`;
                     if (overlayContent) {
                         overlayContent.innerHTML = errorMsg;
                     }
                }
            }

            function handleAiScanFiles(files) {
                if (!files || files.length === 0) return;
                const filesArray = Array.from(files);
                
                for(const file of filesArray) {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'scroll-item bg-input-bg rounded-lg text-center !flex-shrink-0 h-28 w-28 overflow-hidden relative';
                    resultElement.innerHTML = `
                        <img class="w-full h-full object-cover" src="https://placehold.co/112x112/191919/191919?text=." alt="Scanned item placeholder">
                        <div class="item-overlay-content">
                        </div>
                    `;
                    
                    ui.scannerResultsContainer.prepend(resultElement);

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        const img = resultElement.querySelector('img');
                        img.src = imageUrl;

                        if (ui.photoPopup && ui.photoPopupImg) {
                            ui.photoPopupImg.src = imageUrl;
                            ui.photoPopup.style.display = 'block'; 
                            setTimeout(() => { 
                                ui.photoPopup.classList.add('show');
                                ui.photoPopup.classList.remove('hide');
                            }, 10);

                            setTimeout(() => {
                                ui.photoPopup.classList.add('hide');
                                ui.photoPopup.classList.remove('show');
                                setTimeout(() => {
                                    if (!ui.photoPopup.classList.contains('show')) {
                                        ui.photoPopup.style.display = 'none';
                                    }
                                }, 300);
                            }, 2000);
                        }
                        
                        classifyAndProcessImage(file, resultElement);
                    };
                     reader.onerror = () => {
                         const overlayContent = resultElement.querySelector('.item-overlay-content');
                         if (overlayContent) {
                             overlayContent.innerHTML = `<p class="text-red-400 text-xs">Error reading file.</p>`;
                         }
                     };
                     reader.readAsDataURL(file);

                    setTimeout(() => {
                        resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }, 100); 
                }
            }
            
            // --- EVENT LISTENERS (Combined) ---

            // Macro Swap Listeners
            ui.getSwapsBtn.addEventListener('click', () => {
                runGetAiMacroSwaps(ui.foodNameInput.value.trim());
            });

            ui.aiMacroSwapOutput.addEventListener('click', (e) => {
                const swapBtn = e.target.closest('.swap-suggestion-btn');
                if (swapBtn) {
                    hideModal(ui.swapResultsModal); // NEW: Hide modal on click
                    const newFoodName = swapBtn.dataset.foodName;
                    if (newFoodName) {
                        window.location.href = `../../nutrition.html?swapFood=${encodeURIComponent(newFoodName)}`;
                    }
                }
            });

            // NEW: Close button for swap modal
            ui.closeSwapResultsModalBtn.addEventListener('click', () => hideModal(ui.swapResultsModal));

            // Camera Listeners
            ui.scannerResultsContainer.addEventListener('mousedown', (e) => {
                ui.scannerResultsContainer.style.cursor = 'grabbing';
            });
            ui.scannerResultsContainer.addEventListener('mouseup', () => {
                ui.scannerResultsContainer.style.cursor = 'grab';
            });
            ui.scannerResultsContainer.addEventListener('mouseleave', () => {
                ui.scannerResultsContainer.style.cursor = 'grab';
            });

            ui.startCameraOverlayBtn.addEventListener('click', startAiCamera);
            ui.stopFoodCameraBtn.addEventListener('click', manualStopAiCamera);
            ui.captureFoodPhotoBtn.addEventListener('click', captureAiPhoto);
            ui.uploadPhotoInput.addEventListener('change', (e) => handleAiScanFiles(e.target.files));
            ui.flipCameraBtn.addEventListener('click', flipCamera); 

            // Scanned Log Modal Listeners
            ui.scannedLogPopupBtn.addEventListener('click', () => {
                renderScannerLog(); // Ensure list is up-to-date
                showModal(ui.scannedLogModal);
            });
            ui.closeScannedLogModalBtn.addEventListener('click', () => hideModal(ui.scannedLogModal));
            ui.scannedLogModalOkBtn.addEventListener('click', () => hideModal(ui.scannedLogModal));
            
            ui.scannedLogDisplay.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-log-btn');
                if (removeBtn) {
                    const logId = parseInt(removeBtn.dataset.logId);
                    if (isNaN(logId)) return;
                    
                    // Remove from internal log
                    const dayLog = getTodaysLog();
                    const logIndex = dayLog.entries.findIndex(entry => entry.logId === logId);
                    if (logIndex > -1) {
                        dayLog.entries.splice(logIndex, 1);
                        saveScannerLog();
                        renderScannerLog();
                    }
                }
            });

            // --- INITIALIZATION ---
            
            // 1. Get food name from URL
            const urlParams = new URLSearchParams(window.location.search);
            const foodName = urlParams.get('foodName');
            
            if (foodName) {
                // If linked from nutrition.html, populate input and run swap
                ui.foodNameInput.value = foodName;
                runGetAiMacroSwaps(foodName);
            } else {
                // Otherwise, just show the page, but don't show the results container
                // (it's hidden by default)
            }

            // 2. Load scanner log (for the popup)
            loadScannerLog();
            renderScannerLog();
            
            // 3. Start camera
            startAiCamera();
        }
        
        // Initialize layout and page logic on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeLayout);
    </script>
</body>
</html>
