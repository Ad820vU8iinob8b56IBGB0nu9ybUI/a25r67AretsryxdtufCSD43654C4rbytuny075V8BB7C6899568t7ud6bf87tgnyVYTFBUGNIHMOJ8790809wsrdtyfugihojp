<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kowbi | progress</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Link Shared CSS -->
    <link rel="stylesheet" href="assets/styles.css">
    <!-- Page Specific Styles (if any) -->
    <style>
        /* Add page-specific styles here if needed */
        
        /* Styles for new image pickers */
        .image-picker-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem; /* 12px */
        }
        
        .image-picker-label {
            display: block;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem; /* 8px */
            padding: 0.5rem; /* 8px */
            transition: all 0.2s ease-in-out;
            background-color: var(--input-bg);
        }
        
        .image-picker-label:hover {
            border-color: var(--secondary-text);
        }
        
        .image-picker-label img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 0.25rem; /* 4px */
        }
        
        .image-picker-label p {
            text-align: center;
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            color: var(--secondary-text);
            margin-top: 0.5rem; /* 8px */
        }
        
        /* Style for the hidden radio button */
        .image-picker-input {
            display: none;
        }
        
        /* Style for the selected item */
        .image-picker-input:checked + .image-picker-label {
            border-color: var(--accent);
            background-color: var(--card-bg);
            box-shadow: 0 0 0 2px var(--accent);
        }
        
        .image-picker-input:checked + .image-picker-label p {
            color: var(--primary-text);
            font-weight: 600;
        }

        /* Checkbox grid */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--input-bg);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
        .form-checkbox {
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            background-color: var(--background);
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            position: relative;
        }
        .form-checkbox:checked {
            background-color: var(--accent);
            border-color: var(--accent);
        }
        .form-checkbox:checked::after {
            content: '✔';
            position: absolute;
            color: var(--background);
            font-size: 0.75rem;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Theme script (should be early) -->
    <script>
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <div class="container mx-auto max-w-7xl px-4 py-6">
        <!-- Header Placeholder -->
        <div id="header-placeholder"></div>

        <!-- Main Content Area -->
        <main>
            <h1 class="text-3xl font-bold text-center mb-6">Your Progress</h1>

            <!-- Tab Navigation -->
            <nav class="flex flex-wrap sm:flex-nowrap border-b border-border-color mb-8">
                <button id="general-tab" class="tab-btn active w-1/3 sm:w-auto" data-tab="general">General</button>
                <button id="goals-tab" class="tab-btn w-1/3 sm:w-auto" data-tab="goals">Goals</button>
                <button id="nutrition-tab" class="tab-btn w-1/3 sm:w-auto" data-tab="nutrition">Nutrition</button>
                <button id="workout-tab" class="tab-btn w-1/2 sm:w-auto" data-tab="workout">Workout</button>
                <button id="sleep-tab" class="tab-btn w-1/2 sm:w-auto" data-tab="sleep">Sleep</button>
            </nav>

            <!-- Tab Content Panels -->
            <div>
                <!-- Section 1: General Progress Panel (Body Composition & Check-in) -->
                <section id="general-panel" class="tab-panel active space-y-8">
                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">Daily Check-in</h2>
                        <p class="text-sm text-secondary-text mb-4">Log your weight and optional body composition stats daily.  </p>
                        <form id="check-in-form" class="flex flex-col sm:flex-row gap-4">
                            <input type="number" step="0.1" id="check-in-weight" placeholder="Current weight (kg)" class="form-input w-full" required>
                             <input type="number" step="0.1" id="check-in-smm" placeholder="SMM (kg) - Optional" class="form-input w-full">
                            <button type="submit" id="check-in-btn" class="btn btn-primary sm:w-auto flex-shrink-0">
                                <span class="btn-text">Check In</span>
                                <div class="loader hidden"></div>
                            </button>
                        </form>
                        <div id="check-in-feedback" class="mt-4 text-sm h-5 text-center"></div>
                    </div>

                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">Key Performance Indicators</h2>
                        <div id="key-stats-output">
                            <p class="text-secondary-text text-center">Not enough data to calculate stats. Keep logging!</p>
                        </div>
                    </div>

                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">Body Composition Progress</h2>
                        <div class="flex justify-center gap-2 mb-4 flex-wrap">
                            <button id="chart-range-30d" class="chart-range-btn" data-range="30d">30D</button>
                            <button id="chart-range-90d" class="chart-range-btn" data-range="90d">90D</button>
                            <button id="chart-range-1y" class="chart-range-btn" data-range="1y">1Y</button>
                            <button id="chart-range-all" class="chart-range-btn active" data-range="all">All Time</button>
                        </div>
                        <div class="flex justify-center gap-2 mb-4 flex-wrap">
                            <button id="chart-toggle-weight" class="chart-dataset-btn active" data-dataset="weight">Weight</button>
                            <button id="chart-toggle-smm" class="chart-dataset-btn" data-dataset="smm">SMM</button>
                            <button id="chart-toggle-bfm" class="chart-dataset-btn" data-dataset="bfm">Body Fat</button>
                            <button id="chart-toggle-target" class="chart-dataset-btn" data-dataset="target">Show Target</button>
                        </div>
                        <div class="w-full h-96 flex items-center justify-center"><canvas id="progress-chart"></canvas></div>
                    </div>

                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">AI Progress Insights</h2>
                        <ul id="progress-insights-output" class="list-disc list-inside space-y-2 text-secondary-text">
                            <li>Log your weight daily to generate powerful insights.</li>
                        </ul>
                    </div>
                </section>

                <!-- Section 2: Goals Panel (Profile Form & Adaptive Plan) -->
                <section id="goals-panel" class="tab-panel space-y-8">
                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-6">Health & Fitness Stats</h2>
                        <form id="profile-form" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="age" class="form-label">Age</label><input type="number" id="age" class="form-input mt-1" required></div><div><label for="gender" class="form-label">Gender</label><select id="gender" class="form-input mt-1"><option value="male">Male</option><option value="female">Female</option></select></div></div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="height" class="form-label">Height (cm)</label><input type="number" id="height" class="form-input mt-1" required></div><div><label for="weight" class="form-label">Weight (kg) - Auto-filled</label><input type="number" id="weight" step="0.1" class="form-input mt-1" required readonly></div></div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="smm" class="form-label">Skeletal Muscle Mass (kg) (Optional)</label><input type="number" step="0.1" id="smm" class="form-input mt-1"></div><div><label for="bfm" class="form-label">Body Fat Mass (kg) (Optional)</label><input type="number" id="bfm" step="0.1" class="form-input mt-1"></div></div>
                            <div><label for="activity-level" class="form-label">Activity Level</label><select id="activity-level" class="form-input mt-1"><option value="1.2">Sedentary</option><option value="1.375">Lightly active</option><option value="1.55" selected>Moderately active</option><option value="1.725">Very active</option><option value="1.9">Extra active</option></select></div>
                            <div><label for="user-goal" class="form-label">Primary Goal</label><select id="user-goal" class="form-select mt-1"><option value="lose">Fat Loss</option><option value="maintain">Maintain Weight</option><option value="gain">Muscle Gain</option><option value="recomposition" selected>Recomposition</option></select></div>
                            <div id="recomp-deficit-container" class="hidden"><label for="recomp-deficit-input" class="form-label">Calorie Deficit (kcal)</label><input type="number" id="recomp-deficit-input" value="500" class="form-input mt-1"></div>
                            <button type="submit" class="w-full btn btn-primary !mt-6"><span class="btn-text">Save & Calculate Goals</span><div class="loader hidden"></div></button>
                            <div class="pt-4 mt-4 border-t border-border-color space-y-2 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <label for="bmr-input" class="font-semibold text-secondary-text">BMR (Override):</label>
                                    <input type="number" id="bmr-input" class="form-input !w-24 !p-1 text-center" placeholder="Auto">
                                    <span class="text-secondary-text">kcal</span>
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    <label for="bmi-input" class="font-semibold text-secondary-text">BMI:</label>
                                    <input type="number" step="0.1" id="bmi-input" class="form-input !w-24 !p-1 text-center bg-transparent border-0" readonly>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">AI Adaptive Calorie & Macro Plan</h2>
                        <div id="calorie-plan-output"><p class="text-secondary-text">Please fill out your profile stats to generate a plan.</p></div>
                    </div>

                    <!-- START: New Card for Additional Goals -->
                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-6">Additional Goals & History</h2>
                        <form id="detailed-goals-form" class="space-y-6">
                            
                            <!-- 1. Ideal Weight -->
                            <div>
                                <label for="ideal-weight" class="form-label">Ideal Weight (kg)</label>
                                <input type="number" id="ideal-weight" class="form-input mt-1" placeholder="e.g., 68.5" step="0.1">
                            </div>

                            <!-- 2. Body Type -->
                            <div>
                                <label class="form-label mb-2">What best matches your current body type?</label>
                                <div class="image-picker-container">
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-ecto" value="ectomorph" class="image-picker-input">
                                        <label for="body-type-ecto" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Ectomorph" alt="Ectomorph body type">
                                            <p>Ectomorph</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-meso" value="mesomorph" class="image-picker-input">
                                        <label for="body-type-meso" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Mesomorph" alt="Mesomorph body type">
                                            <p>Mesomorph</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-endo" value="endomorph" class="image-picker-input">
                                        <label for="body-type-endo" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Endomorph" alt="Endomorph body type">
                                            <p>Endomorph</p>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Body Fat Level -->
                            <div>
                                <label class="form-label mb-2">Which image best reflects your current body fat level?</label>
                                <div class="image-picker-container">
                                    <div>
                                        <input type="radio" name="body-fat" id="body-fat-10" value="10-12%" class="image-picker-input">
                                        <label for="body-fat-10" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=10-12%25" alt="10-12% body fat">
                                            <p>10-12%</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-fat" id="body-fat-15" value="15%" class="image-picker-input">
                                        <label for="body-fat-15" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=15%25" alt="15% body fat">
                                            <p>15%</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-fat" id="body-fat-20" value="20%" class="image-picker-input">
                                        <label for="body-fat-20" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=20%25" alt="20% body fat">
                                            <p>20%</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-fat" id="body-fat-25" value="25%" class="image-picker-input">
                                        <label for="body-fat-25" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=25%25" alt="25% body fat">
                                            <p>25%</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-fat" id="body-fat-30" value="30%" class="image-picker-input">
                                        <label for="body-fat-30" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=30%25" alt="30% body fat">
                                            <p>30%</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-fat" id="body-fat-35" value="35%+" class="image-picker-input">
                                        <label for="body-fat-35" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=35%25%2B" alt="35%+ body fat">
                                            <p>35%+</p>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. Difficult Fat Loss Areas (Conditional) -->
                            <div id="fat-loss-details" class="hidden">
                                <label class="form-label mb-2">What area(s) are the most difficult to lose fat from? (Optional)</label>
                                <div class="checkbox-grid">
                                    <label class="checkbox-label"><input type="checkbox" name="fat-area" value="abs" class="form-checkbox"><span>Stomach / Abs</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="fat-area" value="love-handles" class="form-checkbox"><span>Love Handles / Hips</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="fat-area" value="thighs" class="form-checkbox"><span>Thighs</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="fat-area" value="arms" class="form-checkbox"><span>Arms</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="fat-area" value="chest" class="form-checkbox"><span>Chest</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="fat-area" value="other" class="form-checkbox"><span>Other</span></label>
                                </div>
                            </div>

                            <!-- 5. Training History -->
                            <div>
                                <label for="training-history" class="form-label">Training History</label>
                                <select id="training-history" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="beginner">Beginner (0-1 years)</option>
                                    <option value="intermediate">Intermediate (1-3 years)</option>
                                    <option value="advanced">Advanced (3+ years)</option>
                                </select>
                            </div>

                            <!-- 6. Familiarity -->
                            <div>
                                <label for="fitness-familiarity" class="form-label">How familiar are you with fitness/nutrition science?</label>
                                <select id="fitness-familiarity" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="novice">Novice (Just starting to learn)</option>
                                    <option value="familiar">Familiar (I know the basics)</option>
                                    <option value="knowledgeable">Knowledgeable (I understand concepts like CICO, progressive overload, etc.)</option>
                                </select>
                            </div>

                            <!-- 7. Past Attempts -->
                            <div>
                                <label class="form-label mb-2">Have you attempted any of the following in the past? (Optional)</label>
                                <div class="checkbox-grid">
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="keto" class="form-checkbox"><span>Keto / Atkins</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="low-carb" class="form-checkbox"><span>Low Carb</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="calorie-counting" class="form-checkbox"><span>Calorie Counting</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="intermittent-fasting" class="form-checkbox"><span>Intermittent Fasting</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="personal-trainer" class="form-checkbox"><span>Personal Trainer</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="other-program" class="form-checkbox"><span>Other Program</span></label>
                                </div>
                            </div>

                            <!-- 8. Tracking App -->
                            <div>
                                <label for="tracking-app" class="form-label">Do you currently use a workout tracking app? (Optional)</label>
                                <select id="tracking-app" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>

                            <!-- 9. Compound Lift Comfort -->
                            <div>
                                <label class="form-label mb-2">Main Compound Lift Comfort</label>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-2 gap-2 items-center">
                                        <label for="lift-comfort-squat" class="form-label !text-sm !text-primary-text">Squat (Barbell)</label>
                                        <select id="lift-comfort-squat" name="lift-comfort" class="form-select !py-1.5">
                                            <option value="comfortable">Comfortable</option>
                                            <option value="needs-work">Needs Work</option>
                                            <option value="uncomfortable">Uncomfortable / Avoid</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 items-center">
                                        <label for="lift-comfort-bench" class="form-label !text-sm !text-primary-text">Bench Press (Barbell)</label>
                                        <select id="lift-comfort-bench" name="lift-comfort" class="form-select !py-1.5">
                                            <option value="comfortable">Comfortable</option>
                                            <option value="needs-work">Needs Work</option>
                                            <option value="uncomfortable">Uncomfortable / Avoid</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 items-center">
                                        <label for="lift-comfort-deadlift" class="form-label !text-sm !text-primary-text">Deadlift (Barbell)</label>
                                        <select id="lift-comfort-deadlift" name="lift-comfort" class="form-select !py-1.5">
                                            <option value="comfortable">Comfortable</option>
                                            <option value="needs-work">Needs Work</option>
                                            <option value="uncomfortable">Uncomfortable / Avoid</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" id="save-detailed-goals-btn" class="w-full btn btn-primary !mt-6">
                                <span class="btn-text">Save Details</span>
                                <div class="loader hidden"></div>
                            </button>
                        </form>
                    </div>
                    <!-- END: New Card -->

                </section>

                <!-- Section 3: Nutrition Progress Panel -->
                <section id="nutrition-panel" class="tab-panel">
                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">Nutrition Progress</h2>
                        <p class="text-secondary-text mb-4">Track your **calorie and protein intake** against your goals over time.</p>
                        <div class="w-full h-96 flex items-center justify-center">
                            <canvas id="nutrition-progress-chart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Section 4: Workout Progress Panel -->
                <section id="workout-panel" class="tab-panel">
                     <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">Workout Progress</h2>
                        <p class="text-secondary-text mb-4">See your **workout consistency** and logged **total volume** per week.</p>
                         <div class="w-full h-96 flex items-center justify-center">
                            <canvas id="workout-progress-chart"></canvas>
                         </div>
                    </div>
                </section>

                <!-- Section 5: Sleep Progress Panel -->
                <section id="sleep-panel" class="tab-panel">
                     <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-4">Sleep Progress</h2>
                        <p class="text-secondary-text mb-4">Monitor your **sleep duration and quality** patterns.</p>
                         <div class="w-full h-96 flex items-center justify-center">
                            <canvas id="sleep-progress-chart"></canvas>
                         </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2><p id="alert-modal-text" class="text-secondary-text mb-6"></p><div class="flex justify-end"><button id="alert-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Script to load Header/Footer and Page Logic -->
    <script>
        // --- Load Header and Footer ---
        async function loadComponent(url, placeholderId) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}: ${response.statusText}`);
                const text = await response.text();
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = text;
                }
            } catch (error) {
                console.error(`Error loading component from ${url}:`, error);
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = `<p class="text-red-500 text-center">Error loading component.</p>`;
                }
            }
        }

        async function initializeLayout() {
            await Promise.all([
                loadComponent('assets/header.html', 'header-placeholder'),
                loadComponent('assets/footer.html', 'footer-placeholder')
            ]);
            lucide.createIcons(); // Re-render icons after loading components

            // --- Set Active Footer Link ---
            const currentPage = 'progress'; // Set this page as active
            const navLinks = document.querySelectorAll('#mobile-footer-nav .nav-link');
            navLinks.forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // --- Initialize Page Specific JS ---
            initializeProgressPage();
        }
        // --- End Load Header and Footer ---

        // --- Original script from progress.html (wrapped, Firebase removed) ---
        function initializeProgressPage() {
            // --- STATE MANAGEMENT ---
            let userProfile = {
                age: 30, gender: 'male', height: 175, weight: 70, smm: 30, bfm: 15, activityLevel: 1.55, goal: 'recomposition', recompDeficit: 500, tdee: 2500,
                weightHistory: [], inbodyHistory: [], nutritionHistory: [], workoutHistory: [], sleepHistory: [],
                // Add new fields for the new form
                idealWeight: null,
                bodyType: '',
                bodyFat: '',
                fatLossAreas: [],
                trainingHistory: '',
                fitnessFamiliarity: '',
                pastAttempts: [],
                trackingApp: '',
                liftComfort: { squat: 'comfortable', bench: 'comfortable', deadlift: 'comfortable' }
            };
            let goals = { calories: 2000, protein: 150, carbs: 225, fat: 60, water: 2500 };
            let isDataLoaded = false;
            let activeChartRange = 'all';
            let chartDatasetVisibility = { weight: true, smm: false, bfm: false, target: false };

            // --- UI ELEMENT DEFINITIONS ---
            const ui = {
                profileForm: document.getElementById('profile-form'),
                caloriePlanOutput: document.getElementById('calorie-plan-output'),
                checkInForm: document.getElementById('check-in-form'),
                checkInBtn: document.getElementById('check-in-btn'),
                checkInFeedback: document.getElementById('check-in-feedback'),
                bmrInput: document.getElementById('bmr-input'),
                bmiInput: document.getElementById('bmi-input'),
                userGoalSelect: document.getElementById('user-goal'),
                recompDeficitContainer: document.getElementById('recomp-deficit-container'),
                alertModal: document.getElementById('alert-modal'),
                alertModalOkBtn: document.getElementById('alert-modal-ok-btn'),
                keyStatsOutput: document.getElementById('key-stats-output'),
                progressInsightsOutput: document.getElementById('progress-insights-output'),
                checkInWeightInput: document.getElementById('check-in-weight'),
                checkInSmmInput: document.getElementById('check-in-smm'),
                chartRange30d: document.getElementById('chart-range-30d'),
                chartRange90d: document.getElementById('chart-range-90d'),
                chartRange1y: document.getElementById('chart-range-1y'),
                chartRangeAll: document.getElementById('chart-range-all'),
                tabs: document.querySelectorAll('.tab-btn'),
                panels: document.querySelectorAll('.tab-panel'),
                // New form elements
                detailedGoalsForm: document.getElementById('detailed-goals-form'),
                fatLossDetails: document.getElementById('fat-loss-details'),
                saveDetailedGoalsBtn: document.getElementById('save-detailed-goals-btn')
            };

            // --- CHART.JS SETUP ---
            let chartTextColor, chartGridColor;
            Chart.defaults.color = '#eaeaea';

            function calculateSleepDuration(startTime, endTime, dateStr) {
                const startDate = new Date(`${dateStr}T${startTime}`); const endDate = new Date(`${dateStr}T${endTime}`);
                if (endDate <= startDate) endDate.setDate(endDate.getDate() + 1); const durationMs = endDate - startDate;
                return { durationInMinutes: Math.floor(durationMs / (1000 * 60)) };
            }

            // --- CORE & HELPER FUNCTIONS ---
            function showTab(tabName) {
                ui.panels.forEach(panel => panel.classList.remove('active'));
                ui.tabs.forEach(tab => tab.classList.remove('active'));
                const activePanel = document.getElementById(tabName + '-panel'); const activeTab = document.getElementById(tabName + '-tab');
                if (activePanel) activePanel.classList.add('active'); if (activeTab) activeTab.classList.add('active');
                fullRenderAllCharts();
            }

            function updateChartAppearance() {
                chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-text').trim(); chartGridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(); Chart.defaults.color = chartTextColor;
                [progressChart, sleepProgressChart, nutritionProgressChart, workoutProgressChart].forEach(chart => {
                    if (chart && chart.options) {
                        chart.options.plugins.legend.labels.color = chartTextColor;
                        Object.keys(chart.options.scales).forEach(axisKey => {
                            if (chart === sleepProgressChart && axisKey === 'y2') { chart.options.scales[axisKey].ticks.color = '#f59e0b'; chart.options.scales[axisKey].grid.drawOnChartArea = false; }
                            else { chart.options.scales[axisKey].ticks.color = chartTextColor; chart.options.scales[axisKey].grid.color = chartGridColor; }
                        }); chart.update();
                    }
                });
            }
            function updateChartThemeColors() { updateChartAppearance(); }

            // Chart initializations (unchanged logic, just uses variables)
            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, { type: 'line', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: chartTextColor }, grid: { color: chartGridColor } }, x: { ticks: { color: chartTextColor }, grid: { color: chartGridColor } } }, plugins: { legend: { display: true, labels: { color: chartTextColor } } } } });
            const sleepCtx = document.getElementById('sleep-progress-chart').getContext('2d');
            let sleepProgressChart = new Chart(sleepCtx, { type: 'bar', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { id: 'y', position: 'left', beginAtZero: true, ticks: { callback: (value) => value + 'h', color: chartTextColor }, grid: { color: chartGridColor } }, y2: { id: 'y2', position: 'right', type: 'linear', min: 0, max: 5, ticks: { callback: (value) => value + '★', color: '#f59e0b' }, grid: { drawOnChartArea: false } }, x: { ticks: { color: chartTextColor }, grid: { color: chartGridColor } } }, plugins: { legend: { display: true, labels: { color: chartTextColor } } } } });
            const nutritionCtx = document.getElementById('nutrition-progress-chart').getContext('2d');
            let nutritionProgressChart = new Chart(nutritionCtx, { type: 'line', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: chartTextColor }, grid: { color: chartGridColor } }, x: { ticks: { color: chartTextColor }, grid: { color: chartGridColor } } }, plugins: { legend: { display: true, labels: { color: chartTextColor } } } } });
            const workoutCtx = document.getElementById('workout-progress-chart').getContext('2d');
            let workoutProgressChart = new Chart(workoutCtx, { type: 'bar', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: chartTextColor }, grid: { color: chartGridColor } }, x: { ticks: { color: chartTextColor }, grid: { color: chartGridColor } } }, plugins: { legend: { display: true, labels: { color: chartTextColor } } } } });

            // --- LOCALSTORAGE DATA FUNCTIONS ---
            function saveData() {
                try {
                    const profileToSave = { ...userProfile };
                    delete profileToSave.tdee; delete profileToSave.bmr; delete profileToSave.bmi; // Remove calculated values
                    localStorage.setItem('fitTrackAI_userProfile', JSON.stringify(profileToSave));
                    localStorage.setItem('fitTrackAI_goals', JSON.stringify(goals));
                    // Also save other potentially modified data from different pages
                    localStorage.setItem('fitTrackAI_allDailyLogs', localStorage.getItem('fitTrackAI_allDailyLogs') || '{}');
                    localStorage.setItem('fitTrackAI_workoutHistory', localStorage.getItem('fitTrackAI_workoutHistory') || '[]');
                } catch (error) {
                    console.error("Error saving data to localStorage: ", error);
                    showCustomAlert("Save Error", "Could not save your data. Local storage might be full or disabled.");
                }
            }

            function loadData() {
                try {
                    const loadedProfile = JSON.parse(localStorage.getItem('fitTrackAI_userProfile') || '{}');
                    // Merge loaded profile with defaults, ensuring arrays exist
                    userProfile = {
                         ...userProfile, // Keep defaults from state
                         ...loadedProfile, // Loaded data overrides defaults
                         weightHistory: loadedProfile.weightHistory || [],
                         inbodyHistory: loadedProfile.inbodyHistory || [],
                         // Load histories from potentially other pages
                         nutritionHistory: JSON.parse(localStorage.getItem('fitTrackAI_allDailyLogs') || '{}'), // Assuming logs are nutrition history
                         workoutHistory: JSON.parse(localStorage.getItem('fitTrackAI_workoutHistory') || '[]'),
                         sleepHistory: loadedProfile.sleepHistory || [],
                         // Load new fields
                         liftComfort: loadedProfile.liftComfort || { squat: 'comfortable', bench: 'comfortable', deadlift: 'comfortable' },
                         fatLossAreas: loadedProfile.fatLossAreas || [],
                         pastAttempts: loadedProfile.pastAttempts || []
                    };

                    goals = { ...{ calories: 2000, protein: 150, carbs: 225, fat: 60, water: 2500 }, ...JSON.parse(localStorage.getItem('fitTrackAI_goals') || '{}') };

                    // Ensure historical data is sorted by date
                     ['weightHistory', 'inbodyHistory', 'workoutHistory', 'sleepHistory'].forEach(key => {
                        if (Array.isArray(userProfile[key])) {
                           userProfile[key].sort((a,b) => new Date(a.date) - new Date(b.date));
                        }
                    });
                    // Special handling for nutritionHistory (logs) which are objects keyed by date
                    // Convert logs to an array sorted by date for chart use
                    userProfile.nutritionHistory = Object.entries(userProfile.nutritionHistory)
                       .map(([date, logData]) => ({
                            date: date,
                            calories: (logData.entries || []).reduce((sum, item) => sum + (item.calories || 0), 0),
                            protein: (logData.entries || []).reduce((sum, item) => sum + (item.protein || 0), 0)
                       }))
                       .sort((a,b) => new Date(a.date) - new Date(b.date));


                    isDataLoaded = true;
                    if (userProfile.weightHistory.length > 0) {
                        const latestWeight = userProfile.weightHistory[userProfile.weightHistory.length - 1].weight;
                        userProfile.weight = latestWeight;
                        if(ui.checkInWeightInput) ui.checkInWeightInput.value = latestWeight.toFixed(1);
                    }
                    if (userProfile.inbodyHistory && userProfile.inbodyHistory.length > 0) {
                        const latestSmm = userProfile.inbodyHistory[userProfile.inbodyHistory.length - 1].smm;
                         if (latestSmm && ui.checkInSmmInput) ui.checkInSmmInput.value = latestSmm.toFixed(1);
                    } else if (userProfile.smm && ui.checkInSmmInput) {
                        ui.checkInSmmInput.value = userProfile.smm.toFixed(1);
                    }

                    if (userProfile.age && userProfile.height && userProfile.weight) {
                        calculateAndSaveGoals(false, true); // Recalculate locally
                    }
                    fullRender(); // This will call populateProfileForm
                } catch (error) {
                    console.error("Error loading data from localStorage:", error);
                    showCustomAlert("Load Error", "Could not load data. It might be corrupted.");
                    isDataLoaded = true; // Mark as loaded to prevent infinite loops maybe?
                    fullRender(); // Try to render with defaults
                }
            }

            // --- CHART RENDERING FUNCTIONS (unchanged logic) ---
            function getStartDate(range) { /* ...unchanged... */ const now = new Date(); if (range === '30d') { now.setDate(now.getDate() - 30); return now; } if (range === '90d') { now.setDate(now.getDate() - 90); return now; } if (range === '1y') { now.setFullYear(now.getFullYear() - 1); return now; } return null; }
            function filterHistory(history, range) { /* ...unchanged... */ const startDate = getStartDate(range); if (!startDate) return history; return history.filter(d => new Date(d.date.replace(/-/g, '/')) >= startDate); }

            function renderProgressChart(timeRange = 'all') {
                activeChartRange = timeRange;
                updateChartRangeButtons();
                let weightData = filterHistory(userProfile.weightHistory, timeRange);
                let inbodyData = filterHistory(userProfile.inbodyHistory, timeRange);
                const allDates = new Set([...weightData.map(d => d.date), ...inbodyData.map(d => d.date)]);
                const sortedLabels = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));

                if (sortedLabels.length === 0) {
                    progressChart.data = { labels: [], datasets: [] };
                    progressChart.update();
                    return;
                }

                const weightMap = new Map(weightData.map(d => [d.date, d.weight]));
                const smmMap = new Map(inbodyData.map(d => [d.date, d.smm]));
                const bfmMap = new Map(inbodyData.map(d => [d.date, d.bfm]));

                progressChart.data.labels = sortedLabels.map(date =>
                    new Date(date.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })
                );

                const datasets = [];

                // Weight dataset
                if (chartDatasetVisibility.weight) {
                    datasets.push({
                        label: 'Weight (kg)',
                        data: sortedLabels.map(date => weightMap.get(date) || null),
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.2)',
                        tension: 0.2,
                        fill: false,
                        spanGaps: true,
                        pointRadius: 4
                    });
                }

                // SMM dataset
                if (chartDatasetVisibility.smm) {
                    datasets.push({
                        label: 'SMM (kg)',
                        data: sortedLabels.map(date => smmMap.get(date) || null),
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.2)',
                        tension: 0.2,
                        fill: false,
                        spanGaps: true,
                        pointRadius: 4
                    });
                }

                // BFM dataset
                if (chartDatasetVisibility.bfm) {
                    datasets.push({
                        label: 'BFM (kg)',
                        data: sortedLabels.map(date => bfmMap.get(date) || null),
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.2)',
                        tension: 0.2,
                        fill: false,
                        spanGaps: true,
                        pointRadius: 4
                    });
                }

                // Target line
                if (chartDatasetVisibility.target && userProfile.idealWeight) {
                    datasets.push({
                        label: `Target: ${userProfile.idealWeight}kg`,
                        data: Array(sortedLabels.length).fill(userProfile.idealWeight),
                        borderColor: '#60a5fa',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        tension: 0
                    });
                }

                progressChart.data.datasets = datasets;

                // Add background zones as plugin
                const goalWeight = userProfile.idealWeight || 70;
                progressChart.options.plugins.chartAreaPlugin = {
                    id: 'chartAreaPlugin',
                    afterDatasetsDraw(chart) {
                        if (!chartDatasetVisibility.target) return;
                        const ctx = chart.ctx;
                        const yAxis = chart.scales.y;
                        if (!yAxis) return;

                        const greenZoneMin = yAxis.getPixelForValue(goalWeight - 2);
                        const greenZoneMax = yAxis.getPixelForValue(goalWeight + 2);
                        const yellowZoneMin = yAxis.getPixelForValue(goalWeight - 4);
                        const yellowZoneMax = yAxis.getPixelForValue(goalWeight + 4);

                        // Red zone (bottom)
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.05)';
                        ctx.fillRect(chart.chartArea.left, yellowZoneMax, chart.chartArea.width, chart.chartArea.height - (yellowZoneMax - chart.chartArea.top));

                        // Yellow zone
                        ctx.fillStyle = 'rgba(251, 191, 36, 0.05)';
                        ctx.fillRect(chart.chartArea.left, greenZoneMax, chart.chartArea.width, yellowZoneMax - greenZoneMax);

                        // Green zone
                        ctx.fillStyle = 'rgba(52, 211, 153, 0.05)';
                        ctx.fillRect(chart.chartArea.left, greenZoneMin, chart.chartArea.width, greenZoneMax - greenZoneMin);

                        // Yellow zone (top)
                        ctx.fillStyle = 'rgba(251, 191, 36, 0.05)';
                        ctx.fillRect(chart.chartArea.left, chart.chartArea.top, chart.chartArea.width, greenZoneMin - chart.chartArea.top);
                    }
                };

                updateChartAppearance();
                progressChart.update();
            }
            function renderSleepProgressChart(timeRange = 'all') { /* ...unchanged logic... */ let history = filterHistory(userProfile.sleepHistory, timeRange); const sortedHistory = [...history].sort((a,b) => new Date(a.date) - new Date(b.date)); const labels = sortedHistory.map(log => new Date(log.date.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })); const durationData = sortedHistory.map(log => { if (!log.startTime || !log.endTime || !log.date) return null; const { durationInMinutes } = calculateSleepDuration(log.startTime, log.endTime, log.date); return (durationInMinutes / 60); }); const qualityData = sortedHistory.map(log => log.quality || null); sleepProgressChart.data = { labels, datasets: [ { label: 'Duration (hours)', data: durationData, backgroundColor: 'rgba(96, 165, 250, 0.7)', borderColor: '#60a5fa', borderWidth: 1, borderRadius: 4, yAxisID: 'y' }, { label: 'Quality (stars)', data: qualityData, type: 'line', borderColor: '#f59e0b', backgroundColor: 'transparent', pointBackgroundColor: '#f59e0b', yAxisID: 'y2', tension: 0.4, borderWidth: 2, pointRadius: 5 } ] }; updateChartAppearance(); sleepProgressChart.update(); }
            function renderNutritionProgressChart(timeRange = 'all') { /* ...unchanged logic... */ let history = filterHistory(userProfile.nutritionHistory, timeRange); const sortedHistory = [...history].sort((a,b) => new Date(a.date) - new Date(b.date)); const labels = sortedHistory.map(log => new Date(log.date.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })); const calorieGoals = Array(labels.length).fill(goals.calories); const proteinGoals = Array(labels.length).fill(goals.protein); nutritionProgressChart.data = { labels, datasets: [ { label: 'Calories Consumed', data: sortedHistory.map(d => d.calories || null), borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.1)', tension: 0.2, fill: true, pointRadius: 3, order: 2 }, { label: 'Protein Consumed (g)', data: sortedHistory.map(d => d.protein || null), borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.1)', tension: 0.2, fill: true, pointRadius: 3, order: 3 }, { label: 'Calorie Goal', data: calorieGoals, borderColor: 'rgba(251, 191, 36, 0.4)', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, order: 1 }, { label: 'Protein Goal', data: proteinGoals, borderColor: 'rgba(52, 211, 153, 0.4)', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, order: 4 } ] }; updateChartAppearance(); nutritionProgressChart.update(); }
            function renderWorkoutProgressChart(timeRange = 'all') { /* ...unchanged logic... */ let history = filterHistory(userProfile.workoutHistory, timeRange); const volumeByDay = {}; history.forEach(log => { const dateKey = log.date; const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const logVolume = sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0); if (!volumeByDay[dateKey]) { volumeByDay[dateKey] = 0; } volumeByDay[dateKey] += logVolume; }); const workoutsByWeek = {}; const volumeByWeek = {}; Object.keys(volumeByDay).forEach(dateStr => { const date = new Date(dateStr.replace(/-/g, '/')); const dayOfWeek = date.getDay(); const firstDayOfWeek = new Date(date); firstDayOfWeek.setDate(date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); const weekKey = firstDayOfWeek.toISOString().split('T')[0]; if (!workoutsByWeek[weekKey]) workoutsByWeek[weekKey] = 0; if (!volumeByWeek[weekKey]) volumeByWeek[weekKey] = 0; workoutsByWeek[weekKey]++; volumeByWeek[weekKey] += volumeByDay[dateStr]; }); const sortedWeeks = Object.keys(workoutsByWeek).sort(); const labels = sortedWeeks.map(weekKey => new Date(weekKey.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })); const workoutCountData = sortedWeeks.map(weekKey => workoutsByWeek[weekKey]); const totalVolumeData = sortedWeeks.map(weekKey => volumeByWeek[weekKey] / 1000); workoutProgressChart.data = { labels, datasets: [ { label: 'Workouts Logged', data: workoutCountData, backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: '#ef4444', borderWidth: 1, borderRadius: 4, yAxisID: 'y', type: 'bar', order: 2 }, { label: 'Total Volume (MT/1000kg)', data: totalVolumeData, borderColor: '#fbbf24', backgroundColor: 'transparent', yAxisID: 'y', tension: 0.4, type: 'line', borderWidth: 2, pointRadius: 3, order: 1 } ] }; updateChartAppearance(); workoutProgressChart.update(); }

            // --- NEW ANALYTICAL CALCULATION FUNCTIONS ---
            function calculateTrendDirection(history, days = 7) {
                if (!history || history.length < 2) return '→';
                const now = new Date();
                const daysAgo = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
                const daysBackTwice = new Date(now.getTime() - (days * 2) * 24 * 60 * 60 * 1000);

                const recentData = history.filter(d => new Date(d.date.replace(/-/g, '/')) >= daysAgo);
                const olderData = history.filter(d => {
                    const date = new Date(d.date.replace(/-/g, '/'));
                    return date >= daysBackTwice && date < daysAgo;
                });

                if (recentData.length === 0 || olderData.length === 0) return '→';

                const recentAvg = recentData.reduce((sum, d) => sum + d.weight, 0) / recentData.length;
                const olderAvg = olderData.reduce((sum, d) => sum + d.weight, 0) / olderData.length;
                const diff = recentAvg - olderAvg;

                const threshold = 0.2;
                if (Math.abs(diff) <= threshold) return '→';
                return diff < 0 ? '↓' : '↑';
            }

            function getStatusColor(currentValue, goalValue, isLossGoal = true) {
                if (!goalValue) return '#60a5fa';
                const diff = Math.abs(currentValue - goalValue);
                const totalDiff = Math.abs(goalValue * 2 - goalValue); // Distance from goal to opposite
                const percentToGoal = Math.abs(currentValue - goalValue) / Math.abs(goalValue);

                if (isLossGoal) {
                    if (currentValue <= goalValue) return '#34d399'; // At goal
                    if (percentToGoal <= 0.1) return '#34d399'; // Within 10% (green)
                    if (percentToGoal <= 0.2) return '#fbbf24'; // Within 20% (yellow)
                } else {
                    if (currentValue >= goalValue) return '#34d399'; // At goal
                    if (percentToGoal <= 0.1) return '#34d399'; // Within 10% (green)
                    if (percentToGoal <= 0.2) return '#fbbf24'; // Within 20% (yellow)
                }

                return '#ef4444'; // Off track (red)
            }

            function predictWeeksToGoal(currentWeight, goalWeight, weeklyTrend) {
                if (!weeklyTrend || weeklyTrend === 0 || Math.abs(weeklyTrend) < 0.01) return '—';
                const weeksNeeded = (goalWeight - currentWeight) / weeklyTrend;
                if (weeksNeeded < 0) return 'Off pace';
                return Math.round(weeksNeeded);
            }

            function calculateWeeklyAverage(weightHistory, weeks = 4) {
                if (!weightHistory || weightHistory.length < 2) return 0;
                const weeksMs = weeks * 7 * 24 * 60 * 60 * 1000;
                const cutoffDate = new Date(Date.now() - weeksMs);
                const recentHistory = weightHistory.filter(d => new Date(d.date.replace(/-/g, '/')) >= cutoffDate);

                if (recentHistory.length < 2) return 0;
                const firstWeight = recentHistory[0].weight;
                const lastWeight = recentHistory[recentHistory.length - 1].weight;
                const daysBetween = (new Date(recentHistory[recentHistory.length - 1].date.replace(/-/g, '/')) -
                                     new Date(recentHistory[0].date.replace(/-/g, '/'))) / (1000 * 60 * 60 * 24);

                if (daysBetween <= 0) return 0;
                return ((lastWeight - firstWeight) / daysBetween) * 7;
            }

            function generateSmartInsights(userProfile, weightHistory, inbodyHistory) {
                const insights = [];

                if (!weightHistory || weightHistory.length < 7) {
                    insights.push('📊 Getting started! Log consistently for 4 weeks to see reliable trends.');
                    return insights;
                }

                const weeklyAvg = calculateWeeklyAverage(weightHistory, 4);
                const currentWeight = userProfile.weight;
                const goalWeight = userProfile.idealWeight || 70;
                const trendDir = calculateTrendDirection(weightHistory, 7);

                // Check for good progress
                if (trendDir === '↓' && Math.abs(weeklyAvg) >= 0.3) {
                    const weeksToGoal = predictWeeksToGoal(currentWeight, goalWeight, weeklyAvg);
                    insights.push(`✅ Great progress! Down ${Math.abs(weeklyAvg).toFixed(2)} kg/week toward your ${goalWeight}kg goal.`);
                    if (weeksToGoal !== '—' && weeksToGoal !== 'Off pace') {
                        insights.push(`At this pace, you'll reach your goal in ${weeksToGoal} weeks.`);
                    }
                }
                // Weight stable (concerning if loss goal)
                else if (trendDir === '→' && userProfile.goal === 'lose') {
                    insights.push(`⚠️ Weight stable for 7 days—no progress toward goal. Try increasing your deficit by 100-200 kcal or adding 20 min cardio.`);
                }
                // Weight increasing (concerning if loss goal)
                else if (trendDir === '↑' && userProfile.goal === 'lose') {
                    const weeklyGain = Math.abs(weeklyAvg);
                    insights.push(`⚠️ Weight up ${weeklyGain.toFixed(1)} kg this week. Check your deficit, water intake, and stress levels.`);
                }
                // Muscle gain with fat loss (recomposition)
                else if (inbodyHistory && inbodyHistory.length >= 2 && userProfile.goal === 'recomposition') {
                    const lastInBody = inbodyHistory[inbodyHistory.length - 1];
                    const firstInBody = inbodyHistory[0];
                    const smmChange = lastInBody.smm - firstInBody.smm;
                    const bfmChange = lastInBody.bfm - firstInBody.bfm;
                    if (smmChange > 0 && bfmChange < 0) {
                        insights.push(`🎉 Excellent recomposition! Muscle +${smmChange.toFixed(1)}kg, Fat -${Math.abs(bfmChange).toFixed(1)}kg.`);
                    }
                }
                // Good consistency
                else if (weightHistory.length >= 7) {
                    const last7 = weightHistory.slice(-7);
                    insights.push(`🔥 Amazing logging streak: ${last7.length} days! Your consistency is your edge.`);
                }

                if (insights.length === 0) {
                    insights.push(`📈 Keep logging! You have ${weightHistory.length} entries. Trends emerge with more data.`);
                }

                return insights.length > 0 ? insights : ['Keep logging to see insights!'];
            }

            // --- UI UPDATE FUNCTIONS (UPDATED) ---
            function populateProfileForm() { 
                if (!isDataLoaded) return; 
                
                // --- Original Form ---
                if (userProfile.age) { 
                    ui.profileForm.age.value = userProfile.age; 
                    ui.profileForm.gender.value = userProfile.gender; 
                    ui.profileForm.height.value = userProfile.height; 
                    ui.profileForm.weight.value = userProfile.weight.toFixed(1); 
                    ui.profileForm.smm.value = userProfile.smm || ''; 
                    ui.profileForm.bfm.value = userProfile.bfm || ''; 
                    ui.profileForm['activity-level'].value = userProfile.activityLevel || 1.55; 
                    ui.profileForm['user-goal'].value = userProfile.goal || 'recomposition'; 
                    if(userProfile.bmr) ui.bmrInput.value = Math.round(userProfile.bmr); 
                    else ui.bmrInput.placeholder = 'Auto'; 
                    if(userProfile.bmi) ui.bmiInput.value = userProfile.bmi.toFixed(1); 
                    document.getElementById('recomp-deficit-input').value = userProfile.recompDeficit || 500; 
                } 
                
                // --- New Detailed Goals Form ---
                if (ui.detailedGoalsForm) {
                    ui.detailedGoalsForm['ideal-weight'].value = userProfile.idealWeight || '';
                    
                    if (userProfile.bodyType) {
                        const radioBodyType = ui.detailedGoalsForm.querySelector(`input[name="body-type"][value="${userProfile.bodyType}"]`);
                        if (radioBodyType) radioBodyType.checked = true;
                    }
                    if (userProfile.bodyFat) {
                        const radioBodyFat = ui.detailedGoalsForm.querySelector(`input[name="body-fat"][value="${userProfile.bodyFat}"]`);
                        if (radioBodyFat) radioBodyFat.checked = true;
                    }

                    ui.detailedGoalsForm.querySelectorAll('input[name="fat-area"]').forEach(cb => {
                        cb.checked = (userProfile.fatLossAreas || []).includes(cb.value);
                    });
                    
                    ui.detailedGoalsForm['training-history'].value = userProfile.trainingHistory || '';
                    ui.detailedGoalsForm['fitness-familiarity'].value = userProfile.fitnessFamiliarity || '';

                    ui.detailedGoalsForm.querySelectorAll('input[name="past-attempt"]').forEach(cb => {
                        cb.checked = (userProfile.pastAttempts || []).includes(cb.value);
                    });

                    ui.detailedGoalsForm['tracking-app'].value = userProfile.trackingApp || '';

                    if (userProfile.liftComfort) {
                        ui.detailedGoalsForm['lift-comfort-squat'].value = userProfile.liftComfort.squat || 'comfortable';
                        ui.detailedGoalsForm['lift-comfort-bench'].value = userProfile.liftComfort.bench || 'comfortable';
                        ui.detailedGoalsForm['lift-comfort-deadlift'].value = userProfile.liftComfort.deadlift || 'comfortable';
                    }
                }
                
                updateGoalSpecificUI(); 
            }
            function generateCaloriePlan() { /* ...unchanged... */ if (!isDataLoaded) return; if(!goals.calories || goals.calories === 0 || !userProfile.tdee) { ui.caloriePlanOutput.innerHTML = '<p class="text-secondary-text">Please fill out your profile stats to generate a plan.</p>'; return; } const { tdee } = userProfile; let planHtml = `<p class="mb-4">Your estimated maintenance calories are <strong class="text-xl text-blue-400">${Math.round(tdee)} kcal</strong>. Based on your goal, here is your **AI Adaptive Plan**:</p>`; planHtml += `<div class="grid grid-cols-2 gap-4 text-center"><div><p class="text-sm text-secondary-text">Target Calories</p><p class="font-bold text-2xl text-white">${Math.round(goals.calories)}</p></div><div><p class="text-sm text-secondary-text">Protein</p><p class="font-bold text-2xl text-white">${Math.round(goals.protein)}g</p></div><div><p class="text-sm text-secondary-text">Carbs</p><p class="font-bold text-2xl text-white">${Math.round(goals.carbs)}g</p></div><div><p class="text-sm text-secondary-text">Fat</p><p class="font-bold text-2xl text-white">${Math.round(goals.fat)}g</p></div></div>`; planHtml += `<p class="text-xs text-secondary-text mt-4 text-center">This plan will adapt based on your daily check-ins to ensure consistent progress.</p>`; ui.caloriePlanOutput.innerHTML = planHtml; }
            function calculateAndRenderAnalytics() {
                if (!isDataLoaded) return;
                const { weightHistory, inbodyHistory, weight, bfm, idealWeight, goal } = userProfile;

                // Calculate analytics once
                const weeklyAvg = calculateWeeklyAverage(weightHistory, 4);
                const trendDir = calculateTrendDirection(weightHistory, 7);
                const goalWeight = idealWeight || 70;

                let statsHtml = '<p class="text-secondary-text text-center">Not enough data to calculate stats. Keep logging!</p>';
                let insightsHtml = '';

                if (weightHistory && weightHistory.length >= 2) {
                    const firstEntry = weightHistory[0];
                    const lastEntry = weightHistory[weightHistory.length - 1];
                    const totalChange = lastEntry.weight - firstEntry.weight;

                    // Determine if weight loss goal
                    const isLossGoal = goal === 'lose';

                    // Calculate status colors and predictions
                    const weightStatus = getStatusColor(weight, goalWeight, isLossGoal);
                    const weeksToGoal = predictWeeksToGoal(weight, goalWeight, weeklyAvg);

                    // Build KPI cards with colors and trends
                    const statusIcon = (color) => {
                        if (color === '#34d399') return '✅';
                        if (color === '#fbbf24') return '⚠️';
                        if (color === '#ef4444') return '❌';
                        return '📊';
                    };

                    statsHtml = `<div class="grid grid-cols-2 gap-4">`;

                    // Total Weight Change
                    const changeColor = totalChange < 0 ? '#34d399' : (totalChange === 0 ? '#60a5fa' : '#ef4444');
                    statsHtml += `
                        <div class="kpi-card" style="border-left: 3px solid ${changeColor}">
                            <p class="text-xs text-secondary-text">Total Weight Change</p>
                            <p class="font-bold text-xl" style="color: ${changeColor}">
                                ${totalChange.toFixed(1)} kg ${trendDir}
                            </p>
                            <p class="text-xs text-secondary-text mt-1">Target: ${goalWeight}kg (${Math.round(((goalWeight - weight) / goalWeight) * 100)}% remaining)</p>
                        </div>
                    `;

                    // Weekly Average
                    statsHtml += `
                        <div class="kpi-card" style="border-left: 3px solid ${changeColor}">
                            <p class="text-xs text-secondary-text">Avg. Weekly</p>
                            <p class="font-bold text-xl" style="color: ${changeColor}">
                                ${weeklyAvg.toFixed(2)} kg/week
                            </p>
                            <p class="text-xs text-secondary-text mt-1">
                                ${weeklyAvg < -0.3 ? '✅ On pace' : weeklyAvg >= -0.2 ? '⚠️ Watch' : '❌ Off pace'}
                            </p>
                        </div>
                    `;

                    // Current Weight vs Goal
                    statsHtml += `
                        <div class="kpi-card" style="border-left: 3px solid ${weightStatus}">
                            <p class="text-xs text-secondary-text">Current Weight</p>
                            <p class="font-bold text-xl" style="color: ${weightStatus}">
                                ${weight.toFixed(1)} kg
                            </p>
                            <p class="text-xs text-secondary-text mt-1">${Math.round(((goalWeight - weight) / Math.abs(goalWeight)) * 100)}% to goal (${goalWeight}kg)</p>
                        </div>
                    `;

                    // Weeks to Goal
                    const weeksColor = weeksToGoal === '—' || weeksToGoal === 'Off pace' ? '#fbbf24' : '#34d399';
                    statsHtml += `
                        <div class="kpi-card" style="border-left: 3px solid ${weeksColor}">
                            <p class="text-xs text-secondary-text">Time to Goal</p>
                            <p class="font-bold text-xl" style="color: ${weeksColor}">
                                ${weeksToGoal} weeks
                            </p>
                            <p class="text-xs text-secondary-text mt-1">At current pace</p>
                        </div>
                    `;

                    // Body Fat % if available
                    if (weight && bfm) {
                        const bfPercent = (bfm / weight) * 100;
                        statsHtml += `
                            <div class="kpi-card" style="border-left: 3px solid #60a5fa">
                                <p class="text-xs text-secondary-text">Body Fat %</p>
                                <p class="font-bold text-xl" style="color: #60a5fa">
                                    ${bfPercent.toFixed(1)}%
                                </p>
                                <p class="text-xs text-secondary-text mt-1">Healthy range: 10-20%</p>
                            </div>
                        `;
                    }

                    // Check-in Consistency
                    const last7Days = weightHistory.slice(-7).length;
                    const consistencyColor = last7Days >= 6 ? '#34d399' : (last7Days >= 4 ? '#fbbf24' : '#ef4444');
                    statsHtml += `
                        <div class="kpi-card" style="border-left: 3px solid ${consistencyColor}">
                            <p class="text-xs text-secondary-text">Weekly Streak</p>
                            <p class="font-bold text-xl" style="color: ${consistencyColor}">
                                ${last7Days}/7 days
                            </p>
                            <p class="text-xs text-secondary-text mt-1">Total: ${weightHistory.length} entries</p>
                        </div>
                    `;

                    statsHtml += `</div>`;
                }

                // Generate smart insights
                const insights = generateSmartInsights(userProfile, weightHistory, inbodyHistory);
                insightsHtml = `<div class="smart-insights">`;
                insights.forEach(insight => {
                    const textColor = insight.includes('❌') || insight.includes('⚠️') ? '#ef4444' :
                                     insight.includes('✅') || insight.includes('🎉') ? '#34d399' : '#fbbf24';
                    insightsHtml += `<p style="color: ${textColor}; margin-bottom: 0.5rem; font-size: 0.9rem;">${insight}</p>`;
                });
                insightsHtml += `</div>`;

                ui.keyStatsOutput.innerHTML = statsHtml;
                ui.progressInsightsOutput.innerHTML = insightsHtml;
            }
            async function calculateAndSaveGoals(showFeedback = true, localOnly = false) { /* ...unchanged calculation logic, calls saveData() at the end unless localOnly... */ const btn = ui.profileForm.querySelector('button[type="submit"]'); if (btn && showFeedback) { btn.disabled = true; btn.querySelector('.btn-text').style.display = 'none'; btn.querySelector('.loader').classList.remove('hidden'); btn.querySelector('.btn-text').textContent = "Calculating..."; } if (!localOnly) { userProfile.age = parseInt(ui.profileForm.age.value); userProfile.gender = ui.profileForm.gender.value; userProfile.height = parseInt(ui.profileForm.height.value); userProfile.smm = parseFloat(ui.profileForm.smm.value) || null; userProfile.bfm = parseFloat(ui.profileForm.bfm.value) || null; userProfile.activityLevel = parseFloat(ui.profileForm['activity-level'].value); userProfile.goal = ui.profileForm['user-goal'].value; userProfile.recompDeficit = parseInt(document.getElementById('recomp-deficit-input').value) || 500; } userProfile.weight = parseFloat(ui.profileForm.weight.value); let bmr; const manualBMR = parseFloat(ui.bmrInput.value); if (manualBMR > 0) { bmr = manualBMR; } else { if (userProfile.gender === 'male') { bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age + 5; } else { bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age - 161; } ui.bmrInput.placeholder = Math.round(bmr); if (!localOnly) ui.bmrInput.value = ''; } userProfile.bmr = bmr; const bmi = userProfile.weight / ((userProfile.height / 100) ** 2); userProfile.bmi = bmi; ui.bmiInput.value = bmi.toFixed(1); const tdee = bmr * userProfile.activityLevel; userProfile.tdee = tdee; let calorieTarget = tdee; if(userProfile.goal === 'lose') calorieTarget -= 500; if(userProfile.goal === 'gain') calorieTarget += 300; if(userProfile.goal === 'recomposition') calorieTarget = tdee - userProfile.recompDeficit; goals.calories = Math.round(calorieTarget); goals.protein = Math.round(userProfile.weight * 2.2); goals.fat = Math.round(userProfile.weight * 0.8); goals.carbs = Math.round((goals.calories - (goals.protein * 4 + goals.fat * 9)) / 4); if (goals.carbs < 0) { goals.carbs = 0; goals.fat = Math.round((goals.calories - (goals.protein * 4)) / 9); } if (!localOnly) { saveData(); } if (btn) { btn.disabled = false; if (showFeedback) { btn.querySelector('.btn-text').textContent = "Saved!"; btn.querySelector('.loader').classList.add('hidden'); btn.querySelector('.btn-text').style.display = 'inline'; setTimeout(() => { if (btn) btn.querySelector('.btn-text').textContent = "Save & Calculate Goals"; }, 2000); } else { btn.querySelector('.btn-text').textContent = "Save & Calculate Goals"; btn.querySelector('.loader').classList.add('hidden'); btn.querySelector('.btn-text').style.display = 'inline'; } } if (localOnly) fullRender(); }
            
            function updateGoalSpecificUI() { 
                const goal = ui.userGoalSelect.value;
                
                // Recomp deficit field
                const recompContainer = document.getElementById('recomp-deficit-container'); 
                if (recompContainer) { 
                    recompContainer.classList.toggle('hidden', goal !== 'recomposition'); 
                } 
                
                // New conditional field
                if (ui.fatLossDetails) {
                    ui.fatLossDetails.classList.toggle('hidden', goal !== 'lose');
                }
            }
            
            function updateChartRangeButtons() { /* ...unchanged... */ document.querySelectorAll('.chart-range-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.range === activeChartRange); }); }
            function fullRenderAllCharts() { /* ...unchanged... */ if (!isDataLoaded) return; renderProgressChart(activeChartRange); renderSleepProgressChart(activeChartRange); renderNutritionProgressChart(activeChartRange); renderWorkoutProgressChart(activeChartRange); }
            function fullRender() { /* ...unchanged... */ if (!isDataLoaded) return; populateProfileForm(); generateCaloriePlan(); calculateAndRenderAnalytics(); fullRenderAllCharts(); }

            // --- EVENT LISTENERS (UPDATED) ---
            function setupEventListeners() {
                ui.profileForm.addEventListener('submit', async (e) => { e.preventDefault(); if(!ui.profileForm.age.value || !ui.profileForm.height.value || !ui.profileForm.weight.value){ showCustomAlert('Missing Information', 'Please fill in Age, Height, and Weight to calculate your goals.'); return; } ui.profileForm.weight.value = ui.checkInWeightInput.value; await calculateAndSaveGoals(); });
                
                // Listener for the new detailed goals form
                ui.detailedGoalsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const btn = ui.saveDetailedGoalsBtn;
                    const btnText = btn.querySelector('.btn-text');
                    const loader = btn.querySelector('.loader');

                    btn.disabled = true;
                    btnText.style.display = 'none';
                    loader.classList.remove('hidden');

                    try {
                        userProfile.idealWeight = parseFloat(ui.detailedGoalsForm['ideal-weight'].value) || null;
                        
                        const checkedBodyType = ui.detailedGoalsForm.querySelector('input[name="body-type"]:checked');
                        userProfile.bodyType = checkedBodyType ? checkedBodyType.value : '';

                        const checkedBodyFat = ui.detailedGoalsForm.querySelector('input[name="body-fat"]:checked');
                        userProfile.bodyFat = checkedBodyFat ? checkedBodyFat.value : '';

                        userProfile.fatLossAreas = Array.from(ui.detailedGoalsForm.querySelectorAll('input[name="fat-area"]:checked')).map(cb => cb.value);
                        userProfile.trainingHistory = ui.detailedGoalsForm['training-history'].value;
                        userProfile.fitnessFamiliarity = ui.detailedGoalsForm['fitness-familiarity'].value;
                        userProfile.pastAttempts = Array.from(ui.detailedGoalsForm.querySelectorAll('input[name="past-attempt"]:checked')).map(cb => cb.value);
                        userProfile.trackingApp = ui.detailedGoalsForm['tracking-app'].value;
                        
                        userProfile.liftComfort = {
                            squat: ui.detailedGoalsForm['lift-comfort-squat'].value,
                            bench: ui.detailedGoalsForm['lift-comfort-bench'].value,
                            deadlift: ui.detailedGoalsForm['lift-comfort-deadlift'].value,
                        };

                        saveData();

                        btnText.textContent = "Saved!";
                        setTimeout(() => {
                            btnText.textContent = "Save Details";
                        }, 2000);

                    } catch (error) {
                        console.error("Error saving detailed goals:", error);
                        showCustomAlert("Error", "Could not save your details.");
                        btnText.textContent = "Save Details";
                    } finally {
                        btn.disabled = false;
                        btnText.style.display = 'inline';
                        loader.classList.add('hidden');
                    }
                });

                ui.checkInForm.addEventListener('submit', async (e) => { e.preventDefault(); const btn = ui.checkInBtn; const newWeight = parseFloat(ui.checkInWeightInput.value); const newSmm = parseFloat(ui.checkInSmmInput.value) || null; if (!newWeight || newWeight <= 0) { ui.checkInFeedback.textContent = "Please enter a valid weight."; ui.checkInFeedback.classList.add('text-red-400'); return; } if (!userProfile.age) { ui.checkInFeedback.textContent = "Please fill out your profile first (Goals tab)."; ui.checkInFeedback.classList.add('text-red-400'); return; } btn.disabled = true; btn.querySelector('.btn-text').style.display = 'none'; btn.querySelector('.loader').classList.remove('hidden'); const today = new Date().toISOString().split('T')[0]; const todayWeightIndex = userProfile.weightHistory.findIndex(entry => entry.date === today); if (todayWeightIndex > -1) { userProfile.weightHistory[todayWeightIndex].weight = newWeight; } else { userProfile.weightHistory.push({ date: today, weight: newWeight }); } if (newSmm) { const todayInBodyIndex = userProfile.inbodyHistory.findIndex(entry => entry.date === today); const estimatedBfm = (newSmm > 0 && userProfile.bfm && userProfile.weight > 0) ? newWeight * (userProfile.bfm / userProfile.weight) : null; const inBodyEntry = { date: today, smm: newSmm, bfm: estimatedBfm !== null ? estimatedBfm : (userProfile.bfm || 0) }; if (todayInBodyIndex > -1) { userProfile.inbodyHistory[todayInBodyIndex] = inBodyEntry; } else { userProfile.inbodyHistory.push(inBodyEntry); } userProfile.smm = newSmm; if(estimatedBfm !== null) userProfile.bfm = estimatedBfm; } userProfile.weight = newWeight; saveData(); await new Promise(resolve => setTimeout(resolve, 500)); ui.checkInFeedback.textContent = `Weight logged as ${newWeight} kg. Goals updated.`; ui.checkInFeedback.classList.remove('text-red-400'); ui.checkInFeedback.classList.add('text-green-400'); ui.checkInWeightInput.value = ''; ui.checkInSmmInput.value = ''; btn.disabled = false; btn.querySelector('.btn-text').style.display = 'inline'; btn.querySelector('.loader').classList.add('hidden'); document.getElementById('key-stats-output').scrollIntoView({ behavior: 'smooth' }); });
                
                ui.userGoalSelect.addEventListener('change', updateGoalSpecificUI); 
                
                ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));
                const rangeButtons = [ui.chartRange30d, ui.chartRange90d, ui.chartRange1y, ui.chartRangeAll]; rangeButtons.forEach(btn => { btn.addEventListener('click', () => { const range = btn.dataset.range; activeChartRange = range; fullRenderAllCharts(); }); });
                ui.tabs.forEach(tab => { tab.addEventListener('click', (e) => { const tabName = e.currentTarget.dataset.tab; showTab(tabName); }); });
                if(ui.checkInWeightInput) { ui.checkInWeightInput.addEventListener('focus', () => { if (userProfile.weightHistory.length > 0) { const latestWeight = userProfile.weightHistory[userProfile.weightHistory.length - 1].weight; ui.checkInWeightInput.value = latestWeight.toFixed(1); } }); }
            }

            // --- INITIALIZATION ---
            function showCustomAlert(title, text) { // Define helper here
                const modal = ui.alertModal;
                if (!modal) return;
                modal.querySelector('#alert-modal-title').textContent = title;
                modal.querySelector('#alert-modal-text').textContent = text;
                modal.style.display = 'flex';
            }
             function hideModal(modal) { // Define helper here
                if (modal) modal.style.display = 'none';
            }

            setupEventListeners();
            loadData(); // Load data from Local Storage
            updateChartThemeColors();
            showTab('general'); // Show default tab
            // No Firebase init needed
        }
        // --- End Original script ---

        // Initialize layout and page logic on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeLayout);
    </script>
</body>
</html>
