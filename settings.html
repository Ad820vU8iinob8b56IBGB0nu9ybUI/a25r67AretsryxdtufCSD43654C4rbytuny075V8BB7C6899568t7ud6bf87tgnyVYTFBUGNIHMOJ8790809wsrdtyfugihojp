<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kowbi | Settings</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Link Shared CSS -->
    <link rel="stylesheet" href="assets/styles.css">
    <!-- Page Specific Styles -->
    <style>
        /* Styles specific to settings page */
        body.menu-open { overflow: hidden; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: var(--secondary-text); font-weight: 500; transition: all 0.2s ease; }
        .sidebar-link:hover { background-color: var(--input-bg); color: var(--primary-text); }
        .sidebar-link.active { background-color: var(--input-bg); color: var(--primary-text); font-weight: 600; }
        #mobile-settings-nav { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        #mobile-settings-nav::-webkit-scrollbar { display: none; }
        .mobile-sidebar-link { color: var(--secondary-text); border-bottom: 2px solid transparent; transition: all 0.2s ease; text-align: center; padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; display: inline-block; flex-shrink: 0; }
        .mobile-sidebar-link.active { color: var(--primary-text); border-bottom-color: var(--accent); }
        .theme-btn { background-color: var(--input-bg); color: var(--secondary-text); border: 1px solid var(--border-color); }
        .theme-btn.active { background-color: var(--accent); color: var(--background); border-color: var(--accent); }
        .content-panel { display: none; }
        .content-panel.active { display: block; animation: fadeIn 0.5s ease; }

        /* --- ADDED: Styles for new forms --- */
        /* Styles for new image pickers */
        .image-picker-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem; /* 12px */
        }
        
        .image-picker-label {
            display: block;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem; /* 8px */
            padding: 0.5rem; /* 8px */
            transition: all 0.2s ease-in-out;
            background-color: var(--input-bg);
        }
        
        .image-picker-label:hover {
            border-color: var(--secondary-text);
        }
        
        .image-picker-label img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 0.25rem; /* 4px */
        }
        
        .image-picker-label p {
            text-align: center;
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            color: var(--secondary-text);
            margin-top: 0.5rem; /* 8px */
        }
        
        /* Style for the hidden radio button */
        .image-picker-input {
            display: none;
        }
        
        /* Style for the selected item */
        .image-picker-input:checked + .image-picker-label {
            border-color: var(--accent);
            background-color: var(--card-bg);
            box-shadow: 0 0 0 2px var(--accent);
        }
        
        .image-picker-input:checked + .image-picker-label p {
            color: var(--primary-text);
            font-weight: 600;
        }

        /* Checkbox grid */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--input-bg);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
        .form-checkbox {
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            background-color: var(--background);
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            position: relative;
        }
        .form-checkbox:checked {
            background-color: var(--accent);
            border-color: var(--accent);
        }
        .form-checkbox:checked::after {
            content: 'âœ”';
            position: absolute;
            color: var(--background);
            font-size: 0.75rem;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .hidden {
            display: none;
        }
        /* --- END: Styles for new forms --- */
    </style>
</head>
<body class="antialiased">

    <!-- Theme script (should be early) -->
    <script>
        (function() {
            const theme = localStorage.getItem('fitTrackAI_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <div class="container mx-auto max-w-7xl px-4 py-6">
        <!-- Header Placeholder -->
        <div id="header-placeholder"></div>

        <!-- Mobile Sub-navigation (Order matched original) -->
        <nav id="mobile-settings-nav" class="md:hidden flex items-center border-b border-border-color mb-6">
            <a href="#" class="mobile-sidebar-link active" data-target="general-settings-content">General</a>
            <a href="#" class="mobile-sidebar-link" data-target="home-settings-content">Home</a>
            <a href="#" class="mobile-sidebar-link" data-target="nutrition-settings-content">Nutrition</a>
            <a href="#" class="mobile-sidebar-link" data-target="workouts-settings-content">Workouts</a>
            <a href="#" class="mobile-sidebar-link" data-target="sleep-settings-content">Sleep</a>
            <a href="#" class="mobile-sidebar-link" data-target="progress-settings-content">Progress</a>
            <a href="#" class="mobile-sidebar-link" data-target="social-settings-content">Social</a>
            <!-- ADDED: Your Details Link -->
            <a href="#" class="mobile-sidebar-link" data-target="your-details-content">Your Details</a>
            <a href="#" class="mobile-sidebar-link" data-target="app-settings-content">App</a>
            <a href="#" class="mobile-sidebar-link" data-target="account-content">Data</a>
        </nav>

        <div class="flex flex-col md:flex-row gap-8 lg:gap-12">
            <!-- Sidebar (Order matched original) -->
            <aside class="hidden md:block md:w-64 flex-shrink-0">
                <nav id="settings-sidebar" class="space-y-1">
                    <a href="#" class="sidebar-link active" data-target="general-settings-content"><i data-lucide="sliders-horizontal"></i>General</a>
                    <a href="#" class="sidebar-link" data-target="home-settings-content"><i data-lucide="home"></i>Home</a>
                    <a href="#" class="sidebar-link" data-target="nutrition-settings-content"><i data-lucide="utensils"></i>Nutrition</a>
                    <a href="#" class="sidebar-link" data-target="workouts-settings-content"><i data-lucide="dumbbell"></i>Workouts</a>
                    <a href="#" class="sidebar-link" data-target="sleep-settings-content"><i data-lucide="moon"></i>Sleep</a>
                    <a href="#" class="sidebar-link" data-target="progress-settings-content"><i data-lucide="trending-up"></i>Progress</a>
                    <a href="#" class="sidebar-link" data-target="social-settings-content"><i data-lucide="users"></i>Social</a>
                    <hr class="border-border-color my-2">
                    <!-- ADDED: Your Details Link -->
                    <a href="#" class="sidebar-link" data-target="your-details-content"><i data-lucide="user-check"></i>Your Details</a>
                    <a href="#" class="sidebar-link" data-target="app-settings-content"><i data-lucide="smartphone"></i>App Settings</a>
                    <a href="#" class="sidebar-link" data-target="account-content"><i data-lucide="database"></i>Account & Data</a>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 min-w-0">
                
                <!-- General Settings Panel -->
                <div id="general-settings-content" class="content-panel active">
                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-6">Units</h2>
                        <div class="space-y-4">
                            <div class="setting-row"> <div><label for="setting-weight-unit" class="setting-label block">Weight</label><p class="setting-description">Used for logging weight and exercises.</p></div> <div class="setting-control"><select id="setting-weight-unit" class="form-select !w-28 !py-1 text-sm"><option value="kg">Kilograms (kg)</option><option value="lbs">Pounds (lbs)</option></select></div> </div>
                            <div class="setting-row"> <div><label for="setting-height-unit" class="setting-label block">Height</label><p class="setting-description">Used in profile and calculations.</p></div> <div class="setting-control"><select id="setting-height-unit" class="form-select !w-28 !py-1 text-sm"><option value="cm">Centimeters (cm)</option><option value="ft_in">Feet & Inches (ft/in)</option></select></div> </div>
                            <div class="setting-row"> <div><label for="setting-distance-unit" class="setting-label block">Distance</label><p class="setting-description">Used for cardio activities.</p></div> <div class="setting-control"><select id="setting-distance-unit" class="form-select !w-28 !py-1 text-sm"><option value="km">Kilometers (km)</option><option value="miles">Miles (mi)</option></select></div> </div>
                        </div>
                    </div>
                </div>
                <!-- Home Settings Panel -->
                <div id="home-settings-content" class="content-panel"> <div class="content-card"> <h2 class="text-2xl font-semibold mb-6">Home Dashboard</h2> <div class="space-y-4"> <div class="setting-row opacity-50"> <div><label class="setting-label block">Customize Widgets</label><p class="setting-description">Choose which summaries appear. (Coming Soon)</p></div> <div class="setting-control"><button class="btn btn-secondary !py-1 !px-3 text-sm" disabled>Customize</button></div> </div> <div class="setting-row"> <div><label for="setting-show-motivation" class="setting-label block">Show Motivational Quote</label><p class="setting-description">Display a daily quote on the home screen.</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" id="setting-show-motivation" checked><span class="toggle-slider"></span></label></div> </div> </div> </div> </div>
                <!-- Nutrition Settings Panel -->
                <div id="nutrition-settings-content" class="content-panel"> <div class="content-card"> <h2 class="text-2xl font-semibold mb-6">Nutrition Preferences</h2> <div class="space-y-4"> <div class="setting-row"> <div><label for="setting-water-glass-size" class="setting-label block">Default Water Glass Size</label><p class="setting-description">Amount added via water button (ml).</p></div> <div class="setting-control"><input type="number" id="setting-water-glass-size" class="form-input !w-24 !py-1 text-sm" value="250" min="50" step="50"></div> </div> <div class="setting-row"> <div><label for="setting-default-meal-time" class="setting-label block">Default Meal Time</label><p class="setting-description">Pre-fill time when logging meals.</p></div> <div class="setting-control"><input type="time" id="setting-default-meal-time" class="form-input !w-28 !py-1 text-sm"></div> </div> <div class="setting-row opacity-50"> <div><label class="setting-label block">Barcode Database</label><p class="setting-description">Preferred source for scans. (Coming Soon)</p></div> <div class="setting-control"><select class="form-select !w-32 !py-1 text-sm" disabled><option>OpenFoodFacts</option></select></div> </div> </div> </div> </div>
                <!-- Workouts Settings Panel -->
                <div id="workouts-settings-content" class="content-panel"> <div class="content-card"> <h2 class="text-2xl font-semibold mb-6">Workout Preferences</h2> <div class="space-y-4"> <div class="setting-row"> <div><label for="setting-rest-timer" class="setting-label block">Default Rest Timer</label><p class="setting-description">Default rest duration (seconds).</p></div> <div class="setting-control"><input type="number" id="setting-rest-timer" class="form-input !w-24 !py-1 text-sm" value="90" min="15" step="15"></div> </div> <div class="setting-row"> <div><label for="setting-auto-start-timer" class="setting-label block">Auto-start Rest Timer</label><p class="setting-description">Start timer after logging a set.</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" id="setting-auto-start-timer"><span class="toggle-slider"></span></label></div> </div> <div class="setting-row opacity-50"> <div><label class="setting-label block">Plate Calculator Bar</label><p class="setting-description">Default bar weight (kg). (Coming Soon)</p></div> <div class="setting-control"><input type="number" class="form-input !w-20 !py-1 text-sm" value="20" disabled></div> </div> <div class="setting-row"> <div><label for="setting-video-autoplay" class="setting-label block">Autoplay Exercise Videos</label><p class="setting-description">Play videos automatically in details view.</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" id="setting-video-autoplay" checked><span class="toggle-slider"></span></label></div> </div> </div> </div> </div>
                <!-- Sleep Settings Panel -->
                <div id="sleep-settings-content" class="content-panel"> <div class="content-card"> <h2 class="text-2xl font-semibold mb-6">Sleep Preferences</h2> <div class="space-y-4"> <div class="setting-row"> <div><label for="setting-sleep-goal" class="setting-label block">Sleep Goal</label><p class="setting-description">Your target sleep duration (hours).</p></div> <div class="setting-control"><input type="number" id="setting-sleep-goal" class="form-input !w-20 !py-1 text-sm" value="8" min="4" max="12" step="0.5"></div> </div> <div class="setting-row"> <div><label for="setting-bedtime-reminder" class="setting-label block">Bedtime Reminder</label><p class="setting-description">Get notified when it's time for bed.</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" id="setting-bedtime-reminder"><span class="toggle-slider"></span></label></div> </div> <div class="setting-row"> <div><label for="setting-bedtime-reminder-time" class="setting-label block">Reminder Time</label><p class="setting-description">Time to receive bedtime reminder.</p></div> <div class="setting-control"><input type="time" id="setting-bedtime-reminder-time" class="form-input !w-28 !py-1 text-sm"></div> </div> </div> </div> </div>
                <!-- Progress Settings Panel -->
                <div id="progress-settings-content" class="content-panel"> <div class="content-card"> <h2 class="text-2xl font-semibold mb-6">Progress Tracking</h2> <div class="space-y-4"> <div class="setting-row"> <div><label for="setting-chart-range" class="setting-label block">Default Chart Range</label><p class="setting-description">Initial time range for progress charts.</p></div> <div class="setting-control"><select id="setting-chart-range" class="form-select !w-28 !py-1 text-sm"><option value="30d">30 Days</option><option value="90d">90 Days</option><option value="all" selected>All Time</option></select></div> </div> <div class="setting-row opacity-50"> <div><label class="setting-label block">Goal Check-in Reminders</label><p class="setting-description">Reminders to update goals. (Coming Soon)</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" disabled><span class="toggle-slider"></span></label></div> </div> </div> </div> </div>
                <!-- Social Settings Panel -->
                <div id="social-settings-content" class="content-panel"> <div class="content-card"> <h2 class="text-2xl font-semibold mb-6">Social Preferences</h2> <div class="space-y-4"> <div class="setting-row opacity-50"> <div><label class="setting-label block">Profile Visibility</label><p class="setting-description">Control who can see your profile. (Coming Soon)</p></div> <div class="setting-control"><select class="form-select !w-28 !py-1 text-sm" disabled><option>Private</option><option>Friends</option><option>Public</option></select></div> </div> <div class="setting-row opacity-50"> <div><label class="setting-label block">Allow Friend Requests</label><p class="setting-description">Accept new friend connections. (Coming Soon)</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" checked disabled><span class="toggle-slider"></span></label></div> </div> </div> </div> </div>
                
                <!-- ADDED: Your Details Panel -->
                <div id="your-details-content" class="content-panel">
                    <div class="content-card">
                        <h2 class="text-2xl font-semibold mb-6">Your Details</h2>
                        <p class="text-sm text-secondary-text mb-6">This information helps the AI provide more personalized recommendations for goals, nutrition, and workouts.</p>
                        
                        <form id="your-details-form" class="space-y-6">
                            
                            <!-- 1. Gender -->
                            <div>
                                <label for="setting-gender" class="form-label">Gender</label>
                                <select id="setting-gender" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                    <option value="prefer_not_to_say">Prefer not to say</option>
                                </select>
                            </div>
                            
                            <!-- 2. Training History -->
                            <div>
                                <label for="setting-training-history" class="form-label">Training History</label>
                                <select id="setting-training-history" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="beginner">Beginner (0-1 years)</option>
                                    <option value="intermediate">Intermediate (1-3 years)</option>
                                    <option value="advanced">Advanced (3+ years)</option>
                                </select>
                            </div>

                            <!-- 3. Familiarity -->
                            <div>
                                <label for="setting-fitness-familiarity" class="form-label">How familiar are you with fitness/nutrition science?</label>
                                <select id="setting-fitness-familiarity" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="novice">Novice (Just starting to learn)</option>
                                    <option value="familiar">Familiar (I know the basics)</option>
                                    <option value="knowledgeable">Knowledgeable (I understand CICO, progressive overload, etc.)</option>
                                </select>
                            </div>

                            <!-- 4. How busy -->
                             <div>
                                <label for="setting-how-busy" class="form-label">How busy are you typically?</label>
                                <select id="setting-how-busy" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="Very busy">Very busy (need short, efficient workouts)</option>
                                    <option value="Balanced">Balanced (can make time)</option>
                                    <option value="Lots of free time">Lots of free time (open to longer workouts)</option>
                                </select>
                            </div>

                            <!-- 5. Daily Activity Level -->
                            <div>
                                <label for="setting-activity-level" class="form-label">Daily Activity Level (non-exercise)</label>
                                <select id="setting-activity-level" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="Sedentary">Sedentary (desk job)</option>
                                    <option value="Lightly Active">Lightly Active (some walking)</option>
                                    <option value="Active">Active (on your feet most of the day)</option>
                                    <option value="Very Active">Very Active (physical labor, etc.)</option>
                                </select>
                            </div>

                            <!-- 6. Body Type -->
                            <div>
                                <label class="form-label mb-2">What best matches your current body type?</label>
                                <div class="image-picker-container">
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-slender" value="Slender" class="image-picker-input">
                                        <label for="body-type-slender" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Slender" alt="Slender body type">
                                            <p>Slender</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-defined" value="Defined" class="image-picker-input">
                                        <label for="body-type-defined" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Defined" alt="Defined body type">
                                            <p>Defined</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-athletic" value="Athletic" class="image-picker-input">
                                        <label for="body-type-athletic" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Athletic" alt="Athletic body type">
                                            <p>Athletic</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-slender-soft" value="Slender & Soft" class="image-picker-input">
                                        <label for="body-type-slender-soft" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Slender+Soft" alt="Slender & Soft body type">
                                            <p>Slender & Soft</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-bulky" value="Bulky" class="image-picker-input">
                                        <label for="body-type-bulky" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Bulky" alt="Bulky body type">
                                            <p>Bulky</p>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="radio" name="body-type" id="body-type-soft-heavy" value="Soft & Heavy" class="image-picker-input">
                                        <label for="body-type-soft-heavy" class="image-picker-label">
                                            <img src="https://placehold.co/150x150/111111/FFFFFF?text=Soft+Heavy" alt="Soft & Heavy body type">
                                            <p>Soft & Heavy</p>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 7. Body Fat Level (Conditional) -->
                            <div>
                                <label class="form-label mb-2">Which image best reflects your current body fat level?</label>
                                <!-- Male Examples -->
                                <div id="male-body-fat-group" class="hidden">
                                    <p class="text-xs text-secondary-text mb-2">Appearance examples (Male):</p>
                                    <div class="image-picker-container">
                                        <div><input type="radio" name="body-fat" id="body-fat-m-10" value="10-12%" class="image-picker-input"><label for="body-fat-m-10" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~10-12%25" alt="10-12% body fat male"><p>10-12%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-m-15" value="15%" class="image-picker-input"><label for="body-fat-m-15" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~15%25" alt="15% body fat male"><p>15%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-m-20" value="20%" class="image-picker-input"><label for="body-fat-m-20" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~20%25" alt="20% body fat male"><p>20%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-m-25" value="25%" class="image-picker-input"><label for="body-fat-m-25" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~25%25" alt="25% body fat male"><p>25%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-m-30" value="30%" class="image-picker-input"><label for="body-fat-m-30" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~30%25" alt="30% body fat male"><p>30%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-m-35" value="35-40%" class="image-picker-input"><label for="body-fat-m-35" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~35-40%25" alt="35-40% body fat male"><p>35-40%</p></label></div>
                                    </div>
                                </div>
                                <!-- Female Examples -->
                                <div id="female-body-fat-group" class="hidden">
                                    <p class="text-xs text-secondary-text mb-2">Appearance examples (Female):</p>
                                    <div class="image-picker-container">
                                        <div><input type="radio" name="body-fat" id="body-fat-f-15" value="15-17%" class="image-picker-input"><label for="body-fat-f-15" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~15-17%25" alt="15-17% body fat female"><p>15-17%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-f-20" value="20-22%" class="image-picker-input"><label for="body-fat-f-20" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~20-22%25" alt="20-22% body fat female"><p>20-22%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-f-25" value="25%" class="image-picker-input"><label for="body-fat-f-25" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~25%25" alt="25% body fat female"><p>25%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-f-30" value="30%" class="image-picker-input"><label for="body-fat-f-30" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~30%25" alt="30% body fat female"><p>30%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-f-35" value="35%" class="image-picker-input"><label for="body-fat-f-35" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~35%25" alt="35% body fat female"><p>35%</p></label></div>
                                        <div><input type="radio" name="body-fat" id="body-fat-f-40" value="40-45%" class="image-picker-input"><label for="body-fat-f-40" class="image-picker-label"><img src="https://placehold.co/150x150/111111/FFFFFF?text=~40-45%25" alt="40-45% body fat female"><p>40-45%</p></label></div>
                                    </div>
                                </div>
                                <!-- Placeholder for when no gender is selected -->
                                <div id="body-fat-placeholder" class="text-sm text-secondary-text p-4 bg-input-bg rounded-lg text-center">
                                    <p>Please select a gender above to see body fat examples.</p>
                                </div>
                            </div>

                            <!-- 8. Past Attempts -->
                            <div>
                                <label class="form-label mb-2">Have you attempted any of the following in the past? (Optional)</label>
                                <div class="checkbox-grid">
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="weight-loss" class="form-checkbox"><span>Weight loss</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="muscle-gain" class="form-checkbox"><span>Muscle gain</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="personal-trainer" class="form-checkbox"><span>Personal trainer</span></label>
                                    <label class="checkbox-label"><input type="checkbox" name="past-attempt" value="specific-diet" class="form-checkbox"><span>Specific diet (keto, etc)</span></label>
                                </div>
                            </div>

                            <!-- 9. Tracking App -->
                            <div>
                                <label for="setting-tracking-app" class="form-label">Do you use a workout tracking app in the past? (Optional)</label>
                                <select id="setting-tracking-app" class="form-select mt-1">
                                    <option value="">Select...</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>

                            <!-- 10. Experiences -->
                            <div>
                                <label for="setting-experiences" class="form-label">Experiences with previous fitness plans (Optional)</label>
                                <textarea id="setting-experiences" rows="3" class="form-input mt-1" placeholder="e.g., 'I liked keto but found it too restrictive.', 'I enjoy lifting heavy but get bored easily.'"></textarea>
                            </div>
                            
                            <!-- Save Button -->
                            <button type="submit" id="save-your-details-btn" class="w-full btn btn-primary !mt-6">
                                <span class="btn-text">Save Details</span>
                                <div class="loader hidden"></div>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- App Settings Panel -->
                <div id="app-settings-content" class="content-panel"> <div class="space-y-8"> <div class="content-card"> <h2 class="text-2xl font-semibold mb-6">Notifications</h2> <div class="space-y-4"> <div class="setting-row"> <div><label for="setting-workout-reminders" class="setting-label block">Workout Reminders</label><p class="setting-description">Get notified for scheduled workouts.</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" id="setting-workout-reminders" checked><span class="toggle-slider"></span></label></div> </div> <div class="setting-row"> <div><label for="setting-progress-milestones" class="setting-label block">Progress Milestones</label><p class="setting-description">Celebrate reaching goals or hitting PRs.</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" id="setting-progress-milestones" checked><span class="toggle-slider"></span></label></div> </div> <div class="setting-row opacity-50"> <div><label for="setting-social-notifications" class="setting-label block">Social Notifications</label><p class="setting-description">Friend requests, comments, etc. (Coming Soon)</p></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox" id="setting-social-notifications" disabled><span class="toggle-slider"></span></label></div> </div> </div> </div> <div class="content-card"> <h2 class="text-2xl font-semibold mb-4">Appearance</h2> <p class="text-sm text-secondary-text mb-4">Choose your preferred theme.</p> <div class="flex gap-2 p-1 rounded-lg bg-input-bg"> <button id="theme-light-btn" class="theme-btn w-full btn btn-secondary !py-2"><i data-lucide="sun"></i>Light</button> <button id="theme-dark-btn" class="theme-btn w-full btn btn-secondary !py-2"><i data-lucide="moon"></i>Dark</button> </div> </div> <div class="content-card"> <h2 class="text-2xl font-semibold mb-6">About & Help</h2> <div class="space-y-4"> <a href="#" class="setting-row !block hover:bg-input-bg/50 rounded-md px-2 -mx-2"><span class="setting-label">FAQ & Support</span></a> <a href="#" class="setting-row !block hover:bg-input-bg/50 rounded-md px-2 -mx-2"><span class="setting-label">Privacy Policy</span></a> <a href="#" class="setting-row !block hover:bg-input-bg/50 rounded-md px-2 -mx-2"><span class="setting-label">Terms of Service</span></a> <div class="setting-row"><div><span class="setting-label">App Version</span></div><div><span class="text-sm text-secondary-text">1.0.1</span></div></div> </div> </div> </div> </div>
                <!-- Account & Data Panel -->
                <div id="account-content" class="content-panel"> <div class="space-y-8"> <div class="content-card"> <h2 class="text-2xl font-semibold mb-4">Account Settings</h2> <p class="text-secondary-text">Account management features are coming soon. Your data is currently stored locally in your browser.</p> <div class="mt-6 p-4 border border-dashed border-border-color rounded-lg text-center"><i data-lucide="cloud" class="w-10 h-10 text-secondary-text mx-auto mb-2"></i><p class="text-sm text-secondary-text">Cloud sync and account options will appear here.</p></div> </div> <div class="content-card"> <h2 class="text-2xl font-semibold mb-4">Data Management</h2> <p class="text-sm text-secondary-text mb-6">Save your data to a file or restore from a backup. Deleting is permanent.</p> <div class="space-y-4"> <button id="backup-data-btn" class="w-full btn btn-secondary"><i data-lucide="download"></i>Backup All Data</button> <label for="restore-data-input" class="w-full btn btn-secondary cursor-pointer"><i data-lucide="upload"></i>Restore From Backup</label> <input type="file" id="restore-data-input" class="hidden" accept=".json"> <button id="delete-all-data-btn" class="w-full btn btn-danger"><i data-lucide="trash-2"></i>Delete All Data</button> </div> </div> </div> </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-modal-text" class="text-secondary-text mb-6">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button></div></div></div>
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2><p id="alert-modal-text" class="text-secondary-text mb-6"></p><div class="flex justify-end"><button id="alert-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Script to load Header/Footer and Page Logic -->
    <script>
        // --- Load Header and Footer ---
        async function loadComponent(url, placeholderId) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}: ${response.statusText}`);
                const text = await response.text();
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = text;
                }
            } catch (error) {
                console.error(`Error loading component from ${url}:`, error);
                const placeholder = document.getElementById(placeholderId);
                if (placeholder) {
                    placeholder.innerHTML = `<p class="text-red-500 text-center">Error loading component.</p>`;
                }
            }
        }

        async function initializeLayout() {
            await Promise.all([
                loadComponent('assets/header.html', 'header-placeholder'),
                loadComponent('assets/footer.html', 'footer-placeholder')
            ]);
            lucide.createIcons(); // Re-render icons after loading components

            // --- Set Active Footer Link ---
            const currentPage = 'settings'; // Set this page as active
            const navLinks = document.querySelectorAll('#mobile-footer-nav .nav-link');
            navLinks.forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // --- Initialize Page Specific JS ---
            initializeSettingsPage();
        }
        // --- End Load Header and Footer ---

        // --- Original script from settings.html (wrapped, Firebase removed) ---
        function initializeSettingsPage() {
            // --- STATE MANAGEMENT ---
            let confirmCallback = null;
            let appSettings = {}; // Object to store all settings

            // --- UI ELEMENT DEFINITIONS ---
            const ui = {
                confirmModal: document.getElementById('confirm-modal'),
                alertModal: document.getElementById('alert-modal'),
                backupDataBtn: document.getElementById('backup-data-btn'),
                restoreDataInput: document.getElementById('restore-data-input'),
                deleteAllDataBtn: document.getElementById('delete-all-data-btn'),
                themeLightBtn: document.getElementById('theme-light-btn'),
                themeDarkBtn: document.getElementById('theme-dark-btn'),
                sidebar: document.getElementById('settings-sidebar'),
                mobileNav: document.getElementById('mobile-settings-nav'),
                contentPanels: document.querySelectorAll('.content-panel'),
                // Setting Inputs
                weightUnitSelect: document.getElementById('setting-weight-unit'), 
                heightUnitSelect: document.getElementById('setting-height-unit'), 
                distanceUnitSelect: document.getElementById('setting-distance-unit'), 
                restTimerInput: document.getElementById('setting-rest-timer'), 
                autoStartTimerToggle: document.getElementById('setting-auto-start-timer'), 
                waterGlassSizeInput: document.getElementById('setting-water-glass-size'), 
                workoutRemindersToggle: document.getElementById('setting-workout-reminders'), 
                progressMilestonesToggle: document.getElementById('setting-progress-milestones'), 
                socialNotificationsToggle: document.getElementById('setting-social-notifications'), 
                showMotivationToggle: document.getElementById('setting-show-motivation'), 
                defaultMealTimeInput: document.getElementById('setting-default-meal-time'), 
                videoAutoplayToggle: document.getElementById('setting-video-autoplay'), 
                sleepGoalInput: document.getElementById('setting-sleep-goal'), 
                bedtimeReminderToggle: document.getElementById('setting-bedtime-reminder'), 
                bedtimeReminderTimeInput: document.getElementById('setting-bedtime-reminder-time'), 
                chartRangeSelect: document.getElementById('setting-chart-range'),
                
                // --- ADDED: Your Details Form UI ---
                yourDetailsForm: document.getElementById('your-details-form'),
                saveYourDetailsBtn: document.getElementById('save-your-details-btn'),
                genderSelect: document.getElementById('setting-gender'),
                maleBodyFatGroup: document.getElementById('male-body-fat-group'),
                femaleBodyFatGroup: document.getElementById('female-body-fat-group'),
                bodyFatPlaceholder: document.getElementById('body-fat-placeholder'),
            };

            // --- CORE & HELPER FUNCTIONS ---
            function showModal(modalElement) { modalElement.style.display = 'flex'; }
            function hideModal(modalElement) { modalElement.style.display = 'none'; }
            function showCustomAlert(title, text) { document.getElementById('alert-modal-title').textContent = title; document.getElementById('alert-modal-text').textContent = text; showModal(ui.alertModal); }
            function showConfirmModal(title, text, onConfirm) { document.getElementById('confirm-modal-title').textContent = title; document.getElementById('confirm-modal-text').textContent = text; confirmCallback = onConfirm; showModal(ui.confirmModal); }

            // --- DATA & SETTINGS (Using LocalStorage) ---
            function loadAppSettings() {
                const defaults = { 
                    weightUnit: 'kg', heightUnit: 'cm', distanceUnit: 'km', 
                    defaultRestTimer: 90, autoStartRestTimer: false, waterGlassSize: 250, 
                    defaultMealTime: '', videoAutoplay: true, sleepGoal: 8, 
                    bedtimeReminder: false, bedtimeReminderTime: '22:00', 
                    defaultChartRange: 'all', showMotivation: true, workoutReminders: true, 
                    progressMilestones: true, socialNotifications: false, 
                    profileVisibility: 'Private', allowFriendRequests: true,
                };
                appSettings = { ...defaults, ...JSON.parse(localStorage.getItem('fitTrackAI_appSettings') || '{}') };
                
                // --- ADDED: Load userDetails ---
                const defaultUserDetails = {
                    gender: '', trainingHistory: '', familiarity: '', howBusy: '', activityLevel: '',
                    bodyType: '', bodyFat: '', pastAttempts: [], trackingApp: '', experiences: ''
                };
                appSettings.userDetails = { ...defaultUserDetails, ...JSON.parse(localStorage.getItem('fitTrackAI_userDetails') || '{}') };
                // --- END ADDED ---

                applySettingsToUI();
                loadYourDetailsForm(); // --- ADDED ---
            }

            function saveAppSettings() {
                // Separate userDetails from other app settings for saving
                const userDetails = appSettings.userDetails;
                const otherSettings = { ...appSettings };
                delete otherSettings.userDetails;

                localStorage.setItem('fitTrackAI_appSettings', JSON.stringify(otherSettings));
                localStorage.setItem('fitTrackAI_userDetails', JSON.stringify(userDetails));

                // Dispatch event so other open tabs can update if needed
                window.dispatchEvent(new StorageEvent('storage', { key: 'fitTrackAI_appSettings', newValue: JSON.stringify(otherSettings) }));
                window.dispatchEvent(new StorageEvent('storage', { key: 'fitTrackAI_userDetails', newValue: JSON.stringify(userDetails) }));
            }

            // --- ADDED: Load Your Details Form ---
            function loadYourDetailsForm() {
                const details = appSettings.userDetails || {};
                const form = ui.yourDetailsForm;
                if (!form) return;

                form.querySelector('#setting-gender').value = details.gender || '';
                form.querySelector('#setting-training-history').value = details.trainingHistory || '';
                form.querySelector('#setting-fitness-familiarity').value = details.familiarity || '';
                form.querySelector('#setting-how-busy').value = details.howBusy || '';
                form.querySelector('#setting-activity-level').value = details.activityLevel || '';
                form.querySelector('#setting-tracking-app').value = details.trackingApp || '';
                form.querySelector('#setting-experiences').value = details.experiences || '';

                // Past attempts checkboxes
                form.querySelectorAll('input[name="past-attempt"]').forEach(cb => {
                    cb.checked = (details.pastAttempts || []).includes(cb.value);
                });

                // Body type radio
                if (details.bodyType) {
                    const radio = form.querySelector(`input[name="body-type"][value="${details.bodyType}"]`);
                    if (radio) radio.checked = true;
                }

                // Body fat radio
                if (details.bodyFat) {
                    const radio = form.querySelector(`input[name="body-fat"][value="${details.bodyFat}"]`);
                    if (radio) radio.checked = true;
                }

                // Trigger gender change to show correct body fat pickers
                toggleBodyFatPickers(details.gender);
            }

            // --- ADDED: Save Your Details Form ---
            function saveYourDetails() {
                const form = ui.yourDetailsForm;
                if (!form) return;

                const btn = ui.saveYourDetailsBtn;
                btn.disabled = true;
                const btnText = btn.querySelector('.btn-text');
                const loader = btn.querySelector('.loader');
                if(btnText) btnText.style.display = 'none';
                if(loader) loader.classList.remove('hidden');

                const details = {
                    gender: form.querySelector('#setting-gender').value,
                    trainingHistory: form.querySelector('#setting-training-history').value,
                    familiarity: form.querySelector('#setting-fitness-familiarity').value,
                    howBusy: form.querySelector('#setting-how-busy').value,
                    activityLevel: form.querySelector('#setting-activity-level').value,
                    trackingApp: form.querySelector('#setting-tracking-app').value,
                    experiences: form.querySelector('#setting-experiences').value,
                    pastAttempts: Array.from(form.querySelectorAll('input[name="past-attempt"]:checked')).map(cb => cb.value),
                    bodyType: form.querySelector('input[name="body-type"]:checked')?.value || '',
                    bodyFat: form.querySelector('input[name="body-fat"]:checked')?.value || '',
                };

                appSettings.userDetails = details;
                saveAppSettings();
                
                setTimeout(() => {
                    if (btnText) { btnText.textContent = "Saved!"; btnText.style.display = 'inline'; }
                    if (loader) loader.classList.add('hidden');
                    setTimeout(() => {
                        btn.disabled = false;
                        if (btnText) btnText.textContent = "Save Details";
                    }, 1500);
                }, 500);
            }

            // --- ADDED: Toggle body fat pickers ---
            function toggleBodyFatPickers(gender) {
                if (!ui.maleBodyFatGroup || !ui.femaleBodyFatGroup || !ui.bodyFatPlaceholder) return;

                if (gender === 'male') {
                    ui.maleBodyFatGroup.classList.remove('hidden');
                    ui.femaleBodyFatGroup.classList.add('hidden');
                    ui.bodyFatPlaceholder.classList.add('hidden');
                } else if (gender === 'female') {
                    ui.maleBodyFatGroup.classList.add('hidden');
                    ui.femaleBodyFatGroup.classList.remove('hidden');
                    ui.bodyFatPlaceholder.classList.add('hidden');
                } else {
                    ui.maleBodyFatGroup.classList.add('hidden');
                    ui.femaleBodyFatGroup.classList.add('hidden');
                    ui.bodyFatPlaceholder.classList.remove('hidden');
                }
            }


            function applySettingsToUI() { 
                if (ui.weightUnitSelect) ui.weightUnitSelect.value = appSettings.weightUnit; 
                if (ui.heightUnitSelect) ui.heightUnitSelect.value = appSettings.heightUnit; 
                if (ui.distanceUnitSelect) ui.distanceUnitSelect.value = appSettings.distanceUnit; 
                if (ui.showMotivationToggle) ui.showMotivationToggle.checked = appSettings.showMotivation; 
                if (ui.waterGlassSizeInput) ui.waterGlassSizeInput.value = appSettings.waterGlassSize; 
                if (ui.defaultMealTimeInput) ui.defaultMealTimeInput.value = appSettings.defaultMealTime; 
                if (ui.restTimerInput) ui.restTimerInput.value = appSettings.defaultRestTimer; 
                if (ui.autoStartTimerToggle) ui.autoStartTimerToggle.checked = appSettings.autoStartRestTimer; 
                if (ui.videoAutoplayToggle) ui.videoAutoplayToggle.checked = appSettings.videoAutoplay; 
                if (ui.sleepGoalInput) ui.sleepGoalInput.value = appSettings.sleepGoal; 
                if (ui.bedtimeReminderToggle) ui.bedtimeReminderToggle.checked = appSettings.bedtimeReminder; 
                if (ui.bedtimeReminderTimeInput) ui.bedtimeReminderTimeInput.value = appSettings.bedtimeReminderTime; 
                if (ui.chartRangeSelect) ui.chartRangeSelect.value = appSettings.defaultChartRange; 
                if (ui.workoutRemindersToggle) ui.workoutRemindersToggle.checked = appSettings.workoutReminders; 
                if (ui.progressMilestonesToggle) ui.progressMilestonesToggle.checked = appSettings.progressMilestones; 
            }
            
            // --- THEME ---
            function applyTheme(theme) { 
                document.documentElement.setAttribute('data-theme', theme); 
                localStorage.setItem('fitTrackAI_theme', theme); 
                ui.themeLightBtn?.classList.toggle('active', theme === 'light'); 
                ui.themeDarkBtn?.classList.toggle('active', theme === 'dark'); 
                window.dispatchEvent(new StorageEvent('storage', { key: 'fitTrackAI_theme', newValue: theme })); 
            }

            // --- NAVIGATION ---
            function navigate(targetId) { 
                ui.contentPanels.forEach(panel => panel.classList.remove('active')); 
                const targetPanel = document.getElementById(targetId); 
                if (targetPanel) { 
                    targetPanel.classList.add('active'); 
                } else { 
                    document.getElementById('general-settings-content')?.classList.add('active'); 
                    targetId = 'general-settings-content'; 
                } 
                ui.sidebar?.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active')); 
                ui.sidebar?.querySelector(`[data-target="${targetId}"]`)?.classList.add('active'); 
                ui.mobileNav?.querySelectorAll('.mobile-sidebar-link').forEach(link => link.classList.remove('active')); 
                const activeMobileLink = ui.mobileNav?.querySelector(`[data-target="${targetId}"]`); 
                if (activeMobileLink) { 
                    activeMobileLink.classList.add('active'); 
                    activeMobileLink.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); 
                } 
                localStorage.setItem('fitTrackAI_activeSettingsTab', targetId); 
            }
            
            function setupNavigation() { 
                [ui.sidebar, ui.mobileNav].forEach(bar => { 
                    if (bar) { 
                        bar.addEventListener('click', e => { 
                            const link = e.target.closest('a[data-target]'); 
                            if (link && link.dataset.target) { 
                                e.preventDefault(); 
                                navigate(link.dataset.target); 
                            } 
                        }); 
                    } 
                }); 
            }

            // --- EVENT LISTENERS ---
            document.getElementById('alert-modal-ok-btn')?.addEventListener('click', () => hideModal(ui.alertModal));
            document.getElementById('confirm-modal-cancel-btn')?.addEventListener('click', () => hideModal(ui.confirmModal));
            document.getElementById('confirm-modal-confirm-btn')?.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideModal(ui.confirmModal); });

            ui.backupDataBtn?.addEventListener('click', () => { 
                try { 
                    const allData = {}; 
                    for (let i = 0; i < localStorage.length; i++) { 
                        const key = localStorage.key(i); 
                        if (key && key.startsWith('fitTrackAI_')) { 
                            allData[key] = localStorage.getItem(key); 
                        } 
                    } 
                    const dataStr = JSON.stringify(allData, null, 2); 
                    const blob = new Blob([dataStr], { type: 'application/json' }); 
                    const url = URL.createObjectURL(blob); 
                    const a = document.createElement('a'); 
                    a.href = url; a.download = `kowbi_backup_${new Date().toISOString().split('T')[0]}.json`; 
                    a.click(); 
                    URL.revokeObjectURL(url); 
                    showCustomAlert('Backup Successful', 'Your data has been downloaded.'); 
                } catch (error) { 
                    showCustomAlert('Backup Failed', `Could not create backup file: ${error.message}`); 
                } 
            });
            
            ui.restoreDataInput?.addEventListener('change', (e) => { 
                const file = e.target.files[0]; 
                if (file) { 
                    const reader = new FileReader(); 
                    reader.onload = (event) => { 
                        try { 
                            const backupData = JSON.parse(event.target.result); 
                            showConfirmModal('Restore Data?', 'This will overwrite ALL current app data with the backup file. Continue?', () => { 
                                const keysToRemove = []; 
                                for (let i = 0; i < localStorage.length; i++) { 
                                    const key = localStorage.key(i); 
                                    if (key && key.startsWith('fitTrackAI_')) { 
                                        keysToRemove.push(key); 
                                    } 
                                } 
                                keysToRemove.forEach(key => localStorage.removeItem(key)); 
                                for (const key in backupData) { 
                                    if (key.startsWith('fitTrackAI_')) { 
                                        localStorage.setItem(key, backupData[key]); 
                                    } 
                                } 
                                showCustomAlert('Restore Complete', 'Data restored. Reloading the app...'); 
                                setTimeout(() => location.reload(), 2000); 
                            }); 
                        } catch (error) { 
                            showCustomAlert('Restore Failed', `Invalid backup file or error parsing data: ${error.message}`); 
                        } finally { 
                            e.target.value = null; 
                        } 
                    }; 
                    reader.onerror = () => { 
                        showCustomAlert('Restore Failed', 'Could not read the backup file.'); 
                        e.target.value = null; 
                    }; 
                    reader.readAsText(file); 
                } 
            });
            
            ui.deleteAllDataBtn?.addEventListener('click', () => { 
                showConfirmModal('DELETE ALL DATA?', 'This is PERMANENT and will remove all your logs, settings, and profile information. Are you absolutely sure?', () => { 
                    const keysToRemove = []; 
                    for (let i = 0; i < localStorage.length; i++) { 
                        const key = localStorage.key(i); 
                        if (key && key.startsWith('fitTrackAI_')) { 
                            keysToRemove.push(key); 
                        } 
                    } 
                    keysToRemove.forEach(key => localStorage.removeItem(key)); 
                    showCustomAlert('Data Deleted', 'All app data has been removed. Reloading...'); 
                    setTimeout(() => location.reload(), 2000); 
                }); 
            });

            ui.themeLightBtn?.addEventListener('click', () => applyTheme('light'));
            ui.themeDarkBtn?.addEventListener('click', () => applyTheme('dark'));

            function setupSettingsListeners() { 
                const inputsToWatch = [
                    { element: ui.weightUnitSelect, key: 'weightUnit', type: 'value' },
                    { element: ui.heightUnitSelect, key: 'heightUnit', type: 'value' },
                    { element: ui.distanceUnitSelect, key: 'distanceUnit', type: 'value' },
                    { element: ui.showMotivationToggle, key: 'showMotivation', type: 'checked' },
                    { element: ui.waterGlassSizeInput, key: 'waterGlassSize', type: 'number', min: 50 },
                    { element: ui.defaultMealTimeInput, key: 'defaultMealTime', type: 'value' },
                    { element: ui.restTimerInput, key: 'defaultRestTimer', type: 'number', min: 15 },
                    { element: ui.autoStartTimerToggle, key: 'autoStartRestTimer', type: 'checked' },
                    { element: ui.videoAutoplayToggle, key: 'videoAutoplay', type: 'checked' },
                    { element: ui.sleepGoalInput, key: 'sleepGoal', type: 'number', min: 4, max: 12, step: 0.5 },
                    { element: ui.bedtimeReminderToggle, key: 'bedtimeReminder', type: 'checked' },
                    { element: ui.bedtimeReminderTimeInput, key: 'bedtimeReminderTime', type: 'value' },
                    { element: ui.chartRangeSelect, key: 'defaultChartRange', type: 'value' },
                    { element: ui.workoutRemindersToggle, key: 'workoutReminders', type: 'checked' },
                    { element: ui.progressMilestonesToggle, key: 'progressMilestones', type: 'checked' },
                ];
                
                inputsToWatch.forEach(({ element, key, type, min, max, step }) => {
                    if (element) {
                        element.addEventListener('change', (e) => {
                            let value;
                            if (type === 'checked') {
                                value = e.target.checked;
                            } else if (type === 'number') {
                                value = parseFloat(e.target.value) || 0;
                                if (min !== undefined && value < min) value = min;
                                if (max !== undefined && value > max) value = max;
                                if (step) value = Math.round(value / step) * step;
                                e.target.value = value;
                            } else {
                                value = e.target.value;
                            }
                            appSettings[key] = value;
                            saveAppSettings();
                        });
                    }
                });

                // --- ADDED: Listeners for new form ---
                if (ui.yourDetailsForm) {
                    ui.yourDetailsForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        saveYourDetails();
                    });
                }
                if (ui.genderSelect) {
                    ui.genderSelect.addEventListener('change', (e) => {
                        toggleBodyFatPickers(e.target.value);
                    });
                }
            }

            // --- INITIALIZATION ---
            loadAppSettings();
            applyTheme(localStorage.getItem('fitTrackAI_theme') || 'dark');
            setupNavigation();
            setupSettingsListeners();
            const lastTab = localStorage.getItem('fitTrackAI_activeSettingsTab') || 'general-settings-content'; // Default to General
            navigate(lastTab);
            // Lucide icons are now rendered in initializeLayout after components load
        }
        // --- End Original script ---

        // Initialize layout and page logic on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeLayout);
    </script>
</body>

</html>

